import{_ as r,c as a,a5 as o,j as e,o as d}from"./chunks/framework.B5CpDqM0.js";const s="/assets/DACL%20abuse%20mindmap.CnS4bNaY.png",f=JSON.parse('{"title":"DACL abuse","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/dacl/index.md","filePath":"ad/movement/dacl/index.md","lastUpdated":1724982529000}'),i={name:"ad/movement/dacl/index.md"};function c(n,t,l,h,p,u){return d(),a("div",null,t[0]||(t[0]=[o('<h1 id="dacl-abuse" tabindex="-1">DACL abuse <a class="header-anchor" href="#dacl-abuse" aria-label="Permalink to &quot;DACL abuse&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Access privileges for resources in Active Directory Domain Services are usually granted through the use of an Access Control Entry (ACE). Access Control Entries describe the allowed and denied permissions for a principal (e.g. user, computer account) in Active Directory against a securable object (user, group, computer, container, organizational unit (OU), GPO and so on)</p><p>DACLs (Active Directory Discretionary Access Control Lists) are lists made of ACEs (Access Control Entries) that identify the users and groups that are allowed or denied access on an object. SACLs (Systems Access Control Lists) define the audit and monitoring rules over a securable object.</p><p>When misconfigured, ACEs can be abused to operate lateral movement or privilege escalation within an AD domain.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>If an object&#39;s <em>(referred to as &quot;objectA&quot;)</em> DACL features an ACE stating that another object <em>(referred to as &quot;objectB&quot;)</em> has a specific right (e.g. <code>GenericAll</code>) over it (i.e. over objectA), attackers need to be in control of objectB to take control of objectA. The following abuses can only be carried out when running commands as the user mentioned in the ACE (objectB) (see <a href="./../credentials/impersonation">impersonation techniques</a>).</p><h3 id="recon" tabindex="-1">Recon <a class="header-anchor" href="#recon" aria-label="Permalink to &quot;Recon&quot;">​</a></h3><p>DACL abuse potential paths can be identified by <a href="./../../recon/bloodhound/index">BloodHound</a> from UNIX-like (using the Python ingestor <a href="https://github.com/fox-it/BloodHound.py" target="_blank" rel="noreferrer">bloodhound.py</a>) and Windows (using the <a href="https://github.com/BloodHoundAD/SharpHound3" target="_blank" rel="noreferrer">SharpHound</a> ingestor) systems.</p><p>Other tools like, <code>Get-DomainObjectAcl</code> and <code>Add-DomainObjectAcl</code> from <a href="https://github.com/PowerShellMafia/PowerSploit/" target="_blank" rel="noreferrer">Powersploit</a>&#39;s <a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noreferrer">Powerview</a>, <code>Get-Acl</code> and <code>Set-Acl</code> official Powershell cmdlets, or <a href="https://github.com/SecureAuthCorp/impacket" target="_blank" rel="noreferrer">Impacket</a>&#39;s dacledit.py script (Python) can be used in order to manually inspect an object&#39;s DACL.</p><h3 id="abuse" tabindex="-1">Abuse <a class="header-anchor" href="#abuse" aria-label="Permalink to &quot;Abuse&quot;">​</a></h3><p>In order to navigate the notes, testers can use the mindmap below.</p><p><img src="'+s+'" alt=""></p><p>All the aforementioned attacks (red blocks) are detailed in the child notes, except:</p><ul><li>SPN-jacking: very specific scenario, requires lots of access: see <a href="./../kerberos/spn-jacking">ADDS &gt; Movement &gt; Kerberos &gt; SPN-jacking</a></li><li>Shadow Credentials: see <a href="./../kerberos/shadow-credentials">ADDS &gt; Movement &gt; Kerberos &gt; Shadow Credentials</a></li><li>Kerberos RBCD: see <a href="./../kerberos/delegations/rbcd">ADDS &gt; Movement &gt; Kerberos &gt; Kerberos Delegations &gt; RBCD</a></li><li>GPO abuses: see <a href="./../group-policies">ADDS &gt; Movement &gt; GPOs</a></li><li>DCSync : see <a href="./../credentials/dumping/dcsync">ADDS &gt; Movement &gt; Credential &gt; Dumping &gt; DCSync</a></li></ul><div class="tip custom-block"><p class="custom-block-title">Self-attacks</p><p></p><ul><li>User and computers objects can conduct a <a href="./../kerberos/delegations/#resource-based-constrained-delegations-rbcd">Kerberos RCD</a> attack on themselves.</li><li>Computer objects can conduct a <a href="./../kerberos/shadow-credentials">Shadow Credentials</a> attack on themselves.</li></ul></div><div class="tip custom-block"><p class="custom-block-title">ACE inheritance</p><p></p><p>If attacker can write an ACE (<code>WriteDacl</code>) for a container or organisational unit (OU), if inheritance flags are added (<code>0x01+ 0x02</code>) to the ACE, and inheritance is enabled for an object in that container/OU, the ACE will be applied to it. By default, all the objects with <code>AdminCount=0</code> will inherit ACEs from their parent container/OU.</p><p>Impacket&#39;s dacledit (Python) can be used with the <code>-inheritance</code> flag for that purpose (<a href="https://github.com/fortra/impacket/pull/1291" target="_blank" rel="noreferrer">PR#1291</a>).</p></div><div class="tip custom-block"><p class="custom-block-title">adminCount=1 (gPLink spoofing)</p><p></p><p>In April 2024, <a href="https://www.synacktiv.com/en/publications/ounedpy-exploiting-hidden-organizational-units-acl-attack-vectors-in-active-directory" target="_blank" rel="noreferrer">Synacktiv explained</a> that if <code>GenericAll</code>, <code>GenericWrite</code> or <code>Manage Group Policy Links</code> privileges are available against an Organisational Unit (OU), then it&#39;s possible to compromise its child users and computers with <code>adminCount=1</code> through &quot;gPLink spoofing&quot;.</p><p>This can be performed with <a href="https://github.com/synacktiv/OUned" target="_blank" rel="noreferrer">OUned.py</a>.</p></div><div class="tip custom-block"><p class="custom-block-title">Disabled accounts</p><p>With enough permissions (<code>GenericAll</code>, <code>GenericWrite</code>) over a disabled object, it is possible to enable it again (e.g. <code>set-aduser &quot;user&quot; -enabled 1</code>)</p></div><h3 id="bloodhound-ace-edges" tabindex="-1">BloodHound ACE edges <a class="header-anchor" href="#bloodhound-ace-edges" aria-label="Permalink to &quot;BloodHound ACE edges&quot;">​</a></h3><p><a href="./../../recon/bloodhound/index">BloodHound</a> has the ability to map abuse paths, with some that rely on DACL abuse. The following edges are not includes in the mindmap above:</p><ul><li><code>AddKeyCredentialLink</code>, a write permission on an object&#39;s <code>Key-Credential-Link</code> attribute, for <a href="./../kerberos/shadow-credentials">Shadow Credentials</a> attacks</li><li><code>WriteSPN</code>, a write permission on an object&#39;s <code>Service-Principal-Name</code> attribute, for <a href="./targeted-kerberoasting">targeted Kerberoasting</a> and <a href="./../kerberos/spn-jacking">SPN jacking</a> attacks</li><li><code>AddSelf</code>, similar to <code>AddMember</code>. While <code>AddMember</code> is <code>WriteProperty</code> access right on the target&#39;s <code>Member</code> attribute, <code>AddSelf</code> is a <code>Self</code> access right on the target&#39;s <code>Member</code> attribute, allowing the attacker to <a href="./addmember">add itself to the target group</a>, instead of adding arbitrary principals.</li><li><code>AddAllowedToAct</code>, a write permission on an object&#39;s <code>msDS-Allowed-To-Act-On-Behalf-Of-Other-Identity</code> attribute, for <a href="./../kerberos/delegations/rbcd">Kerberos RBCD</a> attacks</li><li><code>SyncLAPSPassword</code>, both <code>DS-GetChanges</code> and <code>DS-GetChangesInFilteredSet</code>, for <a href="./readlapspassword">synchronizing LAPS password</a> domain-wise</li><li><code>WriteAccountRestrictions</code>, which refers to the <code>User-Account-Restrictions</code> property set, which contains enough permissions to modify the <code>msDS-Allowed-To-Act-On-Behalf-Of-Other-Identity</code> attribute of the target objects, for <a href="./../kerberos/delegations/rbcd">Kerberos RBCD</a> attacks</li></ul><h3 id="permisssions-index" tabindex="-1">Permisssions index <a class="header-anchor" href="#permisssions-index" aria-label="Permalink to &quot;Permisssions index&quot;">​</a></h3><p>The following table should help for better understanding of the ACE types and what they allow.</p><table tabindex="0"><thead><tr><th>Common name</th><th>Permission value / GUID</th><th>Permission type</th><th>Description</th></tr></thead><tbody><tr><td>WriteDacl</td><td><code>ADS_RIGHT_WRITE_DAC</code></td><td>Access Right</td><td>Edit the object&#39;s DACL (i.e. &quot;inbound&quot; permissions).</td></tr><tr><td>GenericAll</td><td><code>ADS_RIGHT_GENERIC_ALL</code></td><td>Access Right</td><td>Combination of almost all other rights.</td></tr><tr><td>GenericWrite</td><td><code>ADS_RIGHT_GENERIC_WRITE</code></td><td>Access Right</td><td>Combination of write permissions (Self, WriteProperty) among other things.</td></tr><tr><td>WriteProperty</td><td><code>ADS_RIGHT_DS_WRITE_PROP</code></td><td>Access Right</td><td>Edit one of the object&#39;s attributes. The attribute is referenced by an &quot;ObjectType GUID&quot;.</td></tr><tr><td>WriteOwner</td><td><code>ADS_RIGHT_WRITE_OWNER</code></td><td>Access Right</td><td>Assume the ownership of the object (i.e. new owner of the victim = attacker, cannot be set to another user).With the &quot;SeRestorePrivilege&quot; right it is possible to specify an arbitrary owner.</td></tr><tr><td>Self</td><td><code>ADS_RIGHT_DS_SELF</code></td><td>Access Right</td><td>Perform &quot;Validated writes&quot; (i.e. edit an attribute&#39;s value and have that value verified and validate by AD). The &quot;Validated writes&quot; is referenced by an &quot;ObjectType GUID&quot;.</td></tr><tr><td>AllExtendedRights</td><td><code>ADS_RIGHT_DS_CONTROL_ACCESS</code></td><td>Access Right</td><td>Peform &quot;Extended rights&quot;. &quot;AllExtendedRights&quot; refers to that permission being unrestricted. This right can be restricted by specifying the extended right in the &quot;ObjectType GUID&quot;.</td></tr><tr><td>User-Force-Change-Password</td><td><code>00299570-246d-11d0-a768-00aa006e0529</code></td><td>Control Access Right (extended right)</td><td>Change the password of the object without having to know the previous one.</td></tr><tr><td>DS-Replication-Get-Changes</td><td><code>1131f6aa-9c07-11d1-f79f-00c04fc2dcd2</code></td><td>Control Access Right (extended right)</td><td>One of the two extended rights needed to operate a <a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync" target="_blank" rel="noreferrer">DCSync</a>.</td></tr><tr><td>DS-Replication-Get-Changes-All</td><td><code>1131f6ad-9c07-11d1-f79f-00c04fc2dcd2</code></td><td>Control Access Right (extended right)</td><td>One of the two extended rights needed to operate a <a href="https://www.thehacker.recipes/ad/movement/credentials/dumping/dcsync" target="_blank" rel="noreferrer">DCSync</a>.</td></tr><tr><td>Self-Membership</td><td><code>bf9679c0-0de6-11d0-a285-00aa003049e2</code></td><td>Validate Write</td><td>Edit the &quot;member&quot; attribute of the object.</td></tr><tr><td>Validated-SPN</td><td><code>f3a64788-5306-11d1-a9c5-0000f80367c1</code></td><td>Validate Write</td><td>Edit the &quot;servicePrincipalName&quot; attribute of the object.</td></tr></tbody></table><h2 id="talk" tabindex="-1">Talk 🎤 <a class="header-anchor" href="#talk" aria-label="Permalink to &quot;Talk :microphone:&quot;">​</a></h2>',26),e("div",{class:"youtube-embed"},[e("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/_nGpZ1ydzS8",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""}),e("p")],-1),o('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584" target="_blank" rel="noreferrer">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/990fb975-ab31-4bc1-8b75-5da132cd4584</a></p><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectoryrights" target="_blank" rel="noreferrer">https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectoryrights</a></p><p><a href="https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces#genericall-on-user" target="_blank" rel="noreferrer">https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/abusing-active-directory-acls-aces#genericall-on-user</a></p><p><a href="http://www.selfadsi.org/deep-inside/ad-security-descriptors.htm" target="_blank" rel="noreferrer">http://www.selfadsi.org/deep-inside/ad-security-descriptors.htm</a></p><p><a href="https://adsecurity.org/?p=3658" target="_blank" rel="noreferrer">https://adsecurity.org/?p=3658</a></p><details class="details custom-block"><summary>BloodHound releases</summary><p><a href="https://medium.com/@_wald0/bloodhound-1-3-the-acl-attack-path-update-74aa56c5eb3a" target="_blank" rel="noreferrer">https://medium.com/@_wald0/bloodhound-1-3-the-acl-attack-path-update-74aa56c5eb3a</a></p><p><a href="https://blog.cptjesus.com/posts/bloodhound20/" target="_blank" rel="noreferrer">https://blog.cptjesus.com/posts/bloodhound20/</a></p><p><a href="https://posts.specterops.io/introducing-bloodhound-3-0-c00e77ff0aa6" target="_blank" rel="noreferrer">https://posts.specterops.io/introducing-bloodhound-3-0-c00e77ff0aa6</a></p><p><a href="https://posts.specterops.io/introducing-bloodhound-4-0-the-azure-update-9b2b26c5e350" target="_blank" rel="noreferrer">https://posts.specterops.io/introducing-bloodhound-4-0-the-azure-update-9b2b26c5e350</a></p><p><a href="https://posts.specterops.io/introducing-bloodhound-4-1-the-three-headed-hound-be3c4a808146" target="_blank" rel="noreferrer">https://posts.specterops.io/introducing-bloodhound-4-1-the-three-headed-hound-be3c4a808146</a></p><p><a href="https://posts.specterops.io/introducing-bloodhound-4-2-the-azure-refactor-1cff734938bd" target="_blank" rel="noreferrer">https://posts.specterops.io/introducing-bloodhound-4-2-the-azure-refactor-1cff734938bd</a></p></details>',7)]))}const m=r(i,[["render",c]]);export{f as __pageData,m as default};
