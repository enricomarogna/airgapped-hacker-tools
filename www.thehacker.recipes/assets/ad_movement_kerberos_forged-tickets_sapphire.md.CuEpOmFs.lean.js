import{_ as l,c,a5 as n,G as i,w as s,B as o,o as p,j as e,a as t}from"./chunks/framework.B5CpDqM0.js";const F=JSON.parse('{"title":"Sapphire tickets","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/kerberos/forged-tickets/sapphire.md","filePath":"ad/movement/kerberos/forged-tickets/sapphire.md","lastUpdated":1724982529000}'),d={name:"ad/movement/kerberos/forged-tickets/sapphire.md"};function u(k,a,m,f,b,g){const r=o("PluginTabsTab"),h=o("PluginTabs");return p(),c("div",null,[a[2]||(a[2]=n('<h1 id="sapphire-tickets" tabindex="-1">Sapphire tickets <a class="header-anchor" href="#sapphire-tickets" aria-label="Permalink to &quot;Sapphire tickets&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Sapphire tickets are similar to <a href="./diamond">Diamond tickets</a> in the way the ticket is not forged, but instead based on a legitimate one obtained after a request. The difference lays in how the PAC is modified. The <a href="./diamond">Diamond ticket</a> approach modifies the legitimate PAC. In the Sapphire ticket approach, the PAC of another powerful user is obtained through an <a href="./../#s4u2self-+-u2u">S4U2self+u2u</a> trick. This PAC then replaces the one featured in the legitimate ticket. The resulting ticket is an assembly of legitimate elements, and follows a standard ticket request, which makes it then most difficult silver/golden ticket variant to detect.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>Since Diamond tickets modify PACs on-the-fly to include arbitrary group IDs, chances are some detection software are (of will be) able to detect discrepancies between a PAC&#39;s values and actual AD relationships (e.g. a PAC indicates a user belongs to some groups when in fact it doesn&#39;t).</p><p>Sapphire tickets are an alternative to obtaining similar tickets in a stealthier way, by including a legitimate powerful user&#39;s PAC in the ticket. There will be no discrepancy anymore between what&#39;s in the PAC and what&#39;s in Active Directory.</p><p>The powerful user&#39;s PAC can be obtained through an <a href="./../">S4U2self+u2u</a> trick.</p>',7)),i(h,null,{default:s(()=>[i(r,{label:"UNIX-like"},{default:s(()=>a[0]||(a[0]=[e("p",null,[t("From UNIX-like systems, "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),t("'s "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/ticketer.py",target:"_blank",rel:"noreferrer"},"ticketer"),t(" (Python) script can be used for such purposes with the "),e("code",null,"-impersonate"),t(" argument.")],-1),e("p",null,[e("strong",null,"Nota bene"),t(": the "),e("code",null,"-user-id"),t(' argument will be used to build the "Requestor" PAC structure, which could be needed in up-to-date environments (see warning at the bottom of this page).')],-1),e("p",null,[t("The arguments used to customize the PAC will be ignored ("),e("code",null,"-groups"),t(", "),e("code",null,"-extra-sid"),t(","),e("code",null,"-duration"),t("), the required domain SID ("),e("code",null,"-domain-sid"),t(") as well as the username supplied in the positional argument ("),e("code",null,"baduser"),t(' in this case). All these information will be kept as-is from the PAC obtained beforehand using the "S4U2self + U2U" technique.')],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ticketer.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -request"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -impersonate"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domainadmin'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-domain "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DOMAIN.FQDN'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain_user'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -password"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'password'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-nthash "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'krbtgt NT hash'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -aesKey"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'krbtgt AES key'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"-user-id "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'1115'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-sid"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'S-1-5-21-...'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'baduser'")])])])],-1)])),_:1}),i(r,{label:"Windows"},{default:s(()=>a[1]||(a[1]=[e("p",null,[e("em",null,"At the time of writing this recipe (September 2022), no equivalent exists for Windows systems.")],-1)])),_:1})]),_:1}),a[3]||(a[3]=n('<div class="note custom-block"><p>In 2021, Microsoft issued a patch (<a href="https://support.microsoft.com/en-gb/topic/kb5008380-authentication-updates-cve-2021-42287-9dafac11-e0d0-4cb8-959a-143bd0201041" target="_blank" rel="noreferrer">KB5008380</a>) for <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-42287" target="_blank" rel="noreferrer">CVE-2021-42287</a> (see <a href="./../samaccountname-spoofing">samaccountname-spoofing.md</a>). The patch is explained a bit more in <a href="https://blog.netwrix.com/2022/01/10/pacrequestorenforcement-and-kerberos-authentication/" target="_blank" rel="noreferrer">this blogpost</a>. When the patch entered its enforcement phase (Oct. 11th 2022), it made the Sapphire Ticket attack harder to conduct.</p><p>The patch introduced two new structures inside a TGT&#39;s PAC: &quot;Requestor&quot; (<code>PAC_REQUESTOR</code>) and &quot;Attributes&quot; (<code>PAC_ATTRIBUTES_INFO</code>). Those structures are now required in TGTs for all up-to-date environments after the patch enforcement phase, and a <code>KDC_ERR_TGT_REVOKED</code> error is raised if a TGT is used without them.</p><p>Necessary updates were brought to offensive tooling like <a href="https://github.com/fortra/impacket" target="_blank" rel="noreferrer">Impacket</a> (PR# <a href="https://github.com/fortra/impacket/pull/1391" target="_blank" rel="noreferrer">1391</a> and <a href="https://github.com/fortra/impacket/pull/1545" target="_blank" rel="noreferrer">1545</a>) and <a href="https://github.com/GhostPack/Rubeus" target="_blank" rel="noreferrer">Rubeus</a> (PR# <a href="https://github.com/GhostPack/Rubeus/pull/105" target="_blank" rel="noreferrer">105</a>).</p><p>However, since the Sapphire Ticket technique relies on a S4U2self + U2U service ticket request to obtain a privileged user&#39;s PAC, the PAC doesn&#39;t feature the two new &quot;Requestor&quot; and &quot;Attributes&quot; structures. This is probably because the two new structures are only included in TGT&#39;s PACs and not service tickets PACs.</p><p>When using the Sapphire Ticket technique to forge a TGT, if the two structures are missing from the forget ticket, a <code>KDC_ERR_TGT_REVOKED</code> error will be raised in environments that have the patch installed.</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://unit42.paloaltonetworks.com/next-gen-kerberos-attacks/" target="_blank" rel="noreferrer">https://unit42.paloaltonetworks.com/next-gen-kerberos-attacks/</a></p>',3))])}const y=l(d,[["render",u]]);export{F as __pageData,y as default};
