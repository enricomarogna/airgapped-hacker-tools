import{_ as h}from"./chunks/KUD mindmap.DVp6Av-H.js";import{_ as d}from"./chunks/KCD mindmap.epl9Po8C.js";import{_ as c}from"./chunks/RBCD mindmap.DIwJW5_9.js";import{_ as k,c as p,a5 as t,G as a,w as l,j as e,B as o,o as u,a as i}from"./chunks/framework.B5CpDqM0.js";const w=JSON.parse('{"title":"Delegations","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/kerberos/delegations/index.md","filePath":"ad/movement/kerberos/delegations/index.md","lastUpdated":1724982529000}'),g={name:"ad/movement/kerberos/delegations/index.md"};function b(y,s,m,f,E,D){const n=o("PluginTabsTab"),r=o("PluginTabs");return u(),p("div",null,[s[2]||(s[2]=t('<h1 id="delegations" tabindex="-1">Delegations <a class="header-anchor" href="#delegations" aria-label="Permalink to &quot;Delegations&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Kerberos delegations allow services to access other services on behalf of domain users.</p><h3 id="types-of-delegation" tabindex="-1">Types of delegation <a class="header-anchor" href="#types-of-delegation" aria-label="Permalink to &quot;Types of delegation&quot;">​</a></h3><p>The &quot;Kerberos&quot; authentication protocol features delegation capabilities described as follows. There are three types of Kerberos delegations</p><ul><li>Unconstrained delegations (KUD): a service can impersonate users on any other service.</li><li>Constrained delegations (KCD): a service can impersonate users on a set of services</li><li>Resource based constrained delegations (RBCD) : a set of services can impersonate users on a service</li></ul><div class="tip custom-block"><p>With constrained and unconstrained delegations, the delegation attributes are set on the impersonating service (requires <code>SeEnableDelegationPrivilege</code> in the domain) whereas with RBCD, these attributes are set on the target service account itself (requires lower privileges).</p></div><h3 id="extensions" tabindex="-1">Extensions <a class="header-anchor" href="#extensions" aria-label="Permalink to &quot;Extensions&quot;">​</a></h3><p>Kerberos delegations can be abused by attackers to obtain access to valuable assets and sometimes even escalate to domain admin privileges. Regarding constrained delegations and rbcd, those types of delegation rely on Kerberos extensions called <a href="./../#service-for-user-extensions">Service-for-User</a> (S4U).</p><p>Want to know more about S4U2self and S4U2proxy (required to understand some delegation abuses) : <a href="./../#service-for-user-extensions">click here</a>.</p><p>Simply put, Service for User to Self (S4U2self) allows a service to obtain a Service Ticket, on behalf of another user (called &quot;principal&quot;), to itself. Service for User to Proxy (S4U2proxy) allows a service to obtain a Service Ticket, on behalf of a user to a different service.</p><p>Some of the following parts allow to obtain modified or crafted Kerberos tickets. Once obtained, these tickets can be used with <a href="./../ptt">Pass-the-Ticket</a>.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="recon" tabindex="-1">Recon <a class="header-anchor" href="#recon" aria-label="Permalink to &quot;Recon&quot;">​</a></h3>',14)),a(r,null,{default:l(()=>[a(n,{label:"UNIX-like"},{default:l(()=>s[0]||(s[0]=[e("p",null,[i("From UNIX-like systems, "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),i("'s "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/findDelegation.py",target:"_blank",rel:"noreferrer"},"findDelegation"),i(" (Python) script can be used to find unconstrained, constrained (with or without protocol transition) and rbcd.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findDelegation.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DOMAIN"/"USER":"PASSWORD"')])])])],-1),e("p",null,[i("At the time of writing (13th October 2021), "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/pull/1184",target:"_blank",rel:"noreferrer"},"a Pull Request"),i(" is pending to feature a "),e("code",null,"-user"),i(" filter to list delegations for a specific account.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findDelegation.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "account"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DOMAIN"/"USER":"PASSWORD"')])])])],-1)])),_:1}),a(n,{label:"Windows"},{default:l(()=>s[1]||(s[1]=[e("p",null,[i("From Windows systems, "),e("a",{href:"./../../../recon/bloodhound/index"},"BloodHound"),i(" can be used to identify unconstrained and constrained delegation.")],-1),e("p",null,"The following queries can be used to audit delegations.",-1),e("div",{class:"language-cypher vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"cypher"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Unconstrained Delegation")]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MATCH"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (c "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"{"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"unconstraineddelegation"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"}"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," c")]),i(`
`),e("span",{class:"line"}),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Constrained Delegation (with Protocol Transition)")]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MATCH"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (c) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NOT c.allowedtodelegate "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"IS NULL"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," AND"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," c.trustedtoauth"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"true"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," c")]),i(`
`),e("span",{class:"line"}),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Constrained Delegation (without Protocol Transition)")]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MATCH"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," (c) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"WHERE"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," NOT c.allowedtodelegate "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"IS NULL"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," AND"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," c.trustedtoauth"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"false"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," return"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," c")]),i(`
`),e("span",{class:"line"}),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"// Resource-Based Constrained Delegation")]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"MATCH"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," p"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(u)"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"[:"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"AllowedToAct"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"]"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"->"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(c) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"RETURN"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," p")])])])],-1),e("p",null,"The Powershell Active Directory module also has a cmdlet that can be used to find delegation for a specific account.",-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-ADComputer"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "Account"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Properties TrustedForDelegation"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," TrustedToAuthForDelegation"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"msDS"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"AllowedToDelegateTo"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"PrincipalsAllowedToDelegateToAccount")])])])],-1),e("table",{tabindex:"0"},[e("thead",null,[e("tr",null,[e("th",null,"Property"),e("th",null,"Delegation type"),e("th"),e("th")])]),e("tbody",null,[e("tr",null,[e("td",null,[e("code",null,"TrustedForDelegation")]),e("td",null,"Unconstrained Delegation"),e("td"),e("td")]),e("tr",null,[e("td",null,[e("code",null,"TrustedToAuthForDelegation")]),e("td",null,"Constrained Delegation with Protocol Transition"),e("td"),e("td")]),e("tr",null,[e("td",null,[e("code",null,"AllowedToDelegateTo")]),e("td",null,"Constrained Delegation, and list of services allowed to delegate to"),e("td"),e("td")]),e("tr",null,[e("td",null,[e("code",null,"PrincipalsAllowedToDelegateToAccount"),i(" (i.e. refers to the "),e("code",null,"msDS-AllowedToActOnBehalfOfOtherIdentity"),i(" attribute)")]),e("td",null,"RBCD, list of services that can delegate to the account"),e("td"),e("td")])])],-1)])),_:1})]),_:1}),s[3]||(s[3]=t('<h3 id="abuse" tabindex="-1">Abuse <a class="header-anchor" href="#abuse" aria-label="Permalink to &quot;Abuse&quot;">​</a></h3><h4 id="unconstrained-delegations-kud" tabindex="-1">Unconstrained delegations (KUD) <a class="header-anchor" href="#unconstrained-delegations-kud" aria-label="Permalink to &quot;Unconstrained delegations (KUD)&quot;">​</a></h4><div class="tip custom-block"><p>Read the <a href="./unconstrained">(KUD) Unconstrained</a> article for more insight</p></div><p><img src="'+h+'" alt=""></p><h4 id="constrained-delegations-kcd" tabindex="-1">Constrained delegations (KCD) <a class="header-anchor" href="#constrained-delegations-kcd" aria-label="Permalink to &quot;Constrained delegations (KCD)&quot;">​</a></h4><div class="tip custom-block"><p>Read the <a href="./constrained">(KCD) Constrained</a> article for more insight</p></div><p><img src="'+d+'" alt=""></p><h4 id="resource-based-constrained-delegations-rbcd" tabindex="-1">Resource-Based Constrained Delegations (RBCD) <a class="header-anchor" href="#resource-based-constrained-delegations-rbcd" aria-label="Permalink to &quot;Resource-Based Constrained Delegations (RBCD)&quot;">​</a></h4><div class="tip custom-block"><p>Read the <a href="./rbcd">RBCD</a> article for more insight</p></div><p><img src="'+c+'" alt=""></p><h2 id="talk" tabindex="-1">Talk 🎤 <a class="header-anchor" href="#talk" aria-label="Permalink to &quot;Talk :microphone:&quot;">​</a></h2>',11)),s[4]||(s[4]=e("div",{class:"youtube-embed"},[e("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/byykEId3FUs",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""}),e("p")],-1)),s[5]||(s[5]=t('<p><a href="https://docs.google.com/presentation/d/1rAl-XKrkuFjCpExHBGrp5L8ZwtuFFrOygZMapxMp28I/edit?usp=sharing" target="_blank" rel="noreferrer">https://docs.google.com/presentation/d/1rAl-XKrkuFjCpExHBGrp5L8ZwtuFFrOygZMapxMp28I/edit?usp=sharing</a></p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-accounts-collude---trustedtoauthfordelegation-who" target="_blank" rel="noreferrer">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#when-accounts-collude---trustedtoauthfordelegation-who</a></p><p><a href="https://blog.harmj0y.net/redteaming/another-word-on-delegation/" target="_blank" rel="noreferrer">https://blog.harmj0y.net/redteaming/another-word-on-delegation/</a></p><p><a href="https://harmj0y.medium.com/s4u2pwnage-36efe1a2777c" target="_blank" rel="noreferrer">https://harmj0y.medium.com/s4u2pwnage-36efe1a2777c</a></p>',5))])}const T=k(g,[["render",b]]);export{w as __pageData,T as default};
