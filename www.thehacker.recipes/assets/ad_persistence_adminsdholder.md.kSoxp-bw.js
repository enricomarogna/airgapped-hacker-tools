import{_ as d,c as h,a5 as r,G as t,w as a,B as l,o as c,j as e,a as i}from"./chunks/framework.B5CpDqM0.js";const A=JSON.parse('{"title":"AdminSDHolder","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/persistence/adminsdholder.md","filePath":"ad/persistence/adminsdholder.md","lastUpdated":1724982529000}'),p={name:"ad/persistence/adminsdholder.md"};function k(m,s,u,g,b,y){const o=l("PluginTabsTab"),n=l("PluginTabs");return c(),h("div",null,[s[2]||(s[2]=r('<h1 id="adminsdholder" tabindex="-1">AdminSDHolder <a class="header-anchor" href="#adminsdholder" aria-label="Permalink to &quot;AdminSDHolder&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>AdminSdHolder protects domain objects against permission changes. &quot;AdminSdHolder&quot; either refers to a domain object, a &quot;worker code&quot; or an operation depending on the context.</p><p>The operation consists in the PDC (Principal Domain Controller) Emulator restoring pre-set permissions for high-privilege users every 60 minutes. Understanding what DACLs/ACEs are and how to abuse them is a requirement to the understanding of this persistence technique (see <a href="./../movement/dacl/">Access Controls abuse</a>).</p><p>The operation is conducted by a &quot;worker code&quot; called SDProp (Security Descriptor propagator).</p><p>SDProp propagates AdminSdHolder&#39;s Security Descriptor (which contains the DACL) to every protected object every 60 minutes if their SD is different.</p><p>The AdminSdHolder object is located at <code>CN=AdminSdHolder,CN=SYSTEM,DC=DOMAIN,DC=LOCAL</code>. For instance, the default AdminSdHolder object&#39;s DACL contains the following.</p><ul><li>Authenticated Users: Read</li><li>SYSTEM: Full Control</li><li>Administrators: Modify</li><li>Domain Admins: ReadAndExecute</li><li>Enterprise Admins: ReadAndExecute</li></ul><p>The default protected objects are the following.</p><ul><li>member users (possibly nested) of the following groups: <code>Account Operators</code>, <code>Administrators</code>, <code>Backup Operators</code>, <code>Domain Admins</code>, <code>Domain Controllers</code>, <code>Enterprise Admins</code>, <code>Print Operators</code>, <code>Read-only Domain Controllers</code>, <code>Replicator</code>, <code>Schema Admins</code>, <code>Server Operators</code></li><li>the following users: <code>Administrator</code>, <code>krbtgt</code></li></ul><div class="tip custom-block"><p>It&#39;s worth noting the members of the <code>Domain Controllers</code> and <code>Read-Only Domain Controllers</code> groups are not protected (<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/a0d0b4fa-2895-4c64-b182-ba64ad0f84b8" target="_blank" rel="noreferrer">source</a>), only the groups are.</p></div><div class="tip custom-block"><p>When talking about <code>AdminSdHolder</code>, the <code>AdminCount</code> attribute is usually mentioned. This attribute is automatically set on an object when adding it to a protected group. Originally, the purpose was to improve SDProp&#39;s performance. <code>AdminCount</code> cannot be used for malicious purposes and is now mainly informative.</p><p>Also, <code>AdminCount</code> will block inheritance. This means that setting inheritence in the ACE added to <code>AdminSdHolder</code> will be mostly useless. For instance, domain controllers objects are part of the Domain Controller group (at <code>CN=Domain Controllers,CN=Users</code>) which has <code>AdminCount</code> set to 1. While a new ACE set to <code>AdminSdHolder</code> will propagate to the group, its members will not inherit it.</p></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>Once sufficient privileges are obtained, attackers can abuse AdminSdHolder to get persistence on the domain by modifying the AdminSdHolder object&#39;s DACL.</p><p>Let&#39;s say an attacker adds the following ACE to AdminSdHolder&#39;s DACL: <code>attackercontrolleduser: Full Control</code>.</p><p>At the next run of SDProp, <code>attackercontrolleduser</code> will have a <code>GenericAll</code> privilege over all protected objects (Domain Admins, Account Operators, and so on).</p>',16)),t(n,null,{default:a(()=>[t(o,{label:"UNIX-like"},{default:a(()=>s[0]||(s[0]=[e("p",null,[i("From UNIX-like systems, this can be done with "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),i("'s dacledit.py (Python).")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dacledit.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'write'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -rights"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'FullControl'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -principal"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'controlled_object'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target-dn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'CN=AdminSDHolder,CN=System,DC=DOMAIN,DC=LOCAL'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'user':'password'")])])])],-1),e("p",null,"AdminSdHolder's DACL can then be inspected with the same utility.",-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dacledit.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'read'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target-dn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'CN=AdminSDHolder,CN=System,DC=DOMAIN,DC=LOCAL'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'user':'password'")])])])],-1)])),_:1}),t(o,{label:"Windows"},{default:a(()=>s[1]||(s[1]=[e("p",null,[i("This can be done in PowerShell with "),e("code",null,"Add-DomainObjectAcl"),i(" from "),e("a",{href:"https://github.com/PowerShellMafia/PowerSploit",target:"_blank",rel:"noreferrer"},"PowerSploit"),i("'s "),e("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),i(" module.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Add-DomainObjectAcl"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"TargetIdentity "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'CN=AdminSDHolder,CN=System,DC=DOMAIN,DC=LOCAL'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"PrincipalIdentity spotless "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Rights All")])])])],-1),e("p",null,[i("AdminSdHolder's DACL can then be inspected with "),e("code",null,"Get-DomainObjectAcl"),i(".")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Inspect all AdminSdHolder's DACL")]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-DomainObjectAcl"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SamAccountName "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"AdminSdHolder"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ResolveGUIDs")]),i(`
`),e("span",{class:"line"}),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Inspect specific rights an object has on AdminSdHolder (example with a user)")]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sid "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Get-DomainUser"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "someuser"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Select-Object"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ExpandProperty objectsid")]),i(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-DomainObjectAcl"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SamAccountName "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"AdminSdHolder"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ResolveGUIDs "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Where-Object"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," {"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"$_"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".SecurityIdentifier "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-eq"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $sid}")])])])],-1)])),_:1})]),_:1}),s[3]||(s[3]=r('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://adsecurity.org/?p=1906" target="_blank" rel="noreferrer">https://adsecurity.org/?p=1906</a></p><p><a href="https://docs.microsoft.com/en-us/archive/blogs/askds/five-common-questions-about-adminsdholder-and-sdprop" target="_blank" rel="noreferrer">https://docs.microsoft.com/en-us/archive/blogs/askds/five-common-questions-about-adminsdholder-and-sdprop</a></p><p><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence" target="_blank" rel="noreferrer">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence</a></p>',4))])}const F=d(p,[["render",k]]);export{A as __pageData,F as default};
