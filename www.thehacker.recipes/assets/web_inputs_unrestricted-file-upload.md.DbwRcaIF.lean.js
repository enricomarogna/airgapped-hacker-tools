import{_ as t,c as i,a5 as a,o}from"./chunks/framework.B5CpDqM0.js";const u=JSON.parse('{"title":"Unrestricted file upload","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"web/inputs/unrestricted-file-upload.md","filePath":"web/inputs/unrestricted-file-upload.md","lastUpdated":1724982529000}'),s={name:"web/inputs/unrestricted-file-upload.md"};function n(l,e,r,d,c,p){return o(),i("div",null,e[0]||(e[0]=[a(`<h1 id="unrestricted-file-upload" tabindex="-1">Unrestricted file upload <a class="header-anchor" href="#unrestricted-file-upload" aria-label="Permalink to &quot;Unrestricted file upload&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Many web applications manage files and allow users to upload and download pictures, documents and so on (e.g. profile pictures). When file upload procedures are not secured enough, attackers can sometimes upload content that servers will execute when later requested or included (PHP, ASP, JSP...).</p><p>Among other things, unrestricted file uploads can lead to defacement (visual appearance alteration), client-side attacks (like <a href="./xss">XSS</a>), or even RCE (Remote Code Execution).</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>Testers need to find forms that allow users to upload content. On a server using PHP, the following test can be operated.</p><ol><li>Upload a PHP file with the following content: <code>&lt;?php phpinfo(): ?&gt;</code></li><li>Find a way to request or include that file</li><li>Assert that the <code>phpinfo()</code> function is executed</li><li>Repeat steps 1 to 3 but with a PHP file with a code execution payload: <code>&lt;?php system(&#39;whoami&#39;); ?&gt;</code></li></ol><div class="tip custom-block"><p>As command execution functions can be filtered (<code>system</code>, <code>passthru</code>, <code>exec</code>, <code>shell_exec</code>), the <code>phpinfo</code> testing phase is required to assert that arbitrary PHP code is included and interpreted.</p></div><p>Exploiting unrestricted file uploads is like playing &quot;cat and mouse&quot;. Inputs can be filtered and filters can be bypassed.</p><ul><li>Filename: depending on the filters put in place, some tricks can sometimes work like <ul><li>using a valid but lesser known extension to bypass blacklists (let&#39;s say the <code>.php</code> extension is blacklisted, what about <code>.php3</code>, <code>.php4</code>, <code>.php5</code>, <code>.php6</code>, <code>.pht</code>, <code>.phpt</code> and <code>.phtml</code> ?)</li><li>using a double extension like <code>.jpg.php</code> or <code>.php.jpg</code> can sometimes work, either when filenames are badly filtered and controlled, or when Apache HTTP servers are badly configured. On Apache servers, when files have multiple extensions, each extension is mapped either to a MIME type or to a handler. If one of the extensions is mapped to a handler, the requested file will be interpreted with that handler. Consequently, if the <code>.php</code> extension is mapped to a PHP handler in the Apache configuration, a filename with multiple extensions will always be interpreted as a PHP file when requested if one of the extensions is <code>.php</code>.</li><li>using a NULL byte or another separator to bypass filters that do but don&#39;t check control characters such as null characters (<code>.php%00.jpg</code> or <code>.php\\x00.jpg</code>) (this as been fixed in PHP 5.3.4), or a separator like <code>.asp;.jpg</code> (IIS6 and prior). The file will then be uploaded with the <code>.php</code> extension and it will possible to request it and make the server interpret its content.</li><li>alternating upper and lower case letters to bypass case sensitive rules (<code>.pHp</code>, <code>.aSp</code>)</li><li>using a special extension like <code>.p.phphp</code> that might be changed to <code>.php</code> after going through some flawed protections</li></ul></li><li>Content type (MIME type): the media type (sent as &quot;Content-type: MIME type&quot;) identifier is sent along with the name and content of the uploaded file. These filters can easily be bypassed by sending a whitelisted/not blacklisted type (<code>image/jpeg</code> or <code>image/png</code>)</li><li>File type: depending on the detector used, testers should make sure to have a valid whitelisted type and include the PHP code in a way it doesn&#39;t make the file corrupted (inserting malicious code after valid data/header, or within the file&#39;s metadata like the EXIF comments section) to bypass detectors that only read the magic bytes/headers/first characters. For example, it is possible to create a <code>.php.gif</code> file with a valid header by writing <code>GIF89a</code> at the beginning of the file like the following example.</li></ul><div class="language-php vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">php</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">GIF89a</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;?</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">php</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// php reverse shell</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?&gt;</span></span></code></pre></div><div class="tip custom-block"><p>Keep in mind that requesting a file and including it are two different things.</p><p>If the uploaded file contains PHP code, it can be included and the code will be interpreted, regardless of the filename and extensions. Testers will need to find a way to include that file (see <a href="./../inputs/file-inclusion/">File inclusion</a>) to achieve remote code execution.</p><p>If the uploaded file contains a valid PHP extension in its name, it will usally be possible to request it and the PHP code will be interpreted, no need to combine the file upload with a file inclusion to achieve remote code execution. Of course, this will depend on the server configuration.</p></div><p><a href="https://github.com/kohler/gifsicle" target="_blank" rel="noreferrer">Gifsicle</a> (C) is a tool used to generate and edit GIF files. Testers can use it to embed PHP code in the comment section of a GIF. This technique can bypass the <code>getimagesize()</code> function sometimes used as a file type detection function without additional protections.</p><p><a href="https://github.com/almandin/fuxploider" target="_blank" rel="noreferrer">Fuxploider</a> (Python) is a tool used to automate the process of detecting and exploiting file upload forms flaws. As any other fuzzing tool, testers need to be careful when using it.</p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload" target="_blank" rel="noreferrer">https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload</a></p><p><a href="https://teambi0s.gitlab.io/bi0s-wiki/web/file-upload/" target="_blank" rel="noreferrer">https://teambi0s.gitlab.io/bi0s-wiki/web/file-upload/</a></p><p><a href="https://doddsecurity.com/94/remote-code-execution-in-the-avatars/" target="_blank" rel="noreferrer">https://doddsecurity.com/94/remote-code-execution-in-the-avatars/</a></p><p><a href="https://www.acunetix.com/websitesecurity/upload-forms-threat/" target="_blank" rel="noreferrer">https://www.acunetix.com/websitesecurity/upload-forms-threat/</a></p><p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files" target="_blank" rel="noreferrer">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files</a></p>`,20)]))}const f=t(s,[["render",n]]);export{u as __pageData,f as default};
