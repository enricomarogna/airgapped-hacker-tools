import{_ as t,c as r,a5 as a,o}from"./chunks/framework.B5CpDqM0.js";const s="/assets/RODC%20Authentication%20mindmap.C36lciZf.png",i="/assets/RODC%20Access%20to%20resources%20mindmap.PGRc3xBh.png",f=JSON.parse('{"title":"RODC","description":"Read-Only Domain Controller","frontmatter":{"description":"Read-Only Domain Controller","authors":"BlWasp, ShutdownRepo, sckdev, skileau"},"headers":[],"relativePath":"ad/movement/builtins/rodc.md","filePath":"ad/movement/builtins/rodc.md","lastUpdated":1726092039000}'),n={name:"ad/movement/builtins/rodc.md"};function c(d,e,l,h,p,u){return o(),r("div",null,e[0]||(e[0]=[a('<h1 id="rodc" tabindex="-1">RODC <a class="header-anchor" href="#rodc" aria-label="Permalink to &quot;RODC&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><blockquote><p>The read-only Domain Controller (RODC) is a solution that Microsoft introduced for physical locations that don’t have adequate security to host a Domain Controller but still require directory services for resources in those locations. A branch office is the classic use case.</p><p>(By Elad Shamir on <a href="https://posts.specterops.io/at-the-edge-of-tier-zero-the-curious-case-of-the-rodc-ef5f1799ca06" target="_blank" rel="noreferrer">specterops.io</a>)</p></blockquote><p>RODC holds a read-only filtered copy of the Active Directory database with all the sensitives attributes deleted, like the LAPS passwords (this refers to <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753459(v=ws.10)#rodc-fas" target="_blank" rel="noreferrer">RODC Filtered Attribute Set</a> (FAS)), and cache only specific credentials.</p><h3 id="rodc-management" tabindex="-1">RODC Management <a class="header-anchor" href="#rodc-management" aria-label="Permalink to &quot;RODC Management&quot;">​</a></h3><p>As any Active Directory object, an RODC has an attribute named <code>managedBy</code>. Any user or group specified in the attribute has local administrative rights on the RODC. From an attacker point of view, this means that compromising an account listed in the <code>managedBy</code> attribute leads to an RODC admin access. And with sufficient rights to modify this attribute, an attacker can promote himself to RODC admin.</p><h3 id="authentication-with-an-rodc" tabindex="-1">Authentication with an RODC <a class="header-anchor" href="#authentication-with-an-rodc" aria-label="Permalink to &quot;Authentication with an RODC&quot;">​</a></h3><p>To authenticate a principal locally, the RODC must be allowed to retrieve his credentials. Only users, groups and computers that are in the <a href="https://learn.microsoft.com/en-us/windows/win32/adschema/a-msds-revealondemandgroup" target="_blank" rel="noreferrer">msDS-RevealOnDemandGroup</a> and not in <a href="https://learn.microsoft.com/en-us/windows/win32/adschema/a-msds-neverrevealgroup" target="_blank" rel="noreferrer">msDS-NeverRevealGroup</a> may have their credentials <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753459(v=ws.10)#credential-caching" target="_blank" rel="noreferrer">cached</a> on the RODC to be used for future local authentication (in this case, their principal name IDs are added to its <a href="https://learn.microsoft.com/en-us/windows/win32/adschema/a-msds-revealedlist" target="_blank" rel="noreferrer">msDS-Revealed-List</a> attribute). The attributes <code>msDS-RevealOnDemandGroup</code> and <code>msDS-NeverRevealGroup</code> define the <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/cc730883(v=ws.10)" target="_blank" rel="noreferrer">Password Replication Policy</a> of the RODC.</p><blockquote><p>The default PRP (Password Replication Policy) specifies that no account passwords can be cached on any RODC, and certain accounts are explicitly denied from being cached on any RODC.<br> (<a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753459(v=ws.10)#credential-caching" target="_blank" rel="noreferrer">Microsoft</a>)</p></blockquote><p>In case the RODC has cached the principal&#39;s credentials and thus, is able to authenticate it locally, it will issue a TGT. To do so, the RODC holds a derived version of the <code>krbtgt</code> key named <code>krbtgt_XXXXX</code>(where XXXXX is its random version number) and uses it to sign and encrypt the generated TGT. This <code>krbtgt</code> account&#39;s version number can also be found in its <code>msDS-SecondaryKrbTgtNumber</code> attribute.</p><div class="tip custom-block"><p>The RODC computer account has reset rights on the account <code>krbtgt_XXXXX</code>&#39;s password.</p></div><p>When the RODC generates the TGT, it indicates in the <code>kvno</code> field the version number of the key used to generate the ticket. With this TGT, it is possible to request a Service Ticket (ST) against the RODC or any accessible standard writable Domain Controller (provided that the principal is listed in <code>msDS-RevealOnDemandGroup</code> and not listed in <code>msDS-NeverRevealGroup</code>).</p><p><img src="'+s+'" alt=""></p><p class="caption">RODC authentication flow</p><p><img src="'+i+'" alt=""></p><p class="caption">RODC service access flow</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>Several attacks can be performed on RODCs:</p><ul><li><a href="./../kerberos/forged-tickets/rodc-golden-tickets">RODC golden ticket</a></li><li><a href="./../credentials/dumping/kerberos-key-list">Key list attack</a></li><li><a href="./../dacl/rights-on-rodc-object">Exploiting control over a RODC computer object</a></li></ul><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://posts.specterops.io/at-the-edge-of-tier-zero-the-curious-case-of-the-rodc-ef5f1799ca06" target="_blank" rel="noreferrer">https://posts.specterops.io/at-the-edge-of-tier-zero-the-curious-case-of-the-rodc-ef5f1799ca06</a></p><p><a href="https://adsecurity.org/?p=3592" target="_blank" rel="noreferrer">https://adsecurity.org/?p=3592</a></p><p><a href="https://www.secureauth.com/blog/the-kerberos-key-list-attack-the-return-of-the-read-only-domain-controllers/" target="_blank" rel="noreferrer">https://www.secureauth.com/blog/the-kerberos-key-list-attack-the-return-of-the-read-only-domain-controllers/</a></p><p><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754218(v=ws.10)?redirectedfrom=MSDN#how-the-authentication-process-works-on-an-rodc" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc754218(v=ws.10)?redirectedfrom=MSDN#how-the-authentication-process-works-on-an-rodc</a></p><p><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753459(v=ws.10)#credential-caching" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc753459(v=ws.10)#credential-caching</a></p>',25)]))}const w=t(n,[["render",c]]);export{f as __pageData,w as default};
