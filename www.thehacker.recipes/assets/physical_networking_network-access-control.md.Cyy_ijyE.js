import{_ as s,c as i,a5 as t,j as e,o as n}from"./chunks/framework.B5CpDqM0.js";const r="/assets/802.1x%20auth%20flow.CczT__2p.png",o="/assets/Raspberry%20Pi%20drop%20box.Bj3MlsuN.png",l="/assets/nac%20bypass%20setup.FtmORp-D.png",c="/assets/nac%20bypass%20gathered%20MAC%20addresses.DBIVsjw8.png",f=JSON.parse('{"title":"Network Access Control","description":"Bypassing Network Access Control Systems","frontmatter":{"description":"Bypassing Network Access Control Systems","authors":"ShutdownRepo, sckdev"},"headers":[],"relativePath":"physical/networking/network-access-control.md","filePath":"physical/networking/network-access-control.md","lastUpdated":1724982529000}'),h={name:"physical/networking/network-access-control.md"};function p(d,a,u,b,g,k){return n(),i("div",null,a[0]||(a[0]=[t('<h1 id="network-access-control" tabindex="-1">Network Access Control <a class="header-anchor" href="#network-access-control" aria-label="Permalink to &quot;Network Access Control&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p><a href="https://en.wikipedia.org/wiki/Network_Access_Control" target="_blank" rel="noreferrer">NAC</a> (Network Access Control) acts as a kind of a gatekeeper to the local network infrastructure. Its usually works with whitelists, blacklists, authentication requirements or host scanning to restrict access and keep unwanted devices out of the network.</p><h3 id="basics" tabindex="-1">Basics <a class="header-anchor" href="#basics" aria-label="Permalink to &quot;Basics&quot;">​</a></h3><p>NAC is a principle. It can be setup with several measures.</p><ul><li>Filtering of MAC addresses</li><li>Authentication with username &amp; password</li><li>Authentication with certificates</li><li>Fingerprinting</li><li>Host checks</li></ul><p>NAC aims at protecting against the including, but not limited to, scenarios.</p><ul><li>Employees bringing rogue devices (willingly or not)</li><li>Service providers acting inside the IT / OT network*</li><li>Attackers trying to gain access to the internal network</li></ul><p><em>*IT/OT network: Information Technology (workstations, users, shares, ...) and</em> <a href="https://en.wikipedia.org/wiki/Operational_technology" target="_blank" rel="noreferrer"><em>Operational Technology</em></a> <em>(machines, productionl lines, ...).</em></p><h3 id="infrastructure-auth-flow" tabindex="-1">Infrastructure &amp; auth flow <a class="header-anchor" href="#infrastructure-auth-flow" aria-label="Permalink to &quot;Infrastructure &amp; auth flow&quot;">​</a></h3><p>Most commonly, NAC solution are based on <a href="https://en.wikipedia.org/wiki/IEEE_802.1X" target="_blank" rel="noreferrer">802.1x</a> which is a standard for port based network access. It will interact with the switches (most likely and mainly via SNMP) and allow or block ports based on the preset rules. There are 3 actors involved:</p><ul><li>The supplicant: the client that is asking for network access</li><li>The authenticator: the device that acts as the gatekeeper and to which the clients connects - most likely a switch.</li><li>The authentication server: something in the background that validates the requests and grants or denies access to the supplicant.</li></ul><p>By default, the ports are in an unauthorized state and will only be allowed to transmit and receive <a href="https://www.vocal.com/secure-communication/eapol-extensible-authentication-protocol-over-lan/" target="_blank" rel="noreferrer">EAPOL</a> frames (Extensible Authentication Protocol Over LAN), which basically is encapsulated <a href="https://en.wikipedia.org/wiki/Extensible_Authentication_Protocol" target="_blank" rel="noreferrer">EAP</a>.</p><ol><li>These EAPOL frames are forwarded from &quot;the client desiring access to the network&quot; to &quot;the switch&quot;.</li><li>The switch unpacks the EAPOL and forwards the EAP packet to an authentication server, which in most cases will be a RADIUS server.</li></ol><p>From there everything goes vice versa. As EAP is more a framework than a protocol, it contains several EAP methods for authentication. The most commonly known variants are EAP-TLS, EAP-MD5, EAP-PSK and EAP-IKEv2, allowing to authenticate by preshared keys, passwords, certificates or other mechanisms.</p><p class="caption"><img src="'+r+'" alt=""> 802.1x auth flow (Wikipedia)</p><p>When all checks are passed, the port will be switched to authorized and thus be allowed for normal network traffic.</p><p>An infrastructure that is capable of talking 802.1x is needed for all this to work properly. The infrastructure is comprised of supplicants (i.e. clients), authenticators (i.e. switches) and authentication servers (i.e. <a href="https://en.wikipedia.org/wiki/RADIUS" target="_blank" rel="noreferrer">RADIUS</a> servers).</p><p>A short overview from Gartner lists and reviews many NAC solutions: <a href="https://www.gartner.com/reviews/market/network-access-control" target="_blank" rel="noreferrer">NAC Reviews &amp; Ratings</a>.</p><h2 id="offensive-tooling-dropbox" tabindex="-1">Offensive tooling (dropbox) <a class="header-anchor" href="#offensive-tooling-dropbox" aria-label="Permalink to &quot;Offensive tooling (dropbox)&quot;">​</a></h2><h3 id="hardware" tabindex="-1">Hardware <a class="header-anchor" href="#hardware" aria-label="Permalink to &quot;Hardware&quot;">​</a></h3><p>A device, known as &quot;dropbox&quot;, is needed to carry out according attacks when conducting NAC penetration tests. The following setup is a commonly used for this type of engagement.</p><ul><li>Raspberry Pi 4 8GB</li><li>SD card</li><li>3.5” TFT with Case</li><li>Additional USB Ethernet Adapter Power Adapter</li><li>Keyboard</li><li>(optional) Powerbank</li><li>(optional) LTE USB modem</li></ul><p class="caption"><img src="'+o+`" alt=""> Raspberry Pi drop box</p><p>The Raspberry can be flushed with <a href="https://www.kali.org/get-kali/#kali-arm" target="_blank" rel="noreferrer">the official ARM image of Kali</a>.</p><p>The integrated wireless interface can be used to spawn a hotspot to be able to connect via SSH.</p><h3 id="initial-setup" tabindex="-1">Initial setup <a class="header-anchor" href="#initial-setup" aria-label="Permalink to &quot;Initial setup&quot;">​</a></h3><p>The following commands can then be run to install the necessary libraries and tools.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>sudo apt-get install isc-dhcp-server </span></span>
<span class="line"><span>sudo apt-get install hostapd </span></span>
<span class="line"><span>sudo systemctl enable isc-dhcp-server </span></span>
<span class="line"><span>sudo systemctl unmask hostapd </span></span>
<span class="line"><span>sudo systemctl enable hostapd</span></span></code></pre></div><h3 id="dhcp-configuration" tabindex="-1">DHCP configuration <a class="header-anchor" href="#dhcp-configuration" aria-label="Permalink to &quot;DHCP configuration&quot;">​</a></h3><p>The DHCP configuration file is located at <code>/etc/dhcp/dhcpd.conf</code> and can be edited to determine how the dropbox will act as a DHCP server.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>default-lease-time 600;</span></span>
<span class="line"><span>max-lease-time 7200;</span></span>
<span class="line"><span>subnet 192.168.200.0 netmask 255.255.255.0 {</span></span>
<span class="line"><span>range 192.168.200.2 192.168.200.20;</span></span>
<span class="line"><span>option subnet-mask 255.255.255.0;</span></span>
<span class="line"><span>option broadcast-address 192.168.200.255;</span></span>
<span class="line"><span>}</span></span></code></pre></div><h3 id="wi-fi-configuration" tabindex="-1">Wi-Fi configuration <a class="header-anchor" href="#wi-fi-configuration" aria-label="Permalink to &quot;Wi-Fi configuration&quot;">​</a></h3><p>The host access point daemon (hostapd) configuration file is located at <code>/etc/hostapd/hostapd.conf</code> and can be edited to determine how the dropbox will act as a wireless access point.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>interface=wlan0</span></span>
<span class="line"><span>driver=nl80211</span></span>
<span class="line"><span>ssid=kali_hotspot</span></span>
<span class="line"><span>hw_mode=g</span></span>
<span class="line"><span>channel=11</span></span>
<span class="line"><span>macaddr_acl=0</span></span>
<span class="line"><span>ignore_broadcast_ssid=0</span></span>
<span class="line"><span>auth_algs=1</span></span>
<span class="line"><span>wpa=2</span></span>
<span class="line"><span>wpa_passphrase=Sup3rS3cr3tW1F1P@ss!</span></span>
<span class="line"><span>wpa_key_mgmt=WPA-PSK</span></span>
<span class="line"><span>wpa_pairwise=CCMP</span></span>
<span class="line"><span>wpa_group_rekey=86400</span></span>
<span class="line"><span>ieee80211n=1</span></span>
<span class="line"><span>wme_enabled=1</span></span></code></pre></div><h2 id="abuse" tabindex="-1">Abuse <a class="header-anchor" href="#abuse" aria-label="Permalink to &quot;Abuse&quot;">​</a></h2><p>There are several scenarios to take into consideration with specific bypass possibilities.</p><p>Companies usually have devices that don&#39;t fully support 802.1x. Among them can be printers, VOIP equipment, cameras, etc. These will usually be granted access to the network only by having their MAC address in a whitelist. This is often dubbed &quot;MAC-based NAC&quot;.</p><p>MAC-based and 802.1x are usually managed one of many ways:</p><ul><li>by setting up each physical RJ45 port (i.e. the authenticator) in the building to do either MAC-based NAC or 802.1x -&gt; <a href="./network-access-control#mac-address-used-as-only-authentication-feature">MAC-based bypass</a></li><li>by having the authenticator (i.e. port) check if the devices than connect support 802.1x and switch to MAC-based if they don&#39;t</li><li>by mixing MAC-based and authentication (i.e. 802.1x): the MAC address is checked and authentication then takes place -&gt; <a href="./network-access-control#mac-address-needs-to-be-authorized-and-authentication-required">MAC-based + authentication</a></li></ul><div class="tip custom-block"><p>Devices like the <a href="https://ringtail.ch/products/basilisk-automatic-ethernet-ghosting" target="_blank" rel="noreferrer">Basilisk</a>, <a href="https://ringtail.ch/products/basilisk-zero-automatic-ethernet-ghosting" target="_blank" rel="noreferrer">Basilisk Zero</a>, or <a href="https://ringtail.ch/products/skunk-gigabit-ethernet-tap-switch" target="_blank" rel="noreferrer">Skunk</a> can be helpful in NAC-bypass engagements. <em>Nota bene: keep in mind ghosted Linux machines will require custom iptable rules to work smoothly.</em></p></div><h3 id="mac-based-only" tabindex="-1">MAC-based only <a class="header-anchor" href="#mac-based-only" aria-label="Permalink to &quot;MAC-based only&quot;">​</a></h3><p><a href="https://networklessons.com/cisco/ccie-routing-switching-written/mac-authentication-bypass-mab" target="_blank" rel="noreferrer">MAC Authentication Bypass (MAB)</a> can be done by spoofing an authorized MAC address.</p><p>The first step in spoofing an authorized MAC address is to find one. This can be done by physically searching addresses on printers, labels, IP phones and similar equipment, or by using <a href="https://www.wireshark.org/" target="_blank" rel="noreferrer">Wireshark</a> to manually inspect broadcast and multicast packets that travel on the network and obtain some MAC addresses in the traffic.c.</p><p><a href="https://github.com/alobbs/macchanger" target="_blank" rel="noreferrer">macchanger</a> can then be used to spoof the a MAC address. Once there, cables can be swapped to access the customer&#39;s network.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># manually set the address</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">macchanger</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;AA:BB:CC:DD:EE:FF&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># reset the address to the permanent physical MAC</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">macchanger</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span></code></pre></div><div class="tip custom-block"><p>Some errors may be raised when the interface settings cannot be changed. This is usually due to the interface being used.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ifdown</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">macchanger</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;AA:BB:CC:DD:EE:FF&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ifup</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> eth0</span></span></code></pre></div></div><h3 id="authentication-only" tabindex="-1">Authentication only <a class="header-anchor" href="#authentication-only" aria-label="Permalink to &quot;Authentication only&quot;">​</a></h3><p>Same thing as <a href="./network-access-control#mac-address-needs-to-be-authorized-and-authentication-required-1">MAC-based + authentication</a>, without the MAC-based verification bypass.</p><p>A regular authentication to 802.1x (and others) systems can be conducted with <a href="https://github.com/Zero3K/xsupplicant" target="_blank" rel="noreferrer">xsupplicant</a> (C).</p><h3 id="mac-based-authentication" tabindex="-1">MAC-based + authentication <a class="header-anchor" href="#mac-based-authentication" aria-label="Permalink to &quot;MAC-based + authentication&quot;">​</a></h3><p>In this case, access to the network is granted if the supplicant&#39;s MAC address is whitelisted and if the authentication then succeeds.</p><p>Just like with <a href="./network-access-control#mac-address-used-as-only-authentication-feature">MAC-based</a> bypass, the first step is to find an authorized MAC address.</p><p>The second step is to access the port without authentication, which leaves at least two possible ways, both relying on <a href="./network-access-control#offensive-tooling-dropbox">the dropbox</a>.</p><h4 id="using-a-hub" tabindex="-1">Using a Hub <a class="header-anchor" href="#using-a-hub" aria-label="Permalink to &quot;Using a Hub&quot;">​</a></h4><p>Use a Hub, switch the MAC address to the victim&#39;s one, connect the drop box and the victim to the same ethernet port. The “real” device will do the auth stuff, putting the port into authorized mode, and allow both devices to connect to the network. As both have the same MAC, the switch will only have one entry in its ARP / SAT table, not raising suspicion.</p><div class="tip custom-block"><p>But there is a downside to this method. As long as stateless protocols like UDP are used, both devices can communicate just fine. However when it comes to using stateful protocols like TCP, they will for certain run into issues, as one device behind the Hub will be the first to receive and drop or answer a package e.g. in the 3-way-handshake. One could unplug the original device after it opened the port and have a fully capable device inside the network, but this might very quickly raise alarms, when the device is somewhat monitored and will block access to the network when the next authentication needs to be done.</p></div><h4 id="using-a-transparent-bridge" tabindex="-1">Using a transparent bridge <a class="header-anchor" href="#using-a-transparent-bridge" aria-label="Permalink to &quot;Using a transparent bridge&quot;">​</a></h4><p>This idea involves a device that - simply spoken - in a first instance just lets all the traffic traverse it by means of forwarding rules, being totally transparent to the network and all the participants. Tt then does some tcpdump magic to sniff traffic like ARP, NetBIOS but also Kerberos, Active Directory, web etc., extracting the needed info to spoof the victim and the networks gateway to stay under the radar. With this info the needed rules in ebtables, iptables etc. are automatically created, and will allow an attacker to interact with the network mimicking the victim.</p><p>There is an awesome tool called <a href="https://github.com/scipag/nac_bypass" target="_blank" rel="noreferrer">nac_bypass</a> from <a href="https://twitter.com/0x6d69636b" target="_blank" rel="noreferrer">Mick Schneider</a> which he walks through in <a href="https://www.scip.ch/?labs.20190207" target="_blank" rel="noreferrer">this</a> blog post.</p><p>The steps are as follows:</p><ul><li>find a target deivce and put the dropbox in between</li><li>start the <code>nac_bypass_setup.sh</code> script</li></ul><p><img src="`+l+'" alt=""></p><div class="tip custom-block"><p>To manually specify the interfaces, one can do so with the -1 and -2 switches. By default it will treat the lower device as switch side facing, and the next one as victim facing interface.</p></div><ul><li>Wait until the script gathered the MAC address of the attacked system, the IP of the attacked system and the gateway&#39;s MAC address in order to perform the attack. If all went well the following info will show up and the device should be able to talk to the network:</li></ul><p><img src="'+c+'" alt=""></p><ul><li>run other offensive tools for <a href="./../../ad/movement/ntlm/capture">NTLM capture</a>, <a href="./../../ad/movement/ntlm/relay">relay</a>, etc.</li></ul><div class="tip custom-block"><p>Responder needs to bet set up to listen on the bridge interface, but change the answering IP address to the one of the victim.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">responder</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --interface</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> br0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --externalip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $VICTIM</span></span></code></pre></div></div><h2 id="mitigation" tabindex="-1">Mitigation <a class="header-anchor" href="#mitigation" aria-label="Permalink to &quot;Mitigation&quot;">​</a></h2><p>In general an 802.1x implementation will prevent employees or service providers from connecting rogue devices to the network. To a certain extend it may also block script kiddies that don&#39;t have the l33t skillz to bypass it. For more advanced adversaries, the attacks will most likely be successful.</p><p>Here are some general guidelines for keeping things as secure as possible:</p><ul><li>Separate devices that authenticate by MAC only</li><li>Reduce the time for re-authentication to minimize the hub attack scenario. Leaving ports open after a successful 802.1x authentication for an hour will pose a much higher risk than 5 minutes.</li><li>Use MACSec if possible. This will at least make it much harder for an attacker to gather the needed info to play for Man in the Middle.</li><li>Monitoring:</li><li>Uncommon link up/downs on switches</li><li>Speed / duplex changes</li><li>Changes in framesizes (e.g. Windows vs Linux)</li><li>Changed TTLs</li><li>Access to systems and services that normally don´t get accessed (firewall logs)</li><li>Monitor network traffic and detect attacks / unknown patterns (IDS/IPS/SIEM)</li><li>Unneeded ports must be disabled/disconnected.</li><li>Don&#39;t expose unneeded info. Stickers with IP/MAC addresses will make it much easier for an attacker. Same goes for access to IP phone or printer menus to gather network intel. Restrict them as much as possible.</li><li>Restrict access to the systems. If someone is not able to get in between, he can&#39;t carry out attacks.</li><li>Awareness: train employees to ask questions and inform people, when they see a suspicious device hanging from a printer or stuff like that.</li></ul><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2>',73),e("div",{class:"youtube-embed"},[e("iframe",{width:"560",height:"315",src:"https://www.youtube.com/embed/rurYRDlf1Bo",frameborder:"0",allow:"accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",allowfullscreen:""}),e("p")],-1),t('<p><a href="https://www.gremwell.com/marvin-mitm-tapping-dot1x-links" target="_blank" rel="noreferrer">https://www.gremwell.com/marvin-mitm-tapping-dot1x-links</a></p><p><a href="https://github.com/Orange-Cyberdefense/fenrir-ocd" target="_blank" rel="noreferrer">https://github.com/Orange-Cyberdefense/fenrir-ocd</a> 802.1x bypass tool</p><p><a href="https://github.com/nccgroup/phantap" target="_blank" rel="noreferrer">https://github.com/nccgroup/phantap</a> An &quot;invisible&quot; network tap aimed at red teams</p><p><a href="https://github.com/s0lst1c3/silentbridge" target="_blank" rel="noreferrer">https://github.com/s0lst1c3/silentbridge</a> 802.1x-2010 and 802.1x-2004 bypass toolkit</p><p><a href="https://github.com/SySS-Research/Lauschgeraet" target="_blank" rel="noreferrer">https://github.com/SySS-Research/Lauschgeraet</a></p><p><a href="https://github.com/Zero3K/xsupplicant" target="_blank" rel="noreferrer">https://github.com/Zero3K/xsupplicant</a> 802.1X/WPA/WPA2/IEEE802.11i implementation for GNU/Linux/BSD/Windows</p>',6)]))}const w=s(h,[["render",p]]);export{f as __pageData,w as default};
