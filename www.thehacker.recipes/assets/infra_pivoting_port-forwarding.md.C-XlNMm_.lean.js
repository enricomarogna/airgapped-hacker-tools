import{_ as h,c as d,a5 as l,G as t,w as a,B as o,o as p,j as i,a as s}from"./chunks/framework.B5CpDqM0.js";const k="/assets/Chained%20local%20port%20forwarding%20diagram.D87am0u0.png",c="/assets/Chained%20local%20port%20forwarding%20commands.DO9h1nNx.png",g="/assets/Chained%20remote%20port%20forwarding%20diagram.CMq8S-Kx.png",u="/assets/Chained%20remote%20port%20forwarding%20commands.DVQJgZHu.png",T=JSON.parse('{"title":"üõ†Ô∏è Port forwarding","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"infra/pivoting/port-forwarding.md","filePath":"infra/pivoting/port-forwarding.md","lastUpdated":1724982529000}'),E={name:"infra/pivoting/port-forwarding.md"};function m(y,e,w,f,F,C){const n=o("PluginTabsTab"),r=o("PluginTabs");return p(),d("div",null,[e[6]||(e[6]=l('<h1 id="üõ†Ô∏è-port-forwarding" tabindex="-1">üõ†Ô∏è Port forwarding <a class="header-anchor" href="#üõ†Ô∏è-port-forwarding" aria-label="Permalink to &quot;üõ†Ô∏è Port forwarding&quot;">‚Äã</a></h1><div class="warning custom-block"><p>This is a work-in-progress. It&#39;s indicated with the üõ†Ô∏è emoji in the page name or in the category name. Need to do some SSH config work</p></div><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">‚Äã</a></h2><p>Port forwarding is a pivoting technique that allows network packets to be relayed from a port to another. The tunnel can be setup between two controlled and connected machines, hence allowing a bridge between a network and another. That concept is similar to PAT (Port Address Translation), an extension of NAT (Network Address Translation) that allows multiple devices on a LAN to be mapped to a single public IP address by assigning addresses to ports numbers.</p><p>This technique is useful when an attacker wants to stay under the radar or when access to a service is limited to a specific network.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">‚Äã</a></h2><p>There are multiple types of port forwarding used during penetration testing engagements.</p><ul><li>Local port forwarding: access a port that only a remote machine can communicate with (e.g. &quot;firewalled&quot; network, internal localhost network).</li><li>Remote port forwarding: access an attacker&#39;s service (from the attacker&#39;s machine&#39;s networks) from a remote workstation that can&#39;t access those networks directly.</li><li>Dynamic port forwarding: tunnel the whole attacker&#39;s network traffic (instead of only one port) through a remote machine. Explained in <a href="./socks-proxy">SOCKS proxy</a>.</li><li>Reverse dynamic port forwarding: tunnel the whole network traffic from a remote machine through the attacker&#39;s machine. Explained in <a href="./socks-proxy">SOCKS proxy</a>.</li></ul><h3 id="basic-setup" tabindex="-1">Basic setup <a class="header-anchor" href="#basic-setup" aria-label="Permalink to &quot;Basic setup&quot;">‚Äã</a></h3><div class="tip custom-block"><p>While setting up port forwarding, it&#39;s important to remember that non-admin users can only open ports above 1024.</p></div><p>Port forwarding can be set up in many different ways.</p>',11)),t(r,null,{default:a(()=>[t(n,{label:"SSH"},{default:a(()=>e[0]||(e[0]=[i("p",null,[i("strong",null,"SSH commands")],-1),i("p",null,"One of the most easy is by relying on SSH however, it requires to have an SSH server running on the controlled machine and a valid account. The tester needs to open an SSH connection to the machine that should be turned into a SOCKS proxy, and supply",-1),i("ul",null,[i("li",null,[s("the "),i("code",null,"-L"),s(" option for a local port forwarding, along with the ports and addresses to bind")]),i("li",null,[s("the "),i("code",null,"-R"),s(" option for a remote port forwarding, along with the ports and addresses to bind")])],-1),i("p",null,[s("The command can also be used with "),i("code",null,"-N"),s(" option to make sure no command gets executed after the SSH session is opened.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Local port forwarding")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ssh"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -N"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -L"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $LOCAL_ADDRESS"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$LOCAL_PORT"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$REMOTE_ADDRESS"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$REMOTE_PORT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"user@target")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Remote port forwarding")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ssh"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -N"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -R"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $REMOTE_ADDRESS"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$REMOTE_PORT"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$LOCAL_ADDRESS"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$LOCAL_PORT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"user@target")])])])],-1),i("p",null,"Once the ssh command exits successful (or once a session opens) the tester can then proceed to use the tunnel.",-1),i("hr",null,null,-1),i("p",null,[i("strong",null,"SSH configs")],-1),i("p",null,"The same operations can be conducted through a pre-configured agent instead of using command-line argument. TODO",-1)])),_:1}),t(n,{label:"Chisel"},{default:a(()=>e[1]||(e[1]=[i("p",null,"Chisel is a fast TCP/UDP tunnel, transported over HTTP, secured via SSH. Single executable including both client and server. Written in Go (golang). Chisel is mainly useful for passing through firewalls, though it can also be used to provide a secure endpoint into your network.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Attacker machine")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"chisel"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," server"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $ATTACKER_PORT "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-reverse")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Victime machine")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\\"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"chisel.exe"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," client"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $ATTACKER_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ATTACKER_PORT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"R:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$REMOTE_PORT"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":localhost:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$LOCAL_PORT")])])])],-1),i("div",{class:"tip custom-block"},[i("p",null,[s("Chisel binaries can be downloaded from "),i("a",{href:"https://github.com/jpillora/chisel/releases",target:"_blank",rel:"noreferrer"},"the official GitHub repository"),s(".")])],-1)])),_:1}),t(n,{label:"Metasploit"},{default:a(()=>e[2]||(e[2]=[i("p",null,[s("Meterpreter features built in port forwarding capabilities with the "),i("code",null,"portfwd"),s(" cmdlet.")],-1),i("ul",null,[i("li",null,[s("the "),i("code",null,"-l"),s(" option for a local port forwarding, along with the ports and addresses to bind.")]),i("li",null,[s("the "),i("code",null,"-p"),s(" option for a remote port forwarding, along with the ports and addresses to bind.")]),i("li",null,[s("the "),i("code",null,"-r"),s(" option for the targeted remote machine IP address.")])],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Add port forward")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"portfwd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ‚Äìl"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $LOCAL_PORT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"‚Äìp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $REMOTE_PORT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"‚Äìr"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $REMOTE_ADDRESS")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# List ports forwarded")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"portfwd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," list")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Delete port forwarded")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"portfwd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," delete"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ‚Äìl"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $LOCAL_PORT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"‚Äìp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $REMOTE_PORT "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"‚Äìr"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $REMOTE_ADDRESS")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Remove all port forwarded")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"portfwd"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," flush")])])])],-1)])),_:1}),t(n,{label:"plink"},{default:a(()=>e[3]||(e[3]=[i("p",null,"TODO",-1)])),_:1}),t(n,{label:"nc"},{default:a(()=>e[4]||(e[4]=[i("p",null,[s("From a UNIX-like host, the "),i("code",null,"nc"),s(" utility can be used to setup local port forwarding.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nc"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -lvk"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $LOCAL_ADDRESS $LOCAL_PORT "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-c"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "nc -v '),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$REMOTE_ADDRESS"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $REMOTE_PORT"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1)])),_:1}),t(n,{label:"ngrok"},{default:a(()=>e[5]||(e[5]=[i("p",null,[i("a",{href:"https://github.com/inconshreveable/ngrok",target:"_blank",rel:"noreferrer"},"Ngrok"),s(" (Go) is a tool that allows to expose a local web server to the Internet. Upon command execution, the tool will output the Internet-facing address that's configured for port forwarding to the local service.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Expose a local HTTP service on a given port:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ngrok"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," http"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $LOCAL_PORT")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Expose a local HTTPS server:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ngrok"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," http"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," https://localhost")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Expose raw TCP traffic on a given port:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ngrok"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," tcp"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $LOCAL_PORT")])])])],-1)])),_:1})]),_:1}),e[7]||(e[7]=l('<h3 id="chained-local-port-forwarding" tabindex="-1">Chained local port forwarding <a class="header-anchor" href="#chained-local-port-forwarding" aria-label="Permalink to &quot;Chained local port forwarding&quot;">‚Äã</a></h3><p>In the following example (real-world badly secured network), let&#39;s assume the remote attacker wants to access a internal workstation&#39;s web service (i.e. localhost), and that the attackers controls multiple machines that can bridge the multiple networks at play.</p><p><img src="'+k+'" alt=""></p><p><img src="'+c+'" alt=""></p><p>This setup allows the attackers to connect to the workstation web-service on port <code>80/TCP</code> by targeting port <code>1111/TCP</code> on his own machine. His machine will forward the communication to pivot1&#39;s port <code>2222/TCP</code>. Pivot1 will forward to pivot2&#39;s <code>3333/TCP</code>. Pivot2 will forward to workstation&#39;s <code>80/TCP</code>.</p><h3 id="chained-remote-port-forwarding" tabindex="-1">Chained remote port forwarding <a class="header-anchor" href="#chained-remote-port-forwarding" aria-label="Permalink to &quot;Chained remote port forwarding&quot;">‚Äã</a></h3><p>In the following example (real-world badly secured network), let&#39;s assume the remote attacker wants a target workstation to connect back to him with a reverse shell, and that the attackers controls multiple machines that can bridge the multiple networks at play. There are multiple scenarios where using a combination of remote port forwarding would be interesting or even required.</p><ul><li>the attacker wants to stay stealthy by using multiple specific hops to make the traffic legitimate-looking (workstation communicates with an internal server, an internal server communicates with a DMZed server, a DMZed server communicates with a remote client)</li><li>the target workstation doesn&#39;t have access to the remote attacker&#39;s network (i.e. to the Internet)</li></ul><p><img src="'+g+'" alt=""></p><p><img src="'+u+'" alt=""></p><p>This setup allows the target workstation to communicate with the attacker&#39;s port <code>1111/TCP</code> by targeting pivot2 on port <code>3333/TCP</code>. Pivot2 will forward the communication to pivot1&#39;s port <code>2222/TCP</code> which will itself forward to attacker&#39;s port <code>1111/TCP</code>.</p><div class="tip custom-block"><p>If ports are only opened on the loopback interface, testers should make sure the <code>/etc/ssh/sshd_config</code> has the <code>GatewayPorts</code> option set to <code>yes</code> or <code>clientspecified</code>.</p></div>',12))])}const v=h(E,[["render",m]]);export{T as __pageData,v as default};
