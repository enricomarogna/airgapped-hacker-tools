import{_ as h,c as d,a5 as o,G as i,w as a,j as e,a as t,B as r,o as p}from"./chunks/framework.B5CpDqM0.js";const w=JSON.parse('{"title":"GoldenGMSA","description":"","frontmatter":{"authors":"4ndr3w6, ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/persistence/goldengmsa.md","filePath":"ad/persistence/goldengmsa.md","lastUpdated":1724982529000}'),c={name:"ad/persistence/goldengmsa.md"};function u(g,s,k,m,b,f){const l=r("PluginTabsTab"),n=r("PluginTabs");return p(),d("div",null,[s[6]||(s[6]=o('<h1 id="goldengmsa" tabindex="-1">GoldenGMSA <a class="header-anchor" href="#goldengmsa" aria-label="Permalink to &quot;GoldenGMSA&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><h3 id="what-is-a-gmsa-account" tabindex="-1">What is a gMSA account? <a class="header-anchor" href="#what-is-a-gmsa-account" aria-label="Permalink to &quot;What is a gMSA account?&quot;">​</a></h3><p>Within an Active Directory environment, service accounts are often created and used by different applications. These accounts usually have a password that is rarely updated. To address this issue, it is possible to create Group Managed Service Accounts (gMSA), which are managed directly by AD, with a strong password and a regular password rotation.</p><p>The password of a gMSA account can legitimately be requested by authorized applications. In that case, an LDAP request is made to the domain controller, asking for the gMSA account&#39;s <code>msDS-ManagedPassword</code> attribute&#39;s value.</p><div class="tip custom-block"><p>A gMSA account&#39;s <code>msDS-ManagedPassword</code> attribute doesn&#39;t actually store the password (it&#39;s a <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/a3aff238-5f0e-4eec-8598-0a59c30ecd56" target="_blank" rel="noreferrer">constructed attribute</a>). Everytime that attribute is requested by an authorized principal, the domain controller computes it and returns the result. The calculation is detailed a bit more in the <a href="./goldengmsa#password-calculation">password calculation</a> part of this recipe, but simply said, it relies on a static master key (i.e. one of the KDS root keys) and some additional data relative to the gMSA account.</p></div><p>The &quot;GoldenGMSA&quot; persistence lies in the fact that the KDS root keys used for gMSA password calculation don&#39;t change (at least not without some admin intervention or custom automation). Once they are exfiltrated and saved, any gMSA account password can be calculated since the additional values needed can be obtained by any low-privileged user.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="obtaining-persistence" tabindex="-1">Obtaining persistence <a class="header-anchor" href="#obtaining-persistence" aria-label="Permalink to &quot;Obtaining persistence&quot;">​</a></h3><p>Once an AD environment is compromised, acquiring the &quot;GoldenGMSA&quot; persistence requires to dump the KDS root keys.</p>',10)),i(n,null,{default:a(()=>[i(l,{label:"Windows"},{default:a(()=>s[0]||(s[0]=[e("p",null,[t("The KDS (Key Distribution Service) root keys can be exfiltrated from the domain with high-privileged access with "),e("a",{href:"https://github.com/Semperis/GoldenGMSA",target:"_blank",rel:"noreferrer"},"GoldenGMSA"),t(" (C#).")],-1),e("p",null,[t("Without the "),e("code",null,"--forest"),t(" argument, the forest root domain is queried, hence requiring Enterprise Admins or Domain Admins privileges in the forest root domain, or SYSTEM privileges on a forest root Domain Controller.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"GoldenGMSA.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," kdsinfo")])])])],-1),e("p",null,[t("With the "),e("code",null,"--forest"),t(" argument specifying the target domain or forest, SYSTEM privileges are required on the corresponding domain or forest Domain Controller. In case a child domain is specified, the parent domain keys will be dumped as well.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"GoldenGMSA.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," kdsinfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"forest child.lab.local")])])])],-1)])),_:1}),i(l,{label:"UNIX-like"},{default:a(()=>s[1]||(s[1]=[e("p",null,[e("em",null,"At the time of writing this recipe, September 24th, 2022, no equivalent exists (not that we know of), for UNIX-like systems.")],-1)])),_:1})]),_:1}),s[7]||(s[7]=o('<h3 id="retrieving-gmsa-passwords" tabindex="-1">Retrieving gMSA passwords <a class="header-anchor" href="#retrieving-gmsa-passwords" aria-label="Permalink to &quot;Retrieving gMSA passwords&quot;">​</a></h3><p>Later on, the attacker can then, with low-privileged access to the domain:</p><ol><li><a href="./goldengmsa#account-information-dump">dump some information relative to the gMSA account</a> to retrieve the password for</li><li>use those elements to <a href="./goldengmsa#password-calculation">calculate the gMSA password</a></li></ol><h4 id="account-information-dump" tabindex="-1">Account information dump <a class="header-anchor" href="#account-information-dump" aria-label="Permalink to &quot;Account information dump&quot;">​</a></h4>',4)),i(n,null,{default:a(()=>[i(l,{label:"Windows"},{default:a(()=>s[2]||(s[2]=[e("p",null,"In addition to the KDS root keys, the following information, relative to a gMSA, need to be dumped in order to compute its password:",-1),e("ul",null,[e("li",null,"SID (Security IDentifier)"),e("li",null,"RootKeyGuid: indicating what KDS root key to use"),e("li",null,"Password ID: which rotates regularly")],-1),e("p",null,[t("The information can be dumped with low-privilege access to AD with "),e("a",{href:"https://github.com/Semperis/GoldenGMSA",target:"_blank",rel:"noreferrer"},"GoldenGMSA"),t(" (C#).")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"GoldenGMSA.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," gmsainfo")])])])],-1),e("p",null,[t("In order to dump the necessary information of a single gMSA, its SID can be used as filter with the "),e("code",null,"--sid"),t(" argument.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"GoldenGMSA.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," gmsainfo "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sid "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"S-1-5-21-[...]1586295871-1112"')])])])],-1)])),_:1}),i(l,{label:"UNIX-like"},{default:a(()=>s[3]||(s[3]=[e("p",null,[e("em",null,"At the time of writing this recipe, September 24th, 2022, no equivalent exists (not that we know of), for UNIX-like systems.")],-1)])),_:1})]),_:1}),s[8]||(s[8]=e("h4",{id:"password-calculation",tabindex:"-1"},[t("Password calculation "),e("a",{class:"header-anchor",href:"#password-calculation","aria-label":'Permalink to "Password calculation"'},"​")],-1)),i(n,null,{default:a(()=>[i(l,{label:"Windows"},{default:a(()=>s[4]||(s[4]=[e("p",null,[t("Given a gMSA SID, the corresponding KDS root key (matching the RootKeyGuid obtained beforehand), and the Password ID, the actual plaintext password can be calculated with "),e("a",{href:"https://github.com/Semperis/GoldenGMSA",target:"_blank",rel:"noreferrer"},"GoldenGMSA"),t(" (C#).")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"GoldenGMSA.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," compute "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"--"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sid "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"S-1-5-21-[...]1586295871-1112"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"kdskey "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"AQA[...]jG2/M="'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"pwdid "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"AQAAAEtEU[...]gBsAGEAYgBzAAAA"')])])])],-1),e("p",null,[t("Since the password is randomly generated and is not intended to be used by real users with a keyboard (but instead by servers, programs, scripts, etc.) the password is very long, complex and can include non-printable characters. "),e("a",{href:"https://github.com/Semperis/GoldenGMSA",target:"_blank",rel:"noreferrer"},"GoldenGMSA"),t(" will output the password in base64.")],-1),e("p",null,[t("In order to use the password, its MD4 (i.e. NT) hash can be calculated, for "),e("a",{href:"./../movement/ntlm/pth"},"pass the hash"),t(".")],-1),e("div",{class:"language-python vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"python"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," base64")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hashlib")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"b64 "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," input"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Password Base64: "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"NT hash:"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", hashlib.new("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"md4"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},", base64.b64decode()).hexdigest())"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'")])])])],-1)])),_:1}),i(l,{label:"UNIX-like"},{default:a(()=>s[5]||(s[5]=[e("p",null,[e("em",null,"At the time of writing this recipe, September 24th, 2022, no equivalent exists (not that we know of), for UNIX-like systems.")],-1)])),_:1})]),_:1}),s[9]||(s[9]=o('<div class="tip custom-block"><p>The <a href="https://github.com/Semperis/GoldenGMSA" target="_blank" rel="noreferrer">GoldenGMSA</a> (C#) tool featured in this recipe can retrieve gMSA password without the <code>--kdskey</code> or <code>--pwdid</code> arguments, by requesting those information. If the <code>--kdskey</code> is not supplied, high-privilege access will be needed by the tool, which is outside the scope of the GoldenGMSA technique explained in this recipe.</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://github.com/Semperis/GoldenGMSA" target="_blank" rel="noreferrer">https://github.com/Semperis/GoldenGMSA</a></p><p><a href="https://www.semperis.com/blog/golden-gmsa-attack" target="_blank" rel="noreferrer">https://www.semperis.com/blog/golden-gmsa-attack</a></p><p><a href="https://www.trustedsec.com/blog/splunk-spl-queries-for-detecting-gmsa-attacks/" target="_blank" rel="noreferrer">https://www.trustedsec.com/blog/splunk-spl-queries-for-detecting-gmsa-attacks/</a></p>',5))])}const E=h(c,[["render",u]]);export{w as __pageData,E as default};
