import{_ as h,c,a5 as l,G as a,w as s,B as n,o as d,j as e,a as t}from"./chunks/framework.B5CpDqM0.js";const C=JSON.parse('{"title":"Certificate Services (AD-CS)","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/adcs/index.md","filePath":"ad/movement/adcs/index.md","lastUpdated":1724982529000}'),p={name:"ad/movement/adcs/index.md"};function k(u,i,f,g,m,b){const r=n("PluginTabsTab"),o=n("PluginTabs");return d(),c("div",null,[i[5]||(i[5]=l('<h1 id="certificate-services-ad-cs" tabindex="-1">Certificate Services (AD-CS) <a class="header-anchor" href="#certificate-services-ad-cs" aria-label="Permalink to &quot;Certificate Services (AD-CS)&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><blockquote><p>AD CS is Microsoft’s PKI implementation that provides everything from encrypting file systems, to digital signatures, to user authentication (a large focus of our research), and more. While AD CS is not installed by default for Active Directory environments, from our experience in enterprise environments it is widely deployed, and the security ramifications of misconfigured certificate service instances are enormous. (<a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">specterops.io</a>)</p></blockquote><p>In <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">their research papers</a>, <a href="https://twitter.com/harmj0y" target="_blank" rel="noreferrer">Will Schroeder</a> and <a href="https://twitter.com/tifkin_" target="_blank" rel="noreferrer">Lee Christensen</a> shared their research on AD CS and identified multiple theft, escalation and persistence vectors.</p><ul><li>Credential theft (dubbed THEFT1 to THEFT5)</li><li>Account persistence (dubbed PERSIST1 to PERSIST3)</li><li>Domain escalation (dubbed ESC1 to ESC14)</li><li>based on <a href="./certificate-templates">misconfigured certificate templates</a></li><li>based on <a href="./certificate-authority">dangerous CA configuration</a></li><li>related to <a href="./access-controls">access control vulnerabilities</a></li><li>based on an NTLM relay vulnerability related to the <a href="./unsigned-endpoints">web and RPC endpoints of AD CS</a></li><li>Domain persistence (dubbed DPERSIST1 to DPERSIST3)</li><li>by <a href="./certificate-authority#stolen-ca">forging certificates with a stolen CA certificates</a></li><li>by trusting rogue CA certificates</li><li>by <a href="./../../persistence/dacl">maliciously creating vulnerable access controls</a></li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="escalation-techniques" tabindex="-1">Escalation techniques <a class="header-anchor" href="#escalation-techniques" aria-label="Permalink to &quot;Escalation techniques&quot;">​</a></h3><ul><li><a href="./certificate-templates#template-allows-san-esc1">ESC1 &quot;template-allows-san&quot;</a></li><li><a href="./certificate-templates#any-purpose-eku-esc2">ESC2 &quot;any-purpose-eku&quot;</a></li><li><a href="./certificate-templates#certificate-agent-eku-esc3">ESC3 &quot;certificate-agent-eku&quot;</a></li><li><a href="./access-controls#certificate-templates-esc4">ESC4 &quot;certificate-templates&quot;</a></li><li><a href="./access-controls#other-objects-esc5">ESC5 &quot;other-objects&quot;</a></li><li><a href="./certificate-authority#editf_attributesubjectaltname2-esc6">ESC6 &quot;editf_attributesubjectaltname2&quot;</a></li><li><a href="./access-controls#certificate-authority-esc7">ESC7 &quot;certificate-authority&quot;</a></li><li><a href="./unsigned-endpoints#web-endpoint-esc8">ESC8 &quot;web-endpoint-esc8</a></li><li><a href="./certificate-templates#no-security-extension-esc9">ESC9 &quot;no-security-extension&quot;</a></li><li><a href="./certificate-templates#weak-certificate-mapping-esc10">ESC10 &quot;weak-certificate-mapping&quot;</a></li><li><a href="./unsigned-endpoints#rpc-endpoint-esc11">ESC11 &quot;rpc-endpoint&quot;</a></li><li><a href="./certificate-authority#shell-access-to-adcs-ca-with-yubihsm-esc12">ESC12 &quot;shell-access-to-adcs-ca-with-yubihsm&quot;</a></li><li><a href="./certificate-templates#esc13-issuance-policiy-with-privileged-group-linked">ESC13 &quot;issuance-policiy-with-privileged-group-linked&quot;</a></li><li><a href="./certificate-templates#esc14-weak-explicit-mapping">ESC14 &quot;weak-explicit-mapping&quot;</a></li><li><a href="./certifried">Certifried.md</a></li></ul><h3 id="terminology" tabindex="-1">Terminology <a class="header-anchor" href="#terminology" aria-label="Permalink to &quot;Terminology&quot;">​</a></h3><blockquote><ul><li>PKI (Public Key Infrastructure) — a system to manage certificates/public key encryption</li><li>AD CS (Active Directory Certificate Services) — Microsoft’s PKI implementation</li><li>CA (Certificate Authority) — PKI server that issues certificates</li><li>Enterprise CA — CA integrated with AD (as opposed to a standalone CA), offers certificate templates</li><li>Certificate Template — a collection of settings and policies that defines the contents of a certificate issued by an enterprise CA</li><li>CSR (Certificate Signing Request) — a message sent to a CA to request a signed certificate</li><li>EKU (Extended/Enhanced Key Usage) — one or more object identifiers (OIDs) that define how a certificate can be used</li></ul><p>(<a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">specterops.io</a>)</p></blockquote><h3 id="recon" tabindex="-1">Recon <a class="header-anchor" href="#recon" aria-label="Permalink to &quot;Recon&quot;">​</a></h3><p>While AD CS offers attackers a wide range of exploitation and persistence scenarios, this set of services is not always installed, and when it is, it is a requirement to identify its different parts in the domain.</p><h4 id="cert-publishers" tabindex="-1">Cert Publishers <a class="header-anchor" href="#cert-publishers" aria-label="Permalink to &quot;Cert Publishers&quot;">​</a></h4><p>An initial indicator is the &quot;Cert Publishers&quot; built-in group whose members usually are the servers where AD CS is installed (i.e. PKI/CA).</p><ul><li>From UNIX-like systems: <code>rpc net group members &quot;Cert Publishers&quot; -U &quot;DOMAIN&quot;/&quot;User&quot;%&quot;Password&quot; -S &quot;DomainController&quot;</code></li><li>From Windows systems: <code>net group &quot;Cert Publishers&quot; /domain</code></li></ul><h4 id="pkienrollmentservice-objects" tabindex="-1"><code>pKIEnrollmentService</code> objects <a class="header-anchor" href="#pkienrollmentservice-objects" aria-label="Permalink to &quot;`pKIEnrollmentService` objects&quot;">​</a></h4><p>Alternatively, information like the PKI&#39;s CA and DNS names can be gathered through LDAP.</p>',17)),a(o,null,{default:s(()=>[a(r,{label:"netexec"},{default:s(()=>i[0]||(i[0]=[e("p",null,[e("a",{href:"https://github.com/Pennyw0rth/NetExec",target:"_blank",rel:"noreferrer"},"netexec"),t("'s "),e("a",{href:"https://github.com/Pennyw0rth/NetExec/blob/master/cme/modules/adcs.py",target:"_blank",rel:"noreferrer"},"adcs"),t(" module (Python) can be used to find PKI enrollment services in AD.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"netexec"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domaincontroller'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'password'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -M"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," adcs")])])])],-1)])),_:1}),a(r,{label:"windapsearch"},{default:s(()=>i[1]||(i[1]=[e("p",null,[e("a",{href:"https://github.com/ropnop/windapsearch",target:"_blank",rel:"noreferrer"},"windapsearch "),t("(Python) can be used to manually to the LDAP query.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"windapsearch"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -m"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," custom"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --filter"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '(objectCategory=pKIEnrollmentService)'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --base"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'CN=Configuration,DC=domain,DC=local'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --attrs"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," dn,dnshostname"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --dc"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domaincontroller'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain.local'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'password'")])])])],-1)])),_:1}),a(r,{label:"ntlmrelayx"},{default:s(()=>i[2]||(i[2]=[e("p",null,[t("With "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),t("'s "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx"),t(" (Python), thanks to "),e("a",{href:"https://twitter.com/saerxcit",target:"_blank",rel:"noreferrer"},"SAERXCIT"),t(" ("),e("a",{href:"https://github.com/SecureAuthCorp/impacket/pull/1214",target:"_blank",rel:"noreferrer"},"PR#1214"),t("), it is possible to gather information regarding ADCS like the name and host of the CA, the certificate templates enrollment rights for those allowing client authentication and not requiring manager approval, etc. With ntlmrelayx, these information can be gathered through a relayed LDAP session.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "ldap://domaincontroller"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --dump-adcs")])])])],-1)])),_:1})]),_:1}),i[6]||(i[6]=l('<h4 id="attack-paths" tabindex="-1">Attack paths <a class="header-anchor" href="#attack-paths" aria-label="Permalink to &quot;Attack paths&quot;">​</a></h4><div class="tip custom-block"><p><a href="https://github.com/ly4k/Certipy" target="_blank" rel="noreferrer">Certipy</a> (Python) and <a href="https://github.com/GhostPack/Certify" target="_blank" rel="noreferrer">Certify</a> (C#) can also identify the PKI enrollment services and potential attack paths.</p></div>',2)),a(o,null,{default:s(()=>[a(r,{label:"UNIX-like"},{default:s(()=>i[3]||(i[3]=[e("p",null,[t("From UNIX-like systems, the "),e("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),t(" (Python) tool can be used to operate multiple attacks and enumeration operations.")],-1),e("div",{class:"language-python vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"python"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# enumerate and save text, json and bloodhound (original) outputs")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"certipy find "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"u "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'user@domain.local'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'password'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ip "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DC_IP'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"old"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"bloodhound")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# quickly spot vulnerable elements")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"certipy find "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"u "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'user@domain.local'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"p "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'password'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ip "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DC_IP'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"vulnerable "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"stdout")])])])],-1),e("p",null,[t("Certipy also supports BloodHound. With the "),e("code",null,"-old-bloodhound"),t(" option, the data will be exported for the original version of "),e("a",{href:"https://github.com/BloodHoundAD/BloodHound",target:"_blank",rel:"noreferrer"},"BloodHound"),t(". With the "),e("code",null,"-bloodhound"),t(" option, the data will be exported for the modified version of BloodHound, "),e("a",{href:"https://github.com/ly4k/BloodHound/",target:"_blank",rel:"noreferrer"},"forked"),t(" by Certipy's "),e("a",{href:"https://twitter.com/ly4k_",target:"_blank",rel:"noreferrer"},"author"),t(" (default output when no flag is set).")],-1),e("p",null,"The tool also supports multiple output types (text, json, stdout).",-1),e("div",{class:"tip custom-block"},[e("p",null,[t("By default, Certipy uses LDAPS, which is not always supported by the domain controllers. The "),e("code",null,"-scheme"),t(" flag can be used to set whether to use LDAP or LDAPS.")])],-1)])),_:1}),a(r,{label:"Windows"},{default:s(()=>i[4]||(i[4]=[e("p",null,[t("From Windows systems, the "),e("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),t(" (C#) tool can be used to operate multiple attacks and enumeration operations.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," cas")])])])],-1)])),_:1})]),_:1}),i[7]||(i[7]=l('<h3 id="abuse" tabindex="-1">Abuse <a class="header-anchor" href="#abuse" aria-label="Permalink to &quot;Abuse&quot;">​</a></h3><p>The different domain escalation scenarios are detailed in the following parts.</p><ul><li>ESC1 to ESC3, ESC9, ESC10, ESC13 and ESC14: <a href="./certificate-templates">Certificate Templates</a></li><li>ESC6 and ESC12: <a href="./certificate-authority">Certificate Authority</a></li><li>ESC4, ESC5 &amp; ESC7: <a href="./access-controls">Access Controls</a></li><li>ESC8, ESC11: <a href="./unsigned-endpoints">Unsigned Endpoints</a></li></ul><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">https://posts.specterops.io/certified-pre-owned-d95910965cd2</a></p><p><a href="https://www.riskinsight-wavestone.com/en/2021/06/microsoft-adcs-abusing-pki-in-active-directory-environment" target="_blank" rel="noreferrer">https://www.riskinsight-wavestone.com/en/2021/06/microsoft-adcs-abusing-pki-in-active-directory-environment</a></p><p><a href="https://http418infosec.com/ad-cs-what-can-be-misconfigured" target="_blank" rel="noreferrer">https://http418infosec.com/ad-cs-what-can-be-misconfigured</a></p><p><a href="https://http418infosec.com/ad-cs-the-certified-pre-owned-attacks" target="_blank" rel="noreferrer">https://http418infosec.com/ad-cs-the-certified-pre-owned-attacks</a></p><p><a href="https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6" target="_blank" rel="noreferrer">https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6</a></p>',9))])}const E=h(p,[["render",k]]);export{C as __pageData,E as default};
