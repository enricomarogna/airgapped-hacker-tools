import{_ as l,c as o,a5 as k,G as t,w as a,j as s,a as i,B as n,o as d}from"./chunks/framework.B5CpDqM0.js";const p="/assets/UnPAC-the-hash.Dt-60pdc.png",C=JSON.parse('{"title":"UnPAC the hash","description":"","frontmatter":{"authors":"ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/movement/kerberos/unpac-the-hash.md","filePath":"ad/movement/kerberos/unpac-the-hash.md","lastUpdated":1724982529000}'),c={name:"ad/movement/kerberos/unpac-the-hash.md"};function g(u,e,E,y,F,b){const h=n("PluginTabsTab"),r=n("PluginTabs");return d(),o("div",null,[e[2]||(e[2]=k('<h1 id="unpac-the-hash" tabindex="-1">UnPAC the hash <a class="header-anchor" href="#unpac-the-hash" aria-label="Permalink to &quot;UnPAC the hash&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>When using PKINIT to obtain a TGT (Ticket Granting Ticket), the KDC (Key Distribution Center) includes in the ticket a <code>PAC_CREDENTIAL_INFO</code> structure containing the NTLM keys (i.e. LM and NT hashes) of the authenticating user. This feature allows users to switch to NTLM authentications when remote servers don&#39;t support Kerberos, while still relying on an asymmetric Kerberos pre-authentication verification mechanism (i.e. PKINIT).</p><p>The NTLM keys will then be recoverable after a TGS-REQ through U2U, combined with S4U2self, which is a Service Ticket request made to the KDC where the user asks to authenticate to itself (i.e. <a href="./#s4u2self-+-u2u">S4U2self + User-to-User authentication</a>).</p><p>The following protocol diagram details how UnPAC-the-hash works. It allows attackers that know a user&#39;s private key, or attackers able to conduct <a href="./shadow-credentials">Shadow Credentials</a> or <a href="./../../persistence/adcs/golden-certificate">Golden certificate</a> attacks, to recover the user&#39;s LM and NT hashes.</p><p class="caption"><img src="'+p+'" alt=""> UnPAC the hash flow</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2>',7)),t(r,null,{default:a(()=>[t(h,{label:"UNIX-like"},{default:a(()=>e[0]||(e[0]=[s("p",null,[i("From UNIX-like systems, this attack can be conducted with "),s("a",{href:"https://github.com/dirkjanm/PKINITtools",target:"_blank",rel:"noreferrer"},"PKINITtools"),i(" (Python).")],-1),s("p",null,"The first step consists in obtaining a TGT by validating a PKINIT pre-authentication first.",-1),s("div",{class:"language-python vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"python"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"gettgtpkinit.py "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"cert"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"pfx "),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"PATH_TO_CERTIFICATE"'),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"pfx"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-pass"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CERTIFICATE_PASSWORD"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "FQDN_DOMAIN/TARGET_SAMNAME"'),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "TGT_CCACHE_FILE"')])])])],-1),s("p",null,"Once the TGT is obtained, and the session key extracted (printed by gettgtpkinit.py), the getnthash.py script can be used to recover the NT hash.",-1),s("div",{class:"language-bash vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"bash"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"export"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," KRB5CCNAME"),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"TGT_CCACHE_FILE"')]),i(`
`),s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"getnthash.py"),s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -key"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'AS-REP encryption key'"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'FQDN_DOMAIN'/'TARGET_SAMNAME'")])])])],-1),s("p",null,[i("The NT hash can be used for "),s("a",{href:"./../ntlm/pth"},"pass-the-hash"),i(", "),s("a",{href:"./forged-tickets/silver"},"silver ticket"),i(", or "),s("a",{href:"./delegations/"},"Kerberos delegations"),i(" abuse.")],-1)])),_:1}),t(h,{label:"Windows"},{default:a(()=>e[1]||(e[1]=[s("p",null,[i("From Windows systems, "),s("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),i(" (C#) can be used to requesting a ticket using a certificate and use "),s("code",null,"/getcredentials"),i(" to retrieve the NT hash in the PAC.")],-1),s("div",{class:"language-powershell vp-adaptive-theme"},[s("button",{title:"Copy Code",class:"copy"}),s("span",{class:"lang"},"powershell"),s("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getcredentials "),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"user:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"TARGET_SAMNAME"'),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"certificate:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"BASE64_CERTIFICATE"'),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CERTIFICATE_PASSWORD"'),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"FQDN_DOMAIN"'),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),s("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DOMAIN_CONTROLLER"'),s("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),s("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"show")])])])],-1)])),_:1})]),_:1}),e[3]||(e[3]=s("h2",{id:"resources",tabindex:"-1"},[i("Resources "),s("a",{class:"header-anchor",href:"#resources","aria-label":'Permalink to "Resources"'},"​")],-1)),e[4]||(e[4]=s("p",null,[s("a",{href:"https://shenaniganslabs.io/2021/06/21/Shadow-Credentials.html",target:"_blank",rel:"noreferrer"},"https://shenaniganslabs.io/2021/06/21/Shadow-Credentials.html")],-1)),e[5]||(e[5]=s("p",null,[s("a",{href:"https://www.sstic.org/2014/presentation/secrets_dauthentification_pisode_ii__kerberos_contre-attaque/",target:"_blank",rel:"noreferrer"},"https://www.sstic.org/2014/presentation/secrets_dauthentification_pisode_ii__kerberos_contre-attaque/")],-1))])}const f=l(c,[["render",g]]);export{C as __pageData,f as default};
