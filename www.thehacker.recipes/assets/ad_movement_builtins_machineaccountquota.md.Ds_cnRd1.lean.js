import{_ as r,c as o,a5 as n,G as a,w as e,j as i,a as s,B as k,o as d}from"./chunks/framework.B5CpDqM0.js";const m=JSON.parse('{"title":"MachineAccountQuota","description":"","frontmatter":{"authors":"ShutdownRepo, mpgn, noraj, sckdev"},"headers":[],"relativePath":"ad/movement/builtins/machineaccountquota.md","filePath":"ad/movement/builtins/machineaccountquota.md","lastUpdated":1724982529000}'),p={name:"ad/movement/builtins/machineaccountquota.md"};function c(g,t,F,u,E,y){const h=k("PluginTabsTab"),l=k("PluginTabs");return d(),o("div",null,[t[4]||(t[4]=n('<h1 id="machineaccountquota" tabindex="-1">MachineAccountQuota <a class="header-anchor" href="#machineaccountquota" aria-label="Permalink to &quot;MachineAccountQuota&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><blockquote><p>MachineAccountQuota (MAQ) is a domain level attribute that by default permits unprivileged users to attach up to 10 computers to an Active Directory (AD) domain (<a href="https://blog.netspi.com/machineaccountquota-is-useful-sometimes/" target="_blank" rel="noreferrer">source</a>)</p></blockquote><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><p>There are multiple ways attackers can leverage that power.</p><ul><li><a href="./../mitm-and-coerced-authentications/">Force client authentications</a>, <a href="./../ntlm/relay">relay those authentications</a> to domain controllers using LDAPS, and take advantage of authenticated sessions to create a domain computer account. This account can then be used as a foothold on the AD domain to operate authenticated recon (i.e. <a href="./../../recon/bloodhound/index">with BloodHound</a> for example)</li><li>Create a computer account and use it for <a href="./../kerberos/delegations/#resource-based-constrained-delegations-rbcd">Kerberos RBCD attacks</a> when leveraging owned accounts with sufficient permissions (i.e. ACEs like <code>GenericAll</code>, <code>GenericWrite</code> or <code>WriteProperty</code>) against a target machine</li><li>Create a computer account and use it for a <a href="./../kerberos/delegations/#unconstrained-delegations">Kerberos Unconstrained Delegation</a> attack when leveraging owned accounts with sufficient permissions (i.e. the <code>SeEnableDelegationPrivilege</code> user right)</li><li>Profit from special rights that members of the Domain Computers group could inherit</li><li>Profit from special rights that could automatically be applied to new domain computers based on their account name</li></ul><h3 id="check-the-value" tabindex="-1">Check the value <a class="header-anchor" href="#check-the-value" aria-label="Permalink to &quot;Check the value&quot;">​</a></h3>',7)),a(l,null,{default:e(()=>[a(h,{label:"UNIX-like"},{default:e(()=>t[0]||(t[0]=[i("p",null,[s("The "),i("a",{href:"https://github.com/ShutdownRepo/CrackMapExec-MachineAccountQuota",target:"_blank",rel:"noreferrer"},"MachineAccountQuota"),s(" module (for "),i("a",{href:"https://github.com/Pennyw0rth/NetExec",target:"_blank",rel:"noreferrer"},"NetExec"),s(" (Python)) can be used to check the value of the MachineAccountQuota attribute:")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"nxc"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN_CONTROLLER "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-d"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-u"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $USER "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-p"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PASSWORD "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-M"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," maq")])])])],-1),i("p",null,[s("Alternatively, it can be done manually with the Python library "),i("a",{href:"https://pypi.org/project/ldap3/",target:"_blank",rel:"noreferrer"},"ldap3"),s(" ("),i("a",{href:"https://github.com/cannatag/ldap3",target:"_blank",rel:"noreferrer"},"source"),s("):")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"import"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap3")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"target_dn"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "DC=domain,DC=local"'),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # change this")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"domain"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "domain"'),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # change this")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "username"'),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # change this")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"password"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "password"'),i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}}," # change this")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "{}'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"\\\\"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'{}".format'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"domain,"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," username"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap3.Server"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"domain"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"connection"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap3.Connection"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"server"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," server,"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," user,"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," password"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," password,"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," authentication"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ="),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap3.NTLM"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"connection.bind"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"()")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"connection.search(target_dn,"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},'"(objectClass=*)"'),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},","),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," attributes=['ms-DS-MachineAccountQuota']"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"print"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"("),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"connection.entries[0]"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},")")])])])],-1),i("p",null,[s("With "),i("a",{href:"https://github.com/CravateRouge/bloodyAD",target:"_blank",rel:"noreferrer"},"bloodyAD"),s(" (Python):")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bloodyad"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-u"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $USER "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-p"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PASSWORD "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"--host"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN_CONTROLLER "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"get"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," object"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DC=acme,DC=local'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --attr"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ms-DS-MachineAccountQuota")])])])],-1),i("p",null,[s("With "),i("a",{href:"https://github.com/franc-pentest/ldeep",target:"_blank",rel:"noreferrer"},"ldeep"),s(" (Python):")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ldeep"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-u"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $USER "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-p"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $PASSWORD "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-s"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}}," $DOMAIN_CONTROLLER "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"search"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," '(objectclass=domain)'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," jq"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},` '.[]."ms-DS-MachineAccountQuota"'`)])])])],-1),i("p",null,"With ldapsearch (openldap (C)):",-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ldapsearch"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -x"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -H"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap://"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN_CONTROLLER "),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"-b"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'DC=acme,DC=local'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -D"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"@"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -W"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," sub"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "(objectclass=domain)"'),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}}," grep"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ms-DS-MachineAccountQuota")])])])],-1)])),_:1}),a(h,{label:"Windows"},{default:e(()=>t[1]||(t[1]=[i("p",null,[s("In order to run the following commands and tools as other users, testers can check the "),i("a",{href:"./../credentials/impersonation"},"user impersonation"),s(" part.")],-1),i("p",null,[s("The following command, using the "),i("a",{href:"https://docs.microsoft.com/en-us/powershell/module/addsadministration/?view=win10-ps",target:"_blank",rel:"noreferrer"},"PowerShell ActiveDirectory module"),s("'s cmdlets Get-ADDomain and Get-ADObject, will help testers make sure the controlled domain user can create computer accounts (the MachineAccountQuota domain-level attribute needs to be set higher than 0. It is set to 10 by default).")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Get-ADDomain"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," |"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Select-Object"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"ExpandProperty DistinguishedName "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"|"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," Get-ADObject"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Properties "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'ms-DS-MachineAccountQuota'")])])])],-1),i("p",null,[s("FuzzSecurity's "),i("a",{href:"https://github.com/FuzzySecurity/StandIn",target:"_blank",rel:"noreferrer"},"StandIn"),s(" project is an alternative in C# (.NET assembly) to perform some AD post-compromise operations. Among the possible actions, the MAQ attribute can be requested ("),i("a",{href:"https://github.com/FuzzySecurity/StandIn#create-machine-object",target:"_blank",rel:"noreferrer"},"source"),s(").")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"StandIn.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"object ms"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"DS"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MachineAccountQuota"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"=*")])])])],-1)])),_:1})]),_:1}),t[5]||(t[5]=i("h3",{id:"create-a-computer-account",tabindex:"-1"},[s("Create a computer account "),i("a",{class:"header-anchor",href:"#create-a-computer-account","aria-label":'Permalink to "Create a computer account"'},"​")],-1)),a(l,null,{default:e(()=>[a(h,{label:"UNIX-like"},{default:e(()=>t[2]||(t[2]=[i("p",null,[s("The "),i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s(" script "),i("a",{href:"https://tools.thehacker.recipes/impacket/examples/addcomputer.py",target:"_blank",rel:"noreferrer"},"addcomputer"),s(" (Python) can be used to create a computer account, using the credentials of a domain user the the "),i("code",null,"MachineAccountQuota"),s(" domain-level attribute is set higher than 0 (10 by default).")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"addcomputer.py"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -computer-name"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomeName$'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -computer-pass"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomePassword'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-host"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -domain-netbios"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"/"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'":"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"')])])])],-1),i("p",null,[i("code",null,"addcomputer.py"),s(" also has an option "),i("code",null,"-computer-group"),s(" for adding a group to which the account will be added. Because if omitted, the group "),i("code",null,"CN=Computers"),s(" will be used by default.")],-1),i("p",null,[s("Testers can also use "),i("a",{href:"https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py",target:"_blank",rel:"noreferrer"},"ntlmrelayx"),s(" (Python) instead with the "),i("code",null,"--add-computer"),s(" option, like "),i("a",{href:"https://arkanoidctf.medium.com/hackthebox-writeup-forest-4db0de793f96",target:"_blank",rel:"noreferrer"},"this")],-1),i("div",{class:"tip custom-block"},[i("p",null,[s("When using "),i("a",{href:"https://github.com/SecureAuthCorp/impacket",target:"_blank",rel:"noreferrer"},"Impacket"),s(`'s addcomputer script for the creation of a computer account, the "SAMR" method is used by default (instead of the LDAPS one). At the time of writing (10th of December, 2021), the SAMR method creates the account without SPNs. In this case, they could be added later on with `),i("a",{href:"https://github.com/dirkjanm/krbrelayx",target:"_blank",rel:"noreferrer"},"addspn.py"),s(" (Python). By default, computer accounts have the following SPNs set:")]),i("div",{class:"language- vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"}),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",null,"KrbRestrictedHost/hostname")]),s(`
`),i("span",{class:"line"},[i("span",null,"KrbRestrictedHost/hostname.domain_fqdn")]),s(`
`),i("span",{class:"line"},[i("span",null,"Host/hostname")]),s(`
`),i("span",{class:"line"},[i("span",null,"Host/hostname.domain_fqdn")])])])])],-1),i("p",null,[s("With "),i("a",{href:"https://github.com/CravateRouge/bloodyAD",target:"_blank",rel:"noreferrer"},"bloodyAD"),s(" (Python):")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"bloodyad"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," --host"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," add"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," computer"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomeName$'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomePassword'")])])])],-1),i("p",null,[s("With "),i("a",{href:"https://github.com/franc-pentest/ldeep",target:"_blank",rel:"noreferrer"},"ldeep"),s(" (Python):")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"ldeep"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," ldap"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -u"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -p"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -d"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -s"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' ldap://"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create_computer"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomeName$'"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomePassword'")])])])],-1),i("p",null,[s("With "),i("a",{href:"https://github.com/ly4k/Certipy",target:"_blank",rel:"noreferrer"},"Certipy"),s(" (Python):")],-1),i("div",{class:"language-bash vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"bash"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6F42C1","--shiki-dark":"#B392F0"}},"certipy"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," account"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," create"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -username"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$USER"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"@"'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DOMAIN"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -password"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$PASSWORD"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dc-ip"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},' "'),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$DC_HOST"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},'"'),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -user"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomeName$'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -pass"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomePassword'"),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," -dns"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomeDNS'")])])])],-1),i("p",null,[s("Certipy also offers option to set the UPN ("),i("code",null,"-upn"),s("), SAM account name ("),i("code",null,"-sam"),s("), SPNS ("),i("code",null,"-spns"),s(") while creating the computer.")],-1)])),_:1}),a(h,{label:"Windows"},{default:e(()=>t[3]||(t[3]=[i("p",null,[s("The "),i("a",{href:"https://github.com/Kevin-Robertson/Powermad",target:"_blank",rel:"noreferrer"},"Powermad"),s(" module (PowerShell) can be used to create a domain computer account.")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"$password "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"="),i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}}," ConvertTo-SecureString"),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}}," 'SomePassword'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"AsPlainText "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Force")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"New-MachineAccount"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MachineAccount "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'PENTEST01'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Password "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"$"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"($password) "),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}},"-"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,"While the machine account can only be deleted by domian administrators, it can be deactivated by the creator account with the following command using the Powermad module.",-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"Disable-MachineAccount"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"MachineAccount "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'PENTEST01'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," -"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"Verbose")])])])],-1),i("p",null,[s("An alternative is to use FuzzSecurity's "),i("a",{href:"https://github.com/FuzzySecurity/StandIn",target:"_blank",rel:"noreferrer"},"StandIn"),s(" (C#, .NET assembly) project to create a new password account with a random password, disable the account, or delete it (with elevated privileges):")],-1),i("div",{class:"language-powershell vp-adaptive-theme"},[i("button",{title:"Copy Code",class:"copy"}),i("span",{class:"lang"},"powershell"),i("pre",{class:"shiki shiki-themes github-light github-dark vp-code",tabindex:"0"},[i("code",null,[i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Create the account")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"StandIn.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"computer "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'PENTEST01'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"make")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Disable the account")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"StandIn.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"computer "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'PENTEST01'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"disable")]),s(`
`),i("span",{class:"line"}),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#6A737D","--shiki-dark":"#6A737D"}},"# Delete the account (requires elevated rights)")]),s(`
`),i("span",{class:"line"},[i("span",{style:{"--shiki-light":"#005CC5","--shiki-dark":"#79B8FF"}},"StandIn.exe"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"computer "),i("span",{style:{"--shiki-light":"#032F62","--shiki-dark":"#9ECBFF"}},"'PENTEST01'"),i("span",{style:{"--shiki-light":"#D73A49","--shiki-dark":"#F97583"}}," --"),i("span",{style:{"--shiki-light":"#24292E","--shiki-dark":"#E1E4E8"}},"delete")])])])],-1)])),_:1})]),_:1}),t[6]||(t[6]=n('<div class="tip custom-block"><p>Testers need to be aware that the MAQ attribute set to a non-zero value doesn&#39;t necessarily mean the users can create machine accounts. The right to add workstations to a domain can in fact be changed in the Group Policies. <code>Group Policy Management Console (gpmc.msc) &gt; Domain Controllers OU &gt; Domain Controllers Policy &gt; Computer Configuration &gt; Policies &gt; Windows Settings &gt; Security Settings &gt; Local Policies &gt; User Rights Assigments &gt; Add workstations to domain</code></p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://blog.netspi.com/machineaccountquota-is-useful-sometimes/" target="_blank" rel="noreferrer">https://blog.netspi.com/machineaccountquota-is-useful-sometimes/</a></p><p><a href="https://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/" target="_blank" rel="noreferrer">https://www.harmj0y.net/blog/activedirectory/the-most-dangerous-user-right-you-probably-have-never-heard-of/</a></p><p><a href="https://social.technet.microsoft.com/wiki/contents/articles/5446.active-directory-how-to-prevent-authenticated-users-from-joining-workstations-to-a-domain.aspx" target="_blank" rel="noreferrer">https://social.technet.microsoft.com/wiki/contents/articles/5446.active-directory-how-to-prevent-authenticated-users-from-joining-workstations-to-a-domain.aspx</a></p>',5))])}const b=r(p,[["render",c]]);export{m as __pageData,b as default};
