import{_ as t,c as a,a5 as s,o as r}from"./chunks/framework.B5CpDqM0.js";const u=JSON.parse('{"title":"MS-RPC","description":"","frontmatter":{"authors":"ShutdownRepo"},"headers":[],"relativePath":"ad/recon/ms-rpc.md","filePath":"ad/recon/ms-rpc.md","lastUpdated":1724982529000}'),i={name:"ad/recon/ms-rpc.md"};function o(n,e,l,c,p,d){return r(),a("div",null,e[0]||(e[0]=[s(`<h1 id="ms-rpc" tabindex="-1">MS-RPC <a class="header-anchor" href="#ms-rpc" aria-label="Permalink to &quot;MS-RPC&quot;">​</a></h1><h2 id="theory" tabindex="-1">Theory <a class="header-anchor" href="#theory" aria-label="Permalink to &quot;Theory&quot;">​</a></h2><p>MS-RPC (Microsoft Remote Procedure Call) is a protocol that allows requesting service from a program on another computer without having to understand the details of that computer&#39;s network. An MS-RPC service can be accessed through different transport protocols, among which:</p><ul><li>a network SMB pipe (listening ports are 139 &amp; 445)</li><li>plain TCP or plain UDP (listening port set at the service creation)</li><li>a local SMB pipe</li></ul><p>RPC services over an SMB transport, i.e. port 445/TCP, are reachable through &quot;named pipes&quot;&#39; (through the <code>IPC$</code> share). There are many interesting named pipes that allow various operations from NULL sessions context, to local administrative context.</p><ul><li><code>\\pipe\\lsarpc</code>: enumerate privileges, trust relationships, SIDs, policies and more through the LSA (Local Security Authority)</li><li><code>\\pipe\\samr</code>: enumerate domain users, groups and more through the local SAM database (only works pre Win 10 Anniversary)</li><li><code>\\pipe\\svcctl</code>: remotely create, start and stop services to execute commands (used by Impacket&#39;s <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py" target="_blank" rel="noreferrer">psexec.py</a> and <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py" target="_blank" rel="noreferrer">smbexec.py</a>)</li><li><code>\\pipe\\atsvc</code>: remotely create scheduled tasks to execute commands (used by Impacket&#39;s <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py" target="_blank" rel="noreferrer">atexec.py</a>)</li><li><code>\\pipe\\epmapper</code>: used by DCOM (Distributed Component Object Model), itself used by WMI (Windows Management Instrumentation), itself abused by attackers for command execution (used by Impacket&#39;s <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py" target="_blank" rel="noreferrer">wmiexec.py</a>). DCOM is also used by MMC (Microsoft Management Console), itslef abused by attackers for command execution (Impacket&#39;s <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/dcomexec.py" target="_blank" rel="noreferrer">dcomexec.py</a>)</li></ul><h2 id="practice" tabindex="-1">Practice <a class="header-anchor" href="#practice" aria-label="Permalink to &quot;Practice&quot;">​</a></h2><h3 id="find-exposed-services" tabindex="-1">Find exposed services <a class="header-anchor" href="#find-exposed-services" aria-label="Permalink to &quot;Find exposed services&quot;">​</a></h3><p>The epmapper (MS-RPC EndPoint Mapper) maps services to ports. It uses port 135/TCP and/or port 593/TCP (for RPC over HTTP). Through epmapper, tools like Impacket&#39;s <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/rpcdump.py" target="_blank" rel="noreferrer">rpcdump.py</a> (Python) or rpcdump.exe (C) from <a href="https://resources.oreilly.com/examples/9780596510305/tree/master/tools/rpctools" target="_blank" rel="noreferrer">rpctools</a> can find exposed RPC services.</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># with rpcdump.py (example with target port 135/TCP)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpcdump.py</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -port</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 135</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TARGET_IP</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># with rpcdump.exe (example with target port 593/TCP)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpcdump.exe</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 593</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TARGET_IP</span></span></code></pre></div><h3 id="null-sessions" tabindex="-1">Null sessions <a class="header-anchor" href="#null-sessions" aria-label="Permalink to &quot;Null sessions&quot;">​</a></h3><p>NULL sessions are unauthenticated SMB sessions that allow attackers to operate RPC calls through SMB named pipes without being authenticated first. This allows for many recon techniques like the enumeration of domain and local information (users, groups, RIDs, SIDs, policies, etc.).</p><h3 id="recon-through-interesting-named-pipes" tabindex="-1">Recon through interesting named pipes <a class="header-anchor" href="#recon-through-interesting-named-pipes" aria-label="Permalink to &quot;Recon through interesting named pipes&quot;">​</a></h3><p>The Samba utility named <a href="https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html" target="_blank" rel="noreferrer">rpcclient</a> can be used to operate recon through MS-RPC services behind SMB named pipes. It offers multiple useful commands.</p><ul><li><code>lsaquery</code>: get domain name and SID (Security IDentifier)</li><li><code>enumalsgroups builtin</code>: list local groups, returns RIDs (Relative IDs)</li><li><code>queryaliasmem &lt;RID&gt;</code>: list local group members, returns SIDs</li><li><code>lookupsids &lt;SID&gt;</code>: resolve SID to name</li><li><code>lookupnames &lt;NAME&gt;</code>: resolve name to SID</li><li><code>enumdomusers</code>: list users, equivalent to <code>net user /domain</code></li><li><code>enumdomgroups</code>: list groups equivalent to <code>net group /domain</code></li><li><code>queryuser &lt;rid/name&gt;</code>: obtain info on a user, equivalent to <code>net user &lt;user&gt; /domain</code></li><li><code>querygroupmem &lt;rid&gt;</code>: obtain group members, equivalent to <code>net group &lt;group&gt; /domain</code></li><li><code>getdompwinfo</code>: get password policy</li></ul><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rpcclient</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -c</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;command1,command2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $TARGET_IP</span></span></code></pre></div><h3 id="rid-cycling" tabindex="-1">RID Cycling <a class="header-anchor" href="#rid-cycling" aria-label="Permalink to &quot;RID Cycling&quot;">​</a></h3><p>RID Cycling is a method that allows attackers to enumerate domain objects by bruteforcing or guessing RIDs and SIDs, based on the fact that RIDs are sequential.</p><p>The Python script <a href="https://github.com/trustedsec/ridenum" target="_blank" rel="noreferrer">ridenum</a> can be used to operate that recon technique, with a Null session or with an authenticated one.</p><div class="success custom-block"><p>The enum4linux tool can be used to easily operate fast recon through MS-RPC, with Null session or not (see <a href="./enum4linux">this page</a>).</p></div><h2 id="resources" tabindex="-1">Resources <a class="header-anchor" href="#resources" aria-label="Permalink to &quot;Resources&quot;">​</a></h2><p><a href="https://mucomplex.medium.com/remote-procedure-call-and-active-directory-enumeration-616b234468e5" target="_blank" rel="noreferrer">https://mucomplex.medium.com/remote-procedure-call-and-active-directory-enumeration-616b234468e5</a></p><p><a href="https://actes.sstic.org/SSTIC06/Dissection_RPC_Windows/SSTIC06-article-Pouvesle-Dissection_RPC_Windows.pdf" target="_blank" rel="noreferrer">https://actes.sstic.org/SSTIC06/Dissection_RPC_Windows/SSTIC06-article-Pouvesle-Dissection_RPC_Windows.pdf</a></p>`,23)]))}const m=t(i,[["render",o]]);export{u as __pageData,m as default};
